/**
 * HQ Core Controller
 */

import {
  Controller,
  Get,
  Post,
  Put,
  Delete,
  Body,
  Param,
  Query,
  Logger,
} from '@nestjs/common';
import { ApiTags, ApiOperation } from '@nestjs/swagger';
import { HqCoreService, ChatRequest, ChatResponse } from './hq-core.service';
import { HqAgent } from '../../entities/hq-agent.entity';
import { HqAlert, AlertStatus, AlertSeverity } from '../../entities/hq-alert.entity';

@ApiTags('HQ Core')
@Controller('hq')
export class HqCoreController {
  private readonly logger = new Logger(HqCoreController.name);

  constructor(private readonly hqCoreService: HqCoreService) {}

  // ========== Dashboard ==========

  @Get('dashboard')
  @ApiOperation({ summary: '获取仪表盘统计' })
  async getDashboardStats() {
    return this.hqCoreService.getDashboardStats();
  }

  // ========== Agents ==========

  @Get('agents')
  @ApiOperation({ summary: '获取所有 Agent' })
  async getAgents(): Promise<HqAgent[]> {
    return this.hqCoreService.getAgents();
  }

  @Get('agents/:agentId')
  @ApiOperation({ summary: '获取单个 Agent' })
  async getAgent(@Param('agentId') agentId: string): Promise<HqAgent | null> {
    return this.hqCoreService.getAgent(agentId);
  }

  @Put('agents/:agentId/model')
  @ApiOperation({ summary: '更新 Agent 模型设置' })
  async updateAgentModel(
    @Param('agentId') agentId: string,
    @Body()
    body: {
      provider?: 'openai' | 'claude' | 'deepseek' | 'gemini' | 'bedrock-opus' | 'bedrock-sonnet' | 'bedrock-haiku' | 'auto';
      model?: string;
      clear?: boolean;
    },
  ): Promise<HqAgent> {
    return this.hqCoreService.updateAgentModel(agentId, body);
  }

  // ========== Chat ==========

  @Post('chat')
  @ApiOperation({ summary: '与 Agent 对话 (含记忆)' })
  async chat(@Body() request: ChatRequest): Promise<ChatResponse> {
    this.logger.log(`Chat request for agent ${request.agentId}`);
    return this.hqCoreService.chat(request);
  }

  @Post('chat/completion')
  @ApiOperation({ summary: '纯 AI 文本补全 (用于分布式/中转)' })
  async chatCompletion(@Body() request: any) {
    this.logger.log(`AI Completion relay request`);
    return this.hqCoreService.chatCompletion(request.messages, request.options);
  }

  // ========== Alerts ==========

  @Get('alerts')
  @ApiOperation({ summary: '获取告警列表' })
  async getAlerts(
    @Query('projectId') projectId?: string,
    @Query('status') status?: AlertStatus,
    @Query('severity') severity?: AlertSeverity,
    @Query('limit') limit?: string,
  ): Promise<HqAlert[]> {
    return this.hqCoreService.getAlerts({
      projectId,
      status,
      severity,
      limit: limit ? parseInt(limit) : undefined,
    });
  }

  @Put('alerts/:alertId/acknowledge')
  @ApiOperation({ summary: '确认告警' })
  async acknowledgeAlert(
    @Param('alertId') alertId: string,
    @Body() body: { userId: string },
  ): Promise<{ success: boolean }> {
    await this.hqCoreService.acknowledgeAlert(alertId, body.userId);
    return { success: true };
  }

  @Put('alerts/:alertId/resolve')
  @ApiOperation({ summary: '解决告警' })
  async resolveAlert(
    @Param('alertId') alertId: string,
    @Body() body: { userId: string; notes?: string },
  ): Promise<{ success: boolean }> {
    await this.hqCoreService.resolveAlert(alertId, body.userId, body.notes);
    return { success: true };
  }

  // ========== Knowledge Base (简化版) ==========

  @Get('knowledge-base')
  @ApiOperation({ summary: '获取知识库内容' })
  async getKnowledgeBase() {
    return this.hqCoreService.getKnowledgeBase();
  }

  @Post('knowledge-base')
  @ApiOperation({ summary: '保存知识库内容' })
  async saveKnowledgeBase(@Body() body: { content: string }) {
    return this.hqCoreService.saveKnowledgeBase(body.content);
  }

  @Get('rag-files')
  @ApiOperation({ summary: '获取 RAG 文件列表' })
  async getRagFiles() {
    return this.hqCoreService.getRagFiles();
  }

  @Post('rag-files/upload')
  @ApiOperation({ summary: '上传 RAG 文件' })
  async uploadRagFile(@Body() body: { name?: string; filename?: string; content: string }) {
    const name = body.name || body.filename;
    return this.hqCoreService.uploadRagFile(name, body.content);
  }

  @Delete('rag-files/:filename')
  @ApiOperation({ summary: '删除 RAG 文件' })
  async deleteRagFile(@Param('filename') filename: string) {
    return this.hqCoreService.deleteRagFile(`/rag/${filename}`);
  }
}
