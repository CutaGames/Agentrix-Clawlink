# PayMind V3.0 统一支付流程时序图

## 设计原则

1. **用户友好**：用户只看到简单的支付方式选择，无需了解技术细节
2. **技术透明**：所有复杂技术（X402、Escrow、Agent Payment等）在后台自动处理
3. **智能路由**：系统根据支付场景自动选择最优技术方案
4. **统一入口**：QuickPay作为统一入口，自动使用已授权的支付方式

---

## 用户可见的支付方式

用户在前端只看到以下5种支付方式：

1. **QuickPay（快速支付）** ⚡
   - 自动使用已授权的支付方式（X402、Agent Payment等）
   - 用户无需了解技术细节
   - 如果未授权，会引导用户授权

2. **Apple Pay** 🍎
   - 使用Stripe处理，支持Apple Pay

3. **Google Pay** 📱
   - 使用Stripe处理，支持Google Pay

4. **信用卡/借记卡** 💳
   - 使用Stripe处理，支持Visa、Mastercard、银联等

5. **数字货币支付** ₿
   - 支持USDC、USDT、ETH等
   - 自动选择最优链和支付方式（X402或直接转账）

---

## 完整支付流程时序图

### 场景1：用户选择 QuickPay（已授权）

```
用户                前端UI              后端API              智能路由              支付服务
 │                   │                   │                    │                    │
 │──点击支付─────────>│                   │                    │                    │
 │                   │                   │                    │                    │
 │                   │──获取路由建议─────>│                    │                    │
 │                   │                   │──查询授权状态─────>│                    │
 │                   │                   │<─返回授权信息──────│                    │
 │                   │                   │                    │                    │
 │                   │                   │──智能路由选择──────>│                    │
 │                   │                   │<─推荐支付方式──────│                    │
 │                   │<─返回路由建议─────│                    │                    │
 │                   │                   │                    │                    │
 │                   │──显示QuickPay选项─>│                    │                    │
 │<─显示支付方式选择──│                   │                    │                    │
 │                   │                   │                    │                    │
 │──选择QuickPay─────>│                   │                    │                    │
 │                   │                   │                    │                    │
 │                   │──检查授权状态─────>│                    │                    │
 │                   │                   │──查询QuickPay授权──>│                    │
 │                   │                   │<─返回授权信息──────│                    │
 │                   │<─授权状态─────────│                    │                    │
 │                   │                   │                    │                    │
 │                   │──处理支付─────────>│                    │                    │
 │                   │                   │──processPayment───>│                    │
 │                   │                   │                    │──智能路由选择─────>│
 │                   │                   │                    │<─推荐X402/Agent───│
 │                   │                   │                    │                    │
 │                   │                   │                    │──执行支付─────────>│
 │                   │                   │                    │                    │
 │                   │                   │                    │   [X402支付]       │
 │                   │                   │                    │   [Agent Payment]  │
 │                   │                   │                    │   [直接转账]       │
 │                   │                   │                    │                    │
 │                   │                   │                    │<─支付结果─────────│
 │                   │                   │<─支付结果──────────│                    │
 │                   │<─支付成功─────────│                    │                    │
 │<─显示支付成功──────│                   │                    │                    │
```

### 场景2：用户选择 QuickPay（未授权）

```
用户                前端UI              后端API              授权服务
 │                   │                   │                    │
 │──选择QuickPay─────>│                   │                    │
 │                   │                   │                    │
 │                   │──检查授权状态─────>│                    │
 │                   │                   │──查询授权─────────>│
 │                   │                   │<─未授权───────────│
 │                   │<─未授权───────────│                    │
 │                   │                   │                    │
 │                   │──显示授权引导─────>│                    │
 │<─显示授权页面──────│                   │                    │
 │                   │                   │                    │
 │──同意授权─────────>│                   │                    │
 │                   │──创建授权─────────>│                    │
 │                   │                   │──创建QuickPay授权─>│
 │                   │                   │<─授权成功──────────│
 │                   │<─授权成功─────────│                    │
 │                   │                   │                    │
 │                   │──继续支付─────────>│                    │
 │                   │                   │──processPayment───>│
 │                   │                   │<─支付成功──────────│
 │                   │<─支付成功─────────│                    │
 │<─显示支付成功──────│                   │                    │
```

### 场景3：用户选择 数字货币支付

```
用户                前端UI              后端API              智能路由              支付服务
 │                   │                   │                    │                    │
 │──选择数字货币支付──>│                   │                    │                    │
 │                   │                   │                    │                    │
 │                   │──检查钱包连接─────>│                    │                    │
 │                   │<─钱包已连接───────│                    │                    │
 │                   │                   │                    │                    │
 │                   │──处理支付─────────>│                    │                    │
 │                   │                   │──processPayment───>│                    │
 │                   │                   │                    │                    │
 │                   │                   │                    │──智能路由选择─────>│
 │                   │                   │                    │                    │
 │                   │                   │                    │  判断条件：         │
 │                   │                   │                    │  - 金额大小         │
 │                   │                   │                    │  - 用户KYC状态      │
 │                   │                   │                    │  - 是否有X402授权    │
 │                   │                   │                    │  - 是否链上支付     │
 │                   │                   │                    │                    │
 │                   │                   │                    │<─推荐X402──────────│
 │                   │                   │                    │  或直接转账         │
 │                   │                   │                    │                    │
 │                   │                   │                    │──执行支付─────────>│
 │                   │                   │                    │                    │
 │                   │                   │                    │  [X402支付流程]     │
 │                   │                   │                    │  或[直接转账流程]   │
 │                   │                   │                    │                    │
 │                   │                   │                    │<─支付结果─────────│
 │                   │                   │<─支付成功──────────│                    │
 │                   │<─支付成功─────────│                    │                    │
 │<─显示支付成功──────│                   │                    │                    │
```

### 场景4：用户选择 法币支付（Apple Pay/Google Pay/信用卡）

```
用户                前端UI              Stripe服务            后端API
 │                   │                   │                    │
 │──选择法币支付─────>│                   │                    │
 │                   │                   │                    │
 │                   │──创建支付意图─────>│                    │
 │                   │                   │──createIntent─────>│
 │                   │                   │                    │──创建Stripe意图───>│
 │                   │                   │                    │<─返回clientSecret─│
 │                   │                   │<─返回clientSecret──│                    │
 │                   │<─返回clientSecret─│                    │
 │                   │                   │                    │
 │                   │──显示Stripe支付UI─>│                    │
 │<─显示支付表单──────│                   │                    │
 │                   │                   │                    │
 │──填写支付信息─────>│                   │                    │
 │                   │                   │                    │
 │──确认支付─────────>│                   │                    │
 │                   │──提交到Stripe─────>│                    │
 │                   │                   │──处理支付─────────>│
 │                   │                   │<─支付成功──────────│
 │                   │<─支付成功─────────│                    │
 │                   │                   │                    │
 │                   │──processPayment───>│                    │
 │                   │                   │──更新支付状态─────>│
 │                   │                   │<─更新成功──────────│
 │                   │<─支付成功─────────│                    │
 │<─显示支付成功──────│                   │                    │
```

### 场景5：需要托管交易（Escrow）

```
用户                前端UI              后端API              Escrow服务
 │                   │                   │                    │
 │──选择支付方式─────>│                   │                    │
 │                   │                   │                    │
 │                   │──检测支付场景─────>│                    │
 │                   │                   │──判断是否需要托管─>│
 │                   │                   │                    │
 │                   │                   │  判断条件：         │
 │                   │                   │  - 订单类型         │
 │                   │                   │  - 商家设置         │
 │                   │                   │  - 金额阈值         │
 │                   │                   │                    │
 │                   │                   │<─需要托管──────────│
 │                   │                   │                    │
 │                   │                   │──创建托管交易─────>│
 │                   │                   │                    │──创建Escrow合约───>│
 │                   │                   │                    │<─返回escrowId─────│
 │                   │                   │<─返回escrowId──────│                    │
 │                   │                   │                    │
 │                   │                   │──执行支付─────────>│
 │                   │                   │                    │
 │                   │                   │                    │──锁定资金─────────>│
 │                   │                   │                    │<─资金已锁定────────│
 │                   │                   │<─支付成功──────────│                    │
 │                   │<─支付成功─────────│                    │
 │                   │                   │                    │
 │<─显示支付成功──────│                   │                    │
 │                   │                   │                    │
 │  [等待商家发货]    │                   │                    │
 │                   │                   │                    │
 │──确认收货─────────>│                   │                    │
 │                   │──确认收货─────────>│                    │
 │                   │                   │──释放资金─────────>│
 │                   │                   │                    │──释放Escrow资金───>│
 │                   │                   │                    │<─资金已释放────────│
 │                   │                   │<─确认成功──────────│                    │
 │<─显示确认成功──────│                   │                    │
```

### 场景6：Agent代付场景

```
用户                前端UI              后端API              Agent服务
 │                   │                   │                    │
 │──选择QuickPay─────>│                   │                    │
 │                   │                   │                    │
 │                   │──检查授权状态─────>│                    │
 │                   │                   │──查询Agent授权─────>│
 │                   │                   │<─有Agent授权───────│
 │                   │<─有Agent授权─────│                    │
 │                   │                   │                    │
 │                   │──处理支付─────────>│                    │
 │                   │                   │──processPayment───>│
 │                   │                   │                    │
 │                   │                   │──检测Agent场景─────>│
 │                   │                   │                    │
 │                   │                   │  判断条件：         │
 │                   │                   │  - 是否有Agent ID   │
 │                   │                   │  - Agent是否在线    │
 │                   │                   │  - 是否有授权       │
 │                   │                   │                    │
 │                   │                   │<─使用Agent代付─────│
 │                   │                   │                    │
 │                   │                   │──创建Agent支付─────>│
 │                   │                   │                    │──Agent代付────────>│
 │                   │                   │                    │<─支付成功──────────│
 │                   │                   │<─支付成功──────────│                    │
 │                   │<─支付成功─────────│                    │
 │                   │                   │                    │
 │<─显示支付成功──────│                   │                    │
 │                   │                   │                    │
 │  [用户后续还款]    │                   │                    │
 │                   │                   │                    │
 │──还款─────────────>│                   │                    │
 │                   │──repayToAgent────>│                    │
 │                   │                   │──处理还款─────────>│
 │                   │                   │                    │──更新还款状态─────>│
 │                   │                   │                    │<─还款成功──────────│
 │                   │                   │<─还款成功──────────│                    │
 │                   │<─还款成功─────────│                    │
 │<─显示还款成功──────│                   │                    │
```

---

## 智能路由决策逻辑

### 决策树

```
支付请求
  │
  ├─ 用户选择QuickPay？
  │   │
  │   ├─ 有QuickPay授权？
  │   │   │
  │   │   ├─ 有X402授权？
  │   │   │   └─> 使用X402支付（最快、最安全）
  │   │   │
  │   │   ├─ 有Agent授权？
  │   │   │   └─> 使用Agent代付（用户无需立即支付）
  │   │   │
  │   │   └─> 使用已授权的支付方式
  │   │
  │   └─ 无授权？
  │       └─> 引导用户授权（X402或Agent）
  │
  ├─ 用户选择数字货币支付？
  │   │
  │   ├─ 金额 < 阈值？
  │   │   └─> 直接转账（Gas费低）
  │   │
  │   ├─ 金额 >= 阈值？
  │   │   └─> 使用X402（更安全、可撤销）
  │   │
  │   └─ 有X402授权？
  │       └─> 优先使用X402
  │
  ├─ 用户选择法币支付？
  │   └─> 使用Stripe处理
  │
  └─ 需要托管交易？
      └─> 创建Escrow + 执行支付
```

---

## 技术实现细节（用户不可见）

### 1. QuickPay 自动选择逻辑

```typescript
// 伪代码
async function processQuickPay(paymentRequest) {
  // 1. 检查用户授权状态
  const grants = await getQuickPayGrants(userId);
  const x402Auth = await checkX402Authorization(userId);
  const agentAuth = await checkAgentAuthorization(userId);
  
  // 2. 智能选择最优支付方式
  if (x402Auth && isCryptoPayment) {
    // 优先使用X402（最快、最安全）
    return await processX402Payment(paymentRequest);
  }
  
  if (agentAuth && canUseAgentPayment) {
    // 使用Agent代付（用户无需立即支付）
    return await processAgentPayment(paymentRequest);
  }
  
  // 3. 使用其他已授权的支付方式
  if (grants.length > 0) {
    return await processWithGrant(grants[0], paymentRequest);
  }
  
  // 4. 引导用户授权
  throw new AuthorizationRequiredError();
}
```

### 2. 数字货币支付自动路由

```typescript
// 伪代码
async function processCryptoPayment(paymentRequest) {
  const amount = paymentRequest.amount;
  const hasX402Auth = await checkX402Authorization(userId);
  
  // 智能路由决策
  if (hasX402Auth && amount >= X402_THRESHOLD) {
    // 大额支付，使用X402（更安全、可撤销）
    return await processX402Payment(paymentRequest);
  }
  
  if (amount < SMALL_AMOUNT_THRESHOLD) {
    // 小额支付，直接转账（Gas费低）
    return await processDirectTransfer(paymentRequest);
  }
  
  // 默认使用X402（如果可用）
  if (hasX402Auth) {
    return await processX402Payment(paymentRequest);
  }
  
  // 直接转账
  return await processDirectTransfer(paymentRequest);
}
```

### 3. 托管交易自动检测

```typescript
// 伪代码
async function processPayment(paymentRequest) {
  // 检测是否需要托管交易
  const needsEscrow = await shouldUseEscrow({
    orderType: paymentRequest.metadata.orderType,
    merchantSettings: merchant.escrowSettings,
    amount: paymentRequest.amount,
    category: paymentRequest.metadata.category,
  });
  
  if (needsEscrow) {
    // 创建托管交易
    const escrow = await createEscrow({
      merchantId: paymentRequest.merchantId,
      amount: paymentRequest.amount,
      currency: paymentRequest.currency,
    });
    
    // 在支付metadata中标记
    paymentRequest.metadata.escrowId = escrow.escrowId;
  }
  
  // 继续正常支付流程
  return await executePayment(paymentRequest);
}
```

---

## 用户界面设计

### 支付方式选择界面

```
┌─────────────────────────────────────┐
│  选择支付方式                        │
│                                     │
│  ⚡ QuickPay（快速支付）            │
│     使用已授权的支付方式，最快最安全  │
│     [推荐]                          │
│                                     │
│  🍎 Apple Pay                      │
│     使用Apple Pay快速支付           │
│                                     │
│  📱 Google Pay                     │
│     使用Google Pay快速支付          │
│                                     │
│  💳 信用卡/借记卡                  │
│     Visa、Mastercard、银联等        │
│                                     │
│  ₿ 数字货币支付                     │
│     使用USDC、USDT等稳定币          │
│                                     │
│  [取消]  [支付 ¥100.00]            │
└─────────────────────────────────────┘
```

### QuickPay授权引导界面

```
┌─────────────────────────────────────┐
│  启用QuickPay快速支付                │
│                                     │
│  QuickPay可以让您：                 │
│  • 一键完成支付，无需重复输入        │
│  • 自动使用最优支付方式              │
│  • 支持X402、Agent代付等高级功能    │
│                                     │
│  授权设置：                          │
│  □ 单笔限额：¥10,000               │
│  □ 每日限额：¥50,000               │
│  □ 有效期：30天                    │
│                                     │
│  [取消]  [同意并授权]               │
└─────────────────────────────────────┘
```

---

## 总结

1. **用户只看到5种简单支付方式**，技术细节完全透明
2. **QuickPay作为统一入口**，自动使用已授权的支付方式（X402、Agent Payment等）
3. **智能路由自动选择**最优技术方案，用户无需了解
4. **所有支付场景都支持**（Escrow、Agent Payment、X402等），但用户无需关心
5. **困难留给自己，方便留给用户**

---

## 待确认问题

1. ✅ QuickPay是否应该作为第一个选项（如果已授权）？
2. ✅ 未授权时，是否应该自动引导用户授权？
3. ✅ 数字货币支付的阈值是多少？（建议：< $10 直接转账，>= $10 使用X402）
4. ✅ Escrow是否应该完全自动检测，还是需要商家配置？
5. ✅ Agent Payment是否应该完全集成到QuickPay中？

请确认以上设计是否符合您的需求，确认后我将开始实现。

