# 支付聚合服务商集成测试指南

## 测试环境准备

### 1. 服务启动状态检查

**后端服务** (`http://localhost:3001`):
```bash
# 检查后端是否运行
curl http://localhost:3001/api/health
```

**前端服务** (`http://localhost:3000`):
- 打开浏览器访问 `http://localhost:3000`
- 应该能看到首页

---

## 测试场景

### 场景1：测试智能路由优先推荐数字货币支付

**步骤**:
1. 打开 `http://localhost:3000/payment-demo`
2. 点击"体验统一支付流程"按钮
3. 创建一个支付请求（金额：100 CNY，商家接受数字货币）

**预期结果**:
- ✅ 智能路由优先推荐数字货币支付（X402或WALLET）
- ✅ 推荐理由中包含"⭐ 推荐"
- ✅ 价格对比显示：
  - `cryptoPrice`: 数字货币价格（USDC）
  - `stripePrice`: Stripe价格（USDC）
  - `fiatToCryptoPrice`: 法币转数字货币价格（USDC）

**验证点**:
- [ ] 数字货币支付选项显示在最前面
- [ ] 价格显示单位为"USDC"
- [ ] 推荐理由明确说明数字货币成本更低

---

### 场景2：测试支付聚合服务商（无Stripe账户）

**前提条件**:
- 确保 `backend/.env` 中**没有**配置 `STRIPE_SECRET_KEY`
- 或者临时删除该配置

**步骤**:
1. 打开 `http://localhost:3000/payment-demo`
2. 点击"体验统一支付流程"按钮
3. 创建一个支付请求（金额：100 CNY，商家只收法币）
4. 选择"Apple Pay"或"Google Pay"或"信用卡"支付方式

**预期结果**:
- ✅ 系统自动检测到Stripe未配置
- ✅ 自动使用支付聚合服务商（Paddle/Adyen/Checkout.com）
- ✅ 后端日志显示：`通过Paddle处理支付` 或 `通过Adyen处理支付`
- ✅ 支付处理成功

**验证点**:
- [ ] 支付请求成功创建
- [ ] 后端日志显示使用聚合服务商
- [ ] 支付状态正确更新
- [ ] 支付元数据包含 `aggregatorId` 和 `aggregatorTransactionId`

---

### 场景3：测试价格显示单位（USDC）

**步骤**:
1. 打开 `http://localhost:3000/payment-demo`
2. 点击"体验统一支付流程"按钮
3. 查看所有支付方式的价格显示

**预期结果**:
- ✅ 所有价格都显示"USDC"单位
- ✅ 价格格式：`XX.XX USDC`
- ✅ 价格对比正确（数字货币 < 法币转数字货币 < Stripe）

**验证点**:
- [ ] QuickPay价格显示"USDC"
- [ ] 数字货币支付价格显示"USDC"
- [ ] Stripe支付价格显示"USDC"
- [ ] 法币转数字货币价格显示"USDC"

---

### 场景4：测试商家收款方式配置

**场景4A：商家只收法币（fiat_only）**

**步骤**:
1. 创建支付请求，设置 `merchantPaymentConfig: 'fiat_only'`
2. 查看可用支付方式

**预期结果**:
- ✅ 只显示法币支付选项（Apple Pay、Google Pay、信用卡）
- ✅ 不显示数字货币支付选项
- ✅ 如果Stripe未配置，自动使用支付聚合服务商

**场景4B：商家只收数字货币（crypto_only）**

**步骤**:
1. 创建支付请求，设置 `merchantPaymentConfig: 'crypto_only'`
2. 查看可用支付方式

**预期结果**:
- ✅ 只显示数字货币支付选项
- ✅ 智能路由优先推荐X402或WALLET
- ✅ 不显示法币支付选项

**场景4C：商家两种都接受（both）**

**步骤**:
1. 创建支付请求，设置 `merchantPaymentConfig: 'both'`
2. 查看可用支付方式

**预期结果**:
- ✅ 显示所有支付选项
- ✅ 智能路由优先推荐数字货币支付
- ✅ 显示价格对比（数字货币 < 法币转数字货币 < Stripe）

---

### 场景5：测试汇率转换

**步骤**:
1. 创建支付请求，金额：100 CNY
2. 查看价格对比中的USDC价格

**预期结果**:
- ✅ `cryptoPrice`: 约 14.001 USDC (100 CNY * 0.14 + Gas费用)
- ✅ `stripePrice`: 约 14.406 USDC (100 CNY * 1.029 * 0.14 + 0.3 * 0.14)
- ✅ `fiatToCryptoPrice`: 约 13.253 USDC (比Stripe便宜8%)

**验证点**:
- [ ] CNY到USDC汇率转换正确（1 CNY = 0.14 USDC）
- [ ] 价格计算包含手续费
- [ ] 所有价格统一为USDC单位

---

## API测试

### 测试1：获取支付路由（智能路由）

**请求**:
```bash
curl -X GET "http://localhost:3001/api/payments/routing?amount=100&currency=CNY&merchantPaymentConfig=both" \
  -H "Content-Type: application/json"
```

**预期响应**:
```json
{
  "recommendedMethod": "x402",
  "reason": "⭐ 推荐使用X402协议，成本比标准链上支付低40%...",
  "priceComparison": {
    "cryptoPrice": 14.001,
    "stripePrice": 14.406,
    "fiatToCryptoPrice": 13.253,
    "fiatToCryptoProvider": "MoonPay"
  },
  "requiresKYC": false
}
```

**验证点**:
- [ ] `recommendedMethod` 是数字货币支付方式（x402或wallet）
- [ ] `priceComparison` 中所有价格都是USDC单位
- [ ] `reason` 包含"⭐ 推荐"

---

### 测试2：处理支付（使用支付聚合服务商）

**前提**:
- 确保 `STRIPE_SECRET_KEY` 未配置

**请求**:
```bash
curl -X POST "http://localhost:3001/api/payments/process" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "amount": 100,
    "currency": "CNY",
    "paymentMethod": "stripe",
    "metadata": {
      "merchantPaymentConfig": "fiat_only"
    }
  }'
```

**预期响应**:
```json
{
  "id": "...",
  "status": "processing",
  "metadata": {
    "aggregatorId": "paddle",
    "aggregatorTransactionId": "paddle_..."
  }
}
```

**验证点**:
- [ ] 支付状态为 `processing` 或 `completed`
- [ ] `metadata` 包含 `aggregatorId`（paddle/adyen/checkout）
- [ ] `metadata` 包含 `aggregatorTransactionId`

---

## 后端日志检查

### 支付聚合服务商日志

**预期日志**:
```
[PaymentAggregatorService] 通过Paddle处理支付: 100 CNY, method=card
```

或

```
[PaymentAggregatorService] 通过Adyen处理支付: 100 CNY, method=apple_pay
```

### 智能路由日志

**预期日志**:
```
[SmartRouterService] 推荐支付方式: x402, 原因: ⭐ 推荐使用X402协议...
```

---

## 前端界面检查

### 支付模态框检查

1. **打开支付模态框**:
   - 访问 `http://localhost:3000/payment-demo`
   - 点击"体验统一支付流程"

2. **检查支付方式列表**:
   - [ ] QuickPay显示在最前面（如果已授权）
   - [ ] 数字货币支付显示在前面（如果商家接受）
   - [ ] 所有价格都显示"USDC"单位

3. **检查价格对比**:
   - [ ] 数字货币价格最低
   - [ ] 法币转数字货币价格次之
   - [ ] Stripe价格最高

4. **检查推荐标识**:
   - [ ] 数字货币支付选项有"⭐ 推荐"标识
   - [ ] 推荐理由明确说明优势

---

## 常见问题排查

### 问题1：支付聚合服务商未触发

**可能原因**:
- Stripe仍然配置了（检查 `.env` 文件）
- 支付方式不是法币支付

**解决方法**:
- 确保 `STRIPE_SECRET_KEY` 未配置或为空
- 选择法币支付方式（Apple Pay、Google Pay、信用卡）

### 问题2：价格显示不正确

**可能原因**:
- 汇率转换错误
- 价格计算逻辑问题

**解决方法**:
- 检查后端日志中的价格计算
- 验证汇率是否正确（1 CNY = 0.14 USDC）

### 问题3：智能路由未优先推荐数字货币

**可能原因**:
- 商家配置为 `fiat_only`
- 路由逻辑未正确应用

**解决方法**:
- 确保 `merchantPaymentConfig` 为 `both` 或 `crypto_only`
- 检查后端日志中的路由决策

---

## 测试检查清单

- [ ] 场景1：智能路由优先推荐数字货币支付
- [ ] 场景2：支付聚合服务商（无Stripe账户）
- [ ] 场景3：价格显示单位（USDC）
- [ ] 场景4A：商家只收法币
- [ ] 场景4B：商家只收数字货币
- [ ] 场景4C：商家两种都接受
- [ ] 场景5：汇率转换
- [ ] API测试1：获取支付路由
- [ ] API测试2：处理支付（使用聚合服务商）
- [ ] 后端日志检查
- [ ] 前端界面检查

---

## 测试结果记录

**测试日期**: ___________

**测试人员**: ___________

**测试结果**:
- 通过: ___________
- 失败: ___________
- 问题: ___________

**备注**:
___________

