# 数据库修复 - 解决 Peer Authentication 错误

## 问题
`Peer authentication failed` - PostgreSQL 默认使用 Unix socket 连接，需要 peer 认证

## 解决方案：使用 TCP/IP 连接（强制密码认证）

### 方法1：使用 localhost 连接（推荐）

```bash
psql -h localhost -U paymind -d paymind -c "ALTER TABLE agent_sessions ALTER COLUMN \"userId\" DROP NOT NULL;"
```

如果提示输入密码，输入：`paymind_password`

### 方法2：使用 postgres 超级用户

```bash
psql -h localhost -U postgres -d paymind -c "ALTER TABLE agent_sessions ALTER COLUMN \"userId\" DROP NOT NULL;"
```

### 方法3：使用环境变量设置密码（避免交互式输入）

```bash
PGPASSWORD=paymind_password psql -h localhost -U paymind -d paymind -c "ALTER TABLE agent_sessions ALTER COLUMN \"userId\" DROP NOT NULL;"
```

### 方法4：交互式执行

```bash
# 1. 连接到数据库
PGPASSWORD=paymind_password psql -h localhost -U paymind -d paymind

# 2. 在 psql 提示符下执行
ALTER TABLE agent_sessions ALTER COLUMN "userId" DROP NOT NULL;

# 3. 验证修复
SELECT column_name, is_nullable 
FROM information_schema.columns 
WHERE table_name = 'agent_sessions' AND column_name = 'userId';

# 4. 退出
\q
```

## 如果还是不行：使用 sudo

```bash
sudo -u postgres psql -d paymind -c "ALTER TABLE agent_sessions ALTER COLUMN \"userId\" DROP NOT NULL;"
```

