# 佣金分配测试计划（简版）

## 一、测试准备条件

### 1.1 测试账户准备
- **商户账户** x1（用于创建商品和收款）
- **用户账户** x1（用于下单支付）
- **执行Agent账户** x1（execAgentId）
- **推荐Agent账户** x1（refAgentId）
- **推广Agent账户** x1（promoterId）
- **开发者账户** x1（仅DEV_TOOL类型需要）

### 1.2 测试商品准备
创建以下测试商品，每个商品金额设为 **100 USDT**（便于计算验证）：

| 商品ID | 商品名称 | 资产类型 | 订单类型 | 预期佣金率 |
|--------|---------|---------|---------|-----------|
| P001 | 实体商品-无Agent | PHYSICAL | physical | baseRate: 0.5%, poolRate: 2.5% |
| P002 | 实体商品-单执行Agent | PHYSICAL | physical | baseRate: 0.5%, poolRate: 2.5% |
| P003 | 实体商品-双Agent | PHYSICAL | physical | baseRate: 0.5%, poolRate: 2.5% |
| S001 | 服务类-无Agent | SERVICE | service | baseRate: 1%, poolRate: 4% |
| S002 | 服务类-单执行Agent | SERVICE | service | baseRate: 1%, poolRate: 4% |
| V001 | 虚拟商品-无Agent | VIRTUAL | virtual | baseRate: 1%, poolRate: 3% |
| N001 | NFT-无Agent | NFT_RWA | nft | baseRate: 1%, poolRate: 1.5% |
| D001 | 开发者工具-无Agent | DEV_TOOL | dev_tool | developer: 80%, agentrix: 5% |
| D002 | 开发者工具-双Agent | DEV_TOOL | dev_tool | developer: 80%, recommendation: 10%, execution: 5%, agentrix: 5% |

### 1.3 测试环境配置
- 确保后端服务运行正常
- 数据库连接正常
- 支付流程可正常完成
- 佣金计算服务可用

---

## 二、测试案例

### 场景1：实体商品（PHYSICAL）- 无Agent

**测试条件**：
- 商品：P001（100 USDT）
- 无 execAgentId
- 无 refAgentId
- 无 promoterId

**预期结果**：
```
订单金额：100 USDT
平台税：0 USDT（假设platformTaxRate=0）
净收入：100 USDT
通道费：0 USDT（假设）

Agentrix基础收入：100 × 0.5% = 0.5 USDT
佣金池：100 × 2.5% = 2.5 USDT（无Agent，归平台）
商户收入：100 - 0.5 - 2.5 = 97 USDT

最终分配：
- Agentrix平台：0.5 + 2.5 = 3 USDT
- 商户：97 USDT
- 执行Agent：0 USDT
- 推荐Agent：0 USDT
- 推广Agent：0 USDT
```

**验证点**：
- [ ] Commission表中Agentrix记录金额 = 3 USDT
- [ ] Commission表中商户记录金额 = 97 USDT
- [ ] 无Agent相关佣金记录
- [ ] 订单状态正确更新

---

### 场景2：实体商品（PHYSICAL）- 单执行Agent

**测试条件**：
- 商品：P002（100 USDT）
- execAgentId = "agent-exec-001"
- executorHasWallet = true
- 无 refAgentId
- 无 promoterId

**预期结果**：
```
订单金额：100 USDT
净收入：100 USDT

Agentrix基础收入：100 × 0.5% = 0.5 USDT
佣金池：100 × 2.5% = 2.5 USDT
商户收入：100 - 0.5 - 2.5 = 97 USDT

佣金池分配（execution-only场景）：
- 执行Agent：2.5 USDT（100%）
- 推荐Agent：0 USDT

最终分配：
- Agentrix平台：0.5 USDT
- 商户：97 USDT
- 执行Agent：2.5 USDT
- 推荐Agent：0 USDT
```

**验证点**：
- [ ] 执行Agent佣金 = 2.5 USDT
- [ ] Agentrix平台佣金 = 0.5 USDT
- [ ] 商户收入 = 97 USDT
- [ ] AgentType = EXECUTION

---

### 场景3：实体商品（PHYSICAL）- 双Agent（推荐+执行）

**测试条件**：
- 商品：P003（100 USDT）
- execAgentId = "agent-exec-001"
- refAgentId = "agent-ref-001"
- executorHasWallet = true
- 无 promoterId

**预期结果**：
```
订单金额：100 USDT
净收入：100 USDT

Agentrix基础收入：100 × 0.5% = 0.5 USDT
佣金池：100 × 2.5% = 2.5 USDT
商户收入：100 - 0.5 - 2.5 = 97 USDT

佣金池分配（dual场景，推荐30% + 执行70%）：
- 推荐Agent：2.5 × 30% = 0.75 USDT
- 执行Agent：2.5 × 70% = 1.75 USDT

最终分配：
- Agentrix平台：0.5 USDT
- 商户：97 USDT
- 推荐Agent：0.75 USDT
- 执行Agent：1.75 USDT
```

**验证点**：
- [ ] 推荐Agent佣金 = 0.75 USDT，AgentType = RECOMMENDATION
- [ ] 执行Agent佣金 = 1.75 USDT，AgentType = EXECUTION
- [ ] 总佣金 = 0.75 + 1.75 = 2.5 USDT（等于佣金池）
- [ ] Agentrix平台佣金 = 0.5 USDT

---

### 场景4：服务类（SERVICE）- 单执行Agent

**测试条件**：
- 商品：S002（100 USDT）
- execAgentId = "agent-exec-001"
- executorHasWallet = true
- 无 refAgentId
- 无 promoterId

**预期结果**：
```
订单金额：100 USDT
净收入：100 USDT

Agentrix基础收入：100 × 1% = 1 USDT
佣金池：100 × 4% = 4 USDT
商户收入：100 - 1 - 4 = 95 USDT

佣金池分配（execution-only）：
- 执行Agent：4 USDT（100%）

最终分配：
- Agentrix平台：1 USDT
- 商户：95 USDT
- 执行Agent：4 USDT
```

**验证点**：
- [ ] 服务类佣金率正确（baseRate=1%, poolRate=4%）
- [ ] 执行Agent佣金 = 4 USDT
- [ ] 结算时间 = T + 3天（服务类）

---

### 场景5：实体商品 - 执行Agent无钱包

**测试条件**：
- 商品：P002（100 USDT）
- execAgentId = "agent-exec-002"
- executorHasWallet = **false**
- 无 refAgentId

**预期结果**：
```
订单金额：100 USDT
净收入：100 USDT

Agentrix基础收入：100 × 0.5% = 0.5 USDT
佣金池：100 × 2.5% = 2.5 USDT

佣金池分配：
- 执行Agent：0 USDT（无钱包，转入返佣池）
- 返佣池：2.5 USDT

最终分配：
- Agentrix平台：0.5 + 2.5 = 3 USDT（包含返佣池）
- 商户：97 USDT
- 执行Agent：0 USDT
- 返佣池：2.5 USDT（payeeId = 'system_rebate_pool'）
```

**验证点**：
- [ ] 返佣池记录存在，金额 = 2.5 USDT
- [ ] 执行Agent佣金 = 0 USDT
- [ ] Agentrix最终收入 = 3 USDT

---

### 场景6：实体商品 - 有推广Agent（Promoter）

**测试条件**：
- 商品：P002（100 USDT）
- execAgentId = "agent-exec-001"
- promoterId = "agent-promoter-001"
- executorHasWallet = true

**预期结果**：
```
订单金额：100 USDT
净收入：100 USDT

Agentrix基础收入：100 × 0.5% = 0.5 USDT
佣金池：100 × 2.5% = 2.5 USDT

推广Agent分配（从Agentrix基础收入中分20%）：
- 推广Agent：0.5 × 20% = 0.1 USDT
- Agentrix最终收入：0.5 - 0.1 = 0.4 USDT

佣金池分配：
- 执行Agent：2.5 USDT

最终分配：
- Agentrix平台：0.4 USDT
- 推广Agent：0.1 USDT（AgentType = REFERRAL）
- 商户：97 USDT
- 执行Agent：2.5 USDT
```

**验证点**：
- [ ] 推广Agent佣金 = 0.1 USDT
- [ ] Agentrix最终收入 = 0.4 USDT
- [ ] breakdown.type = 'promoter'
- [ ] breakdown.share = 0.2

---

### 场景7：开发者工具（DEV_TOOL）- 无Agent

**测试条件**：
- 商品：D001（100 USDT）
- 无 execAgentId
- 无 refAgentId
- 无 promoterId

**预期结果**：
```
订单金额：100 USDT
净收入：100 USDT

开发者工具特殊分配：
- 开发者：100 × 80% = 80 USDT
- 推荐Agent：0 USDT（无Agent，归开发者）
- 执行Agent：0 USDT（无Agent，归开发者）
- Agentrix平台：100 × 5% = 5 USDT

最终开发者收入：80 + 0 + 0 = 80 USDT（所有Agent佣金归开发者）

最终分配：
- 开发者（商户）：80 USDT
- Agentrix平台：5 USDT
- 通道费：0 USDT（假设）
```

**验证点**：
- [ ] 开发者收入 = 80 USDT
- [ ] Agentrix平台 = 5 USDT
- [ ] 结算时间 = 即时（lockupDays = 'instant'）
- [ ] 订单状态自动变为DELIVERED

---

### 场景8：开发者工具（DEV_TOOL）- 双Agent

**测试条件**：
- 商品：D002（100 USDT）
- execAgentId = "agent-exec-001"
- refAgentId = "agent-ref-001"
- executorHasWallet = true

**预期结果**：
```
订单金额：100 USDT
净收入：100 USDT

开发者工具特殊分配：
- 开发者：100 × 80% = 80 USDT
- 推荐Agent：100 × 10% = 10 USDT
- 执行Agent：100 × 5% = 5 USDT
- Agentrix平台：100 × 5% = 5 USDT

最终分配：
- 开发者（商户）：80 USDT
- 推荐Agent：10 USDT
- 执行Agent：5 USDT
- Agentrix平台：5 USDT
```

**验证点**：
- [ ] 开发者收入 = 80 USDT
- [ ] 推荐Agent = 10 USDT
- [ ] 执行Agent = 5 USDT
- [ ] Agentrix平台 = 5 USDT
- [ ] 总计 = 100 USDT

---

### 场景9：虚拟商品（VIRTUAL）- 双Agent

**测试条件**：
- 商品：V001（100 USDT）
- execAgentId = "agent-exec-001"
- refAgentId = "agent-ref-001"
- executorHasWallet = true

**预期结果**：
```
订单金额：100 USDT
净收入：100 USDT

Agentrix基础收入：100 × 1% = 1 USDT
佣金池：100 × 3% = 3 USDT
商户收入：100 - 1 - 3 = 96 USDT

佣金池分配（dual场景）：
- 推荐Agent：3 × 30% = 0.9 USDT
- 执行Agent：3 × 70% = 2.1 USDT

最终分配：
- Agentrix平台：1 USDT
- 商户：96 USDT
- 推荐Agent：0.9 USDT
- 执行Agent：2.1 USDT
```

**验证点**：
- [ ] 虚拟商品佣金率正确（baseRate=1%, poolRate=3%）
- [ ] 结算时间 = T + 1天
- [ ] 订单状态自动变为DELIVERED

---

### 场景10：NFT（NFT_RWA）- 单执行Agent

**测试条件**：
- 商品：N001（100 USDT）
- execAgentId = "agent-exec-001"
- executorHasWallet = true

**预期结果**：
```
订单金额：100 USDT
净收入：100 USDT

Agentrix基础收入：100 × 1% = 1 USDT
佣金池：100 × 1.5% = 1.5 USDT
商户收入：100 - 1 - 1.5 = 97.5 USDT

佣金池分配：
- 执行Agent：1.5 USDT

最终分配：
- Agentrix平台：1 USDT
- 商户：97.5 USDT
- 执行Agent：1.5 USDT
```

**验证点**：
- [ ] NFT佣金率正确（baseRate=1%, poolRate=1.5%）
- [ ] 结算时间 = T + 1天
- [ ] 订单状态自动变为DELIVERED

---

## 三、测试执行步骤

### 3.1 前置准备
1. 创建测试账户（商户、用户、各Agent）
2. 创建测试商品（按上表）
3. 准备测试数据脚本

### 3.2 执行测试
对每个测试案例：
1. 创建订单（指定商品、Agent ID等）
2. 完成支付（金额100 USDT）
3. 等待佣金计算完成
4. 查询Commission表验证结果
5. 验证订单状态和结算时间

### 3.3 验证SQL查询
```sql
-- 查询某个支付的所有佣金记录
SELECT 
  payee_id,
  payee_type,
  agent_type,
  amount,
  breakdown,
  status,
  settlement_available_at
FROM commissions
WHERE payment_id = '支付ID'
ORDER BY amount DESC;

-- 验证总金额
SELECT 
  SUM(amount) as total_commission,
  COUNT(*) as record_count
FROM commissions
WHERE payment_id = '支付ID';
```

---

## 四、预期验证结果汇总

| 场景 | Agentrix | 商户 | 执行Agent | 推荐Agent | 推广Agent | 返佣池 | 总计 |
|------|---------|------|-----------|-----------|-----------|--------|------|
| 场景1 | 3.0 | 97.0 | 0 | 0 | 0 | 0 | 100 |
| 场景2 | 0.5 | 97.0 | 2.5 | 0 | 0 | 0 | 100 |
| 场景3 | 0.5 | 97.0 | 1.75 | 0.75 | 0 | 0 | 100 |
| 场景4 | 1.0 | 95.0 | 4.0 | 0 | 0 | 0 | 100 |
| 场景5 | 3.0 | 97.0 | 0 | 0 | 0 | 2.5 | 100 |
| 场景6 | 0.4 | 97.0 | 2.5 | 0 | 0.1 | 0 | 100 |
| 场景7 | 5.0 | 80.0 | 0 | 0 | 0 | 0 | 100 |
| 场景8 | 5.0 | 80.0 | 5.0 | 10.0 | 0 | 0 | 100 |
| 场景9 | 1.0 | 96.0 | 2.1 | 0.9 | 0 | 0 | 100 |
| 场景10 | 1.0 | 97.5 | 1.5 | 0 | 0 | 0 | 100 |

**验证规则**：每行总计必须等于100 USDT

---

## 五、测试检查清单

- [ ] 所有测试账户已创建
- [ ] 所有测试商品已创建
- [ ] 场景1-10全部执行完成
- [ ] 每个场景的Commission记录数量正确
- [ ] 每个场景的金额分配正确
- [ ] 每个场景的AgentType正确
- [ ] 每个场景的结算时间正确
- [ ] 订单状态更新正确
- [ ] 三层ID（User ID、Agent ID、Session ID）正确关联

---

**测试完成后，请记录实际结果与预期结果的差异，并标记问题。**

