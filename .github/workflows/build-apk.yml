name: Build & Release APK

on:
  push:
    branches: [main, master]
  workflow_dispatch:          # allow manual trigger from GitHub Actions tab

# Allow this workflow to create releases
permissions:
  contents: write

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      # ── 1. Checkout ──────────────────────────────────────────────────
      - name: Checkout code
        uses: actions/checkout@v4

      # ── 2. Node.js ───────────────────────────────────────────────────
      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # ── 3. Java 17 (required by Gradle / React Native) ───────────────
      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # ── 4. Android SDK ───────────────────────────────────────────────
      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: '11.0'
          accept-android-sdk-licenses: true

      - name: Install Android build tools
        run: |
          sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0" --sdk_root=$ANDROID_HOME

      # ── 5. JS dependencies ───────────────────────────────────────────
      - name: Install npm dependencies
        run: npm install

      # ── 6. Expo prebuild  (generates android/ native folder) ─────────
      - name: Expo prebuild
        run: npx expo prebuild --platform android --clean --no-install
        env:
          # Skip Expo login during prebuild — not needed for local builds
          CI: '1'

      # ── 7. Gradle build ──────────────────────────────────────────────
      - name: Make Gradle executable
        run: chmod +x android/gradlew

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ hashFiles('android/**/*.gradle*', 'android/gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: gradle-

      - name: Build Release APK
        working-directory: android
        run: ./gradlew assembleRelease --no-daemon --stacktrace
        env:
          GRADLE_OPTS: '-Dorg.gradle.jvmargs=-Xmx4g -Dorg.gradle.daemon=false'

      # ── 8. Rename APK with build number ──────────────────────────────
      - name: Rename APK
        run: |
          mkdir -p artifacts
          TAG="build-${{ github.run_number }}"
          cp android/app/build/outputs/apk/release/app-release-unsigned.apk \
             artifacts/ClawLink-${TAG}.apk
          echo "APK_PATH=artifacts/ClawLink-${TAG}.apk" >> $GITHUB_ENV
          echo "TAG=${TAG}" >> $GITHUB_ENV

      # ── 9. Upload as workflow artifact (always visible in Actions tab) ─
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: ClawLink-APK-build-${{ github.run_number }}
          path: ${{ env.APK_PATH }}
          retention-days: 30

      # ── 10. Create GitHub Release with direct download link ───────────
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          name: "ClawLink Build #${{ github.run_number }}"
          body: |
            ## ClawLink APK — Build #${{ github.run_number }}

            **Commit:** `${{ github.sha }}`
            **Branch:** `${{ github.ref_name }}`
            **Built at:** ${{ github.event.head_commit.timestamp }}

            ### Install
            1. Download `ClawLink-build-${{ github.run_number }}.apk` below
            2. On your Android device: Settings → Security → enable **Install from unknown sources**
            3. Open the downloaded APK and install

            > APK is unsigned (debug-signed for sideloading). Use EAS Build `production` profile for Play Store release.
          files: ${{ env.APK_PATH }}
          draft: false
          prerelease: false
