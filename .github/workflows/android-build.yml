name: Android Build
on:
  workflow_dispatch:
# Disabled auto-push trigger — use "Build → Test → Release APK" instead

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: |
          npm install --legacy-peer-deps

      # expo-image@2.0.x has a Kotlin 2.x type-safety compile error in GlideUrlWrapperLoader.kt
      # (ResponseBody? vs ResponseBody). Patch is idempotent.
      - name: Patch expo-image for Kotlin 2.x compatibility
        run: |
          python3 - << 'PYEOF'
          import re, os, sys
          filepath = 'node_modules/expo-image/android/src/main/java/expo/modules/image/okhttp/GlideUrlWrapperLoader.kt'
          if not os.path.exists(filepath):
              print(f"[skip] {filepath} not found — expo-image may have been updated")
              sys.exit(0)
          with open(filepath, 'r') as f:
              content = f.read()
          fixed = re.sub(r'originalResponse\.body(?!\!)', 'originalResponse.body!!', content)
          if fixed == content:
              print(f"[ok] Already patched or no match: {filepath}")
          else:
              with open(filepath, 'w') as f:
                  f.write(fixed)
              print(f"[patched] Applied expo-image Kotlin 2.x null-safety fix")
          PYEOF

      - name: Set up NDK
        run: |
          echo "y" | sudo ${ANDROID_HOME}/cmdline-tools/latest/bin/sdkmanager "ndk;27.0.12077973"

      - name: Build Android Release
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleRelease --stacktrace

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: android/app/build/outputs/apk/release/app-release.apk
