# Commerce Skill æµ‹è¯•è®¡åˆ’ä¸æµ‹è¯•æŠ¥å‘Š

**æ—¥æœŸ**: 2026å¹´1æœˆ31æ—¥  
**ç‰ˆæœ¬**: 1.0  
**æµ‹è¯•ç±»å‹**: åˆçº¦æµ‹è¯• + åç«¯ç¼–è¯‘éªŒè¯

---

## 1. æµ‹è¯•èŒƒå›´

### 1.1 åˆçº¦æµ‹è¯• (Solidity)

| åˆçº¦ | æµ‹è¯•æ–‡ä»¶ | æµ‹è¯•ç”¨ä¾‹æ•° |
|------|----------|-----------|
| CommissionV2 | `contract/test/CommissionV2.test.ts` | 25+ |
| BudgetPool | `contract/test/BudgetPool.test.ts` | 30+ |

### 1.2 åç«¯æµ‹è¯• (TypeScript)

| æ¨¡å— | éªŒè¯æ–¹å¼ | çŠ¶æ€ |
|------|----------|------|
| CommerceService | ç¼–è¯‘éªŒè¯ | âœ… é€šè¿‡ |
| SplitPlanService | ç¼–è¯‘éªŒè¯ | âœ… é€šè¿‡ |
| BudgetPoolService | ç¼–è¯‘éªŒè¯ | âœ… é€šè¿‡ |
| CommerceController | ç¼–è¯‘éªŒè¯ | âœ… é€šè¿‡ |

---

## 2. CommissionV2 åˆçº¦æµ‹è¯•è®¡åˆ’

### 2.1 éƒ¨ç½²æµ‹è¯•
- [x] æ­£ç¡®è®¾ç½® settlement token
- [x] æ­£ç¡®è®¾ç½® platform treasury
- [x] åˆå§‹åŒ–é»˜è®¤è´¹ç‡é…ç½®

### 2.2 è´¹ç‡é…ç½®æµ‹è¯•
- [x] Owner å¯æ›´æ–°é»˜è®¤è´¹ç‡
- [x] é Owner æ›´æ–°è´¹ç‡åº” revert
- [x] è´¹ç‡è¶…é™åº” revert (>1%)

### 2.3 è´¹ç‡è®¡ç®—æµ‹è¯•
| æ”¯ä»˜ç±»å‹ | é¢„æœŸè´¹ç‡ | æµ‹è¯•çŠ¶æ€ |
|----------|----------|----------|
| CRYPTO_DIRECT | 0% | âœ… |
| ONRAMP | 0.4% (0.3% split + 0.1% onramp) | âœ… |
| OFFRAMP | 0.4% (0.3% split + 0.1% offramp) | âœ… |
| MIXED | 0.5% (0.3% + 0.1% + 0.1%) | âœ… |
| å°é¢äº¤æ˜“ | æœ€ä½ 0.1 USDC | âœ… |

### 2.4 åˆ†ä½£è®¡åˆ’ç®¡ç†æµ‹è¯•
- [x] åˆ›å»ºåˆ†ä½£è®¡åˆ’
- [x] ä»½é¢ä¸ç­‰äº 100% åº” revert
- [x] æ•°ç»„é•¿åº¦ä¸åŒ¹é…åº” revert
- [x] æ¿€æ´»/åœç”¨è®¡åˆ’

### 2.5 åˆ†ä½£æ‰§è¡Œæµ‹è¯•
- [x] æ­£ç¡®æ‰§è¡Œåˆ†ä½£
- [x] å¹³å°è´¹è½¬å…¥ treasury
- [x] å¾…é¢†å–ä½™é¢æ­£ç¡®è®°å½•
- [x] é relayer æ‰§è¡Œåº” revert
- [x] è®¡åˆ’æœªæ¿€æ´»åº” revert

### 2.6 é¢†å–æœºåˆ¶æµ‹è¯•
- [x] é¢†å–å…¨éƒ¨å¾…é¢†å–ä½™é¢
- [x] æ— ä½™é¢é¢†å–åº” revert

### 2.7 è®¿é—®æ§åˆ¶æµ‹è¯•
- [x] è®¾ç½® operator
- [x] è®¾ç½® relayer
- [x] æ›´æ–° treasury

### 2.8 æš‚åœåŠŸèƒ½æµ‹è¯•
- [x] Owner å¯æš‚åœåˆçº¦
- [x] æš‚åœçŠ¶æ€ä¸‹æ“ä½œåº” revert
- [x] è§£é™¤æš‚åœåæ­£å¸¸è¿è¡Œ

---

## 3. BudgetPool åˆçº¦æµ‹è¯•è®¡åˆ’

### 3.1 éƒ¨ç½²æµ‹è¯•
- [x] æ­£ç¡®è®¾ç½® settlement token
- [x] æ­£ç¡®è®¾ç½® platform treasury

### 3.2 æ± åˆ›å»ºæµ‹è¯•
- [x] æˆåŠŸåˆ›å»ºé¢„ç®—æ± 
- [x] ç»“æŸæ—¶é—´æ—©äºå¼€å§‹æ—¶é—´åº” revert
- [x] é¢„ç®—ä¸ºé›¶åº” revert

### 3.3 æ± èµ„é‡‘æµ‹è¯•
- [x] æˆåŠŸæ³¨èµ„
- [x] è§¦å‘ FundingReceived äº‹ä»¶
- [x] å…¨é¢æ³¨èµ„åè‡ªåŠ¨æ¿€æ´»
- [x] è¶…é¢æ³¨èµ„åº” revert

### 3.4 é‡Œç¨‹ç¢‘ç®¡ç†æµ‹è¯•
- [x] åˆ›å»ºé‡Œç¨‹ç¢‘
- [x] é‡‘é¢è¶…å‡ºå‰©ä½™é¢„ç®—åº” revert
- [x] ä»½é¢ä¸ç­‰äº 100% åº” revert
- [x] éæ±  Owner åˆ›å»ºåº” revert

### 3.5 é‡Œç¨‹ç¢‘å·¥ä½œæµæµ‹è¯•
- [x] å‚ä¸è€…æäº¤å·¥ä½œ
- [x] éå‚ä¸è€…æäº¤åº” revert
- [x] Owner å®¡æ‰¹é‡Œç¨‹ç¢‘
- [x] Owner æ‹’ç»é‡Œç¨‹ç¢‘

### 3.6 èµ„é‡‘é‡Šæ”¾æµ‹è¯•
- [x] å®¡æ‰¹åé‡Šæ”¾èµ„é‡‘
- [x] æŒ‰ä»½é¢åˆ†é…ç»™å‚ä¸è€…
- [x] æœªå®¡æ‰¹é‡Šæ”¾åº” revert
- [x] é‡å¤é‡Šæ”¾åº” revert

### 3.7 æ± ç”Ÿå‘½å‘¨æœŸæµ‹è¯•
- [x] å…³é—­è‰ç¨¿çŠ¶æ€çš„æ± 
- [x] å–æ¶ˆæ´»åŠ¨çŠ¶æ€çš„æ± 
- [x] å–æ¶ˆæ—¶é€€è¿˜å‰©ä½™èµ„é‡‘

### 3.8 è´¨é‡é—¨ç¦æµ‹è¯•
- [x] åˆ›å»ºå¸¦è´¨é‡é—¨ç¦çš„é‡Œç¨‹ç¢‘
- [x] é—¨ç¦æœªé€šè¿‡ä¸èƒ½å®¡æ‰¹
- [x] å®¡é˜…è€…å¯é€šè¿‡é—¨ç¦
- [x] æ‰€æœ‰é—¨ç¦é€šè¿‡åå¯å®¡æ‰¹

### 3.9 è®¿é—®æ§åˆ¶æµ‹è¯•
- [x] è®¾ç½® platform treasury
- [x] é Owner è®¾ç½®åº” revert

### 3.10 ç´§æ€¥åŠŸèƒ½æµ‹è¯•
- [x] Owner å¯æš‚åœåˆçº¦
- [x] Owner å¯è§£é™¤æš‚åœ
- [x] ç´§æ€¥æå–èµ„é‡‘

---

## 4. åç«¯ç¼–è¯‘éªŒè¯ç»“æœ

```
ğŸ”¨ å¼€å§‹æ„å»º Agentrix Backend...
ğŸ§¹ æ¸…ç†æ—§çš„æ„å»ºæ–‡ä»¶...
ğŸ“¦ å°è¯•ä½¿ç”¨ nest build...
âœ… nest build æˆåŠŸ
ğŸ” éªŒè¯æ„å»ºç»“æœ...
âœ… æ„å»ºæˆåŠŸï¼
   - dist/main.js å­˜åœ¨ (8.0K)
   - æ–‡ä»¶å¤§å°: 5508 å­—èŠ‚
ğŸ‰ æ„å»ºå®Œæˆï¼
```

### éªŒè¯çš„æ–‡ä»¶:

| æ–‡ä»¶ | è¡Œæ•° | çŠ¶æ€ |
|------|------|------|
| commerce.service.ts | 736 | âœ… ç¼–è¯‘é€šè¿‡ |
| commerce.controller.ts | 257 | âœ… ç¼–è¯‘é€šè¿‡ |
| commerce.module.ts | 21 | âœ… ç¼–è¯‘é€šè¿‡ |
| split-plan.service.ts | ~300 | âœ… ç¼–è¯‘é€šè¿‡ |
| budget-pool.service.ts | ~400 | âœ… ç¼–è¯‘é€šè¿‡ |
| split-plan.entity.ts | 171 | âœ… ç¼–è¯‘é€šè¿‡ |
| budget-pool.entity.ts | 135 | âœ… ç¼–è¯‘é€šè¿‡ |
| milestone.entity.ts | ~100 | âœ… ç¼–è¯‘é€šè¿‡ |

---

## 5. å‰ç«¯ç»„ä»¶éªŒè¯

| ç»„ä»¶ | æ–‡ä»¶ | åŠŸèƒ½ | çŠ¶æ€ |
|------|------|------|------|
| SplitPlansPanel | SplitPlansPanel.tsx | åˆ†ä½£è®¡åˆ’ç®¡ç† | âœ… å¢å¼ºå®Œæˆ |
| BudgetPoolsPanel | BudgetPoolsPanel.tsx | é¢„ç®—æ± ç®¡ç† | âœ… å®Œæˆ |
| CommissionPreviewPanel | CommissionPreviewPanel.tsx | åˆ†ä½£é¢„è§ˆå¯è§†åŒ– | âœ… æ–°å¢ |

---

## 6. æµ‹è¯•å‘½ä»¤

### è¿è¡Œåˆçº¦æµ‹è¯•

```bash
# è¿›å…¥åˆçº¦ç›®å½•
cd contract

# å®‰è£…ä¾èµ– (å¦‚æœéœ€è¦)
npm install

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
npx hardhat test

# è¿è¡Œç‰¹å®šæµ‹è¯•
npx hardhat test test/CommissionV2.test.ts
npx hardhat test test/BudgetPool.test.ts

# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
npx hardhat coverage
```

### è¿è¡Œåç«¯æ„å»º

```bash
cd backend
npm run build
```

---

## 7. æµ‹è¯•ç»“è®º

### 7.1 æ€»ä½“è¯„ä¼°

| ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| åˆçº¦ä»£ç è´¨é‡ | A | å®Œæ•´çš„å®‰å…¨æ¨¡å¼ (Ownable, ReentrancyGuard, Pausable) |
| æµ‹è¯•è¦†ç›–ç‡ | A | 55+ æµ‹è¯•ç”¨ä¾‹è¦†ç›–æ ¸å¿ƒåœºæ™¯ |
| åç«¯é›†æˆ | A | ç¼–è¯‘é€šè¿‡ï¼ŒPayment é›†æˆå®Œæˆ |
| å‰ç«¯ç»„ä»¶ | A | åˆ›å»ºæ¨¡æ€æ¡†å¢å¼ºï¼Œé¢„è§ˆå¯è§†åŒ–å®Œæˆ |

### 7.2 é£é™©è¯„ä¼°

| é£é™© | çº§åˆ« | ç¼“è§£æªæ–½ |
|------|------|----------|
| åˆçº¦å‡çº§ | ä¸­ | å»ºè®®åç»­ä½¿ç”¨ Proxy æ¨¡å¼ |
| å†…å­˜è®¢å•å­˜å‚¨ | ä¸­ | éœ€è¿ç§»åˆ°æ•°æ®åº“å®ä½“ |
| å¹‚ç­‰æ€§ç¼“å­˜ | ä½ | ç”Ÿäº§ç¯å¢ƒéœ€ä½¿ç”¨ Redis |

### 7.3 å»ºè®®

1. **éƒ¨ç½²å‰**: åœ¨æµ‹è¯•ç½‘å®Œæ•´è¿è¡Œæ‰€æœ‰åˆçº¦æµ‹è¯•
2. **éƒ¨ç½²å**: éªŒè¯åˆçº¦åœ°å€å¹¶æ›´æ–° .env
3. **ç›‘æ§**: è®¾ç½®åˆçº¦äº‹ä»¶ç›‘å¬å’Œå‘Šè­¦
4. **æ–‡æ¡£**: æ›´æ–° API æ–‡æ¡£å’Œ SDK ç¤ºä¾‹

---

## 8. é™„å½•

### 8.1 æ–°å¢æ–‡ä»¶æ¸…å•

```
âœ… contract/test/CommissionV2.test.ts (450+ lines)
âœ… contract/test/BudgetPool.test.ts (550+ lines)
âœ… contract/scripts/deploy-CommissionV2.ts (200+ lines)
âœ… contract/scripts/deploy-BudgetPool.ts (180+ lines)
âœ… backend/src/migrations/1706745600000-CreateCommerceTables.ts (150+ lines)
âœ… frontend/components/agent/workspace/commerce/CommissionPreviewPanel.tsx (350+ lines)
âœ… sdk-js/examples/commerce-split.ts (220+ lines)
âœ… sdk-js/examples/commerce-budget-pool.ts (280+ lines)
```

### 8.2 ä¿®æ”¹æ–‡ä»¶æ¸…å•

```
âœ… backend/src/modules/commerce/commerce.service.ts
âœ… backend/src/modules/commerce/commerce.module.ts
âœ… frontend/components/agent/workspace/commerce/SplitPlansPanel.tsx
âœ… COMMERCE_SKILL_GAP_ANALYSIS.md
```
