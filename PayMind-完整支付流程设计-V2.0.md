# PayMind 完整支付流程设计 V2.0

## 📋 文档目的

基于实际业务需求，设计完整的支付流程，包括：
1. KYC需求场景确认（修正版）
2. 钱包连接流程
3. Provider支付方案（MoonPay等实现Apple Pay/Google Pay）
4. 完整支付流程串联

---

## 🔐 KYC需求场景确认（修正版）

### ✅ 不需要KYC的场景

1. **数字货币直接支付**
   - QuickPay（包括X402,agent支付
   - WalletConnect直接支付
   - **说明**：用户直接使用自己的数字货币钱包支付，无需KYC

2. **法币直接支付（不转换数字货币）**
   - Stripe支付（如果已申请资质）
   - 其他法币支付方式（不涉及数字货币转换）
   - **说明**：纯法币支付，不涉及数字货币转换。用户在注册的时候已做过KYC，不需要额外做。

### ⚠️ 需要KYC的场景

1. **法币转数字货币（通过Provider）**
   - 使用MoonPay、Alchemy Pay等Provider进行法币转数字货币
   - **KYC要求**：Provider要求（通常为基础KYC）
   - **触发条件**：商户只收数字货币，用户使用法币支付

2. **使用Provider实现Apple Pay/Google Pay**
   - 通过MoonPay等Provider实现Apple Pay/Google Pay支付
   - **KYC要求**：Provider要求（通常为基础KYC）
   - **触发条件**：Stripe资质未申请下来时，使用Provider作为替代方案

3. **跨境大额支付（合规要求）**
   - 超过一定金额的跨境支付
   - **KYC要求**：根据金额和地区要求不同等级的KYC

---

## 🔗 钱包连接流程设计

### 1. 触发场景

当用户选择以下支付方式时，需要先连接钱包：
- **X402稳定币支付**
- **WalletConnect等钱包支付**
- **其他需要钱包签名的支付方式**

### 2. 钱包连接界面设计

**布局结构**：
```
┌─────────────────────────────────────┐
│  [返回]  连接钱包            [关闭]  │
├─────────────────────────────────────┤
│                                     │
│  提示卡片                           │
│  ┌─────────────────────────────┐   │
│  │ 🔗 需要连接钱包             │   │
│  │                             │   │
│  │ 该支付方式需要连接数字钱包   │   │
│  │ 以完成支付签名              │   │
│  └─────────────────────────────┘   │
│                                     │
│  支持的钱包类型                     │
│  ┌─────────────────────────────┐   │
│  │ [MetaMask]                  │   │
│  │ [WalletConnect]             │   │
│  │ [Coinbase Wallet]          │   │
│  │ [Trust Wallet]             │   │
│  │ [其他钱包]                  │   │
│  └─────────────────────────────┘   │
│                                     │
│  连接步骤                           │
│  ┌─────────────────────────────┐   │
│  │ 1. 点击钱包图标            │   │
│  │ 2. 在钱包App中确认连接     │   │
│  │ 3. 授权PayMind访问钱包     │   │
│  └─────────────────────────────┘   │
│                                     │
│  [取消]                             │
│                                     │
└─────────────────────────────────────┘
```

### 3. 钱包连接状态检查

在支付流程中，自动检查钱包连接状态：
- **已连接**：显示钱包地址和余额，继续支付流程
- **未连接**：显示钱包连接界面，引导用户连接钱包

---

## 💳 Provider支付方案设计

### 1. 方案说明

**背景**：Stripe资质未申请下来时，使用Provider（MoonPay、Alchemy Pay等）来实现Apple Pay/Google Pay支付。

**实现方式**：
- Provider内部使用Stripe等通道处理法币支付
- Provider处理合规和KYC
- 支持Apple Pay/Google Pay等支付方式

### 2. Provider选择逻辑

**支持的Provider**：
- **MoonPay**：全球覆盖，支持多种支付方式
- **Alchemy Pay**：亚洲市场，支持多种支付方式
- **Ramp**：欧洲/美国，支持Apple Pay/Google Pay
- **Transak**：全球覆盖，支持多种支付方式

**选择因素**：
1. 用户所在地区
2. 支付金额
3. 手续费率
4. 支持的支付方式（Apple Pay/Google Pay）

### 3. Provider支付流程

```
用户选择Apple Pay/Google Pay
    ↓
检查Stripe资质状态
    ↓
Stripe已申请？
    ↓ 否
选择最优Provider（MoonPay等）
    ↓
检查用户KYC状态
    ↓
KYC已完成？
    ↓ 否
显示KYC认证界面
    ↓
用户完成KYC认证
    ↓
跳转到Provider支付页面
    ↓
用户在Provider页面完成支付
    ↓
Provider回调通知支付结果
    ↓
更新支付状态
```

### 4. Provider支付界面设计

**布局结构**：
```
┌─────────────────────────────────────┐
│  [返回]  支付处理            [关闭]  │
├─────────────────────────────────────┤
│                                     │
│  订单信息                           │
│  ┌─────────────────────────────┐   │
│  │ 商品：AI 智能音箱套装        │   │
│  │ 金额：¥1,299.00             │   │
│  └─────────────────────────────┘   │
│                                     │
│  支付方式                           │
│  ┌─────────────────────────────┐   │
│  │ 🍎 Apple Pay                │   │
│  │ 通过 MoonPay 处理           │   │
│  └─────────────────────────────┘   │
│                                     │
│  Provider信息                       │
│  ┌─────────────────────────────┐   │
│  │ 服务商：MoonPay             │   │
│  │ 手续费：2.5%                │   │
│  │ 预计到账：¥1,266.53         │   │
│  └─────────────────────────────┘   │
│                                     │
│  [跳转到Provider支付页面]           │
│                                     │
└─────────────────────────────────────┘
```

---

## 🔄 完整支付流程串联

### 流程总览

```
用户触发支付
    ↓
步骤1：支付入口（显示订单信息）
    ↓
步骤2：智能路由推荐（根据商户配置、用户状态推荐）
    ↓
步骤3：用户状态检查
    ├─ 钱包连接检查（数字货币支付需要）
    ├─ KYC状态检查（Provider支付需要）
    └─ 支付方式可用性检查
    ↓
步骤4：支付方式选择/确认
    ├─ 法币支付（Stripe或Provider）
    ├─ 数字货币支付（X402、WalletConnect）
    └─ 法币转数字货币（Provider）
    ↓
步骤5：支付处理
    ↓
步骤6：支付结果
```

### 详细流程设计

#### 步骤1：支付入口

**界面内容**：
- 订单信息（商品、金额、商户）
- 订单金额（多货币显示）
- 智能路由加载中提示

**逻辑**：
- 加载订单信息
- 调用智能路由API获取推荐支付方式
- 检查用户状态（钱包连接、KYC状态）

#### 步骤2：智能路由推荐

**推荐逻辑**：
1. **检查商户配置**
   - `fiat_only`：根据用户kyc状况，推荐provider法币转数字货币支付
   - `crypto_only`：只推荐数字货币支付方式，符合条件的引导quick pay设置
   - `both`：优先推荐数字货币，符合条件的引导quick pay设置

2. **检查用户状态**
   - 钱包连接状态（数字货币支付需要）
   - KYC状态（Provider支付需要）
   - 支付历史偏好

3. **计算推荐得分**
   - 成本（手续费）
   - 速度（到账时间）
   - 成功率
   - 用户体验

**推荐界面**：
```
┌─────────────────────────────────────┐
│  推荐支付方式                       │
│  ┌─────────────────────────────┐   │
│  │ ⚡ QuickPay (数字货币)       │   │
│  │                             │   │
│  │ 即时 · 建议指数 98          │   │
│  │ 预计费用：$14.90            │   │
│  │                             │   │
│  │ ✅ 钱包已连接               │   │
│  │ ✅ 无需KYC                  │   │
│  │                             │   │
│  │  [立即支付]  [选择其他方式] │   │
│  └─────────────────────────────┘   │
└─────────────────────────────────────┘
```

#### 步骤3：用户状态检查

**检查项**：

1. **钱包连接检查**（数字货币支付）
   - 如果推荐X402或WalletConnect
   - 检查钱包是否已连接
   - 如果未连接，显示钱包连接界面

2. **KYC状态检查**（Provider支付）
   - 如果推荐Provider支付（Apple Pay/Google Pay）
   - 检查KYC是否已完成
   - 如果未完成，显示KYC认证界面

3. **支付方式可用性检查**
   - 检查推荐支付方式是否可用
   - 如果不可用，推荐备选方案

**钱包连接界面**（如果需要）：
```
┌─────────────────────────────────────┐
│  [返回]  连接钱包            [关闭]  │
├─────────────────────────────────────┤
│                                     │
│  提示：该支付方式需要连接钱包       │
│                                     │
│  [连接钱包]  [选择其他方式]         │
│                                     │
└─────────────────────────────────────┘
```

**KYC认证界面**（如果需要）：
```
┌─────────────────────────────────────┐
│  [返回]  KYC认证             [关闭]  │
├─────────────────────────────────────┤
│                                     │
│  提示：该支付方式需要KYC认证        │
│                                     │
│  [开始KYC认证]  [选择其他方式]      │
│                                     │
└─────────────────────────────────────┘
```

#### 步骤4：支付方式选择/确认

**法币支付（Stripe或Provider）**：
- 如果Stripe已申请：推荐Provider（MoonPay等）
- 如果Stripe未申请：直接使用Provider（MoonPay等）
- 显示支付方式（Apple Pay/Google Pay/信用卡）
- 显示手续费和预计到账金额

**数字货币支付（X402、WalletConnect）**：
- 显示钱包地址和余额
- 显示Gas费用估算
- 确认支付金额

**法币转数字货币（Provider）**：
- 显示转换汇率
- 显示转换费用
- 显示转换后的数字货币金额
- 确认转换并支付

#### 步骤5：支付处理

**处理状态**：
- 支付中（显示进度）
- 等待确认（钱包签名）
- 处理中（Provider处理）
- 完成/失败

#### 步骤6：支付结果

**成功**：
- 显示支付成功信息
- 显示订单号
- 显示交易哈希（数字货币支付）
- 提供后续操作（查看订单、返回商户）

**失败**：
- 显示失败原因
- 提供重试选项
- 提供选择其他支付方式选项

---

## 📊 支付方式与KYC/钱包需求对照表

| 支付方式 | KYC需求 | 钱包需求 | Provider需求 | 说明 |
|---------|---------|---------|-------------|------|
| **Stripe** | ❌ 不需要 | ❌ 不需要 | ❌ 不需要 | 需要Stripe资质 |
| **QuickPay（数字货币）** | ❌ 不需要 | ✅ 需要 | ❌ 不需要 | 直接使用数字货币 |
| **X402稳定币** | ❌ 不需要 | ✅ 需要 | ❌ 不需要 | 直接使用数字货币 |
| **WalletConnect** | ❌ 不需要 | ✅ 需要 | ❌ 不需要 | 直接使用数字货币 |
| **Apple Pay（Provider）** | ✅ 需要 | ❌ 不需要 | ✅ 需要 | 通过MoonPay等 |
| **Google Pay（Provider）** | ✅ 需要 | ❌ 不需要 | ✅ 需要 | 通过MoonPay等 |
| **法币转数字货币（Provider）** | ✅ 需要 | ✅ 需要 | ✅ 需要 | 通过MoonPay等转换 |

---

## 🎯 智能路由推荐逻辑（更新版）

### 推荐优先级

1. **数字货币支付**（如果用户钱包已连接）
   - QuickPay（，通过X402数字货币，agent间支付，已经设置quickpay）
   - WalletConnect等数字货币直接支付
   - **优势**：无需KYC，成本低，速度快


2. **Provider支付**，**法币转数字货币**
   - MoonPay（Apple Pay/Google Pay）
   - Alchemy Pay（Apple Pay/Google Pay）
   - **优势**：支持Apple Pay/Google Pay，但需要KYC

3. **stripe 支付**   


---

## 🔄 完整支付流程示例

### 示例1：数字货币支付（无需KYC）

```
用户选择支付
    ↓
智能路由推荐：X402稳定币支付，数字货币支付
    ↓
检查钱包连接状态
    ↓
钱包已连接？
    ↓ 是
显示支付确认界面
    ↓
用户确认支付
    ↓
钱包签名
    ↓
支付处理
    ↓
支付成功
```

### 示例2：Provider支付（需要KYC）

```
用户选择支付
    ↓
智能路由推荐：Apple Pay（通过MoonPay）
    ↓
检查KYC状态
    ↓
KYC已完成？
    ↓ 是
显示Provider支付界面（不同provider统一Paymind UI）
    ↓
跳转到MoonPay支付页面（不同provider统一Paymind UI）
    ↓
用户在MoonPay完成支付（不同provider统一Paymind UI）
    ↓
MoonPay回调通知（不同provider统一Paymind UI）
    ↓
支付成功
```
### 示例3：法币转数字货币（需要KYC和钱包）

```
用户选择支付
    ↓
商户只收数字货币
    ↓
检查钱包连接状态
    ↓
钱包已连接？
    ↓ 是
检查KYC状态
    ↓
KYC已完成？
    ↓ 是
显示法币转数字货币界面
    ↓
显示转换汇率和费用
    ↓
用户确认转换
    ↓
通过Provider转换
    ↓
转换完成，使用数字货币支付
    ↓
支付成功
```

---

## 📝 实现要点

### 1. 状态管理

需要管理以下状态：
- 钱包连接状态
- KYC状态
- 商户配置
- 用户偏好

### 2. 流程控制

- 根据用户状态自动跳转到相应界面
- 提供清晰的错误提示和引导
- 支持流程中断和恢复

### 3. 用户体验

- 尽量减少用户操作步骤
- 提供清晰的状态反馈
- 支持快速支付（QuickPay）

---



