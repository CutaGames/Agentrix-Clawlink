# PayMind V3.0 统一支付引擎时序图

## 概述

PayMind统一支付引擎是一个智能、多通道的支付处理系统，支持法币支付、数字货币支付、X402协议、Escrow托管、Agent代付等多种支付方式，并通过智能路由自动选择最优支付通道。

---

## 核心组件

1. **智能路由服务 (SmartRouterService)**
   - 根据支付场景自动选择最优支付通道
   - 考虑因素：金额、货币、KYC状态、跨境、商家配置等

2. **支付服务 (PaymentService)**
   - 统一支付入口，处理所有支付请求
   - 自动检测是否需要Escrow托管
   - 计算并记录分佣

3. **X402服务 (X402Service)**
   - 处理X402协议支付（压缩交易，节省Gas）
   - 创建支付会话，等待链上确认

4. **Escrow服务 (EscrowService)**
   - 托管交易管理
   - 根据订单类型自动结算

5. **分佣计算服务 (CommissionCalculatorService)**
   - 计算交易分成（Agent、PayMind）
   - 根据订单类型应用不同分成比例

6. **推广服务 (ReferralService)**
   - 记录推广分成（长期0.5%）
   - 管理推广关系

---

## 完整支付流程时序图

### 场景1：数字货币支付（X402协议）

```
用户                前端UI              后端API              智能路由              X402服务              链上
 │                   │                   │                    │                    │                    │
 │──选择数字货币支付──>│                   │                    │                    │                    │
 │                   │                   │                    │                    │                    │
 │                   │──processPayment───>│                    │                    │                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │──selectBestChannel─>│                    │                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │  判断条件：         │                    │                    │
 │                   │                   │  - 金额 >= 阈值    │                    │                    │
 │                   │                   │  - 有X402授权      │                    │                    │
 │                   │                   │  - 链上支付         │                    │                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │<─推荐X402──────────│                    │                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │──createPaymentSession>│                  │                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │                    │──压缩交易数据──────>│                    │
 │                   │                   │                    │                    │──创建会话─────────>│
 │                   │                   │                    │                    │<─返回sessionId─────│
 │                   │                   │                    │<─返回X402Session───│                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │──计算分佣──────────>│                    │                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │  分成计算：         │                    │                    │
 │                   │                   │  - Agent: 2-3%     │                    │                    │
 │                   │                   │  - PayMind: 0.5-1% │                    │                    │
 │                   │                   │  - 推广分成: 0.5%   │                    │                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │<─分佣记录完成───────│                    │                    │
 │                   │                   │                    │                    │                    │
 │                   │<─返回支付会话─────│                    │                    │                    │
 │                   │                   │                    │                    │                    │
 │                   │──显示X402支付UI──>│                    │                    │                    │
 │<─显示支付确认──────│                   │                    │                    │                    │
 │                   │                   │                    │                    │                    │
 │──确认支付─────────>│                   │                    │                    │                    │
 │                   │──提交到链上───────>│                    │                    │                    │
 │                   │                   │                    │                    │──执行交易─────────>│
 │                   │                   │                    │                    │                    │──[链上确认]
 │                   │                   │                    │                    │<─交易哈希──────────│
 │                   │                   │                    │                    │                    │
 │                   │                   │──更新支付状态──────>│                    │                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │  状态更新：         │                    │                    │
 │                   │                   │  - status: COMPLETED│                    │                    │
 │                   │                   │  - transactionHash  │                    │                    │
 │                   │                   │                    │                    │                    │
 │                   │<─支付成功─────────│                    │                    │                    │
 │<─显示支付成功──────│                   │                    │                    │                    │
```

### 场景2：法币支付（Stripe）

```
用户                前端UI              Stripe服务            后端API              智能路由              分佣服务
 │                   │                   │                    │                    │                    │
 │──选择法币支付─────>│                   │                    │                    │                    │
 │                   │                   │                    │                    │                    │
 │                   │──createPaymentIntent>│                  │                    │                    │
 │                   │                   │                    │──createPaymentIntent>│                  │
 │                   │                   │                    │                    │                    │
 │                   │                   │                    │──创建支付记录──────>│                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │                    │──调用Stripe API───>│                    │
 │                   │                   │<─返回clientSecret───│                    │                    │
 │                   │                   │                    │                    │                    │
 │                   │<─返回clientSecret─│                    │                    │                    │
 │                   │                   │                    │                    │                    │
 │                   │──显示Stripe支付UI─>│                    │                    │                    │
 │<─显示支付表单──────│                   │                    │                    │                    │
 │                   │                   │                    │                    │                    │
 │──填写支付信息─────>│                   │                    │                    │                    │
 │                   │                   │                    │                    │                    │
 │──确认支付─────────>│                   │                    │                    │                    │
 │                   │──提交到Stripe─────>│                    │                    │                    │
 │                   │                   │──处理支付─────────>│                    │                    │
 │                   │                   │                    │──processPayment───>│                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │                    │──selectBestChannel─>│                    │
 │                   │                   │                    │<─推荐Stripe────────│                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │                    │──confirmPayment───>│                    │
 │                   │                   │<─支付成功──────────│                    │                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │                    │──计算分佣──────────>│                    │
 │                   │                   │                    │                    │──calculateCommission>│
 │                   │                   │                    │                    │                    │
 │                   │                   │                    │                    │  分成计算：         │
 │                   │                   │                    │                    │  - Agent: 2-3%     │
 │                   │                   │                    │                    │  - PayMind: 0.5-1% │
 │                   │                   │                    │                    │  - Provider: 3%     │
 │                   │                   │                    │                    │                    │
 │                   │                   │                    │                    │<─分佣记录完成──────│
 │                   │                   │                    │                    │                    │
 │                   │                   │                    │──记录推广分成──────>│                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │                    │<─推广分成记录完成───│                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │                    │──更新支付状态──────>│                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │                    │  status: COMPLETED  │                    │
 │                   │                   │                    │                    │                    │
 │                   │<─支付成功─────────│                    │                    │                    │
 │<─显示支付成功──────│                   │                    │                    │                    │
```

### 场景3：需要Escrow托管的支付

```
用户                前端UI              后端API              Escrow服务            分佣服务              商家
 │                   │                   │                    │                    │                    │
 │──选择支付方式─────>│                   │                    │                    │                    │
 │                   │                   │                    │                    │                    │
 │                   │──processPayment───>│                    │                    │                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │──shouldUseEscrow──>│                    │                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │  判断条件：         │                    │                    │
 │                   │                   │  - 订单类型         │                    │                    │
 │                   │                   │  - 商家设置         │                    │                    │
 │                   │                   │  - 金额阈值         │                    │                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │<─需要托管──────────│                    │                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │──createEscrow──────>│                    │                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │                    │  创建托管配置：     │                    │
 │                   │                   │                    │  - 订单类型         │                    │
 │                   │                   │                    │  - 结算类型         │                    │
 │                   │                   │                    │  - 分成配置         │                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │                    │<─返回escrowId─────│                    │
 │                   │                   │<─返回escrowId──────│                    │                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │──执行支付──────────>│                    │                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │  [支付流程...]      │                    │                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │──fundEscrow────────>│                    │                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │                    │  状态更新：         │                    │
 │                   │                   │                    │  - status: FUNDED   │                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │                    │<─资金已托管────────│                    │
 │                   │                   │<─支付成功──────────│                    │                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │──autoSettleByOrderType>│                │                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │                    │  根据订单类型：     │                    │
 │                   │                   │                    │  - NFT/虚拟: 即时   │                    │
 │                   │                   │                    │  - 服务: 等待开始   │                    │
 │                   │                   │                    │  - 商品: 等待确认   │                    │
 │                   │                   │                    │                    │                    │
 │<─显示支付成功──────│                   │                    │                    │                    │
 │                   │                   │                    │                    │                    │
 │  [等待商家发货]    │                   │                    │                    │                    │
 │                   │                   │                    │                    │                    │
 │──确认收货─────────>│                   │                    │                    │                    │
 │                   │──confirmDelivery─>│                    │                    │                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │──confirmDelivery───>│                    │                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │                    │──计算分成──────────>│                    │
 │                   │                   │                    │                    │──calculateCommission>│
 │                   │                   │                    │                    │                    │
 │                   │                   │                    │                    │  分成计算：         │
 │                   │                   │                    │                    │  - 商家: 78-88%    │
 │                   │                   │                    │                    │  - Agent: 6-12%    │
 │                   │                   │                    │                    │  - PayMind: 6-10%  │
 │                   │                   │                    │                    │                    │
 │                   │                   │                    │                    │<─分佣记录完成──────│
 │                   │                   │                    │                    │                    │
 │                   │                   │                    │──releaseFunds──────>│                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │                    │  状态更新：         │                    │
 │                   │                   │                    │  - status: RELEASED │                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │                    │<─资金已释放────────│                    │
 │                   │                   │<─确认成功──────────│                    │                    │
 │<─显示确认成功──────│                   │                    │                    │                    │
```

### 场景4：智能路由决策流程

```
用户                前端UI              后端API              智能路由              支付服务
 │                   │                   │                    │                    │
 │──发起支付请求─────>│                   │                    │                    │
 │                   │                   │                    │                    │
 │                   │──getPaymentRouting>│                    │                    │
 │                   │                   │                    │                    │
 │                   │                   │──selectBestChannel>│                    │
 │                   │                   │                    │                    │
 │                   │                   │                    │  路由决策逻辑：     │
 │                   │                   │                    │                    │
 │                   │                   │                    │  1. 检查商家配置    │
 │                   │                   │                    │     - fiat_only    │
 │                   │                   │                    │     - crypto_only   │
 │                   │                   │                    │     - both         │
 │                   │                   │                    │                    │
 │                   │                   │                    │  2. 检查可用通道    │
 │                   │                   │                    │     - Stripe       │
 │                   │                   │                    │     - X402         │
 │                   │                   │                    │     - Wallet       │
 │                   │                   │                    │     - Multisig     │
 │                   │                   │                    │                    │
 │                   │                   │                    │  3. 评估通道       │
 │                   │                   │                    │     - 成本         │
 │                   │                   │                    │     - 速度         │
 │                   │                   │                    │     - KYC要求      │
 │                   │                   │                    │     - 跨境支持     │
 │                   │                   │                    │                    │
 │                   │                   │                    │  4. 计算手续费     │
 │                   │                   │                    │     - Provider: 3% │
 │                   │                   │                    │     - Agent: 2-3%  │
 │                   │                   │                    │     - PayMind: 0.5-1%│
 │                   │                   │                    │                    │
 │                   │                   │                    │  5. 选择最优通道   │
 │                   │                   │                    │     - 优先级排序   │
 │                   │                   │                    │     - 成本最低     │
 │                   │                   │                    │     - 速度最快     │
 │                   │                   │                    │                    │
 │                   │                   │<─返回路由决策──────│                    │
 │                   │                   │                    │                    │
 │                   │                   │  RoutingDecision:  │                    │
 │                   │                   │  - recommendedMethod│                    │
 │                   │                   │  - channels        │                    │
 │                   │                   │  - priceComparison │                    │
 │                   │                   │  - totalFeeRate    │                    │
 │                   │                   │  - exchangeRate    │                    │
 │                   │                   │                    │                    │
 │                   │<─返回路由建议─────│                    │                    │
 │                   │                   │                    │                    │
 │                   │──显示支付选项─────>│                    │                    │
 │<─显示支付方式选择──│                   │                    │                    │
```

---

## 智能路由决策逻辑

### 决策树

```
支付请求
  │
  ├─ 检查商家收款配置
  │   │
  │   ├─ fiat_only?
  │   │   └─> 只允许Stripe
  │   │
  │   ├─ crypto_only?
  │   │   └─> 不允许Stripe
  │   │
  │   └─ both?
  │       └─> 所有通道可用
  │
  ├─ 检查可用通道
  │   │
  │   ├─ Stripe
  │   │   ├─ 金额范围: $1 - $1,000,000
  │   │   ├─ 成本: 2.9% + 固定费用
  │   │   ├─ 速度: 9/10
  │   │   └─ 支持货币: USD, EUR, GBP, CNY, JPY
  │   │
  │   ├─ X402
  │   │   ├─ 金额范围: $0.001 - $1,000,000
  │   │   ├─ 成本: 0.06% (比标准低40%)
  │   │   ├─ 速度: 8/10
  │   │   ├─ 优先级: 80 (高)
  │   │   └─ 支持货币: USDC, USDT, ETH, BTC
  │   │
  │   ├─ Wallet
  │   │   ├─ 金额范围: $0.001 - $1,000,000
  │   │   ├─ 成本: 0.1% (Gas费用)
  │   │   ├─ 速度: 7/10
  │   │   └─ 支持货币: USDC, USDT, ETH, BTC
  │   │
  │   └─ Multisig
  │       ├─ 金额范围: $1,000 - $10,000,000
  │       ├─ 成本: 0.2% (多签Gas)
  │       ├─ 速度: 5/10
  │       └─ 支持货币: USDC, USDT, ETH, BTC
  │
  ├─ 评估通道
  │   │
  │   ├─ 金额检查
  │   │   └─> 过滤超出范围的通道
  │   │
  │   ├─ 货币检查
  │   │   └─> 过滤不支持的货币
  │   │
  │   ├─ KYC检查
  │   │   └─> 过滤需要KYC但用户未完成的通道
  │   │
  │   └─ 跨境检查
  │       └─> 优先选择支持跨境的通道
  │
  ├─ 计算总手续费
  │   │
  │   ├─ Provider手续费 (如有)
  │   │   └─> 3% (法币转数字货币)
  │   │
  │   ├─ Agent手续费
  │   │   ├─> 2% (实体商品)
  │   │   └─> 3% (服务/数字资产)
  │   │
  │   └─ PayMind手续费
  │       ├─> 0.5% (实体商品)
  │       └─> 1% (其他)
  │
  └─ 选择最优通道
      │
      ├─ 优先级排序
      │   └─> X402 > Wallet > Stripe > Multisig
      │
      ├─ 成本最低
      │   └─> 数字货币通道优先
      │
      └─ 速度最快
          └─> 链上确认快的优先
```

---

## 分佣计算流程

### 分佣计算时序图

```
支付完成              分佣计算服务          推广服务              数据库
 │                     │                    │                    │
 │──支付状态: COMPLETED>│                    │                    │
 │                     │                    │                    │
 │                     │──calculateAndRecordCommission>│          │
 │                     │                    │                    │
 │                     │  1. 获取订单类型   │                    │
 │                     │     - nft          │                    │
 │                     │     - virtual     │                    │
 │                     │     - service     │                    │
 │                     │     - product     │                    │
 │                     │     - physical    │                    │
 │                     │                    │                    │
 │                     │  2. 获取分成配置   │                    │
 │                     │     - merchant: 78-88%│                │
 │                     │     - agent: 6-12%│                    │
 │                     │     - paymind: 6-10%│                  │
 │                     │                    │                    │
 │                     │  3. 计算分佣金额   │                    │
 │                     │     - PayMind分佣 │                    │
 │                     │     - Agent分佣   │                    │
 │                     │                    │                    │
 │                     │──保存分佣记录─────>│                    │
 │                     │                    │                    │
 │                     │                    │──recordPaymentCommission>│
 │                     │                    │                    │
 │                     │                    │  1. 查找推广关系   │
 │                     │                    │     - merchantId   │
 │                     │     - status: ACTIVE│                   │
 │                     │                    │                    │
 │                     │                    │  2. 计算推广分成   │
 │                     │                    │     - 0.5% (永久)   │
 │                     │                    │                    │
 │                     │                    │  3. 创建分成记录   │
 │                     │                    │     - status: PENDING│                 │
 │                     │                    │                    │
 │                     │                    │──保存推广分成记录─>│
 │                     │                    │                    │
 │                     │                    │  4. 更新推广统计   │
 │                     │                    │     - totalCommissionEarned│          │
 │                     │                    │     - totalMerchantGMV│              │
 │                     │                    │                    │
 │                     │                    │<─保存成功──────────│
 │                     │                    │                    │
 │                     │<─分佣计算完成──────│                    │
```

---

## 结算机制

### 结算类型

| 订单类型 | 结算类型 | 自动确认 | 用户确认 | 可退款 |
|---------|---------|---------|---------|--------|
| NFT/虚拟资产 | instant | ✅ | ❌ | ❌ |
| 服务 | service_started | ❌ | ✅ | ✅ |
| 实体商品 | delivery_confirmed | ✅ (7天) | ✅ | ✅ |

### 结算流程

```
支付完成              托管服务              结算服务              商家/Agent
 │                     │                    │                    │
 │──资金已托管─────────>│                    │                    │
 │                     │                    │                    │
 │                     │──autoSettleByOrderType>│                │
 │                     │                    │                    │
 │                     │  根据订单类型：     │                    │
 │                     │                    │                    │
 │                     │  1. NFT/虚拟资产   │                    │
 │                     │     └─> 即时结算   │                    │
 │                     │                    │                    │
 │                     │  2. 服务           │                    │
 │                     │     └─> 等待服务开始│                    │
 │                     │                    │                    │
 │                     │  3. 实体商品       │                    │
 │                     │     └─> 等待确认收货│                    │
 │                     │         (7天自动)  │                    │
 │                     │                    │                    │
 │                     │──确认收货─────────>│                    │
 │                     │                    │                    │
 │                     │──confirmDelivery───>│                    │
 │                     │                    │                    │
 │                     │  1. 计算分成       │                    │
 │                     │     - 商家: 78-88% │                    │
 │                     │     - Agent: 6-12%│                    │
 │                     │     - PayMind: 6-10%│                  │
 │                     │                    │                    │
 │                     │  2. 释放资金       │                    │
 │                     │                    │                    │
 │                     │──releaseFunds──────>│                    │
 │                     │                    │                    │
 │                     │                    │──转账给商家───────>│
 │                     │                    │──转账给Agent──────>│
 │                     │                    │──转账给PayMind────>│
 │                     │                    │                    │
 │                     │                    │<─转账成功──────────│
 │                     │                    │                    │
 │                     │<─结算完成──────────│                    │
```

---

### 场景5：跨境支付（法币转数字货币）

```
用户                前端UI              后端API              智能路由              FiatToCrypto服务        Provider
 │                   │                   │                    │                    │                    │
 │──选择法币支付─────>│                   │                    │                    │                    │
 │                   │                   │                    │                    │                    │
 │                   │──processPayment───>│                    │                    │                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │──检测跨境场景──────>│                    │                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │  判断条件：         │                    │                    │
 │                   │                   │  - userCountry ≠ merchantCountry│      │                    │
 │                   │                   │  - merchantConfig = crypto_only│        │                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │<─需要转换──────────│                    │                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │──lockQuote─────────>│                    │                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │                    │──获取汇率报价──────>│                    │
 │                   │                   │                    │                    │──查询汇率─────────>│
 │                   │                   │                    │                    │<─返回汇率──────────│
 │                   │                   │                    │<─返回报价──────────│                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │<─返回lockId────────│                    │                    │
 │                   │                   │                    │                    │                    │
 │                   │<─返回支付信息─────│                    │                    │                    │
 │                   │                   │                    │                    │                    │
 │──确认支付─────────>│                   │                    │                    │                    │
 │                   │──executeExchange──>│                    │                    │                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │──executeExchange───>│                    │                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │                    │──执行转换─────────>│                    │
 │                   │                   │                    │                    │──调用Provider API─>│
 │                   │                   │                    │                    │                    │──[处理支付]
 │                   │                   │                    │                    │<─转换成功──────────│
 │                   │                   │                    │<─转换完成──────────│                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │                    │──计算分佣──────────>│                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │                    │  分成计算：         │                    │
 │                   │                   │                    │  - Provider: 3%     │                    │
 │                   │                   │                    │  - Agent: 2-3%     │                    │
 │                   │                   │                    │  - PayMind: 0.5-1% │                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │<─支付成功──────────│                    │                    │
 │                   │<─支付成功─────────│                    │                    │                    │
 │<─显示支付成功──────│                   │                    │                    │                    │
```

### 场景6：支付聚合服务商（无Stripe账户）

```
用户                前端UI              后端API              支付聚合服务          分佣服务
 │                   │                   │                    │                    │
 │──选择Apple Pay───>│                   │                    │                    │
 │                   │                   │                    │                    │
 │                   │──processPayment───>│                    │                    │
 │                   │                   │                    │                    │
 │                   │                   │──检测Stripe可用───>│                    │
 │                   │                   │                    │                    │
 │                   │                   │<─Stripe不可用──────│                    │
 │                   │                   │                    │                    │
 │                   │                   │──selectBestAggregator>│                │
 │                   │                   │                    │                    │
 │                   │                   │  评估聚合服务商：   │                    │
 │                   │                   │  - Paddle: 3.5%    │                    │
 │                   │                   │  - Adyen: 3.2%     │                    │
 │                   │                   │  - Checkout.com: 3.4%│                 │
 │                   │                   │                    │                    │
 │                   │                   │<─推荐Adyen─────────│                    │
 │                   │                   │                    │                    │
 │                   │                   │──processPayment───>│                    │
 │                   │                   │                    │                    │
 │                   │                   │                    │──处理支付─────────>│
 │                   │                   │                    │                    │──[Adyen处理]
 │                   │                   │                    │<─支付成功──────────│
 │                   │                   │                    │                    │
 │                   │                   │──计算分佣──────────>│                    │
 │                   │                   │                    │                    │──calculateCommission>│
 │                   │                   │                    │                    │                    │
 │                   │                   │                    │                    │  分成计算：         │
 │                   │                   │                    │                    │  - Provider: 3.2%   │
 │                   │                   │                    │                    │  - Agent: 2-3%     │
 │                   │                   │                    │                    │  - PayMind: 0.5-1% │
 │                   │                   │                    │                    │                    │
 │                   │                   │                    │                    │<─分佣记录完成──────│
 │                   │                   │                    │                    │                    │
 │                   │                   │<─支付成功──────────│                    │                    │
 │                   │<─支付成功─────────│                    │                    │                    │
 │<─显示支付成功──────│                   │                    │                    │                    │
```

### 场景7：多Agent协作支付（推荐+执行）

```
用户                前端UI              后端API              分佣服务              推广服务              数据库
 │                   │                   │                    │                    │                    │
 │──通过Agent A推荐──>│                   │                    │                    │                    │
 │──通过Agent B执行──>│                   │                    │                    │                    │
 │                   │                   │                    │                    │                    │
 │                   │──processPayment───>│                    │                    │                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │  [支付流程...]      │                    │                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │──支付完成──────────>│                    │                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │──calculateAndRecordCommission>│        │                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │  1. 计算执行Agent分成│                    │                    │
 │                   │                   │     - Agent B: 商品佣金率 × 70%│        │                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │  2. 计算推荐Agent分成│                    │                    │
 │                   │                   │     - Agent A: 商品佣金率 × 30%│        │                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │  3. 计算PayMind分成 │                    │                    │
 │                   │                   │     - PayMind: 0.5-1%│                  │                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │──保存分佣记录─────>│                    │                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │                    │──recordPaymentCommission>│              │
 │                   │                   │                    │                    │                    │
 │                   │                   │                    │  1. 查找推广关系   │                    │
 │                   │                   │                    │     - merchantId   │                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │                    │  2. 计算推广分成   │                    │
 │                   │                   │                    │     - 0.5% (永久)   │                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │                    │  3. 创建推广分成记录│                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │                    │──保存推广分成记录─>│                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │                    │  4. 更新推广统计   │                    │
 │                   │                   │                    │     - totalCommissionEarned│          │
 │                   │                   │                    │     - totalMerchantGMV│              │
 │                   │                   │                    │                    │                    │
 │                   │                   │                    │<─保存成功──────────│                    │
 │                   │                   │                    │                    │                    │
 │                   │                   │<─分佣计算完成──────│                    │                    │
 │                   │<─支付成功─────────│                    │                    │                    │
 │<─显示支付成功──────│                   │                    │                    │                    │
```

---

## 支付场景覆盖矩阵

| 支付场景 | 支付方式 | 智能路由 | Escrow | 分佣计算 | 跨境支持 | 状态 |
|---------|---------|---------|--------|---------|---------|------|
| **数字货币支付** | X402/Wallet | ✅ | ✅ | ✅ | ✅ | ✅ |
| **法币支付** | Stripe | ✅ | ✅ | ✅ | ❌ | ✅ |
| **移动支付** | Apple Pay/Google Pay | ✅ | ✅ | ✅ | ❌ | ✅ |
| **跨境支付** | FiatToCrypto | ✅ | ✅ | ✅ | ✅ | ✅ |
| **托管支付** | 所有方式 | ✅ | ✅ | ✅ | ✅ | ✅ |
| **聚合支付** | Paddle/Adyen/Checkout | ✅ | ✅ | ✅ | ✅ | ✅ |
| **多Agent协作** | 所有方式 | ✅ | ✅ | ✅ | ✅ | ✅ |
| **大额支付** | Multisig | ✅ | ✅ | ✅ | ✅ | ✅ |

---

## 总结

1. **统一入口**：所有支付请求通过`PaymentService.processPayment`统一处理
2. **智能路由**：根据支付场景自动选择最优支付通道
3. **自动托管**：根据订单类型自动检测是否需要Escrow托管
4. **自动分佣**：支付完成后自动计算并记录所有分佣（执行Agent、推荐Agent、推广Agent、PayMind）
5. **自动结算**：根据订单类型自动处理结算流程
6. **多通道支持**：支持Stripe、X402、Wallet、Multisig、支付聚合服务商等多种支付方式
7. **跨境支持**：自动处理法币与数字货币的转换（FiatToCrypto/CryptoToFiat）
8. **多Agent协作**：支持推荐Agent和执行Agent的分佣分配
9. **全场景覆盖**：覆盖所有常见支付场景，确保用户体验一致

