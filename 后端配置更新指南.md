# 后端配置更新指南 - Commission合约部署后

**更新日期**: 2025-11-26  
**状态**: ✅ **需要更新后端配置**

---

## 📋 部署信息

### Commission合约地址
- **合约地址**: `0xa0C571F348Bc1C8E08F8fcFc8805254eF128B48D`
- **BSCScan**: https://testnet.bscscan.com/address/0xa0C571F348Bc1C8E08F8fcFc8805254eF128B48D

### 相关地址
- **USDT地址**: `0x337610d27c682E347C9cD60BD4b3b107C9d34dDd`
- **Agentrix金库**: `0x2bee8AE78e4E41cf7facc4A4387A8F299dd2b8f3`
- **系统返利池**: `0x2bee8AE78e4E41cf7facc4A4387A8F299dd2b8f3`

---

## 🔧 后端环境变量更新

### 更新 `backend/.env` 文件

添加或更新以下配置项：

```env
# ===== Commission合约配置 =====
# Commission合约地址（新部署的）
COMMISSION_CONTRACT_ADDRESS=0xa0C571F348Bc1C8E08F8fcFc8805254eF128B48D

# USDT地址（BSC测试网，用于支付和分账）
USDC_ADDRESS=0x337610d27c682E347C9cD60BD4b3b107C9d34dDd

# ===== 其他配置（保持不变） =====
# ERC8004合约地址（已部署）
ERC8004_CONTRACT_ADDRESS=0x...  # 你的ERC8004地址

# RPC配置
RPC_URL=https://data-seed-prebsc-1-s1.binance.org:8545
CHAIN_ID=97

# Relayer配置
RELAYER_PRIVATE_KEY=your_private_key_here
```

---

## 📊 后端使用Commission合约的地方

### 1. 合约事件监听服务

**文件**: `backend/src/modules/contract/contract-listener.service.ts`

**功能**:
- 监听 `PaymentReceived` 事件
- 监听 `PaymentAutoSplit` 事件
- 监听 `SplitConfigSet` 事件
- 监听 `ProviderAuthorized` 事件

**配置要求**:
- 需要 `COMMISSION_CONTRACT_ADDRESS` 环境变量
- 如果未配置，事件监听服务不会启动

### 2. 分账服务（未来）

后端可能需要调用Commission合约的以下函数：
- `setSplitConfig()` - 设置订单分账配置
- `quickPaySplit()` - QuickPay场景分账
- `walletSplit()` - 钱包转账场景分账
- `getSplitConfig()` - 查询分账配置

---

## ✅ 配置验证

### 1. 检查环境变量

```bash
cd backend
# 检查环境变量是否已设置
grep COMMISSION_CONTRACT_ADDRESS .env
grep USDC_ADDRESS .env
```

### 2. 重启后端服务

```bash
cd backend
npm run start:dev
```

### 3. 检查日志

启动后，查看日志中是否有：
```
开始监听Commission合约事件: 0xa0C571F348Bc1C8E08F8fcFc8805254eF128B48D
```

如果看到这个日志，说明配置成功。

---

## 🧪 测试配置

### 1. 测试事件监听

触发一次支付，检查后端日志是否监听到事件：
- `PaymentReceived` 事件
- `PaymentAutoSplit` 事件

### 2. 测试合约调用（如果已实现）

```bash
# 使用curl或Postman测试API
# 例如：设置分账配置、查询分账配置等
```

---

## 📝 配置检查清单

- [ ] 更新 `backend/.env` 中的 `COMMISSION_CONTRACT_ADDRESS`
- [ ] 确认 `USDC_ADDRESS` 配置正确
- [ ] 重启后端服务
- [ ] 检查日志确认事件监听服务启动
- [ ] 测试事件监听功能
- [ ] 测试合约调用功能（如果已实现）

---

## 🔗 相关文档

- **部署记录**: `BSC测试网Commission合约部署记录.md`
- **合约功能说明**: `Agentrix智能合约功能说明.md`
- **快速部署指南**: `BSC测试网快速部署与测试指南.md`

---

**文档维护**: Agentrix 开发团队  
**最后更新**: 2025-11-26

