# PayMind V3.0 测试验收执行指南

## 🎯 快速开始

### 步骤1: 启动服务

**在WSL/Linux环境中运行**:

```bash
# 方式1: 使用启动脚本（推荐）
./启动所有服务-V3.sh

# 方式2: 手动启动
cd backend
npm run migration:run
npm run seed:products
npm run start:dev

# 新终端窗口
cd paymindfrontend
npm run dev
```

**在Windows PowerShell中运行**:

```powershell
# 方式1: 使用启动脚本
.\启动所有服务-V3.bat

# 方式2: 手动启动
cd backend
npm run migration:run
npm run seed:products
npm run start:dev

# 新PowerShell窗口
cd paymindfrontend
npm run dev
```

---

## 📋 测试检查清单

### ✅ 1. 环境检查

- [ ] PostgreSQL数据库运行中（localhost:5432）
- [ ] 后端服务运行中（http://localhost:3001/api）
- [ ] 前端服务运行中（http://localhost:3000）
- [ ] 商品种子数据已导入（18个商品）

**验证方法**:
```bash
# 检查后端服务
curl http://localhost:3001/api/health

# 检查前端服务
curl http://localhost:3000

# 检查商品数据（通过API）
curl http://localhost:3001/api/products
```

---

### ✅ 2. Agent功能测试

#### 2.1 商品搜索/比价

**测试步骤**:
1. 访问 http://localhost:3000/agent
2. 在对话框中输入: `帮我找一把游戏剑，预算20美元`
3. 查看返回结果

**预期结果**:
- ✅ 返回游戏剑商品列表
- ✅ 显示价格和比价信息
- ✅ 商品卡片可点击查看详情

**验收**: [ ] 通过 [ ] 失败

---

#### 2.2 服务推荐

**测试步骤**:
1. 在Agent对话框中输入: `帮我做一套logo设计`
2. 查看返回结果

**预期结果**:
- ✅ 返回服务类商品列表
- ✅ 显示服务类型和交付周期
- ✅ 可以创建任务型订单

**验收**: [ ] 通过 [ ] 失败

---

#### 2.3 链上资产识别

**测试步骤**:
1. 在Agent对话框中输入: `查找NFT收藏品`
2. 查看返回结果

**预期结果**:
- ✅ 返回链上资产列表
- ✅ 显示链信息（Ethereum/Polygon）
- ✅ 显示合约地址和tokenId

**验收**: [ ] 通过 [ ] 失败

---

#### 2.4 自动下单

**测试步骤**:
1. 在Agent对话框中输入: `帮我把火焰之刃加入购物车并支付`
2. 完成支付流程

**预期结果**:
- ✅ 自动创建订单
- ✅ 生成PayIntent
- ✅ 显示支付进度条
- ✅ 完成支付流程

**验收**: [ ] 通过 [ ] 失败

---

#### 2.5 代码生成

**测试步骤**:
1. 在Agent对话框中输入: `生成支付API代码`
2. 查看生成的代码

**预期结果**:
- ✅ 生成TypeScript/JavaScript/Python代码
- ✅ 代码可复制
- ✅ 可在沙箱中运行

**验收**: [ ] 通过 [ ] 失败

---

#### 2.6 订单查询

**测试步骤**:
1. 在Agent对话框中输入: `查询我的订单`
2. 查看返回结果

**预期结果**:
- ✅ 返回订单列表
- ✅ 显示订单状态
- ✅ 显示物流信息（如果有）

**验收**: [ ] 通过 [ ] 失败

---

#### 2.7 退款处理

**测试步骤**:
1. 在Agent对话框中输入: `我要退款订单[订单ID]`
2. 查看退款结果

**预期结果**:
- ✅ 创建退款请求
- ✅ 更新订单状态
- ✅ 返回退款信息

**验收**: [ ] 通过 [ ] 失败

---

### ✅ 3. Marketplace功能测试

#### 3.1 商品上架

**测试步骤**:
1. 访问商户后台
2. 创建新商品
3. 填写商品信息并上架

**预期结果**:
- ✅ 商品创建成功
- ✅ 自动索引到搜索服务
- ✅ 可以在Marketplace中搜索到

**验收**: [ ] 通过 [ ] 失败

---

#### 3.2 商品搜索

**测试步骤**:
1. 访问Marketplace
2. 搜索商品（例如: "游戏剑"）
3. 查看搜索结果

**预期结果**:
- ✅ 返回相关商品列表
- ✅ 支持价格、分类过滤
- ✅ 支持排序

**验收**: [ ] 通过 [ ] 失败

---

#### 3.3 库存管理

**测试步骤**:
1. 创建订单
2. 检查库存扣减
3. 再次下单（库存不足）

**预期结果**:
- ✅ 库存正确扣减
- ✅ 库存不足时提示

**验收**: [ ] 通过 [ ] 失败

---

### ✅ 4. 支付系统测试

#### 4.1 PayIntent创建

**测试步骤**:
1. 通过API创建PayIntent:
```bash
curl -X POST http://localhost:3001/api/payments/payintent \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "amount": 99.99,
    "currency": "CNY",
    "description": "测试支付"
  }'
```
2. 查看返回的payUrl

**预期结果**:
- ✅ PayIntent创建成功
- ✅ 返回payUrl和二维码
- ✅ 可以通过payUrl访问支付页面

**验收**: [ ] 通过 [ ] 失败

---

#### 4.2 QuickPay授权

**测试步骤**:
1. 创建QuickPay授权:
```bash
curl -X POST http://localhost:3001/api/payments/quickpay/grants \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "paymentMethod": "stripe",
    "dailyLimit": 1000,
    "singleLimit": 100
  }'
```
2. 使用QuickPay支付
3. 查看授权使用情况

**预期结果**:
- ✅ 授权创建成功
- ✅ 支付时自动使用授权
- ✅ 授权使用量正确记录

**验收**: [ ] 通过 [ ] 失败

---

#### 4.3 X402支付

**测试步骤**:
1. 创建X402支付会话:
```bash
curl -X POST http://localhost:3001/api/payments/x402/session \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "amount": 50,
    "currency": "USDT",
    "recipient": "0x1234567890abcdef"
  }'
```
2. 执行X402支付
3. 查看支付结果

**预期结果**:
- ✅ 支付会话创建成功
- ✅ 支付执行成功
- ✅ 返回交易哈希

**验收**: [ ] 通过 [ ] 失败

---

#### 4.4 托管支付

**测试步骤**:
1. 创建托管交易:
```bash
curl -X POST http://localhost:3001/api/payments/escrow/create \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "amount": 100,
    "currency": "CNY",
    "merchantId": "MERCHANT_ID",
    "description": "测试托管交易"
  }'
```
2. 完成支付
3. 确认交付
4. 查看资金释放

**预期结果**:
- ✅ 托管交易创建成功
- ✅ 资金正确托管
- ✅ 交付确认后资金释放

**验收**: [ ] 通过 [ ] 失败

---

#### 4.5 退款

**测试步骤**:
1. 创建退款请求:
```bash
curl -X POST http://localhost:3001/api/refunds \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "paymentId": "PAYMENT_ID",
    "reason": "测试退款"
  }'
```
2. 查看退款状态
3. 验证退款完成

**预期结果**:
- ✅ 退款请求创建成功
- ✅ 退款状态正确更新
- ✅ 支付和订单状态正确更新

**验收**: [ ] 通过 [ ] 失败

---

#### 4.6 汇率换算

**测试步骤**:
1. 获取汇率报价:
```bash
curl "http://localhost:3001/api/payments/exchange/quotes?fromAmount=100&fromCurrency=CNY&toCurrency=USDT" \
  -H "Authorization: Bearer YOUR_TOKEN"
```
2. 锁定汇率
3. 执行兑换

**预期结果**:
- ✅ 返回多个Provider报价
- ✅ 汇率锁定成功
- ✅ 兑换执行成功

**验收**: [ ] 通过 [ ] 失败

---

### ✅ 5. 多链钱包测试

#### 5.1 EVM钱包连接

**测试步骤**:
1. 访问钱包连接页面
2. 连接MetaMask钱包
3. 验证签名
4. 查看钱包连接状态

**预期结果**:
- ✅ 钱包连接成功
- ✅ 签名验证通过
- ✅ 钱包地址正确保存

**验收**: [ ] 通过 [ ] 失败

---

#### 5.2 Solana钱包连接

**测试步骤**:
1. 访问钱包连接页面
2. 连接Phantom钱包
3. 验证签名
4. 查看钱包连接状态

**预期结果**:
- ✅ 钱包连接成功
- ✅ 签名验证通过
- ✅ 钱包地址正确保存

**验收**: [ ] 通过 [ ] 失败

---

## 📊 测试结果汇总

### 功能测试结果

| 模块 | 测试项 | 通过 | 失败 | 通过率 |
|------|--------|------|------|--------|
| Agent | 7 | | | |
| Marketplace | 3 | | | |
| 支付系统 | 6 | | | |
| 多链钱包 | 2 | | | |
| **总计** | **18** | | | |

### 验收标准检查

- [ ] Agent自然语言→API调用链路完整
- [ ] 覆盖3类商品渠道+1个服务渠道+1个链上资产渠道
- [ ] 自动下单流程独立跑完
- [ ] SDK生成代码可运行
- [ ] 所有支付方案可在本地Mock环境验证
- [ ] 上架流程支持多类型
- [ ] 库存锁定+扣减
- [ ] 支持搜索和过滤
- [ ] 商户后台UI正常工作
- [ ] API表结构完整，有OpenAPI文档
- [ ] Webhook可在本地Mock环境触发
- [ ] 钱包绑定支持3条链
- [ ] 任何购买流程可落地到Payment Intent
- [ ] QuickPay授权可复用
- [ ] 汇率换算调用Mock FX引擎
- [ ] Refund流程全链通

---

## 🎯 验收结论

**总体评估**: [ ] 通过 [ ] 不通过

**通过条件**:
- ✅ 所有核心功能测试通过
- ✅ 所有验收标准满足
- ✅ 无明显Bug

**不通过原因**:
（如不通过，请详细说明）

---

## 📝 测试记录

**测试日期**: _______________

**测试人员**: _______________

**测试环境**:
- 操作系统: _______________
- Node版本: _______________
- 数据库版本: _______________

**发现的问题**:
1. 
2. 
3. 

**备注**:
_________________________________________________________________
_________________________________________________________________

---

**测试完成后，请将本清单保存并提交给开发团队。**

