# 非托管支付流程实施工作清单

**版本**: V1.0  
**日期**: 2025年1月  
**目标**: 完成非托管支付流程的所有必要工作，按优先级执行

---

## 📋 目录

1. [工作清单总览](#1-工作清单总览)
2. [P0: 核心功能（必须完成）](#2-p0-核心功能必须完成)
3. [P1: 重要功能（尽快完成）](#3-p1-重要功能尽快完成)
4. [P2: 优化功能（后续完成）](#4-p2-优化功能后续完成)
5. [实施时间表](#5-实施时间表)

---

## 1. 工作清单总览

### 1.1 优先级分类

| 优先级 | 说明 | 工作量 | 时间 |
|--------|------|--------|------|
| **P0** | 核心功能，必须完成 | 6-8周 | 立即开始 |
| **P1** | 重要功能，尽快完成 | 4-6周 | P0完成后 |
| **P2** | 优化功能，后续完成 | 2-4周 | P1完成后 |

### 1.2 工作模块

| 模块 | P0 | P1 | P2 | 总计 |
|------|----|----|----|------|
| **智能合约分账** | 3项 | 1项 | 1项 | 5项 |
| **商户 MPC 钱包** | 4项 | 2项 | 1项 | 7项 |
| **Provider 集成** | 1项 | 2项 | 1项 | 4项 |
| **合规声明** | 0项 | 2项 | 1项 | 3项 |
| **测试和文档** | 2项 | 1项 | 1项 | 4项 |
| **总计** | **10项** | **8项** | **5项** | **23项** |

---

## 2. P0: 核心功能（必须完成）

### 2.1 智能合约分账功能

#### ✅ 任务 1.1: 实现统一分账函数 `_autoSplit`

**文件**: `contract/contracts/Commission.sol`

**工作内容**:
- [ ] 添加 `SplitConfig` 结构体（包含商户 MPC 钱包地址、分账金额等）
- [ ] 实现 `_autoSplit()` 内部函数（统一分账逻辑）
- [ ] 支持多角色分账（商户、推荐人、执行Agent、平台）
- [ ] 添加结算时间验证
- [ ] 添加争议状态检查

**工作量**: 3-5天  
**依赖**: 无

---

#### ✅ 任务 1.2: 实现 QuickPay 场景分账 `quickPaySplit`

**文件**: `contract/contracts/Commission.sol`

**工作内容**:
- [ ] 实现 `quickPaySplit()` 函数
- [ ] 验证 Session 签名（可选，或由 ERC8004 合约验证）
- [ ] 从用户钱包转账 USDC 到合约
- [ ] 调用 `_autoSplit()` 自动分账
- [ ] 添加事件记录

**工作量**: 2-3天  
**依赖**: 任务 1.1

---

#### ✅ 任务 1.3: 实现钱包转账场景分账 `walletSplit`

**文件**: `contract/contracts/Commission.sol`

**工作内容**:
- [ ] 实现 `walletSplit()` 函数
- [ ] 从用户钱包转账 USDC 到合约
- [ ] 调用 `_autoSplit()` 自动分账
- [ ] 添加事件记录

**工作量**: 2-3天  
**依赖**: 任务 1.1

---

#### ✅ 任务 1.4: 实现分账配置设置 `setSplitConfig`

**文件**: `contract/contracts/Commission.sol`

**工作内容**:
- [ ] 实现 `setSplitConfig()` 函数
- [ ] 添加分账配置验证
- [ ] 支持更新分账配置
- [ ] 添加事件记录

**工作量**: 2-3天  
**依赖**: 任务 1.1

---

### 2.2 商户 MPC 钱包基础功能

#### ✅ 任务 2.1: 实现私钥分片生成

**文件**: `backend/src/modules/mpc-wallet/mpc-wallet.service.ts`

**工作内容**:
- [ ] 安装依赖（`shamir-secret-sharing`、`crypto-js`）
- [ ] 实现 `generateMPCWallet()` 函数
- [ ] 使用 Shamir Secret Sharing 分成 3 份
- [ ] 实现分片加密存储
- [ ] 生成钱包地址

**工作量**: 5-7天  
**依赖**: 无

---

#### ✅ 任务 2.2: 实现 2/3 签名机制

**文件**: `backend/src/modules/mpc-wallet/mpc-signature.service.ts`

**工作内容**:
- [ ] 研究并选择阈值签名库（`tss-lib` 或使用多签钱包替代）
- [ ] 实现 `signWithShardAAndB()`（商户主动支付）
- [ ] 实现 `signWithShardBAndC()`（自动分账）
- [ ] 实现 `signWithShardAAndC()`（商户提现）
- [ ] 实现签名组合算法

**工作量**: 7-10天  
**依赖**: 任务 2.1

**注意**: 如果阈值签名实现困难，考虑使用多签钱包（2/3 多签）作为替代方案

---

#### ✅ 任务 2.3: 实现钱包创建 API

**文件**: `backend/src/modules/mpc-wallet/mpc-wallet.controller.ts`

**工作内容**:
- [ ] 创建 `POST /api/mpc-wallet/create` 接口
- [ ] 创建 `GET /api/mpc-wallet/:walletId` 接口
- [ ] 实现钱包创建逻辑
- [ ] 实现钱包查询逻辑
- [ ] 添加权限验证

**工作量**: 3-5天  
**依赖**: 任务 2.1

---

#### ✅ 任务 2.4: 实现前端钱包创建界面

**文件**: `paymindfrontend/components/mpc-wallet/MPCWalletCreate.tsx`

**工作内容**:
- [ ] 创建钱包创建界面
- [ ] 实现分片 A 的本地存储
- [ ] 实现分片 C 的备份提示
- [ ] 添加钱包创建成功提示
- [ ] 添加钱包恢复说明

**工作量**: 3-5天  
**依赖**: 任务 2.3

---

### 2.3 Provider 抽象层

#### ✅ 任务 3.1: 实现 Provider 抽象层和 Mock Provider

**文件**: 
- `backend/src/modules/payment/provider-abstract.service.ts`
- `backend/src/modules/payment/mock-provider.service.ts`
- `backend/src/modules/payment/provider-manager.service.ts`

**工作内容**:
- [ ] 创建 `IProvider` 接口
- [ ] 实现 `MockProviderService`（用于测试）
- [ ] 实现 `ProviderManagerService`（Provider 管理器）
- [ ] 集成到支付服务
- [ ] 添加环境变量控制（`USE_MOCK_PROVIDER`）

**工作量**: 3-5天  
**依赖**: 无

---

### 2.4 测试和验证

#### ✅ 任务 4.1: 编写智能合约测试

**文件**: `contract/test/Commission.test.ts`

**工作内容**:
- [ ] 测试 `_autoSplit()` 函数
- [ ] 测试 `quickPaySplit()` 函数
- [ ] 测试 `walletSplit()` 函数
- [ ] 测试 `setSplitConfig()` 函数
- [ ] 测试边界情况和错误处理

**工作量**: 3-5天  
**依赖**: 任务 1.1-1.4

---

#### ✅ 任务 4.2: 集成测试（QuickPay 和钱包转账场景）

**文件**: `backend/test/integration/payment-split.test.ts`

**工作内容**:
- [ ] 测试 QuickPay 支付和分账流程
- [ ] 测试钱包转账和分账流程
- [ ] 测试分账配置设置
- [ ] 测试多角色分账
- [ ] 测试错误处理

**工作量**: 3-5天  
**依赖**: 任务 1.1-1.4, 任务 4.1

---

## 3. P1: 重要功能（尽快完成）

### 3.1 智能合约分账功能

#### ✅ 任务 5.1: 实现 Provider 场景分账 `providerFiatToCryptoSplit`

**文件**: `contract/contracts/Commission.sol`

**工作内容**:
- [ ] 实现 `providerFiatToCryptoSplit()` 函数
- [ ] 添加 Provider 白名单验证
- [ ] 验证 USDC 已转入合约
- [ ] 调用 `_autoSplit()` 自动分账
- [ ] 添加事件记录

**工作量**: 2-3天  
**依赖**: 任务 1.1

---

### 3.2 商户 MPC 钱包管理

#### ✅ 任务 6.1: 实现钱包管理界面

**文件**: `paymindfrontend/components/mpc-wallet/MPCWalletManager.tsx`

**工作内容**:
- [ ] 创建钱包管理界面
- [ ] 实现余额查询
- [ ] 实现交易历史查询
- [ ] 实现钱包信息显示
- [ ] 添加钱包操作按钮

**工作量**: 5-7天  
**依赖**: 任务 2.3, 任务 2.4

---

#### ✅ 任务 6.2: 实现钱包恢复功能

**文件**: 
- `backend/src/modules/mpc-wallet/mpc-wallet.service.ts`
- `paymindfrontend/components/mpc-wallet/MPCWalletRecover.tsx`

**工作内容**:
- [ ] 实现 `recoverWallet()` 函数（使用分片 A+C）
- [ ] 创建钱包恢复界面
- [ ] 实现分片输入和验证
- [ ] 添加恢复成功提示
- [ ] 编写恢复文档

**工作量**: 5-7天  
**依赖**: 任务 2.1, 任务 2.2

---

### 3.3 Provider 集成

#### ✅ 任务 7.1: 实现 Provider 嵌入式集成（前端）

**文件**: `paymindfrontend/components/payment/ProviderEmbed.tsx`

**工作内容**:
- [ ] 创建 Provider 嵌入式组件
- [ ] 实现 iframe 集成
- [ ] 实现 KYC 数据透传（不经过 PayMind 服务器）
- [ ] 添加 "Powered by Provider" 显示
- [ ] 添加 TOS 链接

**工作量**: 5-7天  
**依赖**: 任务 3.1

---

#### ✅ 任务 7.2: 实现 Provider On-ramp 流程

**文件**: `backend/src/modules/payment/provider-payment-flow.service.ts`

**工作内容**:
- [ ] 完善 Provider On-ramp 流程
- [ ] 实现 Provider 报价获取和比价
- [ ] 实现 Provider 支付会话创建
- [ ] 实现 Provider 支付结果处理
- [ ] 集成到支付服务

**工作量**: 5-7天  
**依赖**: 任务 3.1, 任务 7.1

---

### 3.4 合规声明

#### ✅ 任务 8.1: 添加 UI 合规声明

**文件**: `paymindfrontend/components/payment/SmartCheckout.tsx`

**工作内容**:
- [ ] 添加 "Powered by Provider" 显示
- [ ] 添加 PayMind 服务条款链接
- [ ] 添加 Provider 服务条款链接
- [ ] 添加风险提示
- [ ] 添加非托管声明

**工作量**: 2-3天  
**依赖**: 无

---

#### ✅ 任务 8.2: 更新 TOS 和隐私政策

**文件**: 
- `paymindfrontend/pages/terms-of-service.tsx`
- `paymindfrontend/pages/privacy-policy.tsx`

**工作内容**:
- [ ] 明确 PayMind 仅为技术服务商（TSP）
- [ ] 明确非托管架构声明
- [ ] 明确 Provider 责任
- [ ] 明确用户权利和义务
- [ ] 添加风险披露

**工作量**: 3-5天  
**依赖**: 无

---

### 3.5 测试

#### ✅ 任务 9.1: 端到端测试（E2E）

**文件**: `backend/test/e2e/payment-flow.test.ts`

**工作内容**:
- [ ] 测试完整支付流程（QuickPay）
- [ ] 测试完整支付流程（钱包转账）
- [ ] 测试完整支付流程（Provider，使用 Mock）
- [ ] 测试分账流程
- [ ] 测试错误处理

**工作量**: 5-7天  
**依赖**: 任务 4.2, 任务 7.2

---

## 4. P2: 优化功能（后续完成）

### 4.1 智能合约优化

#### ✅ 任务 10.1: 优化 Gas 费用

**文件**: `contract/contracts/Commission.sol`

**工作内容**:
- [ ] 优化存储布局
- [ ] 使用事件替代部分存储
- [ ] 批量操作优化
- [ ] Gas 费用测试和优化

**工作量**: 3-5天  
**依赖**: 任务 1.1-1.4

---

### 4.2 商户 MPC 钱包优化

#### ✅ 任务 11.1: 实现钱包恢复工具和文档

**文件**: 
- `paymindfrontend/components/mpc-wallet/MPCWalletRecoverTool.tsx`
- `docs/mpc-wallet-recovery-guide.md`

**工作内容**:
- [ ] 创建开源恢复工具
- [ ] 编写详细恢复文档
- [ ] 添加恢复视频教程
- [ ] 添加常见问题解答

**工作量**: 3-5天  
**依赖**: 任务 6.2

---

### 4.3 Provider 集成优化

#### ✅ 任务 12.1: 接入真实 Provider

**文件**: 
- `backend/src/modules/payment/moonpay-provider.service.ts`
- `backend/src/modules/payment/transak-provider.service.ts`

**工作内容**:
- [ ] 实现 MoonPay Provider
- [ ] 实现 Transak Provider
- [ ] 实现 Provider API 集成
- [ ] 实现 Provider Webhook 处理
- [ ] 测试真实 Provider 流程

**工作量**: 7-10天  
**依赖**: 任务 7.2

---

### 4.4 合规优化

#### ✅ 任务 13.1: 安全审计和合规证明

**文件**: 外部审计

**工作内容**:
- [ ] 安排第三方安全审计
- [ ] 安排代码审计
- [ ] 准备合规文档
- [ ] 准备审计报告

**工作量**: 2-4周（外部）  
**依赖**: 任务 1.1-1.4, 任务 2.1-2.2

---

### 4.5 文档完善

#### ✅ 任务 14.1: 完善技术文档

**文件**: `docs/`

**工作内容**:
- [ ] 完善 API 文档
- [ ] 完善架构文档
- [ ] 完善部署文档
- [ ] 完善测试文档

**工作量**: 3-5天  
**依赖**: 所有 P0 和 P1 任务

---

## 5. 实施时间表

### 5.1 P0 阶段（6-8周）

**目标**: 完成核心功能，支持 QuickPay 和钱包转账场景的分账

**时间表**:
- **第 1-2 周**: 智能合约分账功能（任务 1.1-1.4）
- **第 3-5 周**: 商户 MPC 钱包基础功能（任务 2.1-2.4）
- **第 6 周**: Provider 抽象层（任务 3.1）
- **第 7-8 周**: 测试和验证（任务 4.1-4.2）

**里程碑**:
- ✅ QuickPay 支付可以自动分账到商户 MPC 钱包
- ✅ 钱包转账可以自动分账到商户 MPC 钱包
- ✅ 商户可以创建和管理 MPC 钱包

---

### 5.2 P1 阶段（4-6周）

**目标**: 完善重要功能，支持 Provider 场景和合规声明

**时间表**:
- **第 1 周**: Provider 场景分账（任务 5.1）
- **第 2-3 周**: 商户 MPC 钱包管理（任务 6.1-6.2）
- **第 4-5 周**: Provider 集成（任务 7.1-7.2）
- **第 6 周**: 合规声明（任务 8.1-8.2）
- **第 7 周**: 端到端测试（任务 9.1）

**里程碑**:
- ✅ Provider 支付可以自动分账到商户 MPC 钱包
- ✅ 商户可以完整管理 MPC 钱包
- ✅ UI 显示合规声明
- ✅ TOS 和隐私政策更新

---

### 5.3 P2 阶段（2-4周）

**目标**: 优化功能，接入真实 Provider，完善文档

**时间表**:
- **第 1 周**: 智能合约优化（任务 10.1）
- **第 2 周**: 钱包恢复工具（任务 11.1）
- **第 3-4 周**: 真实 Provider 接入（任务 12.1）
- **第 5 周**: 安全审计准备（任务 13.1）
- **第 6 周**: 文档完善（任务 14.1）

**里程碑**:
- ✅ 接入真实 Provider（MoonPay、Transak）
- ✅ 完成安全审计
- ✅ 完善所有文档

---

## 6. 关键依赖关系

### 6.1 任务依赖图

```
任务 1.1 (_autoSplit)
    ↓
任务 1.2 (quickPaySplit) + 任务 1.3 (walletSplit) + 任务 1.4 (setSplitConfig)
    ↓
任务 4.1 (合约测试)
    ↓
任务 4.2 (集成测试)

任务 2.1 (私钥分片生成)
    ↓
任务 2.2 (2/3 签名机制)
    ↓
任务 2.3 (钱包创建 API)
    ↓
任务 2.4 (前端钱包创建界面)

任务 3.1 (Provider 抽象层)
    ↓
任务 7.1 (Provider 嵌入式集成)
    ↓
任务 7.2 (Provider On-ramp 流程)
```

### 6.2 并行任务

**可以并行执行的任务**:
- 任务 1.1-1.4（智能合约分账）和任务 2.1-2.4（MPC 钱包）可以并行
- 任务 3.1（Provider 抽象层）可以独立进行
- 任务 8.1-8.2（合规声明）可以独立进行

---

## 7. 风险提示

### 7.1 高风险任务

**任务 2.2: 2/3 签名机制**
- **风险**: 阈值签名实现复杂，可能需要使用多签钱包替代
- **缓解**: 提前研究阈值签名库，准备多签钱包替代方案

**任务 12.1: 接入真实 Provider**
- **风险**: Provider API 可能不稳定，需要处理各种错误情况
- **缓解**: 使用 Provider 抽象层，支持快速切换 Provider

### 7.2 时间风险

**P0 阶段可能延期**:
- MPC 钱包开发可能比预期复杂（7-10天 → 10-14天）
- 测试可能需要更多时间（3-5天 → 5-7天）

**建议**: 预留 20% 的缓冲时间

---

## 8. 总结

### 8.1 工作统计

| 优先级 | 任务数 | 工作量 | 时间 |
|--------|--------|--------|------|
| **P0** | 10项 | 35-50天 | 6-8周 |
| **P1** | 8项 | 30-40天 | 4-6周 |
| **P2** | 5项 | 20-30天 | 2-4周 |
| **总计** | **23项** | **85-120天** | **12-18周** |

### 8.2 关键里程碑

1. **P0 完成**: 支持 QuickPay 和钱包转账场景的分账（6-8周）
2. **P1 完成**: 支持 Provider 场景和合规声明（4-6周）
3. **P2 完成**: 接入真实 Provider 和完成审计（2-4周）

### 8.3 下一步行动

**立即开始**:
1. 任务 1.1: 实现统一分账函数 `_autoSplit`
2. 任务 2.1: 实现私钥分片生成
3. 任务 3.1: 实现 Provider 抽象层

---

**文档维护**: PayMind 开发团队  
**最后更新**: 2025年1月

