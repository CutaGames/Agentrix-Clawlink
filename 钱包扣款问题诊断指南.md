# é’±åŒ…æ‰£æ¬¾é—®é¢˜è¯Šæ–­æŒ‡å—

## é—®é¢˜æè¿°
ç”¨æˆ·åé¦ˆï¼šé’±åŒ…å®é™…æ²¡æœ‰æ‰£æ¬¾ï¼Œä½†äº¤æ˜“å·²ç»æˆåŠŸä¸Šé“¾ï¼ˆæœ‰txHashï¼‰ã€‚

## å…³é”®æ£€æŸ¥ç‚¹

### 1. æ£€æŸ¥äº¤æ˜“çŠ¶æ€ âš ï¸ **æœ€é‡è¦**
åœ¨ BSCScan ä¸ŠæŸ¥çœ‹äº¤æ˜“ï¼š
- äº¤æ˜“å“ˆå¸Œï¼š`0x8ee47dd418c6c87d89f0d542dfdba9a3359a2c925b3008eaae0ef4f77b3eb14c`
- æ£€æŸ¥äº¤æ˜“çŠ¶æ€ï¼š**Success** è¿˜æ˜¯ **Failed**
- å¦‚æœçŠ¶æ€æ˜¯ Failedï¼Œè¯´æ˜äº¤æ˜“revertäº†ï¼Œè½¬è´¦æ²¡æœ‰æ‰§è¡Œ

### 2. æ£€æŸ¥ PaymentExecuted äº‹ä»¶
åœ¨ BSCScan ä¸ŠæŸ¥çœ‹äº¤æ˜“çš„ Eventsï¼š
- åº”è¯¥æœ‰ä¸€ä¸ª `PaymentExecuted` äº‹ä»¶
- å¦‚æœæ²¡æœ‰è¿™ä¸ªäº‹ä»¶ï¼Œè¯´æ˜ `executeWithSession` å‡½æ•°æ²¡æœ‰æ‰§è¡Œåˆ°è½¬è´¦é‚£ä¸€æ­¥

### 3. æ£€æŸ¥ USDT è½¬è´¦è®°å½•
åœ¨ BSCScan ä¸ŠæŸ¥çœ‹äº¤æ˜“çš„ Token Transfersï¼š
- åº”è¯¥æœ‰ä¸€æ¡ä»ç”¨æˆ·é’±åŒ…åˆ° Commission åˆçº¦çš„ USDT è½¬è´¦
- å¦‚æœæ²¡æœ‰ï¼Œè¯´æ˜ `safeTransferFrom` å¤±è´¥äº†

### 4. æ£€æŸ¥æˆæƒçŠ¶æ€
```typescript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œ
const provider = new ethers.BrowserProvider(window.ethereum);
const signer = await provider.getSigner();
const userAddress = await signer.getAddress();

const tokenAddress = '0x337610d27c682E347C9cD60BD4b3b107C9d34dDd'; // USDT
const erc8004Address = '0x88b3993250Da39041C9263358C3c24C6a69a955e';

const tokenContract = new ethers.Contract(
  tokenAddress,
  ['function allowance(address owner, address spender) view returns (uint256)'],
  provider
);

const allowance = await tokenContract.allowance(userAddress, erc8004Address);
console.log('æˆæƒé¢åº¦:', ethers.formatUnits(allowance, 18), 'USDT');
```

### 5. æ£€æŸ¥ Session Owner
```typescript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œ
const erc8004Address = '0x88b3993250Da39041C9263358C3c24C6a69a955e';
const sessionId = '0xe99e2a37ca8a791187108beeef6775e91b73e0b7e26db4bf555688fc3d30d47f';

const erc8004Contract = new ethers.Contract(
  erc8004Address,
  ['function getSession(bytes32) view returns (tuple(address signer, address owner, uint256 singleLimit, uint256 dailyLimit, uint256 usedToday, uint256 expiry, uint256 lastResetDate, bool isActive))'],
  provider
);

const session = await erc8004Contract.getSession(sessionId);
console.log('Session Owner:', session.owner);
console.log('ç”¨æˆ·é’±åŒ…:', userAddress);
console.log('æ˜¯å¦åŒ¹é…:', session.owner.toLowerCase() === userAddress.toLowerCase());
```

### 6. æ£€æŸ¥ ERC8004 åˆçº¦ä½¿ç”¨çš„ä»£å¸åœ°å€
```typescript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œ
const erc8004Contract = new ethers.Contract(
  erc8004Address,
  ['function usdcToken() view returns (address)'],
  provider
);

const usdcToken = await erc8004Contract.usdcToken();
console.log('ERC8004 ä½¿ç”¨çš„ä»£å¸åœ°å€:', usdcToken);
console.log('å‰ç«¯æˆæƒçš„ä»£å¸åœ°å€:', tokenAddress);
console.log('æ˜¯å¦åŒ¹é…:', usdcToken.toLowerCase() === tokenAddress.toLowerCase());
```

## å¯èƒ½çš„åŸå› å’Œè§£å†³æ–¹æ¡ˆ

### åŸå›  1: äº¤æ˜“å®é™…å¤±è´¥ï¼ˆæœ€å¯èƒ½ï¼‰
**ç—‡çŠ¶**ï¼šBSCScan æ˜¾ç¤ºäº¤æ˜“çŠ¶æ€ä¸º Failed

**åŸå› **ï¼š
- æˆæƒä¸è¶³
- ä½™é¢ä¸è¶³
- å…¶ä»–åˆçº¦é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ BSCScan ä¸Šçš„äº¤æ˜“è¯¦æƒ…ï¼ŒæŸ¥çœ‹ revert reason
2. å¦‚æœæ˜¯å› ä¸ºæˆæƒä¸è¶³ï¼Œé‡æ–°åˆ›å»º Session ä»¥æˆæƒè¶³å¤Ÿçš„é¢åº¦
3. å¦‚æœæ˜¯å› ä¸ºä½™é¢ä¸è¶³ï¼Œç¡®ä¿é’±åŒ…æœ‰è¶³å¤Ÿçš„ USDT

### åŸå›  2: æˆæƒé¢åº¦ä¸è¶³
**ç—‡çŠ¶**ï¼šæˆæƒé¢åº¦ < æ”¯ä»˜é‡‘é¢

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ‰“å¼€ Session Manager
2. æ’¤é”€ç°æœ‰ Session
3. é‡æ–°åˆ›å»º Sessionï¼ˆä¼šè‡ªåŠ¨æˆæƒ dailyLimit * 3 çš„é¢åº¦ï¼‰

### åŸå›  3: ä»£å¸åœ°å€ä¸åŒ¹é…
**ç—‡çŠ¶**ï¼šERC8004 åˆçº¦ä½¿ç”¨çš„ä»£å¸åœ°å€ â‰  å‰ç«¯æˆæƒçš„ä»£å¸åœ°å€

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç¡®è®¤ ERC8004 åˆçº¦éƒ¨ç½²æ—¶ä½¿ç”¨çš„ä»£å¸åœ°å€
2. æ›´æ–°å‰ç«¯æˆæƒé€»è¾‘ï¼Œä½¿ç”¨æ­£ç¡®çš„ä»£å¸åœ°å€

### åŸå›  4: é’±åŒ…åœ°å€ä¸åŒ¹é…
**ç—‡çŠ¶**ï¼šSession Owner â‰  ç”¨æˆ·å½“å‰é’±åŒ…åœ°å€

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ä½¿ç”¨åˆ›å»º Session æ—¶çš„é’±åŒ…åœ°å€
2. æˆ–é‡æ–°åˆ›å»º Session

## å¿«é€Ÿè¯Šæ–­å‘½ä»¤

åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œä»¥ä¸‹ä»£ç è¿›è¡Œå®Œæ•´è¯Šæ–­ï¼š

```javascript
async function diagnosePayment() {
  const provider = new ethers.BrowserProvider(window.ethereum);
  const signer = await provider.getSigner();
  const userAddress = await signer.getAddress();
  
  const tokenAddress = '0x337610d27c682E347C9cD60BD4b3b107C9d34dDd';
  const erc8004Address = '0x88b3993250Da39041C9263358C3c24C6a69a955e';
  const sessionId = '0xe99e2a37ca8a791187108beeef6775e91b73e0b7e26db4bf555688fc3d30d47f';
  
  // 1. æ£€æŸ¥æˆæƒ
  const tokenContract = new ethers.Contract(
    tokenAddress,
    ['function allowance(address owner, address spender) view returns (uint256)', 'function balanceOf(address) view returns (uint256)'],
    provider
  );
  const allowance = await tokenContract.allowance(userAddress, erc8004Address);
  const balance = await tokenContract.balanceOf(userAddress);
  
  // 2. æ£€æŸ¥ Session
  const erc8004Contract = new ethers.Contract(
    erc8004Address,
    ['function getSession(bytes32) view returns (tuple(address signer, address owner, uint256 singleLimit, uint256 dailyLimit, uint256 usedToday, uint256 expiry, uint256 lastResetDate, bool isActive))', 'function usdcToken() view returns (address)'],
    provider
  );
  const session = await erc8004Contract.getSession(sessionId);
  const usdcToken = await erc8004Contract.usdcToken();
  
  console.log('ğŸ“‹ è¯Šæ–­ç»“æœ:');
  console.log('1. ç”¨æˆ·é’±åŒ…:', userAddress);
  console.log('2. Session Owner:', session.owner);
  console.log('3. åœ°å€åŒ¹é…:', session.owner.toLowerCase() === userAddress.toLowerCase());
  console.log('4. ERC8004ä»£å¸åœ°å€:', usdcToken);
  console.log('5. å‰ç«¯ä»£å¸åœ°å€:', tokenAddress);
  console.log('6. ä»£å¸åœ°å€åŒ¹é…:', usdcToken.toLowerCase() === tokenAddress.toLowerCase());
  console.log('7. æˆæƒé¢åº¦:', ethers.formatUnits(allowance, 18), 'USDT');
  console.log('8. é’±åŒ…ä½™é¢:', ethers.formatUnits(balance, 18), 'USDT');
  console.log('9. SessionçŠ¶æ€:', session.isActive ? 'æ¿€æ´»' : 'æœªæ¿€æ´»');
  console.log('10. Sessioné™é¢:', {
    singleLimit: ethers.formatUnits(session.singleLimit, 6),
    dailyLimit: ethers.formatUnits(session.dailyLimit, 6),
    usedToday: ethers.formatUnits(session.usedToday, 6),
  });
}

diagnosePayment();
```

