# X402 å•†å“è·å–æµç¨‹æ–‡æ¡£

## 1. æ¦‚è¿°

X402 æ˜¯ä¸€ç§åŸºäº HTTP 402 çŠ¶æ€ç çš„å»ä¸­å¿ƒåŒ–æ”¯ä»˜åè®®ï¼Œå…è®¸ API æœåŠ¡æä¾›å•†é€šè¿‡åŒºå—é“¾æ¥å—å¾®æ”¯ä»˜ã€‚Agentrix å¹³å°æ”¯æŒ X402 åè®®å•†å“çš„è‡ªåŠ¨å‘ç°å’ŒåŒæ­¥ã€‚

## 2. å½“å‰çŠ¶æ€

**æˆ‘ä»¬ç›®å‰å¤„äºç¬¬ 1 æ­¥ï¼šå•†å“å±•ç¤ºå’ŒåŠ è½½**

- âœ… åç«¯ API æ­£å¸¸è¿”å› X402 å•†å“åˆ—è¡¨
- âœ… æ•°æ®åº“ä¸­å·²æœ‰ 5 ä¸ª X402 ç¤ºä¾‹å•†å“
- ğŸ”„ å‰ç«¯è‡ªåŠ¨è·å–åŠŸèƒ½éœ€è¦ç”¨æˆ·ç™»å½•è®¤è¯

## 3. å®Œæ•´æµç¨‹å›¾

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant Frontend as å‰ç«¯
    participant Backend as åç«¯ API
    participant DB as æ•°æ®åº“
    participant X402Net as X402 ç½‘ç»œ
    participant Chain as BSC é“¾

    %% æ­¥éª¤1: åŠ è½½å•†å“åˆ—è¡¨
    rect rgb(200, 230, 200)
        Note over User, DB: æ­¥éª¤1: åŠ è½½ X402 å•†å“åˆ—è¡¨ï¼ˆæ— éœ€ç™»å½•ï¼‰
        User->>Frontend: è®¿é—® X402 ä¸“åŒº
        Frontend->>Backend: GET /api/products?type=x402
        Backend->>DB: æŸ¥è¯¢ x402Enabled å•†å“
        DB-->>Backend: è¿”å›å•†å“åˆ—è¡¨
        Backend-->>Frontend: å•†å“æ•°æ®
        Frontend-->>User: å±•ç¤ºå•†å“å¡ç‰‡
    end

    %% æ­¥éª¤2: è‡ªåŠ¨è·å–
    rect rgb(200, 220, 250)
        Note over User, X402Net: æ­¥éª¤2: è‡ªåŠ¨è·å– X402 å•†å“ï¼ˆéœ€è¦ç™»å½•ï¼‰
        User->>Frontend: ç‚¹å‡»"è‡ªåŠ¨è·å– X402 å•†å“"
        Frontend->>Backend: POST /api/products/x402/auto-fetch<br/>(å¸¦ Authorization Header)
        Backend->>X402Net: è¯·æ±‚ X402 æœåŠ¡å‘ç°ç«¯ç‚¹
        X402Net-->>Backend: è¿”å›æœåŠ¡å…ƒæ•°æ®
        Backend->>DB: åˆ›å»º/æ›´æ–°å•†å“
        Backend-->>Frontend: åŒæ­¥ç»“æœ
        Frontend->>Backend: GET /api/products?type=x402
        Backend-->>Frontend: æ›´æ–°åçš„å•†å“åˆ—è¡¨
        Frontend-->>User: åˆ·æ–°å±•ç¤º
    end

    %% æ­¥éª¤3: è´­ä¹°å•†å“
    rect rgb(250, 220, 200)
        Note over User, Chain: æ­¥éª¤3: è´­ä¹° X402 å•†å“
        User->>Frontend: é€‰æ‹©å•†å“å¹¶è´­ä¹°
        Frontend->>Backend: åˆ›å»ºæ”¯ä»˜è®¢å•
        Backend->>Chain: è°ƒç”¨ X402 æ”¯ä»˜åˆçº¦
        Chain-->>Backend: æ”¯ä»˜ç¡®è®¤
        Backend->>DB: è®°å½•äº¤æ˜“
        Backend-->>Frontend: è´­ä¹°æˆåŠŸ
        Frontend-->>User: è·å–æœåŠ¡è®¿é—®æƒ
    end
```

## 4. è¯¦ç»†æ­¥éª¤è¯´æ˜

### æ­¥éª¤ 1: åŠ è½½å•†å“åˆ—è¡¨ï¼ˆå½“å‰å¯ç”¨ï¼‰

**å‰ç«¯è°ƒç”¨:**
```typescript
// frontend/lib/api/product.api.ts
const data = await productApi.getProducts({ type: 'x402' });
```

**åç«¯å¤„ç†:**
```typescript
// backend/src/modules/product/product.service.ts
// ä½¿ç”¨ QueryBuilder æŸ¥è¯¢ JSONB å­—æ®µ
qb.andWhere(`(product.metadata->>'x402Enabled' = 'true' OR product.metadata->'x402Params' IS NOT NULL)`);
```

**API ç«¯ç‚¹:** `GET /api/products?type=x402`  
**è®¤è¯:** æ— éœ€ç™»å½•ï¼ˆå…¬å¼€æ¥å£ï¼‰

### æ­¥éª¤ 2: è‡ªåŠ¨è·å–å•†å“ï¼ˆéœ€è¦ç™»å½•ï¼‰

**å‰ç«¯è°ƒç”¨:**
```typescript
// frontend/components/marketplace/X402ProductSection.tsx
const response = await fetch(`${apiBaseUrl}/products/x402/auto-fetch`, {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json',
  },
});
```

**åç«¯å¤„ç†:**
```typescript
// backend/src/modules/product/product.service.ts
async autoFetchX402Products(userId: string) {
  // 1. ä» X402 æœåŠ¡å‘ç°ç«¯ç‚¹è·å–å•†å“
  const fetchedProducts = await this.fetchFromX402Network();
  
  // 2. åŒæ­¥åˆ°æ•°æ®åº“
  for (const product of fetchedProducts) {
    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼Œæ›´æ–°æˆ–åˆ›å»º
  }
}
```

**API ç«¯ç‚¹:** `POST /api/products/x402/auto-fetch`  
**è®¤è¯:** éœ€è¦ JWT Token æˆ–é’±åŒ…è¿æ¥

### æ­¥éª¤ 3: è´­ä¹°å•†å“ï¼ˆæœªå®Œå…¨å®ç°ï¼‰

ç›®å‰è´­ä¹°æµç¨‹ä½¿ç”¨æ ‡å‡†æ”¯ä»˜é€šé“ï¼ŒX402 åŸç”Ÿæ”¯ä»˜åŠŸèƒ½å°šæœªå®Œå…¨å®ç°ã€‚

## 5. å…¬é“¾ä¸ç½‘ç»œåŒºåˆ†

### å½“å‰æ”¯æŒ

| ç½‘ç»œ | Chain ID | çŠ¶æ€ |
|------|----------|------|
| BSC Testnet | 97 | âœ… ä¸»è¦æ”¯æŒ |
| BSC Mainnet | 56 | ğŸ”„ å‡†å¤‡ä¸­ |
| Ethereum Mainnet | 1 | ğŸ“‹ è®¡åˆ’ä¸­ |
| Polygon | 137 | ğŸ“‹ è®¡åˆ’ä¸­ |

### ç½‘ç»œé…ç½®

```env
# backend/.env
CHAIN_ID=97
BSC_TESTNET_RPC_URL=https://bsc-testnet.nodereal.io/v1/...
ERC8004_CONTRACT_ADDRESS=0x3310a6e841877f28C755bFb5aF90e6734EF059fA
```

### æµ‹è¯•ç½‘ vs ä¸»ç½‘

- **æµ‹è¯•ç½‘ (BSC Testnet, Chain ID 97)**
  - å½“å‰å¼€å‘å’Œæµ‹è¯•ç¯å¢ƒ
  - ä½¿ç”¨æµ‹è¯•ä»£å¸ (USDT)
  - åˆçº¦åœ°å€: `0x3310a6e841877f28C755bFb5aF90e6734EF059fA`

- **ä¸»ç½‘ (BSC Mainnet, Chain ID 56)**
  - ç”Ÿäº§ç¯å¢ƒï¼ˆæœªéƒ¨ç½²ï¼‰
  - éœ€è¦éƒ¨ç½²æ–°åˆçº¦
  - ä½¿ç”¨çœŸå®ä»£å¸

## 6. X402 æœåŠ¡å‘ç°

### å½“å‰æœåŠ¡æº

```typescript
const x402ServiceUrls = [
  'https://raw.githubusercontent.com/coinbase/x402/master/examples/weather-service/x402.json',
  // å¯æ·»åŠ æ›´å¤šå·²çŸ¥çš„ X402 æœåŠ¡ç«¯ç‚¹
];
```

### é»˜è®¤ç¤ºä¾‹å•†å“

å½“å¤–éƒ¨æœåŠ¡ä¸å¯ç”¨æ—¶ï¼Œç³»ç»Ÿæä¾› 5 ä¸ªç¤ºä¾‹å•†å“ï¼š

1. **AI å›¾åƒç”Ÿæˆ API** - 0.01 USDT/æ¬¡
2. **GPT-4 å¯¹è¯ API** - 0.005 USDT/æ¬¡
3. **å®æ—¶å¸‚åœºæ•°æ®** - 0.001 USDT/æ¬¡
4. **GPU è®¡ç®—æœåŠ¡** - 0.0001 USDT/ç§’
5. **å»ä¸­å¿ƒåŒ–å­˜å‚¨** - 0.00001 USDT/MB

## 7. å•†å“æ•°æ®ç»“æ„

```typescript
interface X402Product {
  id: string;
  name: string;
  description: string;
  price: number;  // åŸºç¡€ä»·æ ¼ï¼ˆå¯èƒ½ä¸º 0ï¼Œå®é™…ä»·æ ¼åœ¨ x402Params ä¸­ï¼‰
  metadata: {
    x402Enabled: boolean;
    x402Network: string;  // 'BSC Testnet' | 'BSC Mainnet' | etc.
    x402Params: {
      scheme: 'exact' | 'upto';
      currency: 'USDT' | 'USDC' | 'ETH';
      paymentAddress: string;
      // è®¡ä»·æ–¹å¼ï¼ˆå–å…¶ä¸€ï¼‰
      pricePerRequest?: string;  // æ¯æ¬¡è°ƒç”¨
      pricePerQuery?: string;    // æ¯æ¬¡æŸ¥è¯¢
      pricePerSecond?: string;   // æ¯ç§’è®¡è´¹
      pricePerMB?: string;       // æ¯ MB è®¡è´¹
    };
    sourceUrl: string;
    lastSyncAt: string;
  };
}
```

## 8. æ•…éšœæ’é™¤

### "fail to fetch" é”™è¯¯

1. æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œ (`npm run start:dev`)
2. æ£€æŸ¥ç½‘ç»œè¿æ¥
3. ç¡®è®¤ç”¨æˆ·å·²ç™»å½•ï¼ˆéœ€è¦ `access_token`ï¼‰

### "ç™»å½•å·²è¿‡æœŸ" é”™è¯¯

1. é‡æ–°ç™»å½•è·å–æ–° token
2. æˆ–è¿æ¥é’±åŒ…è¿›è¡Œé’±åŒ…è®¤è¯

### å•†å“ä»·æ ¼æ˜¾ç¤º 0.00

è¿™æ˜¯æ­£å¸¸çš„ï¼X402 å•†å“çš„å®é™…ä»·æ ¼åœ¨ `metadata.x402Params` ä¸­ï¼š
- `pricePerRequest`: æŒ‰æ¬¡è®¡è´¹
- `pricePerSecond`: æŒ‰ç§’è®¡è´¹
- `pricePerMB`: æŒ‰å­˜å‚¨å®¹é‡è®¡è´¹

## 9. ä¸‹ä¸€æ­¥è®¡åˆ’

1. **å®ç° X402 åŸç”Ÿæ”¯ä»˜**
   - é›†æˆ X402 æ”¯ä»˜åˆçº¦
   - æ”¯æŒå¾®æ”¯ä»˜æµå¼ä»˜æ¬¾

2. **æ·»åŠ æ›´å¤š X402 æœåŠ¡æº**
   - æ”¯æŒè‡ªå®šä¹‰æœåŠ¡å‘ç° URL
   - æ¥å…¥ X402 æœåŠ¡æ³¨å†Œè¡¨

3. **æ”¯æŒå¤šé“¾**
   - éƒ¨ç½²ä¸»ç½‘åˆçº¦
   - æ”¯æŒ Ethereumã€Polygon ç­‰ç½‘ç»œ

4. **å•†æˆ·è‡ªåŠ©ä¸Šæ¶**
   - å…è®¸å•†æˆ·æ³¨å†Œè‡ªå·±çš„ X402 æœåŠ¡
   - æä¾› X402 æœåŠ¡é…ç½®å‘å¯¼
