# PayMind å•†æˆ·å®šä»·æ¨¡å¼å¯¹ç³»ç»Ÿå½±å“åˆ†æ V1.0
## å•†æˆ·è‡ªä¸»å®šä»·å¯¹æ™ºèƒ½è·¯ç”±å’Œæ”¯ä»˜æµç¨‹çš„å½±å“

**ç‰ˆæœ¬**: 1.0  
**æ—¥æœŸ**: 2025å¹´1æœˆ  
**è®¾è®¡ç†å¿µ**: å•†æˆ·è‡ªä¸»å®šä»·ã€æ™ºèƒ½è·¯ç”±é€‚é…ã€æµç¨‹ä¼˜åŒ–ã€äº§å“å®Œå–„

---

## ğŸ“‹ ç›®å½•

1. [å½±å“åˆ†ææ€»è§ˆ](#1-å½±å“åˆ†ææ€»è§ˆ)
2. [å¯¹æ™ºèƒ½è·¯ç”±çš„å½±å“](#2-å¯¹æ™ºèƒ½è·¯ç”±çš„å½±å“)
3. [å¯¹æ”¯ä»˜æµç¨‹çš„å½±å“](#3-å¯¹æ”¯ä»˜æµç¨‹çš„å½±å“)
4. [å¯¹åˆ†ä½£è®¡ç®—çš„å½±å“](#4-å¯¹åˆ†ä½£è®¡ç®—çš„å½±å“)
5. [å¯¹Agent IDä½“ç³»çš„å½±å“](#5-å¯¹agent-idä½“ç³»çš„å½±å“)
6. [å¯¹SLAæ²»ç†æœºåˆ¶çš„å½±å“](#6-å¯¹slaæ²»ç†æœºåˆ¶çš„å½±å“)
7. [å¯¹ç»Ÿä¸€æ”¯ä»˜æµç¨‹çš„å½±å“](#7-å¯¹ç»Ÿä¸€æ”¯ä»˜æµç¨‹çš„å½±å“)
8. [äº§å“è®¾è®¡æ”¹å˜æ¸…å•](#8-äº§å“è®¾è®¡æ”¹å˜æ¸…å•)
9. [å®ç°æ–¹æ¡ˆ](#9-å®ç°æ–¹æ¡ˆ)
10. [è¿ç§»ç­–ç•¥](#10-è¿ç§»ç­–ç•¥)

---

## 1. å½±å“åˆ†ææ€»è§ˆ

### 1.1 æ ¸å¿ƒæ”¹å˜

**æ”¹å˜å‰**ï¼š
- æ™ºèƒ½è·¯ç”±åŸºäºé€šé“æˆæœ¬è®¡ç®—ä»·æ ¼
- ä»·æ ¼ = å•†å“åŸºç¡€ä»·æ ¼ + é€šé“è´¹ç”¨ï¼ˆå•†æˆ·æ‰¿æ‹…ï¼‰
- ç¨è´¹è‡ªåŠ¨è®¡ç®—

**æ”¹å˜å**ï¼š
- å•†æˆ·è‡ªä¸»è®¾ç½®ä»·æ ¼ï¼ˆæ ¹æ®é€šé“ã€å›½å®¶ã€ç¨è´¹ç­‰ï¼‰
- ä»·æ ¼ = å•†æˆ·è®¾ç½®çš„ä»·æ ¼ï¼ˆå·²åŒ…å«ç¨è´¹ï¼‰
- æ™ºèƒ½è·¯ç”±åŸºäºå•†æˆ·è®¾ç½®çš„ä»·æ ¼è¿›è¡Œæ¨è

### 1.2 å½±å“èŒƒå›´

| æ¨¡å— | å½±å“ç¨‹åº¦ | ä¸»è¦æ”¹å˜ |
|------|---------|---------|
| **æ™ºèƒ½è·¯ç”±** | â­â­â­â­ | éœ€è¦ä»å•†æˆ·ä»·æ ¼è®¾ç½®ä¸­è·å–ä»·æ ¼ï¼Œè€Œéè‡ªå·±è®¡ç®—ï¼›æ”¯æŒå…¨çƒ200+å›½å®¶ï¼Œ150+ç§è´§å¸ |
| **æ”¯ä»˜æµç¨‹** | â­â­â­ | éœ€è¦å…ˆè·å–ä»·æ ¼ï¼Œå†è¿›è¡Œè·¯ç”±ï¼›ç»Ÿä¸€æ”¯ä»˜æµç¨‹é€‚é…æ‰€æœ‰åœºæ™¯ |
| **å•†æˆ·åå°** | â­â­â­â­â­ | éœ€è¦å¢åŠ ä»·æ ¼è®¾ç½®åŠŸèƒ½ï¼ˆåŸºç¡€ä»·æ ¼ã€å›½å®¶ä»·æ ¼ã€é€šé“ä»·æ ¼ï¼‰ |
| **ç”¨æˆ·å‰ç«¯** | â­â­â­ | éœ€è¦æ˜¾ç¤ºå•†æˆ·è®¾ç½®çš„ä»·æ ¼ï¼›æ˜¾ç¤ºä»·æ ¼å¯¹æ¯”å’Œæ¨è |
| **åˆ†ä½£è®¡ç®—** | â­â­â­ | éœ€è¦åŸºäºå•†æˆ·ç¨å‰ä»·æ ¼è®¡ç®—ï¼›ç®€åŒ–åˆ†ä½£ï¼ˆå•†æˆ·ä»·æ ¼ Ã— å›ºå®šæ¯”ä¾‹ï¼‰ |
| **æ”¶å…¥è®¡ç®—** | â­â­â­ | éœ€è¦åŒºåˆ†å•†æˆ·ç¨å‰æ”¶å…¥å’Œå®é™…æ”¶å…¥ï¼›è€ƒè™‘ç¨è´¹ã€é€šé“è´¹ç”¨ |
| **Agent IDä½“ç³»** | â­â­ | æ”¯æŒERC 8004ã€å¤šé“¾å…¼å®¹ã€DIDåè®®ï¼›ä¸å½±å“å®šä»·ï¼Œä½†å½±å“åˆ†ä½£è®¡ç®— |
| **SLAæ²»ç†** | â­â­ | è®°å½•æ”¯ä»˜SLAæŒ‡æ ‡ï¼›ä¸å½±å“å®šä»·ï¼Œä½†å½±å“æœåŠ¡è´¨é‡ç›‘æ§ |
| **ç»Ÿä¸€æ”¯ä»˜æµç¨‹** | â­â­â­ | éœ€è¦é€‚é…å•†æˆ·å®šä»·æ¨¡å¼ï¼›ä¿æŒ7é˜¶æ®µæµç¨‹ä¸å˜ |

---

## 2. å¯¹æ™ºèƒ½è·¯ç”±çš„å½±å“

### 2.1 è·¯ç”±å†³ç­–é€»è¾‘æ”¹å˜

#### 2.1.1 æ”¹å˜å‰

```
æ™ºèƒ½è·¯ç”±å†³ç­–æµç¨‹ï¼š
  1. è·å–å•†å“åŸºç¡€ä»·æ ¼
  2. è®¡ç®—å„é€šé“æˆæœ¬
  3. è®¡ç®—å„é€šé“æœ€ç»ˆä»·æ ¼ï¼ˆåŸºç¡€ä»·æ ¼ + é€šé“è´¹ç”¨ï¼‰
  4. é€‰æ‹©ä»·æ ¼æœ€ä½çš„é€šé“
  5. è¿”å›æ¨èé€šé“å’Œä»·æ ¼
```

#### 2.1.2 æ”¹å˜å

```
æ™ºèƒ½è·¯ç”±å†³ç­–æµç¨‹ï¼š
  1. è·å–ç”¨æˆ·æ‰€åœ¨å›½å®¶
  2. è·å–å•†æˆ·è®¾ç½®çš„ä»·æ ¼ï¼ˆæ ¹æ®å›½å®¶ã€é€šé“ï¼‰
  3. è·å–å¯ç”¨é€šé“åˆ—è¡¨
  4. è·å–å„é€šé“çš„å•†æˆ·è®¾ç½®ä»·æ ¼
  5. æ¯”è¾ƒå„é€šé“ä»·æ ¼ï¼ˆå•†æˆ·å·²è®¾ç½®ï¼‰
  6. é€‰æ‹©ä»·æ ¼æœ€ä½çš„é€šé“
  7. è¿”å›æ¨èé€šé“å’Œä»·æ ¼
```

### 2.2 ä»·æ ¼è·å–é€»è¾‘

#### 2.2.1 ä»·æ ¼è·å–ä¼˜å…ˆçº§

```
è·å–å•†å“ä»·æ ¼ï¼š
  1. æ£€æŸ¥æ˜¯å¦æœ‰é€šé“+å›½å®¶ä»·æ ¼è®¾ç½®
     â””â”€â†’ æœ‰ï¼šä½¿ç”¨è¯¥ä»·æ ¼
  2. æ£€æŸ¥æ˜¯å¦æœ‰å›½å®¶ä»·æ ¼è®¾ç½®
     â””â”€â†’ æœ‰ï¼šä½¿ç”¨è¯¥ä»·æ ¼
  3. æ£€æŸ¥æ˜¯å¦æœ‰é€šé“ä»·æ ¼è®¾ç½®
     â””â”€â†’ æœ‰ï¼šä½¿ç”¨è¯¥ä»·æ ¼
  4. ä½¿ç”¨åŸºç¡€ä»·æ ¼
     â””â”€â†’ è‡ªåŠ¨è®¡ç®—ç¨è´¹ï¼ˆå¦‚æœæœªè®¾ç½®ï¼‰
```

#### 2.2.2 ä»·æ ¼è®¡ç®—æœåŠ¡è°ƒæ•´

```typescript
@Injectable()
export class SmartRouterService {
  /**
   * é€‰æ‹©æœ€ä½³æ”¯ä»˜é€šé“ï¼ˆå¢å¼ºç‰ˆï¼Œæ”¯æŒå•†æˆ·ä»·æ ¼è®¾ç½®ï¼‰
   */
  async selectBestChannel(
    productId: string,
    countryCode: string,
    currency: string,
    context?: RoutingContext,
  ): Promise<RoutingDecision> {
    // 1. è·å–å¯ç”¨é€šé“
    const availableChannels = await this.getAvailableChannels(
      countryCode,
      currency,
      context,
    );
    
    // 2. è·å–å„é€šé“çš„å•†æˆ·è®¾ç½®ä»·æ ¼
    const channelPrices = await Promise.all(
      availableChannels.map(async (channel) => {
        const price = await this.pricingService.getProductPrice(
          productId,
          countryCode,
          channel.method,
        );
        return {
          channel,
          price: price.finalPrice, // å•†æˆ·è®¾ç½®çš„æœ€ç»ˆä»·æ ¼
          basePrice: price.basePrice, // å•†æˆ·ç¨å‰ä»·æ ¼
          taxAmount: price.taxAmount, // ç¨è´¹
        };
      }),
    );
    
    // 3. æŒ‰ä»·æ ¼æ’åºï¼ˆä»·æ ¼æœ€ä½ä¼˜å…ˆï¼‰
    channelPrices.sort((a, b) => a.price - b.price);
    
    // 4. é€‰æ‹©ä»·æ ¼æœ€ä½çš„é€šé“
    const recommended = channelPrices[0];
    
    // 5. ç”Ÿæˆä»·æ ¼å¯¹æ¯”
    const priceComparison = channelPrices.map((cp) => ({
      method: cp.channel.method,
      price: cp.price,
      basePrice: cp.basePrice,
      taxAmount: cp.taxAmount,
    }));
    
    return {
      recommendedMethod: recommended.channel.method,
      channels: availableChannels,
      price: recommended.price,
      basePrice: recommended.basePrice,
      taxAmount: recommended.taxAmount,
      priceComparison,
      reason: `ä»·æ ¼æœ€ä½ï¼š${recommended.price} ${currency}`,
    };
  }
}
```

### 2.3 è¯„åˆ†ç³»ç»Ÿè°ƒæ•´

#### 2.3.1 è¯„åˆ†ç»´åº¦è°ƒæ•´

**æ”¹å˜å‰**ï¼š
- æˆæœ¬å¾—åˆ†ï¼šåŸºäºé€šé“è´¹ç”¨
- ä»·æ ¼å¾—åˆ†ï¼šåŸºäºè®¡ç®—çš„ä»·æ ¼

**æ”¹å˜å**ï¼š
- ä»·æ ¼å¾—åˆ†ï¼šåŸºäºå•†æˆ·è®¾ç½®çš„ä»·æ ¼ï¼ˆä¸»è¦å› ç´ ï¼‰
- é€Ÿåº¦å¾—åˆ†ï¼šåŸºäºé€šé“å¤„ç†é€Ÿåº¦
- æˆåŠŸç‡å¾—åˆ†ï¼šåŸºäºé€šé“æˆåŠŸç‡
- å®‰å…¨æ€§å¾—åˆ†ï¼šåŸºäºé€šé“å®‰å…¨æ€§

#### 2.3.2 è¯„åˆ†å…¬å¼è°ƒæ•´

**æ”¹å˜å‰**ï¼š
```
ç»¼åˆå¾—åˆ† = æˆæœ¬å¾—åˆ† Ã— 30% + é€Ÿåº¦å¾—åˆ† Ã— 25% + æˆåŠŸç‡å¾—åˆ† Ã— 25% + 
           å®‰å…¨æ€§å¾—åˆ† Ã— 10% + è¦†ç›–èŒƒå›´å¾—åˆ† Ã— 5% + ç”¨æˆ·ä½“éªŒå¾—åˆ† Ã— 5%
```

**æ”¹å˜å**ï¼š
```
ç»¼åˆå¾—åˆ† = ä»·æ ¼å¾—åˆ† Ã— 40% + é€Ÿåº¦å¾—åˆ† Ã— 25% + æˆåŠŸç‡å¾—åˆ† Ã— 20% + 
           å®‰å…¨æ€§å¾—åˆ† Ã— 10% + è¦†ç›–èŒƒå›´å¾—åˆ† Ã— 3% + ç”¨æˆ·ä½“éªŒå¾—åˆ† Ã— 2%

ä»·æ ¼å¾—åˆ† = 1 / (å•†æˆ·è®¾ç½®ä»·æ ¼ / æœ€ä½ä»·æ ¼)
```

### 2.4 ä»·æ ¼å¯¹æ¯”é€»è¾‘

#### 2.4.1 ä»·æ ¼å¯¹æ¯”æ•°æ®æº

**æ”¹å˜å‰**ï¼š
- ä»·æ ¼å¯¹æ¯”åŸºäºé€šé“æˆæœ¬è®¡ç®—
- æ‰€æœ‰é€šé“ä½¿ç”¨ç›¸åŒåŸºç¡€ä»·æ ¼

**æ”¹å˜å**ï¼š
- ä»·æ ¼å¯¹æ¯”åŸºäºå•†æˆ·è®¾ç½®çš„ä»·æ ¼
- ä¸åŒé€šé“å¯èƒ½æœ‰ä¸åŒä»·æ ¼ï¼ˆå•†æˆ·è®¾ç½®ï¼‰

#### 2.4.2 ä»·æ ¼å¯¹æ¯”æ˜¾ç¤º

```typescript
interface PriceComparison {
  channels: Array<{
    method: PaymentMethod;
    price: number;        // å•†æˆ·è®¾ç½®çš„æœ€ç»ˆä»·æ ¼
    basePrice: number;    // å•†æˆ·ç¨å‰ä»·æ ¼
    taxAmount: number;    // ç¨è´¹
    channelFee?: number; // é€šé“è´¹ç”¨ï¼ˆå¦‚æœå•†æˆ·è®¾ç½®ï¼‰
  }>;
  recommended: PaymentMethod; // æ¨èé€šé“ï¼ˆä»·æ ¼æœ€ä½ï¼‰
  priceDifference: number;   // ä»·æ ¼å·®å¼‚
}
```

---

## 3. å¯¹æ”¯ä»˜æµç¨‹çš„å½±å“

### 3.1 æ”¯ä»˜æµç¨‹è°ƒæ•´

#### 3.1.1 æ”¹å˜å‰çš„æµç¨‹

```
ç”¨æˆ·å‘èµ·æ”¯ä»˜
    â†“
è·å–å•†å“åŸºç¡€ä»·æ ¼
    â†“
æ™ºèƒ½è·¯ç”±é€‰æ‹©é€šé“
    â†“
è®¡ç®—æœ€ç»ˆä»·æ ¼ï¼ˆåŸºç¡€ä»·æ ¼ + é€šé“è´¹ç”¨ï¼‰
    â†“
ç”¨æˆ·æ”¯ä»˜
    â†“
æ‰§è¡Œæ”¯ä»˜
```

#### 3.1.2 æ”¹å˜åçš„æµç¨‹

```
ç”¨æˆ·å‘èµ·æ”¯ä»˜
    â†“
è·å–ç”¨æˆ·æ‰€åœ¨å›½å®¶
    â†“
è·å–å•†æˆ·è®¾ç½®çš„ä»·æ ¼ï¼ˆæ ¹æ®å›½å®¶ã€é€šé“ï¼‰
    â†“
æ™ºèƒ½è·¯ç”±é€‰æ‹©é€šé“ï¼ˆåŸºäºå•†æˆ·è®¾ç½®çš„ä»·æ ¼ï¼‰
    â†“
ç”¨æˆ·æ”¯ä»˜ï¼ˆå•†æˆ·è®¾ç½®çš„æœ€ç»ˆä»·æ ¼ï¼‰
    â†“
æ‰§è¡Œæ”¯ä»˜
    â†“
è®¡ç®—å•†æˆ·æ”¶å…¥ï¼ˆåŸºäºå•†æˆ·ç¨å‰ä»·æ ¼ï¼‰
```

### 3.2 æ”¯ä»˜è¯·æ±‚å‚æ•°è°ƒæ•´

#### 3.2.1 æ”¹å˜å‰çš„å‚æ•°

```typescript
interface PaymentRequest {
  productId: string;
  amount: number;        // å•†å“åŸºç¡€ä»·æ ¼
  currency: string;
  paymentMethod?: PaymentMethod;
}
```

#### 3.2.2 æ”¹å˜åçš„å‚æ•°

```typescript
interface PaymentRequest {
  productId: string;
  countryCode: string;   // æ–°å¢ï¼šç”¨æˆ·æ‰€åœ¨å›½å®¶
  currency: string;
  paymentMethod?: PaymentMethod;
  // amount ä¸å†éœ€è¦ï¼Œä»å•†æˆ·ä»·æ ¼è®¾ç½®ä¸­è·å–
}
```

### 3.3 æ”¯ä»˜å¤„ç†é€»è¾‘è°ƒæ•´

#### 3.3.1 ä»·æ ¼è·å–æ—¶æœº

**æ”¹å˜å‰**ï¼š
- æ”¯ä»˜æ—¶ä½¿ç”¨è¯·æ±‚ä¸­çš„é‡‘é¢
- æ™ºèƒ½è·¯ç”±è®¡ç®—æœ€ç»ˆä»·æ ¼

**æ”¹å˜å**ï¼š
- æ”¯ä»˜å‰å…ˆè·å–å•†æˆ·è®¾ç½®çš„ä»·æ ¼
- æ™ºèƒ½è·¯ç”±åŸºäºå•†æˆ·ä»·æ ¼æ¨èé€šé“
- æ”¯ä»˜æ—¶ä½¿ç”¨å•†æˆ·è®¾ç½®çš„æœ€ç»ˆä»·æ ¼

#### 3.3.2 æ”¯ä»˜æœåŠ¡è°ƒæ•´

```typescript
@Injectable()
export class PaymentService {
  /**
   * åˆ›å»ºæ”¯ä»˜ï¼ˆæ”¯æŒå•†æˆ·ä»·æ ¼è®¾ç½®ï¼‰
   */
  async createPayment(
    userId: string,
    productId: string,
    countryCode: string,
    currency: string,
    paymentMethod?: PaymentMethod,
  ): Promise<Payment> {
    // 1. è·å–å•†æˆ·è®¾ç½®çš„ä»·æ ¼
    const pricing = await this.pricingService.getProductPrice(
      productId,
      countryCode,
      paymentMethod,
    );
    
    // 2. å¦‚æœæ²¡æœ‰æŒ‡å®šæ”¯ä»˜æ–¹å¼ï¼Œä½¿ç”¨æ™ºèƒ½è·¯ç”±æ¨è
    if (!paymentMethod) {
      const routing = await this.smartRouter.selectBestChannel(
        productId,
        countryCode,
        currency,
      );
      paymentMethod = routing.recommendedMethod;
      // ä½¿ç”¨æ¨èé€šé“çš„ä»·æ ¼
      const recommendedPricing = await this.pricingService.getProductPrice(
        productId,
        countryCode,
        paymentMethod,
      );
      pricing.finalPrice = recommendedPricing.finalPrice;
    }
    
    // 3. åˆ›å»ºæ”¯ä»˜è®°å½•
    const payment = await this.paymentRepository.save({
      userId,
      productId,
      amount: pricing.finalPrice,      // ç”¨æˆ·æ”¯ä»˜é‡‘é¢ï¼ˆå«ç¨ï¼‰
      baseAmount: pricing.basePrice,   // å•†æˆ·ç¨å‰ä»·æ ¼
      taxAmount: pricing.taxAmount,    // ç¨è´¹
      currency,
      countryCode,
      paymentMethod,
      status: PaymentStatus.PENDING,
    });
    
    return payment;
  }
}
```

### 3.4 åˆ†ä½£è®¡ç®—è°ƒæ•´

#### 3.4.1 åˆ†ä½£è®¡ç®—åŸºç¡€

**æ”¹å˜å‰**ï¼š
- åˆ†ä½£åŸºäºå•†å“åŸºç¡€ä»·æ ¼
- å›ºå®šä½£é‡‘æ¯”ä¾‹

**æ”¹å˜å**ï¼š
- åˆ†ä½£åŸºäºå•†æˆ·ç¨å‰ä»·æ ¼ï¼ˆbasePriceï¼‰
- å›ºå®šä½£é‡‘æ¯”ä¾‹
- ç¨è´¹ä¸å½±å“åˆ†ä½£è®¡ç®—

#### 3.4.2 åˆ†ä½£è®¡ç®—å…¬å¼

```typescript
// å•†æˆ·ç¨å‰ä»·æ ¼ï¼ˆä¸å«ç¨ï¼‰
const basePrice = pricing.basePrice;

// åˆ†ä½£è®¡ç®—ï¼ˆåŸºäºå•†æˆ·ç¨å‰ä»·æ ¼ï¼‰
const agentCommission = basePrice * agentCommissionRate;
const paymindFee = basePrice * paymindFeeRate;

// å•†æˆ·å®é™…æ”¶å…¥
const merchantIncome = basePrice - agentCommission - paymindFee - channelFee;
```

---

## 4. å¯¹åˆ†ä½£è®¡ç®—çš„å½±å“

### 4.1 åˆ†ä½£è®¡ç®—åŸºç¡€æ”¹å˜

#### 4.1.1 æ”¹å˜å‰

**åˆ†ä½£è®¡ç®—åŸºç¡€**ï¼š
- åŸºäºå¯åˆ†é…é‡‘é¢ï¼ˆæ‰£é™¤é€šé“è´¹ç”¨åï¼‰
- è®¡ç®—å¤æ‚ï¼Œéœ€è¦å…ˆæ‰£é™¤é€šé“è´¹ç”¨

**è®¡ç®—å…¬å¼**ï¼š
```
å¯åˆ†é…é‡‘é¢ = ç”¨æˆ·æ”¯ä»˜é‡‘é¢ - é€šé“è´¹ç”¨
Agentä½£é‡‘ = å¯åˆ†é…é‡‘é¢ Ã— Agentä½£é‡‘æ¯”ä¾‹
PayMindå¹³å°è´¹ = å¯åˆ†é…é‡‘é¢ Ã— PayMindè´¹ç‡
```

#### 4.1.2 æ”¹å˜å

**åˆ†ä½£è®¡ç®—åŸºç¡€**ï¼š
- åŸºäºå•†æˆ·ç¨å‰ä»·æ ¼ï¼ˆbasePriceï¼‰
- è®¡ç®—ç®€åŒ–ï¼Œå›ºå®šä½£é‡‘æ¯”ä¾‹

**è®¡ç®—å…¬å¼**ï¼š
```
å•†æˆ·ç¨å‰ä»·æ ¼ = å•†æˆ·è®¾ç½®çš„åŸºç¡€ä»·æ ¼ï¼ˆä¸å«ç¨ï¼‰
Agentä½£é‡‘ = å•†æˆ·ç¨å‰ä»·æ ¼ Ã— Agentä½£é‡‘æ¯”ä¾‹ï¼ˆå›ºå®šï¼‰
PayMindå¹³å°è´¹ = å•†æˆ·ç¨å‰ä»·æ ¼ Ã— PayMindè´¹ç‡ï¼ˆå›ºå®šï¼‰
å•†æˆ·é¢„æœŸæ”¶å…¥ = å•†æˆ·ç¨å‰ä»·æ ¼ - Agentä½£é‡‘ - PayMindå¹³å°è´¹
å•†æˆ·å®é™…æ”¶å…¥ = å•†æˆ·é¢„æœŸæ”¶å…¥ - é€šé“è´¹ç”¨
```

### 4.2 åˆ†ä½£è®¡ç®—æœåŠ¡è°ƒæ•´

#### 4.2.1 åˆ†ä½£è®¡ç®—é€»è¾‘

```typescript
@Injectable()
export class CommissionCalculatorService {
  /**
   * è®¡ç®—å›ºå®šä½£é‡‘ï¼ˆåŸºäºå•†æˆ·ç¨å‰ä»·æ ¼ï¼‰
   */
  async calculateFixedCommission(
    paymentId: string,
    merchantBasePrice: number,  // å•†æˆ·ç¨å‰ä»·æ ¼
    orderType: OrderType,
    productCategory?: string,
  ): Promise<CommissionCalculation> {
    // 1. è·å–ä½£é‡‘æ¯”ä¾‹ï¼ˆæ ¹æ®å•†å“ç±»å‹å’Œç±»åˆ«ï¼‰
    const rates = this.getCommissionRates(orderType, productCategory);
    
    // 2. è®¡ç®—Agentä½£é‡‘ï¼ˆåŸºäºå•†æˆ·ç¨å‰ä»·æ ¼ï¼‰
    const agentCommission = merchantBasePrice * rates.agentRate;
    
    // 3. è®¡ç®—PayMindå¹³å°è´¹ï¼ˆåŸºäºå•†æˆ·ç¨å‰ä»·æ ¼ï¼‰
    const paymindFee = merchantBasePrice * rates.paymindRate;
    
    // 4. è®¡ç®—å•†æˆ·é¢„æœŸæ”¶å…¥
    const merchantExpectedIncome = merchantBasePrice - agentCommission - paymindFee;
    
    // 5. è·å–é€šé“è´¹ç”¨ï¼ˆä»æ”¯ä»˜è®°å½•ä¸­è·å–ï¼‰
    const payment = await this.paymentRepository.findOne({
      where: { id: paymentId },
    });
    const channelFee = payment.channelFee;
    
    // 6. è®¡ç®—å•†æˆ·å®é™…æ”¶å…¥
    const merchantActualIncome = merchantExpectedIncome - channelFee;
    
    return {
      merchantBasePrice,
      agentCommission,
      agentCommissionRate: rates.agentRate,
      paymindFee,
      paymindFeeRate: rates.paymindRate,
      merchantExpectedIncome,
      channelFee,
      merchantActualIncome,
    };
  }
  
  /**
   * æ ¹æ®å•†å“ç±»å‹å’Œç±»åˆ«è·å–ä½£é‡‘æ¯”ä¾‹
   */
  private getCommissionRates(
    orderType: OrderType,
    productCategory?: string,
  ): { agentRate: number; paymindRate: number } {
    // å®ä½“å•†å“
    if (orderType === 'product' || orderType === 'physical') {
      return this.getPhysicalProductRates(productCategory);
    }
    
    // æœåŠ¡
    if (orderType === 'service') {
      return this.getServiceRates(productCategory);
    }
    
    // é“¾ä¸Šèµ„äº§
    if (orderType === 'nft' || orderType === 'virtual') {
      return this.getOnChainAssetRates(productCategory);
    }
    
    // é»˜è®¤
    return { agentRate: 0.10, paymindRate: 0.01 };
  }
}
```

### 4.3 è¡Œä¸šå¯¹æ ‡ä½£é‡‘æ¯”ä¾‹

#### 4.3.1 ä½£é‡‘æ¯”ä¾‹å‚è€ƒ

**å®ä½“å•†å“**ï¼ˆå‚è€ƒAmazonã€eBayï¼‰ï¼š
- ç”µå­äº§å“ï¼š8-12% Agent + 1-2% PayMind
- æœé¥°æ—¶å°šï¼š12-15% Agent + 1.5-2% PayMind
- ç¾å®¹å¥åº·ï¼š8-10% Agent + 1% PayMind

**æœåŠ¡ç±»å•†å“**ï¼š
- å’¨è¯¢æœåŠ¡ï¼š15-20% Agent + 2-3% PayMind
- è®¾è®¡æœåŠ¡ï¼š12-18% Agent + 2% PayMind
- æŠ€æœ¯æœåŠ¡ï¼š10-15% Agent + 1.5-2% PayMind

**é“¾ä¸Šèµ„äº§**ï¼ˆå‚è€ƒOpenSeaã€Uniswapï¼‰ï¼š
- NFTäºŒçº§å¸‚åœºï¼š2-3% Agent + 0.5-1% PayMind
- NFTä¸€çº§å¸‚åœºï¼š5-10% Agent + 1-2% PayMind
- FT DEXäº¤æ˜“ï¼š0.1-0.5% Agent + 0.1-0.2% PayMind

---

## 5. å¯¹Agent IDä½“ç³»çš„å½±å“

### 5.1 ERC 8004å’Œå¤šé“¾å…¼å®¹

#### 5.1.1 å½±å“åˆ†æ

**å½±å“ç¨‹åº¦**ï¼šâ­â­ï¼ˆä¸­ç­‰ï¼‰

**ä¸»è¦å½±å“**ï¼š
- Agent IDéªŒè¯éœ€è¦æ”¯æŒå¤šé“¾
- åˆ†ä½£è®¡ç®—éœ€è¦å…³è”Agent ID
- ä¸å½±å“å®šä»·ï¼Œä½†å½±å“åˆ†ä½£åˆ†é…

#### 5.1.2 Agent IDè§£æ

```typescript
@Injectable()
export class AgentIdentityService {
  /**
   * è§£æAgent IDï¼ˆå¤šé“¾æ”¯æŒï¼‰
   */
  async resolveAgentId(
    agentId: string,
    chain?: string,
  ): Promise<AgentIdentity> {
    // 1. å°è¯•è§£æä¸ºPayMindç»Ÿä¸€ID
    let agent = await this.findByPayMindId(agentId);
    
    if (!agent) {
      // 2. å°è¯•è§£æä¸ºé“¾ä¸ŠID
      if (chain) {
        agent = await this.findByChainId(chain, agentId);
      } else {
        // 3. å°è¯•æ‰€æœ‰é“¾
        agent = await this.findByAnyChain(agentId);
      }
    }
    
    if (!agent) {
      throw new NotFoundException('Agent not found');
    }
    
    return agent;
  }
  
  /**
   * éªŒè¯Agent IDï¼ˆæ”¯æŒERC 8004ã€DIDç­‰ï¼‰
   */
  async verifyAgentId(
    agentId: string,
    chain: string,
  ): Promise<boolean> {
    // 1. æ£€æŸ¥åè®®ç±»å‹
    const protocol = this.detectProtocol(agentId);
    
    // 2. ä½¿ç”¨å¯¹åº”çš„é€‚é…å™¨éªŒè¯
    const adapter = this.getAdapter(protocol);
    return adapter.verifyAgent(agentId, chain);
  }
}
```

### 5.2 åˆ†ä½£è®¡ç®—ä¸­çš„Agent ID

#### 5.2.1 Agent IDåœ¨åˆ†ä½£ä¸­çš„ä½œç”¨

**ä½œç”¨**ï¼š
1. **æ‰§è¡ŒAgent**ï¼šæ‰§è¡Œäº¤æ˜“ï¼Œè·å¾—æ‰§è¡ŒAgentåˆ†ä½£
2. **æ¨èAgent**ï¼šæ¨èå•†å“ï¼Œè·å¾—æ¨èAgentåˆ†ä½£
3. **æ¨å¹¿Agent**ï¼šæ¨å¹¿å•†æˆ·ï¼Œè·å¾—æ¨å¹¿Agentåˆ†ä½£ï¼ˆæ°¸ä¹…ï¼‰
4. **è”ç›ŸèŠ‚ç‚¹**ï¼šç½‘ç»œèŠ‚ç‚¹ï¼Œè·å¾—è”ç›Ÿç½‘ç»œåˆ†æˆï¼ˆæ°¸ä¹…ï¼‰

**åˆ†ä½£è®¡ç®—**ï¼š
```typescript
async calculateAgentCommission(
  paymentId: string,
  merchantBasePrice: number,
  agentId?: string,
  referralAgentId?: string,
): Promise<AgentCommission> {
  const commissions = [];
  
  // 1. æ‰§è¡ŒAgentåˆ†ä½£ï¼ˆå¦‚æœæœ‰ï¼‰
  if (agentId) {
    const agentIdentity = await this.agentIdentityService.resolveAgentId(agentId);
    const executionCommission = merchantBasePrice * this.getExecutionCommissionRate();
    commissions.push({
      agentId: agentIdentity.paymindAgentId,
      agentType: 'execution',
      commission: executionCommission,
      chain: agentIdentity.primaryChain,
    });
  }
  
  // 2. æ¨èAgentåˆ†ä½£ï¼ˆå¦‚æœæœ‰ï¼‰
  if (referralAgentId) {
    const referralIdentity = await this.agentIdentityService.resolveAgentId(referralAgentId);
    const referralCommission = merchantBasePrice * this.getReferralCommissionRate();
    commissions.push({
      agentId: referralIdentity.paymindAgentId,
      agentType: 'referral',
      commission: referralCommission,
      chain: referralIdentity.primaryChain,
    });
  }
  
  return { commissions };
}
```

---

## 6. å¯¹SLAæ²»ç†æœºåˆ¶çš„å½±å“

### 6.1 SLAè®°å½•ä¸ç›‘æ§

#### 6.1.1 å½±å“åˆ†æ

**å½±å“ç¨‹åº¦**ï¼šâ­â­ï¼ˆä¸­ç­‰ï¼‰

**ä¸»è¦å½±å“**ï¼š
- éœ€è¦è®°å½•æ”¯ä»˜ç›¸å…³çš„SLAæŒ‡æ ‡
- ä¸å½±å“å®šä»·ï¼Œä½†å½±å“æœåŠ¡è´¨é‡ç›‘æ§
- éœ€è¦å…³è”Session IDã€User IDã€Agent ID

#### 6.1.2 SLAè®°å½•é€»è¾‘

```typescript
@Injectable()
export class SLAService {
  /**
   * è®°å½•æ”¯ä»˜SLAæŒ‡æ ‡
   */
  async recordPaymentSLA(
    sessionId: string,
    paymentId: string,
    metrics: {
      responseTime: number;
      paymentSuccess: boolean;
      availability: number;
    },
  ): Promise<void> {
    const payment = await this.paymentRepository.findOne({
      where: { id: paymentId },
      relations: ['user', 'merchant'],
    });
    
    // è®°å½•SLAæŒ‡æ ‡
    await this.slaRepository.save({
      sessionId,
      userId: payment.userId,
      agentId: payment.agentId,
      merchantId: payment.merchantId,
      slaLevel: this.getSLALevel(payment.merchantId),
      responseTime: metrics.responseTime,
      paymentSuccess: metrics.paymentSuccess,
      availability: metrics.availability,
    });
    
    // æ£€æŸ¥SLAåˆè§„æ€§
    await this.checkSLACompliance(sessionId, metrics);
  }
  
  /**
   * æ£€æŸ¥SLAåˆè§„æ€§
   */
  async checkSLACompliance(
    sessionId: string,
    metrics: SLAMetrics,
  ): Promise<void> {
    const slaRecord = await this.slaRepository.findOne({
      where: { sessionId },
    });
    
    const slaTarget = this.getSLATarget(slaRecord.slaLevel);
    
    // æ£€æŸ¥å„é¡¹æŒ‡æ ‡
    if (metrics.availability < slaTarget.availability) {
      await this.triggerSLAViolation(sessionId, 'availability');
    }
    
    if (metrics.responseTime > slaTarget.responseTime) {
      await this.triggerSLAViolation(sessionId, 'responseTime');
    }
    
    if (!metrics.paymentSuccess && slaTarget.paymentSuccessRate > 0.99) {
      await this.triggerSLAViolation(sessionId, 'paymentSuccess');
    }
  }
}
```

### 6.2 è¿½è´£æœºåˆ¶

#### 6.2.1 ä¸‰å±‚IDè¿½è´£

**è¿½è´£ä½“ç³»**ï¼š
- **User ID**ï¼šç”¨æˆ·è´£ä»»ï¼ˆæ”¯ä»˜å¤±è´¥ã€é€€æ¬¾ç­‰ï¼‰
- **Agent ID**ï¼šAgentè´£ä»»ï¼ˆæœåŠ¡è´¨é‡ã€æ¨èé”™è¯¯ç­‰ï¼‰
- **Session ID**ï¼šä¼šè¯è´£ä»»ï¼ˆäº¤æ˜“è¿½è¸ªã€é—®é¢˜å®šä½ï¼‰

**è¿½è´£é€»è¾‘**ï¼š
```typescript
async determineLiability(
  sessionId: string,
  issue: PaymentIssue,
): Promise<Liability> {
  const session = await this.sessionRepository.findOne({
    where: { id: sessionId },
    relations: ['user', 'agent', 'payment'],
  });
  
  // æ ¹æ®é—®é¢˜ç±»å‹ç¡®å®šè´£ä»»æ–¹
  if (issue.type === 'payment_failure') {
    // æ£€æŸ¥æ˜¯å¦æ˜¯ç”¨æˆ·åŸå› 
    if (issue.reason === 'insufficient_balance' || issue.reason === 'user_cancelled') {
      return {
        liableParty: 'user',
        userId: session.userId,
        reason: issue.reason,
      };
    }
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯é€šé“åŸå› 
    if (issue.reason === 'channel_failure') {
      return {
        liableParty: 'channel',
        channel: session.payment.paymentMethod,
        reason: issue.reason,
      };
    }
  }
  
  // æ£€æŸ¥æ˜¯å¦æ˜¯AgentåŸå› 
  if (issue.type === 'service_quality') {
    return {
      liableParty: 'agent',
      agentId: session.agentId,
      reason: issue.reason,
    };
  }
  
  // é»˜è®¤å¹³å°è´£ä»»
  return {
    liableParty: 'platform',
    reason: 'platform_error',
  };
}
```

---

## 7. å¯¹ç»Ÿä¸€æ”¯ä»˜æµç¨‹çš„å½±å“

### 7.1 ç»Ÿä¸€æ”¯ä»˜æµç¨‹è°ƒæ•´

#### 7.1.1 æµç¨‹é˜¶æ®µï¼ˆä¿æŒä¸å˜ï¼‰

```
é˜¶æ®µ1: æ”¯ä»˜è¯·æ±‚ï¼ˆå«ä¸‰å±‚IDï¼‰
  â†“
é˜¶æ®µ2: æ™ºèƒ½è·¯ç”±é€‰æ‹©ï¼ˆå«ä»·æ ¼è·å–ï¼‰
  â†“
é˜¶æ®µ3: æ”¯ä»˜æ‰§è¡Œ
  â†“
é˜¶æ®µ4: é€šé“è´¹ç”¨æ‰£é™¤ï¼ˆå•†æˆ·æ‰¿æ‹…ï¼‰
  â†“
é˜¶æ®µ5: å›ºå®šä½£é‡‘è®¡ç®—ï¼ˆåŸºäºå•†æˆ·ç¨å‰ä»·æ ¼ï¼‰
  â†“
é˜¶æ®µ6: èµ„é‡‘æ‰˜ç®¡ï¼ˆå¯é€‰ï¼‰
  â†“
é˜¶æ®µ7: ç»“ç®—åˆ†æ´¾
```

#### 7.1.2 æµç¨‹è°ƒæ•´ç‚¹

**è°ƒæ•´ç‚¹1ï¼šé˜¶æ®µ1 - æ”¯ä»˜è¯·æ±‚**
- æ–°å¢ï¼šè·å–ç”¨æˆ·æ‰€åœ¨å›½å®¶
- æ–°å¢ï¼šåˆ›å»ºSession ID
- æ–°å¢ï¼šè·å–/éªŒè¯Agent IDï¼ˆå¤šé“¾æ”¯æŒï¼‰

**è°ƒæ•´ç‚¹2ï¼šé˜¶æ®µ2 - æ™ºèƒ½è·¯ç”±é€‰æ‹©**
- ä¿®æ”¹ï¼šå…ˆè·å–å•†æˆ·ä»·æ ¼è®¾ç½®
- ä¿®æ”¹ï¼šåŸºäºå•†æˆ·ä»·æ ¼è¿›è¡Œè·¯ç”±å†³ç­–
- æ–°å¢ï¼šæ”¯æŒå…¨çƒ200+å›½å®¶ï¼Œ150+ç§è´§å¸

**è°ƒæ•´ç‚¹3ï¼šé˜¶æ®µ5 - å›ºå®šä½£é‡‘è®¡ç®—**
- ä¿®æ”¹ï¼šåŸºäºå•†æˆ·ç¨å‰ä»·æ ¼è®¡ç®—
- ä¿®æ”¹ï¼šä½¿ç”¨å›ºå®šä½£é‡‘æ¯”ä¾‹ï¼ˆæ ¹æ®å•†å“ç±»å‹ï¼‰
- æ–°å¢ï¼šæ”¯æŒè¡Œä¸šå¯¹æ ‡ä½£é‡‘æ¯”ä¾‹

**è°ƒæ•´ç‚¹4ï¼šé˜¶æ®µ7 - ç»“ç®—åˆ†æ´¾**
- æ–°å¢ï¼šè®°å½•SLAæŒ‡æ ‡
- æ–°å¢ï¼šå…³è”ä¸‰å±‚IDï¼ˆUser IDã€Agent IDã€Session IDï¼‰
- æ–°å¢ï¼šè®°å½•ç¨è´¹ä¿¡æ¯

### 7.2 æ”¯ä»˜æµç¨‹æ—¶åºå›¾è°ƒæ•´

#### 7.2.1 å®Œæ•´æ—¶åºå›¾ï¼ˆæ–°ï¼‰

```
ç”¨æˆ·                å‰ç«¯UI              åç«¯API              ä»·æ ¼æœåŠ¡              æ™ºèƒ½è·¯ç”±              æ”¯ä»˜æ‰§è¡ŒæœåŠ¡          åˆ†ä½£æœåŠ¡              Agent IDæœåŠ¡          SLAæœåŠ¡              ç»“ç®—æœåŠ¡
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚â”€â”€å‘èµ·æ”¯ä»˜è¯·æ±‚â”€â”€â”€â”€â”€>â”‚                   â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚â”€â”€processPaymentâ”€â”€â”€>â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚  [é˜¶æ®µ1: æ”¯ä»˜è¯·æ±‚]  â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚  1. åˆ›å»ºSession ID â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚  2. è·å–User ID   â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚  3. è·å–Agent ID  â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚  4. éªŒè¯Agent ID (å¤šé“¾)â”‚              â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚                    â”‚                    â”‚â”€â”€resolveAgentIDâ”€â”€â”€>â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚                    â”‚                    â”‚  å¤šé“¾è§£æ:         â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚                    â”‚                    â”‚  - ERC 8004       â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚                    â”‚                    â”‚  - W3C DID       â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚                    â”‚                    â”‚  - Solana        â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚                    â”‚                    â”‚  - BSC/Polygon   â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚                    â”‚                    â”‚<â”€è¿”å›Agentä¿¡æ¯â”€â”€â”€â”€â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚  [é˜¶æ®µ2: ä»·æ ¼è·å–] â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚â”€â”€getProductPriceâ”€>â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚                    â”‚  1. è·å–åŸºç¡€ä»·æ ¼   â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚                    â”‚  2. æ£€æŸ¥å›½å®¶ä»·æ ¼   â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚                    â”‚  3. æ£€æŸ¥é€šé“ä»·æ ¼   â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚                    â”‚  4. è®¡ç®—ç¨è´¹       â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚                    â”‚<â”€è¿”å›ä»·æ ¼ä¿¡æ¯â”€â”€â”€â”€â”€â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚  [é˜¶æ®µ2: æ™ºèƒ½è·¯ç”±é€‰æ‹©]â”‚                  â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚â”€â”€selectBestChannel>â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚  1. è·å–å„é€šé“ä»·æ ¼  â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚  2. æ¯”è¾ƒä»·æ ¼       â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚  3. é€‰æ‹©æœ€ä¼˜é€šé“   â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚  4. æ”¯æŒå…¨çƒ200+å›½å®¶â”‚                  â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚  5. æ”¯æŒ150+ç§è´§å¸ â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚<â”€è¿”å›è·¯ç”±å†³ç­–â”€â”€â”€â”€â”€â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚  [é˜¶æ®µ3: æ”¯ä»˜æ‰§è¡Œ] â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚â”€â”€æ‰§è¡Œæ”¯ä»˜â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚                    â”‚<â”€æ”¯ä»˜ç»“æœâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚  [é˜¶æ®µ4: é€šé“è´¹ç”¨æ‰£é™¤]â”‚                  â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚  [é˜¶æ®µ5: å›ºå®šä½£é‡‘è®¡ç®—]â”‚                â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚                    â”‚                    â”‚â”€â”€calculateFixedCommission>â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚                    â”‚                    â”‚  åŸºäºå•†æˆ·ç¨å‰ä»·æ ¼:  â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚                    â”‚                    â”‚  - Agentä½£é‡‘ = å•†æˆ·ç¨å‰ä»·æ ¼ Ã— å›ºå®šæ¯”ä¾‹â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚                    â”‚                    â”‚  - PayMindå¹³å°è´¹ = å•†æˆ·ç¨å‰ä»·æ ¼ Ã— å›ºå®šæ¯”ä¾‹â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚                    â”‚                    â”‚  - å•†æˆ·å®é™…æ”¶å…¥ = å•†æˆ·ç¨å‰ä»·æ ¼ - ä½£é‡‘ - é€šé“è´¹ç”¨â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚â”€â”€recordSLAâ”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚  è®°å½•SLAæŒ‡æ ‡:     â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚  - å“åº”æ—¶é—´       â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚  - æ”¯ä»˜æˆåŠŸç‡     â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚  - å¯ç”¨æ€§         â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚<â”€SLAè®°å½•å®Œæˆâ”€â”€â”€â”€â”€â”€â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚                    â”‚                    â”‚<â”€åˆ†ä½£è®¡ç®—å®Œæˆâ”€â”€â”€â”€â”€â”€â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚  [é˜¶æ®µ6: èµ„é‡‘æ‰˜ç®¡] â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚  [é˜¶æ®µ7: ç»“ç®—åˆ†æ´¾] â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚                   â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚                   â”‚<â”€æ”¯ä»˜æˆåŠŸâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
 â”‚<â”€æ˜¾ç¤ºæ”¯ä»˜æˆåŠŸâ”€â”€â”€â”€â”€â”€â”‚                   â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
```

---

## 8. äº§å“è®¾è®¡æ”¹å˜æ¸…å•

### 4.1 å•†æˆ·åå°åŠŸèƒ½

#### 4.1.1 æ–°å¢åŠŸèƒ½

**1. å•†å“ä»·æ ¼è®¾ç½®é¡µé¢**
- [ ] åŸºç¡€ä»·æ ¼è®¾ç½®
- [ ] å›½å®¶ä»·æ ¼è¦†ç›–è®¾ç½®
- [ ] é€šé“ä»·æ ¼è¦†ç›–è®¾ç½®
- [ ] ä»·æ ¼é¢„è§ˆè¡¨æ ¼
- [ ] ä»·æ ¼æ‰¹é‡å¯¼å…¥/å¯¼å‡º

**2. ä»·æ ¼ç®¡ç†åŠŸèƒ½**
- [ ] ä»·æ ¼æ¨¡æ¿ç®¡ç†
- [ ] ä»·æ ¼å†å²è®°å½•
- [ ] ä»·æ ¼å˜æ›´é€šçŸ¥
- [ ] ä»·æ ¼åˆ†ææŠ¥è¡¨

**3. ç¨è´¹ç®¡ç†åŠŸèƒ½**
- [ ] ç¨è´¹è®¡ç®—å·¥å…·
- [ ] ç¨è´¹æŠ¥è¡¨
- [ ] ç¨è´¹è®¾ç½®ï¼ˆå«ç¨/ä¸å«ç¨ï¼‰
- [ ] ç¨è´¹è±å…ç®¡ç†

#### 4.1.2 ä¿®æ”¹åŠŸèƒ½

**1. å•†å“ç®¡ç†é¡µé¢**
- [ ] æ·»åŠ ä»·æ ¼è®¾ç½®å…¥å£
- [ ] æ˜¾ç¤ºä»·æ ¼è®¾ç½®çŠ¶æ€
- [ ] ä»·æ ¼è®¾ç½®å¿«æ·æ“ä½œ

**2. è®¢å•ç®¡ç†é¡µé¢**
- [ ] æ˜¾ç¤ºè®¢å•ä»·æ ¼æ˜ç»†
- [ ] æ˜¾ç¤ºç¨è´¹æ˜ç»†
- [ ] æ˜¾ç¤ºå•†æˆ·ç¨å‰æ”¶å…¥
- [ ] æ˜¾ç¤ºå•†æˆ·å®é™…æ”¶å…¥

**3. æ”¶å…¥æŠ¥è¡¨é¡µé¢**
- [ ] åŒºåˆ†ç¨å‰æ”¶å…¥å’Œå®é™…æ”¶å…¥
- [ ] æ˜¾ç¤ºç¨è´¹æ±‡æ€»
- [ ] æ˜¾ç¤ºå„å›½å®¶æ”¶å…¥åˆ†å¸ƒ
- [ ] æ˜¾ç¤ºå„é€šé“æ”¶å…¥åˆ†å¸ƒ

### 4.2 ç”¨æˆ·å‰ç«¯åŠŸèƒ½

#### 4.2.1 æ–°å¢åŠŸèƒ½

**1. ä»·æ ¼æ˜¾ç¤º**
- [ ] æ˜¾ç¤ºå•†æˆ·è®¾ç½®çš„æœ€ç»ˆä»·æ ¼
- [ ] æ˜¾ç¤ºä»·æ ¼å·®å¼‚ï¼ˆå¦‚æœä¸åŒé€šé“ä»·æ ¼ä¸åŒï¼‰
- [ ] æ˜¾ç¤ºç¨è´¹ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰

**2. æ”¯ä»˜æ–¹å¼é€‰æ‹©**
- [ ] æ˜¾ç¤ºå„é€šé“çš„ä»·æ ¼å¯¹æ¯”
- [ ] æ¨èä»·æ ¼æœ€ä½çš„é€šé“
- [ ] æ˜¾ç¤ºä»·æ ¼å·®å¼‚åŸå› 

#### 4.2.2 ä¿®æ”¹åŠŸèƒ½

**1. æ”¯ä»˜æµç¨‹**
- [ ] æ”¯ä»˜å‰å…ˆè·å–ä»·æ ¼
- [ ] æ˜¾ç¤ºå•†æˆ·è®¾ç½®çš„æœ€ç»ˆä»·æ ¼
- [ ] æ”¯ä»˜ç¡®è®¤é¡µé¢æ˜¾ç¤ºä»·æ ¼æ˜ç»†

**2. è®¢å•é¡µé¢**
- [ ] æ˜¾ç¤ºè®¢å•ä»·æ ¼æ˜ç»†
- [ ] æ˜¾ç¤ºç¨è´¹ä¿¡æ¯
- [ ] æ˜¾ç¤ºæ”¯ä»˜æ–¹å¼

### 4.3 åç«¯APIè°ƒæ•´

#### 4.3.1 æ–°å¢API

**1. ä»·æ ¼ç®¡ç†API**
```typescript
// è·å–å•†å“ä»·æ ¼
GET /api/products/:productId/pricing?countryCode=GB&channel=stripe

// è®¾ç½®å•†å“ä»·æ ¼
POST /api/products/:productId/pricing
PUT /api/products/:productId/pricing/:pricingId
DELETE /api/products/:productId/pricing/:pricingId

// æ‰¹é‡è®¾ç½®ä»·æ ¼
POST /api/products/:productId/pricing/batch

// è·å–ä»·æ ¼æ¨¡æ¿
GET /api/pricing/templates
POST /api/pricing/templates
```

**2. ç¨è´¹ç®¡ç†API**
```typescript
// è®¡ç®—ç¨è´¹
POST /api/tax/calculate

// è·å–ç¨è´¹æŠ¥è¡¨
GET /api/tax/reports?startDate=...&endDate=...

// å¯¼å‡ºç¨è´¹æŠ¥è¡¨
GET /api/tax/reports/export
```

#### 4.3.2 ä¿®æ”¹API

**1. æ”¯ä»˜è·¯ç”±API**
```typescript
// ä¿®æ”¹å‰
GET /api/payments/routing?amount=1000&currency=USD

// ä¿®æ”¹å
GET /api/payments/routing?productId=xxx&countryCode=GB&currency=USD
```

**2. æ”¯ä»˜åˆ›å»ºAPI**
```typescript
// ä¿®æ”¹å‰
POST /api/payments
{
  "productId": "xxx",
  "amount": 1000,
  "currency": "USD"
}

// ä¿®æ”¹å
POST /api/payments
{
  "productId": "xxx",
  "countryCode": "GB",
  "currency": "USD",
  "paymentMethod": "stripe" // å¯é€‰
}
```

### 4.4 æ•°æ®åº“è®¾è®¡

#### 4.4.1 æ–°å¢è¡¨

**1. å•†å“ä»·æ ¼è¡¨**
```sql
CREATE TABLE product_prices (
  id UUID PRIMARY KEY,
  product_id UUID NOT NULL,
  base_price DECIMAL NOT NULL,
  base_currency VARCHAR NOT NULL,
  tax_included BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP,
  updated_at TIMESTAMP
);
```

**2. å•†å“å›½å®¶ä»·æ ¼è¡¨**
```sql
CREATE TABLE product_country_prices (
  id UUID PRIMARY KEY,
  product_id UUID NOT NULL,
  country_code VARCHAR(2) NOT NULL,
  price DECIMAL NOT NULL,
  currency VARCHAR NOT NULL,
  tax_included BOOLEAN DEFAULT TRUE,
  tax_rate DECIMAL,
  reason TEXT,
  created_at TIMESTAMP,
  updated_at TIMESTAMP,
  UNIQUE(product_id, country_code)
);
```

**3. å•†å“é€šé“ä»·æ ¼è¡¨**
```sql
CREATE TABLE product_channel_prices (
  id UUID PRIMARY KEY,
  product_id UUID NOT NULL,
  country_code VARCHAR(2),
  channel VARCHAR NOT NULL,
  price DECIMAL NOT NULL,
  currency VARCHAR NOT NULL,
  tax_included BOOLEAN DEFAULT TRUE,
  tax_rate DECIMAL,
  channel_fee DECIMAL,
  reason TEXT,
  created_at TIMESTAMP,
  updated_at TIMESTAMP,
  UNIQUE(product_id, country_code, channel)
);
```

#### 4.4.2 ä¿®æ”¹è¡¨

**1. æ”¯ä»˜è®°å½•è¡¨**
```sql
ALTER TABLE payments ADD COLUMN country_code VARCHAR(2);
ALTER TABLE payments ADD COLUMN base_amount DECIMAL; -- å•†æˆ·ç¨å‰ä»·æ ¼
ALTER TABLE payments ADD COLUMN tax_amount DECIMAL;  -- ç¨è´¹
ALTER TABLE payments ADD COLUMN tax_rate DECIMAL;    -- ç¨ç‡
```

---

## 9. å®ç°æ–¹æ¡ˆ

### 5.1 æ™ºèƒ½è·¯ç”±è°ƒæ•´æ–¹æ¡ˆ

#### 5.1.1 è·¯ç”±å†³ç­–æµç¨‹ï¼ˆæ–°ï¼‰

```
æ”¯ä»˜è¯·æ±‚
  â”‚
  â”œâ”€â†’ [è·å–ä¸Šä¸‹æ–‡ä¿¡æ¯]
  â”‚   â”œâ”€â†’ å•†å“ID
  â”‚   â”œâ”€â†’ ç”¨æˆ·æ‰€åœ¨å›½å®¶
  â”‚   â”œâ”€â†’ æ”¯ä»˜è´§å¸
  â”‚   â””â”€â†’ å•†æˆ·æ”¶æ¬¾é…ç½®
  â”‚
  â”œâ”€â†’ [è·å–å•†æˆ·ä»·æ ¼è®¾ç½®]
  â”‚   â”œâ”€â†’ æ£€æŸ¥é€šé“+å›½å®¶ä»·æ ¼
  â”‚   â”œâ”€â†’ æ£€æŸ¥å›½å®¶ä»·æ ¼
  â”‚   â”œâ”€â†’ æ£€æŸ¥é€šé“ä»·æ ¼
  â”‚   â””â”€â†’ ä½¿ç”¨åŸºç¡€ä»·æ ¼ï¼ˆå¦‚æœæœªè®¾ç½®ï¼‰
  â”‚
  â”œâ”€â†’ [è·å–å¯ç”¨é€šé“]
  â”‚   â”œâ”€â†’ æ£€æŸ¥é€šé“å¯ç”¨æ€§
  â”‚   â”œâ”€â†’ æ£€æŸ¥è´§å¸æ”¯æŒ
  â”‚   â””â”€â†’ æ£€æŸ¥KYCè¦æ±‚
  â”‚
  â”œâ”€â†’ [è®¡ç®—å„é€šé“ä»·æ ¼]
  â”‚   â””â”€â†’ ä»å•†æˆ·ä»·æ ¼è®¾ç½®ä¸­è·å–
  â”‚
  â”œâ”€â†’ [é€‰æ‹©æœ€ä¼˜é€šé“]
  â”‚   â”œâ”€â†’ ä»·æ ¼æœ€ä½ä¼˜å…ˆ
  â”‚   â”œâ”€â†’ é€Ÿåº¦ã€æˆåŠŸç‡ã€å®‰å…¨æ€§æ¬¡ä¹‹
  â”‚   â””â”€â†’ ç»¼åˆè¯„åˆ†
  â”‚
  â””â”€â†’ [è¿”å›è·¯ç”±å†³ç­–]
      â”œâ”€â†’ æ¨èé€šé“
      â”œâ”€â†’ æ¨èä»·æ ¼ï¼ˆå•†æˆ·è®¾ç½®ï¼‰
      â”œâ”€â†’ ä»·æ ¼å¯¹æ¯”
      â””â”€â†’ è·¯ç”±ç†ç”±
```

#### 5.1.2 ä»·æ ¼æœåŠ¡é›†æˆ

```typescript
@Injectable()
export class SmartRouterService {
  constructor(
    private pricingService: PricingService,
    // ... other services
  ) {}
  
  /**
   * é€‰æ‹©æœ€ä½³æ”¯ä»˜é€šé“ï¼ˆæ”¯æŒå•†æˆ·ä»·æ ¼è®¾ç½®ï¼‰
   */
  async selectBestChannel(
    productId: string,
    countryCode: string,
    currency: string,
    context?: RoutingContext,
  ): Promise<RoutingDecision> {
    // 1. è·å–å¯ç”¨é€šé“
    const availableChannels = await this.getAvailableChannels(
      countryCode,
      currency,
      context,
    );
    
    // 2. è·å–å„é€šé“çš„å•†æˆ·è®¾ç½®ä»·æ ¼
    const channelPrices = await Promise.all(
      availableChannels.map(async (channel) => {
        const pricing = await this.pricingService.getProductPrice(
          productId,
          countryCode,
          channel.method,
        );
        
        return {
          channel,
          price: pricing.finalPrice,
          basePrice: pricing.basePrice,
          taxAmount: pricing.taxAmount,
          channelFee: pricing.channelFee,
        };
      }),
    );
    
    // 3. è®¡ç®—ç»¼åˆå¾—åˆ†ï¼ˆä»·æ ¼æƒé‡40%ï¼‰
    const scoredChannels = channelPrices.map((cp) => {
      const priceScore = 1 / (cp.price / Math.min(...channelPrices.map(p => p.price)));
      const speedScore = cp.channel.speed / 10;
      const successRateScore = cp.channel.successRate / 100;
      const securityScore = cp.channel.securityLevel / 10;
      
      const score = 
        priceScore * 0.4 +
        speedScore * 0.25 +
        successRateScore * 0.20 +
        securityScore * 0.10 +
        (cp.channel.coverage / 100) * 0.03 +
        (cp.channel.ux / 10) * 0.02;
      
      return {
        ...cp,
        score,
      };
    });
    
    // 4. æŒ‰å¾—åˆ†æ’åº
    scoredChannels.sort((a, b) => b.score - a.score);
    
    // 5. é€‰æ‹©æœ€ä¼˜é€šé“
    const recommended = scoredChannels[0];
    
    // 6. ç”Ÿæˆä»·æ ¼å¯¹æ¯”
    const priceComparison = channelPrices.map((cp) => ({
      method: cp.channel.method,
      price: cp.price,
      basePrice: cp.basePrice,
      taxAmount: cp.taxAmount,
      channelFee: cp.channelFee,
    }));
    
    return {
      recommendedMethod: recommended.channel.method,
      channels: availableChannels,
      price: recommended.price,
      basePrice: recommended.basePrice,
      taxAmount: recommended.taxAmount,
      priceComparison,
      reason: `ä»·æ ¼æœ€ä½ï¼š${recommended.price} ${currency}ï¼Œé€Ÿåº¦ï¼š${recommended.channel.speed}/10ï¼ŒæˆåŠŸç‡ï¼š${recommended.channel.successRate}%`,
    };
  }
}
```

### 5.2 æ”¯ä»˜æµç¨‹è°ƒæ•´æ–¹æ¡ˆ

#### 5.2.1 æ”¯ä»˜æµç¨‹ï¼ˆæ–°ï¼‰

```
ç”¨æˆ·å‘èµ·æ”¯ä»˜
    â†“
[é˜¶æ®µ1: æ”¯ä»˜è¯·æ±‚]
  â”œâ”€â†’ è·å–å•†å“ä¿¡æ¯
  â”œâ”€â†’ è·å–ç”¨æˆ·æ‰€åœ¨å›½å®¶
  â””â”€â†’ åˆ›å»ºæ”¯ä»˜è®°å½•ï¼ˆå¾…å®šä»·ï¼‰
    â†“
[é˜¶æ®µ2: ä»·æ ¼è·å–]
  â”œâ”€â†’ è·å–å•†æˆ·ä»·æ ¼è®¾ç½®
  â”œâ”€â†’ è®¡ç®—æœ€ç»ˆä»·æ ¼
  â””â”€â†’ æ›´æ–°æ”¯ä»˜è®°å½•ä»·æ ¼
    â†“
[é˜¶æ®µ3: æ™ºèƒ½è·¯ç”±é€‰æ‹©]
  â”œâ”€â†’ è·å–å„é€šé“ä»·æ ¼
  â”œâ”€â†’ é€‰æ‹©æœ€ä¼˜é€šé“
  â””â”€â†’ è¿”å›æ¨èé€šé“å’Œä»·æ ¼
   åŒ…æ‹¬ â†“
[é˜¶æ®µ4: æ”¯ä»˜æ‰§è¡Œ]
  â”œâ”€â†’ ç”¨æˆ·ç¡®è®¤æ”¯ä»˜
  â”œâ”€â†’ æ‰§è¡Œæ”¯ä»˜
  â””â”€â†’ æ›´æ–°æ”¯ä»˜çŠ¶æ€
    â†“
[é˜¶æ®µ5: åˆ†ä½£è®¡ç®—]
  â”œâ”€â†’ åŸºäºå•†æˆ·ç¨å‰ä»·æ ¼è®¡ç®—
  â”œâ”€â†’ è®¡ç®—Agentä½£é‡‘
  â”œâ”€â†’ è®¡ç®—PayMindå¹³å°è´¹
  â””â”€â†’ è®¡ç®—å•†æˆ·å®é™…æ”¶å…¥
    â†“
[é˜¶æ®µ6: ç»“ç®—åˆ†æ´¾]
  â”œâ”€â†’ èµ„é‡‘æ‰˜ç®¡ï¼ˆå¦‚éœ€è¦ï¼‰
  â”œâ”€â†’ ç»“ç®—åˆ†æ´¾
  â””â”€â†’ å®Œæˆæ”¯ä»˜
```

#### 5.2.2 æ”¯ä»˜æœåŠ¡è°ƒæ•´

```typescript
@Injectable()
export class PaymentService {
  /**
   * åˆ›å»ºæ”¯ä»˜ï¼ˆæ”¯æŒå•†æˆ·ä»·æ ¼è®¾ç½®ï¼‰
   */
  async createPayment(
    userId: string,
    productId: string,
    countryCode: string,
    currency: string,
    paymentMethod?: PaymentMethod,
  ): Promise<Payment> {
    // 1. è·å–å•†å“ä¿¡æ¯
    const product = await this.productRepository.findOne({
      where: { id: productId },
    });
    
    // 2. è·å–å•†æˆ·ä»·æ ¼è®¾ç½®
    const pricing = await this.pricingService.getProductPrice(
      productId,
      countryCode,
      paymentMethod,
    );
    
    // 3. å¦‚æœæ²¡æœ‰æŒ‡å®šæ”¯ä»˜æ–¹å¼ï¼Œä½¿ç”¨æ™ºèƒ½è·¯ç”±æ¨è
    if (!paymentMethod) {
      const routing = await this.smartRouter.selectBestChannel(
        productId,
        countryCode,
        currency,
      );
      paymentMethod = routing.recommendedMethod;
      // ä½¿ç”¨æ¨èé€šé“çš„ä»·æ ¼
      const recommendedPricing = await this.pricingService.getProductPrice(
        productId,
        countryCode,
        paymentMethod,
      );
      pricing.finalPrice = recommendedPricing.finalPrice;
      pricing.basePrice = recommendedPricing.basePrice;
      pricing.taxAmount = recommendedPricing.taxAmount;
    }
    
    // 4. åˆ›å»ºæ”¯ä»˜è®°å½•
    const payment = await this.paymentRepository.save({
      userId,
      productId,
      merchantId: product.merchantId,
      amount: pricing.finalPrice,      // ç”¨æˆ·æ”¯ä»˜é‡‘é¢ï¼ˆå«ç¨ï¼‰
      baseAmount: pricing.basePrice,   // å•†æˆ·ç¨å‰ä»·æ ¼
      taxAmount: pricing.taxAmount,    // ç¨è´¹
      taxRate: pricing.taxRate,        // ç¨ç‡
      currency,
      countryCode,
      paymentMethod,
      status: PaymentStatus.PENDING,
    });
    
    return payment;
  }
  
  /**
   * å¤„ç†æ”¯ä»˜æˆåŠŸï¼ˆæ”¯æŒå•†æˆ·ä»·æ ¼è®¾ç½®ï¼‰
   */
  async processPaymentSuccess(
    paymentId: string,
  ): Promise<void> {
    const payment = await this.paymentRepository.findOne({
      where: { id: paymentId },
    });
    
    // åˆ†ä½£è®¡ç®—åŸºäºå•†æˆ·ç¨å‰ä»·æ ¼
    const baseAmount = payment.baseAmount;
    
    // è®¡ç®—åˆ†ä½£
    await this.commissionService.calculateCommission(
      paymentId,
      baseAmount, // ä½¿ç”¨å•†æˆ·ç¨å‰ä»·æ ¼
    );
    
    // è®¡ç®—å•†æˆ·å®é™…æ”¶å…¥
    const channelFee = await this.calculateChannelFee(payment);
    const agentCommission = await this.calculateAgentCommission(payment, baseAmount);
    const paymindFee = await this.calculatePayMindFee(payment, baseAmount);
    
    const merchantIncome = baseAmount - channelFee - agentCommission - paymindFee;
    
    // æ›´æ–°æ”¯ä»˜è®°å½•
    payment.status = PaymentStatus.COMPLETED;
    payment.merchantIncome = merchantIncome;
    await this.paymentRepository.save(payment);
  }
}
```

### 5.3 å•†æˆ·åå°ç•Œé¢è®¾è®¡

#### 5.3.1 å•†å“ä»·æ ¼è®¾ç½®é¡µé¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å•†å“ä»·æ ¼è®¾ç½® - iPhone 15 Pro Max                        â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  åŸºç¡€ä»·æ ¼è®¾ç½®                                    â”‚   â”‚
â”‚  â”‚                                                   â”‚   â”‚
â”‚  â”‚  åŸºç¡€ä»·æ ¼ï¼š[$1,000.00] [USD â–¼]                   â”‚   â”‚
â”‚  â”‚  â˜‘ï¸ ä»·æ ¼å«ç¨                                      â”‚   â”‚
â”‚  â”‚                                                   â”‚   â”‚
â”‚  â”‚  ğŸ’¡ åŸºç¡€ä»·æ ¼å°†ä½œä¸ºé»˜è®¤ä»·æ ¼ï¼Œé€‚ç”¨äºæœªè®¾ç½®ç‰¹å®šå›½å®¶  â”‚   â”‚
â”‚  â”‚     æˆ–é€šé“ä»·æ ¼çš„æƒ…å†µã€‚                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  å›½å®¶ä»·æ ¼è®¾ç½®                                    â”‚   â”‚
â”‚  â”‚                                                   â”‚   â”‚
â”‚  â”‚  [+ æ·»åŠ å›½å®¶ä»·æ ¼]                                 â”‚   â”‚
â”‚  â”‚                                                   â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚  ğŸ‡¬ğŸ‡§ è‹±å›½                                â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  ä»·æ ¼ï¼š$1,200.00                        â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  ç¨è´¹ï¼šVAT 20%ï¼ˆå·²åŒ…å«ï¼‰                 â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  åŸå› ï¼šè‹±å›½VATç¨ç‡è¾ƒé«˜                    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  [ç¼–è¾‘] [åˆ é™¤]                            â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  é€šé“ä»·æ ¼è®¾ç½®                                    â”‚   â”‚
â”‚  â”‚                                                   â”‚   â”‚
â”‚  â”‚  [+ æ·»åŠ é€šé“ä»·æ ¼]                                 â”‚   â”‚
â”‚  â”‚                                                   â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚  ğŸ’³ Stripeï¼ˆè‹±å›½ï¼‰                       â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  ä»·æ ¼ï¼š$1,229.00                        â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  åŸºç¡€ä»·æ ¼ï¼š$1,200.00                    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  é€šé“è´¹ç”¨ï¼š$29.00ï¼ˆç”¨æˆ·æ‰¿æ‹…ï¼‰            â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  ç¨è´¹ï¼šVAT 20%ï¼ˆå·²åŒ…å«ï¼‰                 â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  [ç¼–è¾‘] [åˆ é™¤]                            â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                   â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚  âš¡ X402åè®®ï¼ˆè‹±å›½ï¼‰                      â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  ä»·æ ¼ï¼š$1,200.60                        â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  åŸºç¡€ä»·æ ¼ï¼š$1,200.00                    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  é€šé“è´¹ç”¨ï¼š$0.60ï¼ˆå•†æˆ·æ‰¿æ‹…ï¼‰              â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  ç¨è´¹ï¼šVAT 20%ï¼ˆå·²åŒ…å«ï¼‰                 â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  [ç¼–è¾‘] [åˆ é™¤]                            â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ä»·æ ¼é¢„è§ˆ                                        â”‚   â”‚
â”‚  â”‚                                                   â”‚   â”‚
â”‚  â”‚  å›½å®¶/é€šé“ | æœ€ç»ˆä»·æ ¼ | åŸºç¡€ä»·æ ¼ | ç¨è´¹ | é€šé“è´¹ç”¨ â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚   â”‚
â”‚  â”‚  è‹±å›½/X402 | $1,200.60 | $1,000.00 | $200.00 | $0.60 â”‚   â”‚
â”‚  â”‚  è‹±å›½/Stripe | $1,229.00 | $1,000.00 | $200.00 | $29.00 â”‚   â”‚
â”‚  â”‚  ç¾å›½/X402 | $1,050.60 | $1,000.00 | $50.00 | $0.60 â”‚   â”‚
â”‚  â”‚  ç¾å›½/Stripe | $1,079.00 | $1,000.00 | $50.00 | $29.00 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                           â”‚
â”‚  [å–æ¶ˆ]                                    [ä¿å­˜]          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.4 ç”¨æˆ·å‰ç«¯ç•Œé¢è°ƒæ•´

#### 5.4.1 æ”¯ä»˜ç•Œé¢è°ƒæ•´

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PayMind æ”¯ä»˜                          â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              è®¢å•ä¿¡æ¯                             â”‚   â”‚
â”‚  â”‚                                                   â”‚   â”‚
â”‚  â”‚  ğŸ“¦ å•†å“åç§°ï¼šiPhone 15 Pro Max                  â”‚   â”‚
â”‚  â”‚  ğŸ’° å•†å“ä»·æ ¼ï¼š$1,000.00ï¼ˆåŸºç¡€ä»·æ ¼ï¼‰               â”‚   â”‚
â”‚  â”‚  ğŸ“Š æ•°é‡ï¼š1                                      â”‚   â”‚
â”‚  â”‚  ğŸª å•†æˆ·ï¼šApple Store                            â”‚   â”‚
â”‚  â”‚  ğŸŒ æ‚¨çš„å›½å®¶ï¼šè‹±å›½                                â”‚   â”‚
â”‚  â”‚                                                   â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚   â”‚
â”‚  â”‚                                                   â”‚   â”‚
â”‚  â”‚  ğŸ’µ æ”¯ä»˜é‡‘é¢ï¼š$1,200.60ï¼ˆå«ç¨ï¼‰                  â”‚   â”‚
â”‚  â”‚  ğŸ’³ ç¨è´¹ï¼ˆVAT 20%ï¼‰ï¼š$200.00                      â”‚   â”‚
â”‚  â”‚  ğŸ’¡ é€šé“è´¹ç”¨ï¼šç”±å•†æˆ·æ‰¿æ‹…ï¼ˆä¸å‘æ‚¨æ”¶è´¹ï¼‰            â”‚   â”‚
â”‚  â”‚                                                   â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚   â”‚
â”‚  â”‚                                                   â”‚   â”‚
â”‚  â”‚  âœ… æ€»è®¡ï¼š$1,200.60                              â”‚   â”‚
â”‚  â”‚                                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  â­ æ¨èæ”¯ä»˜æ–¹å¼                                â”‚   â”‚
â”‚  â”‚                                                   â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚  âš¡ X402åè®®æ”¯ä»˜                         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  ğŸ’° æ”¯ä»˜é‡‘é¢ï¼š$1,200.60                â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  âš¡ å¤„ç†é€Ÿåº¦ï¼š1-3ç§’                      â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  âœ… æˆåŠŸç‡ï¼š99.8%                        â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  ğŸ”’ å®‰å…¨æ€§ï¼šæé«˜                          â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  ğŸ’¡ æ¨èç†ç”±ï¼šä»·æ ¼æœ€ä½ï¼Œé€Ÿåº¦æœ€å¿«          â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  [ä½¿ç”¨æ­¤æ–¹å¼æ”¯ä»˜]                        â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                   â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚  ğŸ“Š ä»·æ ¼å¯¹æ¯”                             â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  X402åè®®ï¼š$1,200.60ï¼ˆæ¨èï¼‰            â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  Walletæ”¯ä»˜ï¼š$1,201.00                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  Stripeæ”¯ä»˜ï¼š$1,229.00                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  ğŸ’¡ ä»·æ ¼ç”±å•†æˆ·è®¾ç½®ï¼Œä¸åŒé€šé“ä»·æ ¼å¯èƒ½ä¸åŒ  â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                   â”‚   â”‚
â”‚  â”‚  [æŸ¥çœ‹å…¶ä»–æ”¯ä»˜æ–¹å¼]                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                           â”‚
â”‚  [å–æ¶ˆ]                                    [ç»§ç»­æ”¯ä»˜ â†’]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 10. è¿ç§»ç­–ç•¥

### 6.1 æ•°æ®è¿ç§»

#### 6.1.1 ç°æœ‰æ•°æ®è¿ç§»

**æ­¥éª¤1ï¼šåˆ›å»ºä»·æ ¼è®¾ç½®è¡¨**
- åˆ›å»º `product_prices` è¡¨
- åˆ›å»º `product_country_prices` è¡¨
- åˆ›å»º `product_channel_prices` è¡¨

**æ­¥éª¤2ï¼šè¿ç§»ç°æœ‰å•†å“ä»·æ ¼**
- ä» `products` è¡¨è¯»å–ç°æœ‰ä»·æ ¼
- åˆ›å»ºåŸºç¡€ä»·æ ¼è®°å½•
- ä¸ºæœ‰å›½å®¶å·®å¼‚çš„å•†å“åˆ›å»ºå›½å®¶ä»·æ ¼è®°å½•

**æ­¥éª¤3ï¼šæ›´æ–°æ”¯ä»˜è®°å½•è¡¨**
- æ·»åŠ  `country_code` å­—æ®µ
- æ·»åŠ  `base_amount` å­—æ®µ
- æ·»åŠ  `tax_amount` å­—æ®µ
- æ·»åŠ  `tax_rate` å­—æ®µ

### 6.2 åŠŸèƒ½è¿ç§»

#### 6.2.1 åˆ†é˜¶æ®µè¿ç§»

**é˜¶æ®µ1ï¼šåŸºç¡€åŠŸèƒ½ï¼ˆ1-2å‘¨ï¼‰**
- å®ç°ä»·æ ¼è®¾ç½®åŠŸèƒ½
- å®ç°ä»·æ ¼è·å–æœåŠ¡
- æ›´æ–°æ™ºèƒ½è·¯ç”±æœåŠ¡

**é˜¶æ®µ2ï¼šæ”¯ä»˜æµç¨‹ï¼ˆ1-2å‘¨ï¼‰**
- æ›´æ–°æ”¯ä»˜åˆ›å»ºæµç¨‹
- æ›´æ–°æ”¯ä»˜å¤„ç†æµç¨‹
- æ›´æ–°åˆ†ä½£è®¡ç®—é€»è¾‘

**é˜¶æ®µ3ï¼šç•Œé¢æ›´æ–°ï¼ˆ1å‘¨ï¼‰**
- æ›´æ–°å•†æˆ·åå°ç•Œé¢
- æ›´æ–°ç”¨æˆ·å‰ç«¯ç•Œé¢
- æ›´æ–°APIæ–‡æ¡£

**é˜¶æ®µ4ï¼šæµ‹è¯•å’Œä¼˜åŒ–ï¼ˆ1å‘¨ï¼‰**
- åŠŸèƒ½æµ‹è¯•
- æ€§èƒ½ä¼˜åŒ–
- ç”¨æˆ·ä½“éªŒä¼˜åŒ–

### 6.3 å…¼å®¹æ€§å¤„ç†

#### 6.3.1 å‘åå…¼å®¹

**ç­–ç•¥**ï¼š
- æ”¯æŒæ—§APIï¼ˆé€æ­¥åºŸå¼ƒï¼‰
- æ–°APIä¼˜å…ˆä½¿ç”¨å•†æˆ·ä»·æ ¼è®¾ç½®
- å¦‚æœæ²¡æœ‰ä»·æ ¼è®¾ç½®ï¼Œä½¿ç”¨é»˜è®¤ä»·æ ¼

**å®ç°**ï¼š
```typescript
async getProductPrice(
  productId: string,
  countryCode: string,
  channel?: PaymentMethod,
): Promise<ProductPrice> {
  // 1. å°è¯•è·å–å•†æˆ·è®¾ç½®çš„ä»·æ ¼
  const merchantPrice = await this.getMerchantPrice(
    productId,
    countryCode,
    channel,
  );
  
  if (merchantPrice) {
    return merchantPrice;
  }
  
  // 2. å¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œä½¿ç”¨é»˜è®¤ä»·æ ¼ï¼ˆå‘åå…¼å®¹ï¼‰
  const product = await this.productRepository.findOne({
    where: { id: productId },
  });
  
  const taxRate = await this.getTaxRate(countryCode);
  return {
    finalPrice: product.price * (1 + taxRate),
    basePrice: product.price,
    taxAmount: product.price * taxRate,
    taxRate,
    taxIncluded: true,
  };
}
```

---

## 7. æ€»ç»“

### 11.1 æ ¸å¿ƒå½±å“æ€»ç»“

#### 11.1.1 æ™ºèƒ½è·¯ç”±å½±å“

1. **ä»·æ ¼è·å–**ï¼šéœ€è¦ä»å•†æˆ·ä»·æ ¼è®¾ç½®ä¸­è·å–ä»·æ ¼ï¼Œè€Œéè‡ªå·±è®¡ç®—
2. **å…¨çƒæ”¯æŒ**ï¼šæ”¯æŒå…¨çƒ200+å›½å®¶ï¼Œ150+ç§è´§å¸
3. **é€šé“é€‰æ‹©**ï¼šåŸºäºå•†æˆ·è®¾ç½®çš„ä»·æ ¼è¿›è¡Œæ¨è
4. **ä»·æ ¼å¯¹æ¯”**ï¼šæ˜¾ç¤ºå„é€šé“çš„å•†æˆ·è®¾ç½®ä»·æ ¼å¯¹æ¯”

#### 11.1.2 æ”¯ä»˜æµç¨‹å½±å“

1. **æµç¨‹è°ƒæ•´**ï¼šéœ€è¦å…ˆè·å–ä»·æ ¼ï¼Œå†è¿›è¡Œè·¯ç”±
2. **ç»Ÿä¸€æµç¨‹**ï¼šä¿æŒ7é˜¶æ®µç»Ÿä¸€æ”¯ä»˜æµç¨‹ä¸å˜
3. **ä¸‰å±‚ID**ï¼šé›†æˆUser IDã€Agent IDã€Session ID
4. **SLAè®°å½•**ï¼šè®°å½•æ”¯ä»˜ç›¸å…³çš„SLAæŒ‡æ ‡

#### 11.1.3 åˆ†ä½£è®¡ç®—å½±å“

1. **è®¡ç®—åŸºç¡€**ï¼šåŸºäºå•†æˆ·ç¨å‰ä»·æ ¼ï¼ˆbasePriceï¼‰
2. **ç®€åŒ–è®¡ç®—**ï¼šå•†æˆ·ä»·æ ¼ Ã— å›ºå®šä½£é‡‘æ¯”ä¾‹
3. **è¡Œä¸šå¯¹æ ‡**ï¼šå‚è€ƒAmazonã€eBayç­‰ä¸»æµå¹³å°ä½£é‡‘æ¯”ä¾‹
4. **ç±»å‹åŒºåˆ†**ï¼šæ ¹æ®å•†å“ç±»å‹å’Œç±»åˆ«è®¾å®šä¸åŒä½£é‡‘æ¯”ä¾‹

#### 11.1.4 Agent IDä½“ç³»å½±å“

1. **å¤šé“¾æ”¯æŒ**ï¼šæ”¯æŒERC 8004ã€W3C DIDã€å¤šé“¾æ³¨å†Œ
2. **åè®®å…¼å®¹**ï¼šæ”¯æŒEthereumã€Solanaã€BSCã€Polygonã€Baseç­‰
3. **IDè§£æ**ï¼šéœ€è¦è§£æå¤šé“¾Agent ID
4. **åˆ†ä½£å…³è”**ï¼šåˆ†ä½£è®¡ç®—éœ€è¦å…³è”Agent ID

#### 11.1.5 SLAæ²»ç†å½±å“

1. **æŒ‡æ ‡è®°å½•**ï¼šè®°å½•æ”¯ä»˜æˆåŠŸç‡ã€å“åº”æ—¶é—´ã€å¯ç”¨æ€§ç­‰
2. **åˆè§„æ£€æŸ¥**ï¼šæ£€æŸ¥SLAæ˜¯å¦è¾¾æ ‡
3. **è¿çº¦å¤„ç†**ï¼šè§¦å‘SLAè¿çº¦æ—¶çš„è¡¥å¿æœºåˆ¶
4. **è¿½è´£æœºåˆ¶**ï¼šåŸºäºä¸‰å±‚IDçš„è¿½è´£ä½“ç³»

### 11.2 äº§å“è®¾è®¡æ”¹å˜æ€»ç»“

#### 11.2.1 æ–°å¢åŠŸèƒ½

1. **ä»·æ ¼ç®¡ç†**ï¼š
   - å•†å“ä»·æ ¼è®¾ç½®ï¼ˆåŸºç¡€ä»·æ ¼ã€å›½å®¶ä»·æ ¼ã€é€šé“ä»·æ ¼ï¼‰
   - ä»·æ ¼æ¨¡æ¿ç®¡ç†
   - ä»·æ ¼å†å²è®°å½•
   - ä»·æ ¼åˆ†ææŠ¥è¡¨

2. **ç¨è´¹ç®¡ç†**ï¼š
   - ç¨è´¹è®¡ç®—å·¥å…·
   - ç¨è´¹æŠ¥è¡¨
   - ç¨è´¹è®¾ç½®ï¼ˆå«ç¨/ä¸å«ç¨ï¼‰
   - ç¨è´¹è±å…ç®¡ç†

3. **Agent IDç®¡ç†**ï¼š
   - å¤šé“¾Agent IDæ³¨å†Œ
   - ERC 8004åè®®æ”¯æŒ
   - DIDåè®®æ”¯æŒ
   - è·¨é“¾Agent IDæ˜ å°„

4. **SLAç®¡ç†**ï¼š
   - SLAæŒ‡æ ‡è®°å½•
   - SLAåˆè§„æ£€æŸ¥
   - SLAè¿çº¦å¤„ç†
   - SLAæŠ¥è¡¨

#### 11.2.2 ä¿®æ”¹åŠŸèƒ½

1. **æ™ºèƒ½è·¯ç”±**ï¼š
   - åŸºäºå•†æˆ·ä»·æ ¼è¿›è¡Œè·¯ç”±å†³ç­–
   - æ”¯æŒå…¨çƒ200+å›½å®¶ï¼Œ150+ç§è´§å¸
   - ä»·æ ¼æƒé‡æå‡è‡³40%

2. **æ”¯ä»˜æµç¨‹**ï¼š
   - å…ˆè·å–ä»·æ ¼ï¼Œå†è¿›è¡Œè·¯ç”±
   - é›†æˆä¸‰å±‚IDä½“ç³»
   - è®°å½•SLAæŒ‡æ ‡

3. **åˆ†ä½£è®¡ç®—**ï¼š
   - åŸºäºå•†æˆ·ç¨å‰ä»·æ ¼è®¡ç®—
   - ä½¿ç”¨å›ºå®šä½£é‡‘æ¯”ä¾‹
   - æ”¯æŒè¡Œä¸šå¯¹æ ‡ä½£é‡‘æ¯”ä¾‹

4. **æ”¶å…¥æ˜¾ç¤º**ï¼š
   - åŒºåˆ†å•†æˆ·ç¨å‰æ”¶å…¥å’Œå®é™…æ”¶å…¥
   - æ˜¾ç¤ºç¨è´¹æ˜ç»†
   - æ˜¾ç¤ºé€šé“è´¹ç”¨
   - æ˜¾ç¤ºåˆ†ä½£æ˜ç»†

#### 11.2.3 ç•Œé¢è°ƒæ•´

1. **å•†æˆ·åå°**ï¼š
   - ä»·æ ¼è®¾ç½®é¡µé¢
   - ç¨è´¹ç®¡ç†é¡µé¢
   - Agent IDç®¡ç†é¡µé¢
   - SLAç›‘æ§é¡µé¢

2. **ç”¨æˆ·å‰ç«¯**ï¼š
   - ä»·æ ¼æ˜¾ç¤ºå’Œå¯¹æ¯”
   - æ”¯ä»˜æ–¹å¼é€‰æ‹©
   - è®¢å•ä»·æ ¼æ˜ç»†

### 11.3 æŠ€æœ¯æ¶æ„æ”¹å˜

#### 11.3.1 æ•°æ®åº“è®¾è®¡

**æ–°å¢è¡¨**ï¼š
- `product_prices` - å•†å“åŸºç¡€ä»·æ ¼
- `product_country_prices` - å•†å“å›½å®¶ä»·æ ¼
- `product_channel_prices` - å•†å“é€šé“ä»·æ ¼
- `agent_identities` - Agentèº«ä»½è¡¨ï¼ˆå¤šé“¾ï¼‰
- `agent_chain_identities` - Agentå¤šé“¾èº«ä»½è¡¨
- `sla_records` - SLAè®°å½•è¡¨
- `tax_rates` - ç¨è´¹é…ç½®è¡¨
- `order_taxes` - è®¢å•ç¨è´¹è®°å½•è¡¨

**ä¿®æ”¹è¡¨**ï¼š
- `payments` - æ·»åŠ  `country_code`ã€`base_amount`ã€`tax_amount`ã€`tax_rate`ã€`session_id`

#### 11.3.2 åç«¯æœåŠ¡

**æ–°å¢æœåŠ¡**ï¼š
- `PricingService` - ä»·æ ¼ç®¡ç†æœåŠ¡
- `TaxService` - ç¨è´¹ç®¡ç†æœåŠ¡
- `AgentIdentityService` - Agentèº«ä»½æœåŠ¡ï¼ˆå¤šé“¾ï¼‰
- `SLAService` - SLAç®¡ç†æœåŠ¡

**ä¿®æ”¹æœåŠ¡**ï¼š
- `SmartRouterService` - æ”¯æŒå•†æˆ·ä»·æ ¼è®¾ç½®
- `PaymentService` - æ”¯æŒä»·æ ¼è·å–å’Œç¨è´¹å¤„ç†
- `CommissionCalculatorService` - åŸºäºå•†æˆ·ç¨å‰ä»·æ ¼è®¡ç®—

#### 11.3.3 APIè°ƒæ•´

**æ–°å¢API**ï¼š
- `GET /api/products/:productId/pricing` - è·å–å•†å“ä»·æ ¼
- `POST /api/products/:productId/pricing` - è®¾ç½®å•†å“ä»·æ ¼
- `POST /api/tax/calculate` - è®¡ç®—ç¨è´¹
- `GET /api/tax/reports` - è·å–ç¨è´¹æŠ¥è¡¨
- `GET /api/agents/:agentId/identity` - è·å–Agentèº«ä»½ï¼ˆå¤šé“¾ï¼‰
- `GET /api/sla/records` - è·å–SLAè®°å½•

**ä¿®æ”¹API**ï¼š
- `GET /api/payments/routing` - å‚æ•°æ”¹ä¸º `productId` å’Œ `countryCode`
- `POST /api/payments` - å‚æ•°æ”¹ä¸º `productId` å’Œ `countryCode`

### 11.4 å®æ–½å»ºè®®

#### 11.4.1 åˆ†é˜¶æ®µå®æ–½

**é˜¶æ®µ1ï¼šåŸºç¡€åŠŸèƒ½ï¼ˆ2-3å‘¨ï¼‰**
- å®ç°ä»·æ ¼è®¾ç½®åŠŸèƒ½
- å®ç°ä»·æ ¼è·å–æœåŠ¡
- æ›´æ–°æ™ºèƒ½è·¯ç”±æœåŠ¡
- æ›´æ–°æ”¯ä»˜æµç¨‹

**é˜¶æ®µ2ï¼šåˆ†ä½£å’Œç¨è´¹ï¼ˆ1-2å‘¨ï¼‰**
- å®ç°ç®€åŒ–åˆ†ä½£è®¡ç®—
- å®ç°ç¨è´¹è®¡ç®—å’ŒæŠ¥è¡¨
- æ›´æ–°æ”¶å…¥æ˜¾ç¤º

**é˜¶æ®µ3ï¼šAgent IDå’ŒSLAï¼ˆ1-2å‘¨ï¼‰**
- å®ç°å¤šé“¾Agent IDæ”¯æŒ
- å®ç°ERC 8004åè®®æ”¯æŒ
- å®ç°SLAè®°å½•å’Œç›‘æ§

**é˜¶æ®µ4ï¼šç•Œé¢æ›´æ–°ï¼ˆ1å‘¨ï¼‰**
- æ›´æ–°å•†æˆ·åå°ç•Œé¢
- æ›´æ–°ç”¨æˆ·å‰ç«¯ç•Œé¢
- æ›´æ–°APIæ–‡æ¡£

**é˜¶æ®µ5ï¼šæµ‹è¯•å’Œä¼˜åŒ–ï¼ˆ1-2å‘¨ï¼‰**
- åŠŸèƒ½æµ‹è¯•
- æ€§èƒ½ä¼˜åŒ–
- ç”¨æˆ·ä½“éªŒä¼˜åŒ–

#### 11.4.2 å‘åå…¼å®¹

**ç­–ç•¥**ï¼š
- æ”¯æŒæ—§APIï¼ˆé€æ­¥åºŸå¼ƒï¼‰
- æ–°APIä¼˜å…ˆä½¿ç”¨å•†æˆ·ä»·æ ¼è®¾ç½®
- å¦‚æœæ²¡æœ‰ä»·æ ¼è®¾ç½®ï¼Œä½¿ç”¨é»˜è®¤ä»·æ ¼
- å¦‚æœæ²¡æœ‰Agent IDï¼Œä½¿ç”¨é»˜è®¤åˆ†ä½£é€»è¾‘

#### 11.4.3 æ•°æ®è¿ç§»

**æ­¥éª¤**ï¼š
1. åˆ›å»ºæ–°è¡¨ç»“æ„
2. è¿ç§»ç°æœ‰å•†å“ä»·æ ¼
3. è¿ç§»ç°æœ‰æ”¯ä»˜è®°å½•
4. æ›´æ–°Agent IDæ•°æ®
5. åˆå§‹åŒ–SLAè®°å½•

---

**æ­¤åˆ†æç¡®ä¿äº†PayMindç³»ç»Ÿèƒ½å¤Ÿæ”¯æŒå•†æˆ·è‡ªä¸»å®šä»·æ¨¡å¼ï¼ŒåŒæ—¶ä¿æŒæ™ºèƒ½è·¯ç”±å’Œæ”¯ä»˜æµç¨‹çš„å®Œæ•´æ€§å’Œå‡†ç¡®æ€§ã€‚**

