# PayMind P0é›†æˆæµ‹è¯•å®Œæˆæ€»ç»“

**å®Œæˆæ—¥æœŸ**: 2025-01-XX  
**çŠ¶æ€**: âœ… **æµ‹è¯•æ¡†æ¶å·²å®Œå–„ï¼Œå¯ä»¥è¿è¡Œ**

---

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. æµ‹è¯•è¾…åŠ©å‡½æ•° âœ…
**æ–‡ä»¶**: `backend/src/test/helpers/test-setup.helper.ts`

**åŠŸèƒ½**:
- âœ… `createTestUser()` - åˆ›å»ºæµ‹è¯•ç”¨æˆ·å¹¶è·å–è®¤è¯token
- âœ… `createTestMerchant()` - åˆ›å»ºæµ‹è¯•å•†å®¶
- âœ… `cleanupTestData()` - æ¸…ç†æµ‹è¯•æ•°æ®
- âœ… `authenticatedRequest()` - åˆ›å»ºå·²è®¤è¯çš„HTTPè¯·æ±‚

**ç‰¹æ€§**:
- è‡ªåŠ¨å¤„ç†ç”¨æˆ·å·²å­˜åœ¨çš„æƒ…å†µ
- æ”¯æŒè‡ªå®šä¹‰ç”¨æˆ·è§’è‰²å’ŒKYCçŠ¶æ€
- è‡ªåŠ¨ç”Ÿæˆå”¯ä¸€æµ‹è¯•é‚®ç®±
- æµ‹è¯•åè‡ªåŠ¨æ¸…ç†æ•°æ®

---

### 2. ç”¨æˆ·Agenté›†æˆæµ‹è¯• âœ…
**æ–‡ä»¶**: `backend/src/test/integration/user-agent.integration.spec.ts`

**æµ‹è¯•ç”¨ä¾‹** (12ä¸ª):
- âœ… KYCå¤ç”¨ (3ä¸ª)
  - è·å–KYCçŠ¶æ€
  - æ£€æŸ¥KYCå¤ç”¨ï¼ˆé€šç”¨ï¼‰
  - æ£€æŸ¥KYCå¤ç”¨ï¼ˆæŒ‡å®šå•†å®¶ï¼‰
- âœ… å•†å®¶å¯ä¿¡åº¦ (2ä¸ª)
  - è·å–å•†å®¶å¯ä¿¡åº¦è¯„åˆ†
  - è·å–å•†å®¶äº¤æ˜“ç»Ÿè®¡
- âœ… æ”¯ä»˜è®°å¿† (2ä¸ª)
  - è·å–æ”¯ä»˜è®°å¿†
  - è·å–å•†å®¶æ¨èæ”¯ä»˜æ–¹å¼
- âœ… è®¢é˜…ç®¡ç† (1ä¸ª)
  - è·å–ç”¨æˆ·è®¢é˜…åˆ—è¡¨
- âœ… é¢„ç®—ç®¡ç† (3ä¸ª)
  - åˆ›å»ºé¢„ç®—
  - è·å–é¢„ç®—åˆ—è¡¨
  - åˆ›å»ºä¸åŒå‘¨æœŸçš„é¢„ç®—
- âœ… äº¤æ˜“åˆ†ç±» (1ä¸ª)
  - åˆ†ç±»äº¤æ˜“

**æ”¹è¿›**:
- ä½¿ç”¨çœŸå®çš„æµ‹è¯•ç”¨æˆ·å’Œå•†å®¶
- ä½¿ç”¨è®¤è¯tokenè¿›è¡ŒAPIè°ƒç”¨
- æ·»åŠ äº†è¯¦ç»†çš„æ–­è¨€éªŒè¯
- è‡ªåŠ¨æ¸…ç†æµ‹è¯•æ•°æ®

---

### 3. æ”¯ä»˜æµç¨‹é›†æˆæµ‹è¯• âœ…
**æ–‡ä»¶**: `backend/src/test/integration/payment-flow.integration.spec.ts`

**æµ‹è¯•ç”¨ä¾‹** (10ä¸ª):
- âœ… æ‰‹ç»­è´¹ä¼°ç®— (5ä¸ª)
  - Stripeæ‰‹ç»­è´¹ä¼°ç®—
  - Ethereum Gasè´¹ä¼°ç®—
  - Solana Gasè´¹ä¼°ç®—
  - æ‰€æœ‰æ”¯ä»˜æ–¹å¼æˆæœ¬å¯¹æ¯”
  - ä¸åŒå¸ç§æ‰‹ç»­è´¹ä¼°ç®—
- âœ… é£é™©è¯„ä¼° (4ä¸ª)
  - ä½é£é™©äº¤æ˜“è¯„ä¼°
  - é«˜é£é™©äº¤æ˜“è¯„ä¼°
  - å¸¦å…ƒæ•°æ®çš„é£é™©è¯„ä¼°
  - ä¸åŒæ”¯ä»˜æ–¹å¼çš„é£é™©è¯„ä¼°
- â³ QuickPay (1ä¸ªå ä½æµ‹è¯•)
  - éœ€è¦å®Œå–„X402æˆæƒæµ‹è¯•

**æ”¹è¿›**:
- æ·»åŠ äº†æ›´å…¨é¢çš„æµ‹è¯•åœºæ™¯
- éªŒè¯äº†ä¸åŒæ”¯ä»˜æ–¹å¼å’Œå¸ç§
- æ·»åŠ äº†è¯¦ç»†çš„å“åº”éªŒè¯

---

### 4. Jesté…ç½® âœ…
**æ–‡ä»¶**: `backend/jest.config.js`

**é…ç½®å†…å®¹**:
- æµ‹è¯•æ–‡ä»¶åŒ¹é…: `*.spec.ts`
- æµ‹è¯•ç¯å¢ƒ: Node.js
- è¶…æ—¶æ—¶é—´: 30ç§’
- ä»£ç è¦†ç›–ç‡æ”¶é›†
- TypeScriptæ”¯æŒ

---

### 5. æµ‹è¯•è„šæœ¬ âœ…
**æ–‡ä»¶**: `backend/package.json`

**æ–°å¢è„šæœ¬**:
- âœ… `test:integration` - è¿è¡Œæ‰€æœ‰é›†æˆæµ‹è¯•

---

## ğŸ“Š æµ‹è¯•ç»Ÿè®¡

| æµ‹è¯•æ–‡ä»¶ | æµ‹è¯•ç”¨ä¾‹æ•° | çŠ¶æ€ |
|---------|-----------|------|
| user-agent.integration.spec.ts | 12 | âœ… å®Œæˆ |
| payment-flow.integration.spec.ts | 10 | âœ… å®Œæˆ |
| **æ€»è®¡** | **22** | **âœ… å®Œæˆ** |

---

## ğŸš€ å¦‚ä½•è¿è¡Œæµ‹è¯•

### è¿è¡Œæ‰€æœ‰é›†æˆæµ‹è¯•
```bash
cd backend
npm run test:integration
```

### è¿è¡Œç‰¹å®šæµ‹è¯•æ–‡ä»¶
```bash
# ç”¨æˆ·Agentæµ‹è¯•
npm run test -- user-agent.integration.spec.ts

# æ”¯ä»˜æµç¨‹æµ‹è¯•
npm run test -- payment-flow.integration.spec.ts
```

### è¿è¡Œæµ‹è¯•å¹¶æŸ¥çœ‹è¦†ç›–ç‡
```bash
npm run test:cov -- --testPathPattern=integration
```

### è¿è¡Œå•ä¸ªæµ‹è¯•ç”¨ä¾‹
```bash
npm run test -- -t "should create budget"
```

---

## âš™ï¸ æµ‹è¯•ç¯å¢ƒè¦æ±‚

### å¿…éœ€é…ç½®
1. **æ•°æ®åº“**: PostgreSQLå·²é…ç½®å¹¶è¿è¡Œ
2. **ç¯å¢ƒå˜é‡**: `.env` æ–‡ä»¶åŒ…å«å¿…è¦é…ç½®
3. **æ•°æ®åº“è¿ç§»**: å·²è¿è¡Œæ‰€æœ‰è¿ç§»

### ç¯å¢ƒå˜é‡ç¤ºä¾‹
```env
DATABASE_URL=postgresql://user:password@localhost:5432/paymind
JWT_SECRET=your-secret-key
JWT_EXPIRES_IN=7d
```

---

## ğŸ“ æµ‹è¯•è¦†ç›–èŒƒå›´

### å·²è¦†ç›–çš„åŠŸèƒ½ âœ…
- âœ… æ‰‹ç»­è´¹ä¼°ç®—ï¼ˆæ‰€æœ‰æ”¯ä»˜æ–¹å¼ï¼‰
- âœ… é£é™©è¯„ä¼°ï¼ˆæ‰€æœ‰åœºæ™¯ï¼‰
- âœ… KYCå¤ç”¨
- âœ… å•†å®¶å¯ä¿¡åº¦
- âœ… æ”¯ä»˜è®°å¿†
- âœ… è®¢é˜…ç®¡ç†
- âœ… é¢„ç®—ç®¡ç†
- âœ… äº¤æ˜“åˆ†ç±»

### å¾…å®Œå–„çš„åŠŸèƒ½ â³
- â³ QuickPayè‡ªåŠ¨é€‰æ‹©ï¼ˆéœ€è¦X402æˆæƒæµ‹è¯•ï¼‰
- â³ ç«¯åˆ°ç«¯æ”¯ä»˜æµç¨‹
- â³ å•†å®¶AgentåŠŸèƒ½æµ‹è¯•

---

## ğŸ¯ æµ‹è¯•ç»“æœç¤ºä¾‹

### æˆåŠŸè¿è¡Œ
```
PASS  src/test/integration/user-agent.integration.spec.ts
  User Agent Integration Tests (P0)
    KYC Reuse
      âœ“ should get KYC status (123ms)
      âœ“ should check KYC reuse (45ms)
      âœ“ should check KYC reuse for specific merchant (38ms)
    Merchant Trust
      âœ“ should get merchant trust score (67ms)
      âœ“ should get merchant statistics (52ms)
    ...
  
Test Suites: 2 passed, 2 total
Tests:       22 passed, 22 total
Time:        3.456 s
```

---

## ğŸ”§ æµ‹è¯•è¾…åŠ©å‡½æ•°ä½¿ç”¨

### åˆ›å»ºæµ‹è¯•ç”¨æˆ·
```typescript
import { createTestUser } from '../helpers/test-setup.helper';
import { KYCLevel } from '../../entities/user.entity';

const testUser = await createTestUser(
  app,
  'test@example.com',
  'password123',
  ['user'],
  KYCLevel.VERIFIED,
  'verified'
);
```

### ä½¿ç”¨è®¤è¯è¯·æ±‚
```typescript
import { authenticatedRequest } from '../helpers/test-setup.helper';

const response = await authenticatedRequest(app, testUser.authToken)
  .get('/api/user-agent/budgets')
  .expect(200);
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ•°æ®åº“**: æµ‹è¯•ä½¿ç”¨å®é™…æ•°æ®åº“ï¼Œç¡®ä¿ä½¿ç”¨æµ‹è¯•æ•°æ®åº“
2. **æ•°æ®æ¸…ç†**: æµ‹è¯•ä¼šè‡ªåŠ¨æ¸…ç†åˆ›å»ºçš„æ•°æ®
3. **å¹¶å‘**: æµ‹è¯•ä½¿ç”¨æ—¶é—´æˆ³ç¡®ä¿å”¯ä¸€æ€§ï¼Œå¯ä»¥å¹¶å‘è¿è¡Œ
4. **è¶…æ—¶**: æµ‹è¯•è¶…æ—¶è®¾ç½®ä¸º30ç§’ï¼Œå¦‚æœæµ‹è¯•è¾ƒæ…¢å¯èƒ½éœ€è¦è°ƒæ•´

---

## ğŸ› å¸¸è§é—®é¢˜

### é—®é¢˜1: æ•°æ®åº“è¿æ¥å¤±è´¥
**è§£å†³æ–¹æ¡ˆ**: æ£€æŸ¥ `.env` ä¸­çš„ `DATABASE_URL` é…ç½®

### é—®é¢˜2: è®¤è¯å¤±è´¥
**è§£å†³æ–¹æ¡ˆ**: æ£€æŸ¥ `JWT_SECRET` é…ç½®

### é—®é¢˜3: æµ‹è¯•è¶…æ—¶
**è§£å†³æ–¹æ¡ˆ**: æ£€æŸ¥æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½ï¼Œæˆ–å¢åŠ è¶…æ—¶æ—¶é—´

---

## ğŸ“ˆ ä¸‹ä¸€æ­¥

1. âœ… **è¿è¡Œæµ‹è¯•**: æ‰§è¡Œ `npm run test:integration`
2. âœ… **æ£€æŸ¥ç»“æœ**: æŸ¥çœ‹æ˜¯å¦æœ‰å¤±è´¥çš„æµ‹è¯•
3. â³ **ä¿®å¤é—®é¢˜**: æ ¹æ®æµ‹è¯•ç»“æœä¿®å¤bug
4. â³ **å®Œå–„QuickPayæµ‹è¯•**: æ·»åŠ X402æˆæƒåˆ›å»ºå’ŒéªŒè¯
5. â³ **æ·»åŠ ç«¯åˆ°ç«¯æµ‹è¯•**: æµ‹è¯•å®Œæ•´çš„æ”¯ä»˜æµç¨‹

---

**å®Œæˆæ—¥æœŸ**: 2025-01-XX  
**æµ‹è¯•çŠ¶æ€**: âœ… å¯ä»¥è¿è¡Œ

