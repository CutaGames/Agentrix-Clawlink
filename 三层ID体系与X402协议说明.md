# ä¸‰å±‚IDä½“ç³»ä¸X402åè®®è¯´æ˜

**ç‰ˆæœ¬**: V7.0  
**æ—¥æœŸ**: 2025å¹´1æœˆ

---

## ğŸ“‹ ç›®å½•

1. [ä¸‰å±‚IDä½“ç³»](#1-ä¸‰å±‚idä½“ç³»)
2. [X402åè®®](#2-x402åè®®)
3. [ERC8004ä¸X402çš„å…³ç³»](#3-erc8004ä¸x402çš„å…³ç³»)
4. [åœ¨æ”¯ä»˜æµç¨‹ä¸­çš„åº”ç”¨](#4-åœ¨æ”¯ä»˜æµç¨‹ä¸­çš„åº”ç”¨)

---

## 1. ä¸‰å±‚IDä½“ç³»

### 1.1 ä¸‰å±‚IDå®šä¹‰

ä¸‰å±‚IDä½“ç³»æ˜¯ Agentrix æ”¯ä»˜ç³»ç»Ÿçš„èº«ä»½è¿½è¸ªæœºåˆ¶ï¼Œç”¨äºè¿½è´£å’Œå®¡è®¡ï¼š

#### 1.1.1 User IDï¼ˆç”¨æˆ·IDï¼‰

**å®šä¹‰**: ç”¨æˆ·çš„å”¯ä¸€èº«ä»½æ ‡è¯†

**ç‰¹ç‚¹**:
- æ°¸ä¹…å”¯ä¸€
- è·¨ä¼šè¯ã€è·¨Agent
- ç”¨äºç”¨æˆ·èº«ä»½éªŒè¯å’Œè¿½è¸ª

**å®ç°æ–¹å¼**:
- Agentrix IDï¼ˆç³»ç»Ÿç”Ÿæˆï¼Œæ ¼å¼ï¼š`pm-{timestamp}-{random}`ï¼‰
- é’±åŒ…åœ°å€ï¼ˆWeb3ç”¨æˆ·ï¼Œå¤šé“¾æ”¯æŒï¼‰
- é‚®ç®±/æ‰‹æœºå·ï¼ˆWeb2ç”¨æˆ·ï¼‰

**ç¤ºä¾‹**:
```typescript
userId: "pm-1763463490911-91zf91wu2"
// æˆ–
userId: "0x2bee8ae78e4e41cf7facc4a4387a8f299dd2b8f3"
```

#### 1.1.2 Agent IDï¼ˆä»£ç†IDï¼‰

**å®šä¹‰**: AIä»£ç†çš„å”¯ä¸€èº«ä»½æ ‡è¯†ï¼Œå‚è€ƒERC8004åè®®

**ç‰¹ç‚¹**:
- æ¯ä¸ªAgentæœ‰å”¯ä¸€ID
- å¯éªŒè¯ã€å¯è¿½æº¯
- æ”¯æŒä¿¡èª‰è¯„ä¼°
- å¯é€‰ï¼ˆå¦‚æœæ²¡æœ‰Agentå‚ä¸ï¼Œåˆ™ä¸ºç©ºï¼‰

**å®ç°æ–¹å¼**:
- ERC8004åè®®æ ‡å‡†ï¼ˆé“¾ä¸Šæ³¨å†Œï¼‰
- Agentrix Agent IDï¼ˆè·¨é“¾ç»Ÿä¸€IDï¼‰
- W3C DIDæ ¼å¼ï¼š`did:agentrix:agent:{agentId}`

**ç¤ºä¾‹**:
```typescript
agentId: "x402_system"  // X402ç³»ç»Ÿæˆæƒ
// æˆ–
agentId: "agent-erc8004-0x1234..."  // ERC8004 Agent ID
```

#### 1.1.3 Session IDï¼ˆä¼šè¯IDï¼‰

**å®šä¹‰**: å•æ¬¡æ”¯ä»˜ä¼šè¯çš„å”¯ä¸€æ ‡è¯†

**ç‰¹ç‚¹**:
- æ¯æ¬¡æ”¯ä»˜ç”Ÿæˆæ–°çš„Session ID
- ç”¨äºè¿½è´£å’Œå®¡è®¡
- å…³è”User IDå’ŒAgent ID
- ç”¨äºé—®é¢˜è¿½è¸ª

**å®ç°æ–¹å¼**:
- ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆï¼ˆUUID v4ï¼‰
- å…³è”æ”¯ä»˜ã€åˆ†ä½£ã€ç»“ç®—è®°å½•
- ç”¨äºSLAè®°å½•å’Œè¿½è´£

**ç¤ºä¾‹**:
```typescript
sessionId: "550e8400-e29b-41d4-a716-446655440000"
```

### 1.2 ä¸‰å±‚IDåœ¨æ”¯ä»˜æµç¨‹ä¸­çš„åˆ›å»º

**ä½ç½®**: `backend/src/modules/payment/payment.service.ts`

```typescript
// åˆ›å»ºSession IDï¼ˆä¸‰å±‚IDä¹‹ä¸€ï¼‰
const sessionId = uuidv4();

// æ”¯ä»˜è®°å½•åŒ…å«ä¸‰å±‚ID
const payment = this.paymentRepository.create({
  userId,           // User IDï¼ˆä»è¯·æ±‚ä¸­è·å–ï¼‰
  agentId,          // Agent IDï¼ˆå¯é€‰ï¼Œä»metadataä¸­è·å–ï¼‰
  // sessionId å­˜å‚¨åœ¨ metadata ä¸­
  metadata: {
    sessionId,      // Session ID
    userId,         // User IDï¼ˆå†—ä½™å­˜å‚¨ï¼Œä¾¿äºæŸ¥è¯¢ï¼‰
    agentId,        // Agent IDï¼ˆå†—ä½™å­˜å‚¨ï¼Œä¾¿äºæŸ¥è¯¢ï¼‰
    // ...
  },
});
```

### 1.3 ä¸‰å±‚IDçš„åº”ç”¨åœºæ™¯

#### 1.3.1 æ”¯ä»˜è®°å½•å…³è”

```typescript
interface Payment {
  id: string;
  userId: string;        // User ID
  agentId?: string;     // Agent IDï¼ˆå¯é€‰ï¼‰
  metadata: {
    sessionId: string;  // Session ID
    // ...
  };
}
```

#### 1.3.2 åˆ†ä½£è®°å½•å…³è”

```typescript
interface Commission {
  paymentId: string;
  userId: string;        // User ID
  agentId?: string;     // Agent IDï¼ˆå¦‚æœæœ‰Agentå‚ä¸ï¼‰
  sessionId: string;    // Session ID
  // ...
}
```

#### 1.3.3 è¿½è´£å’Œå®¡è®¡

- **ç”¨æˆ·è¿½è´£**: é€šè¿‡ User ID è¿½è¸ªç”¨æˆ·çš„æ‰€æœ‰æ”¯ä»˜è®°å½•
- **Agentè¿½è´£**: é€šè¿‡ Agent ID è¿½è¸ªAgentçš„æ‰§è¡Œè®°å½•
- **ä¼šè¯è¿½è¸ª**: é€šè¿‡ Session ID è¿½è¸ªå•æ¬¡æ”¯ä»˜çš„å®Œæ•´æµç¨‹

---

## 2. X402åè®®

### 2.1 X402åè®®æ¦‚è¿°

**X402** æ˜¯ä¸€ä¸ªæ”¯ä»˜åè®®ï¼Œä¸“æ³¨äºæ‰¹é‡æ”¯ä»˜å’ŒGasä¼˜åŒ–ã€‚

**æ ¸å¿ƒç‰¹ç‚¹**:
- âœ… **æ‰¹é‡æ”¯ä»˜**: æ”¯æŒæ‰¹é‡å¤„ç†å¤šä¸ªæ”¯ä»˜ï¼ŒèŠ‚çœGas
- âœ… **æ•°æ®å‹ç¼©**: å‹ç¼©äº¤æ˜“æ•°æ®ï¼Œå‡å°‘é“¾ä¸Šå­˜å‚¨æˆæœ¬
- âœ… **Gasä¼˜åŒ–**: é€šè¿‡æ‰¹é‡å¤„ç†å’Œå‹ç¼©ï¼ŒGasè´¹ç”¨é™ä½çº¦40%
- âœ… **Relayeræ‰§è¡Œ**: é€šè¿‡Relayerä»£ä¸ºæ‰§è¡Œï¼Œç”¨æˆ·æ— éœ€æ”¯ä»˜Gas

### 2.2 X402åè®®å®ç°

**æ–‡ä»¶**: `backend/src/modules/payment/x402.service.ts`

#### 2.2.1 X402 Session

```typescript
interface X402Session {
  sessionId: string;        // X402ä¼šè¯ID
  paymentId: string;        // æ”¯ä»˜ID
  compressedData: string;   // å‹ç¼©çš„äº¤æ˜“æ•°æ®
  gasEstimate: string;      // Gasä¼°ç®—
  gasSaved: string;          // èŠ‚çœçš„Gasï¼ˆç™¾åˆ†æ¯”ï¼‰
  expiresAt: Date;          // è¿‡æœŸæ—¶é—´
}
```

#### 2.2.2 åˆ›å»ºX402æ”¯ä»˜ä¼šè¯

```typescript
async createPaymentSession(
  paymentId: string,
  dto: ProcessPaymentDto,
): Promise<X402Session> {
  // 1. å‹ç¼©äº¤æ˜“æ•°æ®
  const compressedData = await this.compressTransactionData(paymentId, dto);
  
  // 2. åˆ›å»ºæ”¯ä»˜ä¼šè¯ï¼ˆè°ƒç”¨X402ä¸­ç»§å™¨ï¼‰
  const sessionId = await this.createSessionOnRelayer(...);
  
  // 3. è®¡ç®—GasèŠ‚çœ
  const gasEstimate = await this.estimateGas(dto);
  const gasSaved = ((standardGas - gasEstimate) / standardGas) * 100;
  
  return { sessionId, paymentId, compressedData, ... };
}
```

#### 2.2.3 æ•°æ®å‹ç¼©

```typescript
private async compressTransactionData(
  paymentId: string,
  dto: ProcessPaymentDto,
): Promise<string> {
  const transactionData = {
    paymentId,
    amount: dto.amount,
    currency: dto.currency,
    recipient: dto.metadata?.recipient || dto.merchantId,
    timestamp: Date.now(),
  };
  
  // ä½¿ç”¨Base64ç¼–ç å‹ç¼©ï¼ˆå®é™…åº”è¯¥ä½¿ç”¨æ›´é«˜æ•ˆçš„å‹ç¼©ç®—æ³•ï¼‰
  const jsonString = JSON.stringify(transactionData);
  const compressed = Buffer.from(jsonString).toString('base64');
  
  return compressed;
}
```

### 2.3 X402æˆæƒæœåŠ¡

**æ–‡ä»¶**: `backend/src/modules/payment/x402-authorization.service.ts`

X402æˆæƒæœåŠ¡ç®¡ç†ç”¨æˆ·çš„X402æ”¯ä»˜æˆæƒï¼š

```typescript
interface X402Authorization {
  id: string;
  userId: string;
  isActive: boolean;
  singleLimit: number;      // å•ç¬”é™é¢
  dailyLimit: number;       // æ¯æ—¥é™é¢
  usedToday: number;         // ä»Šæ—¥å·²ç”¨
  expiresAt: Date;
  createdAt: Date;
}
```

**ç‰¹ç‚¹**:
- ä½¿ç”¨ç‰¹æ®Šçš„ `agentId: 'x402_system'` æ ‡è¯†X402ç³»ç»Ÿæˆæƒ
- åŸºäº `AutoPayGrant` å®ä½“å®ç°
- æ”¯æŒå•ç¬”å’Œæ¯æ—¥é™é¢æ§åˆ¶

### 2.4 X402åœ¨æ”¯ä»˜æµç¨‹ä¸­çš„ä½œç”¨

```
ç”¨æˆ·æ”¯ä»˜è¯·æ±‚
    â†“
æ£€æŸ¥X402æˆæƒï¼ˆX402AuthorizationServiceï¼‰
    â†“
åˆ›å»ºX402æ”¯ä»˜ä¼šè¯ï¼ˆX402Service.createPaymentSessionï¼‰
    â†“
å‹ç¼©äº¤æ˜“æ•°æ®
    â†“
è°ƒç”¨X402ä¸­ç»§å™¨åˆ›å»ºä¼šè¯
    â†“
è®¡ç®—GasèŠ‚çœ
    â†“
æ‰§è¡Œæ”¯ä»˜ï¼ˆé€šè¿‡Relayerï¼‰
    â†“
æ‰¹é‡ä¸Šé“¾ï¼ˆèŠ‚çœGasï¼‰
```

---

## 3. ERC8004ä¸X402çš„å…³ç³»

### 3.1 æ¦‚å¿µåŒºåˆ†

| æ¦‚å¿µ | ç±»å‹ | ä½œç”¨ |
|------|------|------|
| **ERC8004** | æ™ºèƒ½åˆçº¦æ ‡å‡† | Session Keyç®¡ç†æ ‡å‡†ï¼Œé“¾ä¸ŠSessionç®¡ç† |
| **X402** | æ”¯ä»˜åè®® | æ‰¹é‡æ”¯ä»˜å’ŒGasä¼˜åŒ–åè®® |
| **QuickPay** | æ”¯ä»˜æ–¹å¼ | ç»“åˆERC8004å’ŒX402å®ç°çš„å…å¯†æ”¯ä»˜ |

### 3.2 å…³ç³»è¯´æ˜

#### 3.2.1 ERC8004æä¾›Sessionç®¡ç†

**ERC8004åˆçº¦** (`ERC8004SessionManager.sol`):
- ç®¡ç†Session Keyæˆæƒ
- é“¾ä¸ŠSessionçŠ¶æ€ç®¡ç†
- é™é¢æ§åˆ¶å’Œç­¾åéªŒè¯

**ä½œç”¨**:
- ç”¨æˆ·åˆ›å»ºSessionæ—¶ï¼Œè°ƒç”¨ `ERC8004.createSession()`
- æ”¯ä»˜æ—¶ï¼Œä½¿ç”¨Session Keyç­¾å
- RelayeréªŒè¯ç­¾ååï¼Œè°ƒç”¨ `ERC8004.executeWithSession()`

#### 3.2.2 X402æä¾›æ‰¹é‡æ”¯ä»˜ä¼˜åŒ–

**X402åè®®**:
- æ‰¹é‡å¤„ç†å¤šä¸ªæ”¯ä»˜
- æ•°æ®å‹ç¼©ä»¥èŠ‚çœGas
- é€šè¿‡Relayeræ‰§è¡Œ

**ä½œç”¨**:
- å°†å¤šä¸ªæ”¯ä»˜è¯·æ±‚æ‰¹é‡æ‰“åŒ…
- å‹ç¼©äº¤æ˜“æ•°æ®
- ä¸€æ¬¡æ€§ä¸Šé“¾ï¼ŒèŠ‚çœGasè´¹ç”¨

#### 3.2.3 ä¸¤è€…ç»“åˆå®ç°QuickPay

```
ç”¨æˆ·åˆ›å»ºSession
    â†“
ERC8004.createSession() (é“¾ä¸Š)
    â†“
ç”¨æˆ·æ”¯ä»˜æ—¶ä½¿ç”¨Session Keyç­¾å
    â†“
X402åè®®æ‰¹é‡å¤„ç†
    â†“
RelayeréªŒè¯ç­¾åï¼ˆé“¾ä¸‹ï¼Œå³æ—¶ç¡®è®¤ï¼‰
    â†“
X402æ‰¹é‡ä¸Šé“¾ï¼ˆèŠ‚çœGasï¼‰
    â†“
ERC8004.executeWithSession() (é“¾ä¸Šæ‰§è¡Œ)
```

### 3.3 å½“å‰å®ç°çŠ¶æ€

**å½“å‰ç³»ç»Ÿ**:
- âœ… ERC8004åˆçº¦å·²å®ç°ï¼ˆ`ERC8004SessionManager.sol`ï¼‰
- âœ… X402æœåŠ¡å·²å®ç°ï¼ˆ`X402Service`ï¼‰
- âš ï¸ X402æˆæƒæœåŠ¡åŸºäºé“¾ä¸‹æ•°æ®åº“ï¼ˆ`X402AuthorizationService`ï¼‰
- âš ï¸ X402å’ŒERC8004çš„é›†æˆéœ€è¦è¿›ä¸€æ­¥å®Œå–„

**æœªæ¥ä¼˜åŒ–**:
- å°†X402æˆæƒè¿ç§»åˆ°ERC8004åˆçº¦
- ç»Ÿä¸€Sessionç®¡ç†ï¼ˆé“¾ä¸Šï¼‰
- ä¼˜åŒ–æ‰¹é‡æ”¯ä»˜æµç¨‹

---

## 4. åœ¨æ”¯ä»˜æµç¨‹ä¸­çš„åº”ç”¨

### 4.1 æ”¯ä»˜æµç¨‹ä¸­çš„ä¸‰å±‚ID

**ä½ç½®**: `backend/src/modules/payment/payment.service.ts`

```typescript
async processPayment(userId: string, dto: ProcessPaymentDto) {
  // 1. è·å–User IDï¼ˆä»è¯·æ±‚ä¸­ï¼‰
  const user = await this.userRepository.findOne({ where: { id: userId } });
  
  // 2. è·å–Agent IDï¼ˆå¯é€‰ï¼Œä»metadataä¸­ï¼‰
  const agentId = dto.metadata?.agentId || dto.agentId;
  
  // 3. åˆ›å»ºSession IDï¼ˆä¸‰å±‚IDä¹‹ä¸€ï¼‰
  const sessionId = uuidv4();
  
  // 4. åˆ›å»ºæ”¯ä»˜è®°å½•ï¼ˆåŒ…å«ä¸‰å±‚IDï¼‰
  const payment = this.paymentRepository.create({
    userId,           // User ID
    agentId,          // Agent IDï¼ˆå¯é€‰ï¼‰
    metadata: {
      sessionId,      // Session ID
      userId,         // User IDï¼ˆå†—ä½™ï¼‰
      agentId,        // Agent IDï¼ˆå†—ä½™ï¼‰
      // ...
    },
  });
  
  // 5. è®¡ç®—ä½£é‡‘ï¼ˆå…³è”ä¸‰å±‚IDï¼‰
  await this.commissionCalculator.calculateAndRecordCommission(
    payment.id,
    payment,
    commissionBase,
    sessionId,  // ä¼ é€’Session ID
  );
}
```

### 4.2 X402æ”¯ä»˜æµç¨‹

```typescript
// 1. æ£€æŸ¥X402æˆæƒ
const x402Auth = await this.x402AuthService.checkAuthorization(userId);

if (x402Auth && x402Auth.isActive) {
  // 2. æ£€æŸ¥é™é¢
  if (dto.amount <= x402Auth.singleLimit) {
    const dailyUsed = x402Auth.usedToday || 0;
    if (dailyUsed + dto.amount <= x402Auth.dailyLimit) {
      // 3. ä½¿ç”¨X402æ”¯ä»˜
      actualPaymentMethod = PaymentMethod.X402;
      
      // 4. åˆ›å»ºX402æ”¯ä»˜ä¼šè¯
      const x402Session = await this.x402Service.createPaymentSession(
        payment.id,
        dto,
      );
      
      // 5. è®°å½•ä½¿ç”¨é‡
      await this.x402AuthService.recordUsage(x402Auth.id, dto.amount);
    }
  }
}
```

### 4.3 ä¸‰å±‚IDåœ¨åˆ†ä½£ä¸­çš„åº”ç”¨

```typescript
// è®¡ç®—ä½£é‡‘æ—¶å…³è”ä¸‰å±‚ID
await this.commissionCalculator.calculateAndRecordCommission(
  paymentId,
  payment,
  commissionBase,
  sessionId,  // Session ID
);

// ä½£é‡‘è®°å½•åŒ…å«ä¸‰å±‚ID
interface Commission {
  paymentId: string;
  userId: string;        // User ID
  agentId?: string;     // Agent ID
  sessionId: string;    // Session ID
  // ...
}
```

---

## 5. æ€»ç»“

### 5.1 ä¸‰å±‚IDä½“ç³»

- **User ID**: ç”¨æˆ·å”¯ä¸€æ ‡è¯†
- **Agent ID**: Agentå”¯ä¸€æ ‡è¯†ï¼ˆå¯é€‰ï¼‰
- **Session ID**: æ”¯ä»˜ä¼šè¯å”¯ä¸€æ ‡è¯†

**ä½œç”¨**: è¿½è´£ã€å®¡è®¡ã€é—®é¢˜è¿½è¸ª

### 5.2 X402åè®®

- **æ‰¹é‡æ”¯ä»˜**: èŠ‚çœGas
- **æ•°æ®å‹ç¼©**: å‡å°‘é“¾ä¸Šå­˜å‚¨
- **Relayeræ‰§è¡Œ**: ç”¨æˆ·æ— éœ€æ”¯ä»˜Gas

**ä½œç”¨**: ä¼˜åŒ–æ”¯ä»˜æˆæœ¬ï¼Œæå‡ç”¨æˆ·ä½“éªŒ

### 5.3 ERC8004ä¸X402

- **ERC8004**: Session Keyç®¡ç†æ ‡å‡†ï¼ˆé“¾ä¸Šï¼‰
- **X402**: æ‰¹é‡æ”¯ä»˜åè®®ï¼ˆä¼˜åŒ–Gasï¼‰
- **ç»“åˆ**: å®ç°QuickPayå…å¯†æ”¯ä»˜

**å…³ç³»**: ERC8004æä¾›Sessionç®¡ç†ï¼ŒX402æä¾›æ‰¹é‡ä¼˜åŒ–ï¼Œä¸¤è€…ç»“åˆå®ç°é«˜æ•ˆæ”¯ä»˜

---

## 6. ç›¸å…³æ–‡æ¡£

- [Agentrix æ”¯ä»˜æµç¨‹æ–‡æ¡£](./Agentrixæ”¯ä»˜æµç¨‹æ–‡æ¡£-æœ€æ–°ç‰ˆ.md)
- [ERC8004 åˆçº¦ä½œç”¨è¯´æ˜](./ERC8004åˆçº¦ä½œç”¨è¯´æ˜.md)
- [X402Service æºç ](./backend/src/modules/payment/x402.service.ts)
- [X402AuthorizationService æºç ](./backend/src/modules/payment/x402-authorization.service.ts)

---

**æ–‡æ¡£ç»´æŠ¤**: Agentrix å¼€å‘å›¢é˜Ÿ  
**æœ€åæ›´æ–°**: 2025å¹´1æœˆ

