# 统一支付本地浏览器调试排查步骤

## 🚀 快速诊断工具

在浏览器控制台中运行以下命令进行快速诊断：

```javascript
// 完整诊断（推荐）
PaymentDebug.fullDiagnosis()

// 单独检查
PaymentDebug.checkApiConfig()           // 检查API配置
PaymentDebug.checkAuth()                // 检查认证状态
PaymentDebug.testBackendConnection()    // 测试后端连接
PaymentDebug.testPaymentRouting(100, 'CNY')  // 测试支付路由
PaymentDebug.checkPaymentContext()      // 检查支付上下文
```

## 📋 排查流程总览

```
步骤1: 环境检查
  ↓
步骤2: 网络连接检查
  ↓
步骤3: API配置检查
  ↓
步骤4: 认证检查
  ↓
步骤5: 前端代码检查
  ↓
步骤6: 后端API检查
  ↓
步骤7: 浏览器控制台检查
  ↓
步骤8: 网络请求检查
```

---

## 🔍 步骤1: 环境检查

### 1.1 检查后端服务是否启动

**检查方法**：
```bash
# 在项目根目录执行
cd backend
npm run start:dev

# 或者检查端口是否被占用
netstat -ano | findstr :3001  # Windows
lsof -i :3001                 # Mac/Linux
```

**预期结果**：
- 后端服务应该在 `http://localhost:3001` 运行
- 控制台应该显示 "Nest application successfully started"

**如果失败**：
- 检查后端依赖是否安装：`cd backend && npm install`
- 检查数据库连接配置
- 检查环境变量文件 `.env`

### 1.2 检查前端服务是否启动

**检查方法**：
```bash
# 在项目根目录执行
cd agentrixfrontend
npm run dev

# 或者检查端口是否被占用
netstat -ano | findstr :3000  # Windows
lsof -i :3000                 # Mac/Linux
```

**预期结果**：
- 前端服务应该在 `http://localhost:3000` 运行
- 浏览器可以访问首页

---

## 🌐 步骤2: 网络连接检查

### 2.1 检查API基础URL配置

**检查位置**：
- 文件：`agentrixfrontend/lib/api/client.ts`
- 关键代码：
```typescript
const API_BASE_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3001/api';
```

**检查方法**：
1. 打开浏览器开发者工具（F12）
2. 在Console中输入：
```javascript
// 检查环境变量
console.log('API URL:', process.env.NEXT_PUBLIC_API_URL)

// 检查实际使用的URL
// 需要查看 network 请求中的实际URL
```

**预期结果**：
- API_BASE_URL 应该是 `http://localhost:3001/api`
- 如果使用环境变量，确保 `.env.local` 文件存在且配置正确

**如果失败**：
- 创建/检查 `agentrixfrontend/.env.local` 文件：
```bash
NEXT_PUBLIC_API_URL=http://localhost:3001/api
```
- 重启前端服务

### 2.2 测试后端API连通性

**检查方法**：
在浏览器中直接访问：
```
http://localhost:3001/api/health
```

或者使用curl：
```bash
curl http://localhost:3001/api/health
```

**预期结果**：
- 返回JSON响应，包含服务状态信息

**如果失败**：
- 检查后端服务是否真的在运行
- 检查防火墙设置
- 检查端口是否被其他程序占用

---

## 🔐 步骤3: 认证检查

### 3.1 检查用户登录状态

**检查位置**：
- 文件：`agentrixfrontend/contexts/UserContext.tsx`
- 浏览器控制台检查：
```javascript
// 在浏览器Console中执行
const token = localStorage.getItem('access_token')
console.log('Token存在:', !!token)
console.log('Token值:', token ? token.substring(0, 20) + '...' : 'null')
```

**预期结果**：
- 如果已登录，应该有token
- Token应该是有效的JWT格式

**如果失败**：
- 先登录系统
- 检查登录API是否正常工作
- 检查token是否过期

### 3.2 检查API请求中的认证头

**检查方法**：
1. 打开浏览器开发者工具（F12）
2. 切换到 Network 标签
3. 触发一次支付操作
4. 查看请求头中的 `Authorization` 字段

**预期结果**：
```
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**如果失败**：
- 检查 `agentrixfrontend/lib/api/client.ts` 中的token设置逻辑
- 检查token是否被正确保存到localStorage

---

## 💻 步骤4: 前端代码检查

### 4.1 检查PaymentContext是否正确初始化

**检查位置**：
- 文件：`agentrixfrontend/pages/_app.tsx`
- 确保 `PaymentProvider` 包裹了应用

**检查方法**：
查看 `_app.tsx` 文件，确认：
```tsx
<PaymentProvider>
  <Component {...pageProps} />
</PaymentProvider>
```

### 4.2 检查支付页面是否正确使用PaymentContext

**检查位置**：
- 文件：`agentrixfrontend/pages/pay/unified.tsx`
- 或其他支付相关页面

**检查方法**：
确认页面中使用了：
```tsx
const { startPayment, processPayment } = usePayment()
```

**如果失败**：
- 确保在 `PaymentProvider` 内部使用 `usePayment()`
- 检查是否有错误边界阻止了组件渲染

### 4.3 检查支付API调用

**检查位置**：
- 文件：`agentrixfrontend/contexts/PaymentContext.tsx`
- 方法：`processPayment()`

**检查方法**：
1. 在 `processPayment` 方法中添加console.log
2. 检查调用的API路径是否正确

**关键检查点**：
```typescript
// 检查API调用
const result = await paymentApi.process(paymentData)
```

---

## 🔧 步骤5: 后端API检查

### 5.1 检查支付API路由是否存在

**检查位置**：
- 文件：`backend/src/modules/payment/payment.controller.ts`
- 路由：`POST /payments/process`

**检查方法**：
1. 查看后端日志，确认路由已注册
2. 使用Postman或curl测试：
```bash
curl -X POST http://localhost:3001/api/payments/process \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "amount": 100,
    "currency": "CNY",
    "paymentMethod": "stripe"
  }'
```

**预期结果**：
- 返回支付处理结果或错误信息

### 5.2 检查支付服务依赖

**检查位置**：
- 文件：`backend/src/modules/payment/payment.service.ts`
- 检查所有依赖服务是否正常初始化

**检查方法**：
查看后端启动日志，确认没有依赖注入错误

---

## 🖥️ 步骤6: 浏览器控制台检查

### 6.1 检查JavaScript错误

**检查方法**：
1. 打开浏览器开发者工具（F12）
2. 切换到 Console 标签
3. 查看是否有红色错误信息

**常见错误**：
- `NetworkError`: 无法连接到服务器
- `401 Unauthorized`: 认证失败
- `CORS error`: 跨域问题
- `TypeError`: 代码错误

### 6.2 检查API请求日志

**检查位置**：
- 文件：`agentrixfrontend/lib/api/client.ts`
- 代码中已有开发环境日志

**检查方法**：
在Console中查看：
- 🔵 API请求日志
- 🟢 API响应日志
- 🔴 API错误日志

---

## 📡 步骤7: 网络请求检查

### 7.1 检查Network请求详情

**检查方法**：
1. 打开浏览器开发者工具（F12）
2. 切换到 Network 标签
3. 触发支付操作
4. 查看请求详情

**关键检查点**：

#### 请求URL
- 是否正确：`http://localhost:3001/api/payments/process`
- 如果显示其他URL，检查API_BASE_URL配置

#### 请求方法
- 应该是 `POST`

#### 请求头
- `Content-Type: application/json`
- `Authorization: Bearer ...`（如果已登录）

#### 请求体
- 检查发送的数据格式是否正确
- 检查必需字段是否存在

#### 响应状态
- `200 OK`: 成功
- `401 Unauthorized`: 认证失败
- `400 Bad Request`: 请求参数错误
- `500 Internal Server Error`: 服务器错误
- `Network Error`: 无法连接到服务器

#### 响应内容
- 查看响应体的JSON内容
- 检查错误信息

### 7.2 检查CORS问题

**症状**：
- 浏览器控制台显示CORS错误
- Network请求显示 `CORS policy` 错误

**解决方法**：
检查后端CORS配置：
- 文件：`backend/src/main.ts`
- 确保允许 `http://localhost:3000` 的请求

---

## 🐛 步骤8: 常见问题排查

### 问题1: "无法连接到服务器"

**可能原因**：
1. 后端服务未启动
2. 端口配置错误
3. 防火墙阻止

**解决方法**：
1. 确认后端服务在 `http://localhost:3001` 运行
2. 检查 `NEXT_PUBLIC_API_URL` 环境变量
3. 检查防火墙设置

### 问题2: "401 Unauthorized"

**可能原因**：
1. 用户未登录
2. Token过期
3. Token格式错误

**解决方法**：
1. 先登录系统
2. 检查token是否有效
3. 检查token是否正确添加到请求头

### 问题3: "400 Bad Request"

**可能原因**：
1. 请求参数格式错误
2. 缺少必需字段
3. 数据类型不匹配

**解决方法**：
1. 检查请求体格式
2. 查看后端错误信息
3. 对比API文档确认参数要求

### 问题4: "500 Internal Server Error"

**可能原因**：
1. 后端代码错误
2. 数据库连接问题
3. 依赖服务未启动

**解决方法**：
1. 查看后端日志
2. 检查数据库连接
3. 检查所有依赖服务

### 问题5: 支付按钮点击无反应

**可能原因**：
1. JavaScript错误阻止执行
2. 事件处理函数未绑定
3. 组件未正确渲染

**解决方法**：
1. 检查浏览器控制台错误
2. 检查组件是否正确渲染
3. 检查事件处理函数

---

## 🔧 调试工具和技巧

### 1. 浏览器开发者工具

**快捷键**：
- `F12`: 打开/关闭开发者工具
- `Ctrl+Shift+I` (Windows) / `Cmd+Option+I` (Mac)

**关键标签**：
- **Console**: 查看日志和错误
- **Network**: 查看网络请求
- **Application**: 查看localStorage、sessionStorage
- **Sources**: 调试代码

### 2. 添加调试日志

**在前端代码中添加**：
```typescript
console.log('🔵 支付请求:', paymentData)
console.log('🟢 支付响应:', result)
console.error('🔴 支付错误:', error)
```

**在后端代码中添加**：
```typescript
this.logger.log('支付请求:', dto)
this.logger.error('支付错误:', error)
```

### 3. 使用Postman测试API

**创建测试请求**：
1. 方法：POST
2. URL：`http://localhost:3001/api/payments/process`
3. Headers：
   - `Content-Type: application/json`
   - `Authorization: Bearer YOUR_TOKEN`
4. Body：
```json
{
  "amount": 100,
  "currency": "CNY",
  "paymentMethod": "stripe"
}
```

### 4. 检查环境变量

**前端环境变量**：
- 文件：`agentrixfrontend/.env.local`
- 内容：
```bash
NEXT_PUBLIC_API_URL=http://localhost:3001/api
```

**后端环境变量**：
- 文件：`backend/.env`
- 检查数据库、Stripe等配置

---

## 📝 排查清单

使用以下清单逐步排查：

- [ ] 后端服务已启动（端口3001）
- [ ] 前端服务已启动（端口3000）
- [ ] API_BASE_URL配置正确
- [ ] 后端API健康检查通过
- [ ] 用户已登录（有有效token）
- [ ] PaymentProvider已正确初始化
- [ ] 支付页面正确使用usePayment
- [ ] 浏览器控制台无JavaScript错误
- [ ] Network请求显示正确的URL
- [ ] Network请求包含正确的认证头
- [ ] Network请求体格式正确
- [ ] 后端API路由存在且可访问
- [ ] 后端日志显示请求已接收
- [ ] 无CORS错误
- [ ] 数据库连接正常
- [ ] 所有依赖服务正常

---

## 🎯 快速诊断命令

在浏览器Console中执行以下命令进行快速诊断：

```javascript
// 1. 检查API配置
console.log('API URL:', process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3001/api')

// 2. 检查认证token
const token = localStorage.getItem('access_token')
console.log('Token存在:', !!token)
console.log('Token长度:', token?.length || 0)

// 3. 测试API连通性
fetch('http://localhost:3001/api/health')
  .then(r => r.json())
  .then(data => console.log('✅ 后端连接正常:', data))
  .catch(err => console.error('❌ 后端连接失败:', err))

// 4. 测试支付API（需要先登录）
fetch('http://localhost:3001/api/payments/routing?amount=100&currency=CNY', {
  headers: {
    'Authorization': `Bearer ${localStorage.getItem('access_token')}`
  }
})
  .then(r => r.json())
  .then(data => console.log('✅ 支付路由API正常:', data))
  .catch(err => console.error('❌ 支付路由API失败:', err))
```

---

## 📞 如果以上步骤都无法解决问题

1. **收集错误信息**：
   - 浏览器控制台的完整错误信息
   - Network请求的完整详情（包括请求和响应）
   - 后端日志的完整输出

2. **检查代码版本**：
   - 确认代码是最新版本
   - 检查是否有未提交的修改

3. **尝试最小化复现**：
   - 创建一个最简单的支付测试页面
   - 逐步添加功能，定位问题

4. **检查依赖版本**：
   - 确认所有npm包版本兼容
   - 检查是否有版本冲突

---

## 📚 相关文件清单

### 前端关键文件
- `agentrixfrontend/lib/api/client.ts` - API客户端
- `agentrixfrontend/lib/api/payment.api.ts` - 支付API
- `agentrixfrontend/contexts/PaymentContext.tsx` - 支付上下文
- `agentrixfrontend/pages/_app.tsx` - 应用入口
- `agentrixfrontend/pages/pay/unified.tsx` - 统一支付页面

### 后端关键文件
- `backend/src/modules/payment/payment.controller.ts` - 支付控制器
- `backend/src/modules/payment/payment.service.ts` - 支付服务
- `backend/src/main.ts` - 应用入口（CORS配置）

### 配置文件
- `agentrixfrontend/.env.local` - 前端环境变量
- `backend/.env` - 后端环境变量

