# PayMind 智能路由覆盖范围确认与KYC流程设计

## 📋 文档目的

1. 确认智能路由对不同国家、法币、数字货币的覆盖范围
2. 确认商户法币/数字货币接受需求的不同场景
3. 设计法币转数字货币的KYC流程
4. 优化快速支付部分的KYC界面

---

## ✅ 智能路由覆盖范围确认

### 1. 支持的支付方式

根据 `smart-router.service.ts` 和 `smart-routing.tsx` 的分析：

#### 1.1 法币支付方式
- **Stripe 智能路由**
  - 支持货币：USD, EUR（可扩展）
  - KYC要求：❌ **不需要KYC**（修正：法币直接支付不需要KYC）
  - 钱包要求：❌ 不需要
  - 适用场景：实体商品、服务类支付
  - 支持跨境：是
 
  - **注意**：需要Stripe资质，如果未申请，使用Provider替代

- **Provider支付（MoonPay/Alchemy Pay等）**
  - 支持货币：USD, EUR, CNY等（根据Provider）
  - KYC要求：✅ **需要KYC**（Provider要求）
  - 钱包要求：❌ 不需要（法币支付）
  - 适用场景：Stripe未申请时，实现Apple Pay/Google Pay
  - 支持跨境：是
 
  - **说明**：通过Provider实现Apple Pay/Google Pay，Provider内部使用Stripe等通道


#### 1.2 数字货币支付方式

- **QuickPay（X402稳定币支付）**
  - 支持货币：就是X402支付
  - KYC要求：❌ **不需要KYC**（修正）
  - 钱包要求：✅ 需要连接钱包
  - 适用场景：小额快速支付
  - 支持跨境：是
  - 支持QuickPay：是（自身）
  - 最低金额：$5

### 2. 支持的国家和货币

#### 2.1 法币支持
- **USD（美元）**：美国、全球
- **CNY（人民币）**：中国
- **EUR（欧元）**：欧盟国家
- **SGD（新加坡元）**：新加坡
- **JPY（日元）**：日本
- **GBP（英镑）**：英国

#### 2.2 数字货币支持
- **USDC**：多链支持（Ethereum, Polygon, Arbitrum等）
- **USDT**：多链支持（Ethereum, Tron, BSC等）
- **其他稳定币**：根据商户配置

### 3. 商户收款方式配置

智能路由支持三种商户配置：

#### 3.1 只收法币（fiat_only）
- **适用场景**：传统商户，只接受法币支付
- **可用支付方式**：provider支付，stripe
- **路由逻辑**：用户支付数字货币，provider转换成法币

#### 3.2 只收数字货币（crypto_only）
- **适用场景**：Web3商户，只接受数字货币支付
- **可用支付方式**：quickpay（X402）, 数字钱包支付
- **路由逻辑**：自动过滤法币支付方式
- **法币转数字货币**：如果用户使用法币，自动触发法币转数字货币流程

#### 3.3 两者都收（both）
- **适用场景**：混合商户，接受法币和数字货币
- **可用支付方式**：所有支付方式
- **路由逻辑**：优先推荐数字货币支付，根据金额决定是否先推荐quick pay

### 4. 智能路由决策因素

智能路由综合考虑以下因素：

1. **金额范围**：不同支付方式有最低/最高金额限制
2. **KYC等级**：数字货币支付需要高级KYC
3. **商户配置**：商户接受的支付方式类型
4. **跨境场景**：用户和商户是否在不同国家
5. **货币支持**：支付方式是否支持订单货币
6. **成本优化**：选择手续费最低的方式
7. **成功率**：选择成功率最高的方式
8. **QuickPay状态**：如果启用QuickPay（X402），优先推荐支持QuickPay（X402）的方式

---

## 🔐 KYC流程设计

### 1. KYC等级说明

#### 1.1 未认证（None）
- **可用的支付方式**：钱包支付，quickpay（X402）
- **限制**：无法使用任何支付方式

#### 1.2 基础KYC（Basic）
- **可用的支付方式**：Stripe，provider
- **限制**：无法使用数字货币支付方式
- **适用场景**：法币支付

#### 1.3 高级KYC（Advanced）
- **可用的支付方式**：所有支付方式（Stripe, QuickPay, X402, WalletConnect）
- **限制**：无
- **适用场景**：法币支付、数字货币支付、法币转数字货币

### 2. 法币转数字货币的KYC流程

#### 2.1 触发场景

当以下条件同时满足时，触发法币转数字货币流程：
1. 商户配置为 `crypto_only`（只收数字货币）
2. 用户选择使用法币支付（或用户只有法币）
3. **用户KYC已完成**（Provider要求，通常为基础KYC即可）

#### 2.2 流程步骤

```
用户选择支付
    ↓
检查商户收款配置
    ↓
商户只收数字货币？
    ↓ 是
检查钱包连接状态
    ↓
钱包已连接？
    ↓ 否
显示钱包连接界面
    ↓
用户连接钱包
    ↓
检查用户KYC状态
    ↓
KYC已完成？
    ↓ 否
显示KYC认证提示
    ↓
用户点击"开始KYC认证"
    ↓
进入KYC认证流程（Provider要求，通常为基础KYC）
    ↓
KYC认证完成
    ↓
自动触发法币转数字货币
    ↓
显示转换汇率和费用（通过MoonPay等Provider）
    ↓
用户确认转换
    ↓
执行转换（通过Provider）
    ↓
转换完成，数字货币到账
    ↓
使用转换后的数字货币支付
    ↓
支付成功
```

#### 2.3 KYC认证界面设计（修正版）

**布局结构**：
```
┌─────────────────────────────────────┐
│  [返回]  KYC认证             [关闭]  │
├─────────────────────────────────────┤
│                                     │
│  提示卡片                           │
│  ┌─────────────────────────────┐   │
│  │ ⚠️ 需要KYC认证              │   │
│  │                             │   │
│  │ 该商户只接受数字货币支付    │   │
│  │ 使用法币支付需要先转换为    │   │
│  │ 数字货币，这需要KYC认证     │   │
│  │ （Provider要求）             │   │
│  └─────────────────────────────┘   │
│                                     │
│  当前状态                           │
│  ┌─────────────────────────────┐   │
│  │ ✅ 钱包已连接               │   │
│  │ ❌ KYC未完成                │   │
│  │                             │   │
│  │ 无需KYC的支付方式：         │   │
│  │ • 直接使用数字货币支付     │   │
│  │   （X402、WalletConnect）   │   │
│  │                             │   │
│  │ 需要KYC的支付方式：         │   │
│  │ • 法币转数字货币            │   │
│  │   （通过Provider）          │   │
│  │ • Provider支付              │   │
│  │   （Apple Pay/Google Pay）  │   │
│  └─────────────────────────────┘   │
│                                     │
│  KYC认证步骤                       │
│  ┌─────────────────────────────┐   │
│  │ 1. 身份验证                  │   │
│  │    • 上传身份证/护照         │   │
│  │    • 人脸识别                │   │
│  │                             │   │
│  │ 2. 地址验证（可选）          │   │
│  │    • 提供居住地址证明        │   │
│  │                             │   │
│  │ 3. 审核（通常几分钟到几小时）│   │
│  └─────────────────────────────┘   │
│                                     │
│  [开始KYC认证]  [选择其他方式]     │
│                                     │
└─────────────────────────────────────┘
```

### 3. 快速支付部分的KYC界面

#### 3.1 KYC状态检查

在支付入口界面，如果推荐支付方式需要KYC，自动检查用户KYC状态：

**布局结构**：
```
┌─────────────────────────────────────┐
│  推荐支付方式（需要KYC）             │
│  ┌─────────────────────────────┐   │
│  │ ⚡ 快速支付 (需要高级KYC)     │   │
│  │                             │   │
│  │ 即时 · 建议指数 98          │   │
│  │                             │   │
│  │ ⚠️ 需要高级KYC认证           │   │
│  │ 当前：基础KYC                │   │
│  │                             │   │
│  │  [升级KYC]  [选择其他方式]  │   │
│  └─────────────────────────────┘   │
└─────────────────────────────────────┘
```

#### 3.2 KYC已完成的快速支付界面

**布局结构**：
```
┌─────────────────────────────────────┐
│  推荐支付方式（KYC已通过）           │
│  ┌─────────────────────────────┐   │
│  │ ⚡ 快速支付 (无需确认)       │   │
│  │                             │   │
│  │ 即时 · 建议指数 98          │   │
│  │                             │   │
│  │ ✅ KYC已通过（高级）         │   │
│  │                             │   │
│  │ 预计费用：$14.90            │   │
│  │                             │   │
│  │  [立即支付]  [选择其他方式] │   │
│  └─────────────────────────────┘   │
└─────────────────────────────────────┘
```

#### 3.3 法币转数字货币的快速支付界面

**布局结构**：
```
┌─────────────────────────────────────┐
│  推荐支付方式（法币转数字货币）       │
│  ┌─────────────────────────────┐   │
│  │ ⚡ 快速支付 (法币→数字货币)  │   │
│  │                             │   │
│  │ 即时 · 建议指数 98          │   │
│  │                             │   │
│  │ ✅ KYC已通过（高级）         │   │
│  │                             │   │
│  │ 支付金额：¥102.45            │   │
│  │ 转换汇率：1 CNY = 0.14 USDC │   │
│  │ 转换后金额：14.34 USDC      │   │
│  │ 转换费用：$0.10              │   │
│  │                             │   │
│  │  [确认转换并支付]            │   │
│  └─────────────────────────────┘   │
└─────────────────────────────────────┘
```

---

## 🌍 智能路由场景覆盖确认

### 场景1：中国用户 → 中国商户（法币支付）

**配置**：
- 用户国家：CN
- 商户国家：CN
- 订单货币：CNY
- 商户配置：fiat_only 或 both

**智能路由推荐**：
1. **QuickPay**（如果金额 < $50且已启用QuickPay）
   - 理由：成本最低，速度最快，支持CNY
2. **Stripe**（如果金额 >= $50或未启用QuickPay）
   - 理由：支持CNY，成本适中，成功率高

### 场景2：美国用户 → 中国商户（跨境法币支付）

**配置**：
- 用户国家：US
- 商户国家：CN
- 订单货币：USD
- 商户配置：fiat_only 或 both

**智能路由推荐**：
1. **Stripe**（优先推荐）
   - 理由：支持跨境，支持USD，成本适中
2. **QuickPay**（如果金额 < $50且已启用QuickPay）
   - 理由：成本更低，但需要用户已启用QuickPay

### 场景3：中国用户 → 美国商户（跨境法币支付）

**配置**：
- 用户国家：CN
- 商户国家：US
- 订单货币：USD
- 商户配置：fiat_only 或 both

**智能路由推荐**：
1. **Stripe**（优先推荐）
   - 理由：支持跨境，自动处理汇率转换
2. **QuickPay**（如果金额 < $50且已启用QuickPay）
   - 理由：成本更低，但需要用户已启用QuickPay

### 场景4：任意国家用户 → Web3商户（数字货币支付）

**配置**：
- 用户国家：任意
- 商户国家：任意
- 订单货币：USDC/USDT
- 商户配置：crypto_only

**智能路由推荐**：
1. **X402**（优先推荐，如果用户KYC为高级）
   - 理由：成本最低，Gas优化，多链支持
2. **WalletConnect**（备选，如果用户已连接钱包）
   - 理由：支持多签，适合大额支付

**如果用户只有法币**：
- 自动触发法币转数字货币流程
- 显示转换汇率和费用
- 需要用户KYC为高级

### 场景5：中国用户 → Web3商户（法币转数字货币）

**配置**：
- 用户国家：CN
- 商户国家：任意
- 订单货币：CNY（用户支付）
- 商户配置：crypto_only（商户只收USDC）

**智能路由流程**：
1. 检测到商户只收数字货币
2. 检查用户KYC等级
   - 如果KYC为高级：显示法币转数字货币界面
   - 如果KYC为基础：显示KYC升级提示
3. 如果KYC为高级：
   - 显示转换汇率（CNY → USDC）
   - 显示转换费用
   - 用户确认后执行转换
   - 使用转换后的USDC支付

### 场景6：混合商户（接受法币和数字货币）

**配置**：
- 用户国家：任意
- 商户国家：任意
- 订单货币：USD/CNY/EUR/USDC/USDT
- 商户配置：both

**智能路由推荐**：
1. **如果订单货币是法币**：
   - 优先推荐：QuickPay（如果金额 < $50且已启用QuickPay）
   - 备选：Stripe
2. **如果订单货币是数字货币**：
   - 优先推荐：X402（如果用户KYC为高级）
   - 备选：WalletConnect（如果用户已连接钱包）
3. **如果用户想用法币支付数字货币订单**：
   - 自动触发法币转数字货币流程（需要高级KYC）

---

## 📊 智能路由覆盖范围总结

### ✅ 已覆盖的场景

1. **不同国家组合**：
   - ✅ 同国家支付（境内）
   - ✅ 跨境支付（不同国家）

2. **不同法币**：
   - ✅ USD（美元）
   - ✅ CNY（人民币）
   - ✅ EUR（欧元）
   - ✅ SGD（新加坡元）
   - ✅ JPY（日元）
   - ✅ GBP（英镑）

3. **数字货币**：
   - ✅ USDC（多链）
   - ✅ USDT（多链）
   - ✅ 其他稳定币（根据商户配置）

4. **商户收款配置**：
   - ✅ 只收法币（fiat_only）
   - ✅ 只收数字货币（crypto_only）
   - ✅ 两者都收（both）

5. **法币转数字货币**：
   - ✅ 自动检测商户配置
   - ✅ 自动触发转换流程
   - ✅ 显示转换汇率和费用
   - ✅ 需要高级KYC

### ⚠️ 需要优化的场景

1. **更多货币支持**：
   - 当前主要支持USD, CNY, EUR
   - 可以扩展到更多货币（SGD, JPY, GBP等）

2. **更多数字货币支持**：
   - 当前主要支持USDC, USDT
   - 可以扩展到更多稳定币（DAI, BUSD等）

3. **KYC流程优化**：
   - 当前KYC升级流程需要手动触发
   - 可以优化为自动检测并提示

---

## 🎯 下一步行动

1. **实现KYC升级界面**：根据设计文档实现KYC升级流程
2. **实现法币转数字货币界面**：显示转换汇率和费用
3. **优化快速支付KYC检查**：自动检测KYC状态并显示相应界面
4. **扩展货币支持**：根据实际需求扩展更多货币
5. **测试所有场景**：确保智能路由在所有场景下都能正常工作

---

## 📝 总结

智能路由已经覆盖了：
- ✅ 不同国家的支付场景
- ✅ 不同法币的支付场景
- ✅ 数字货币支付场景
- ✅ 商户法币/数字货币接受需求的不同场景
- ✅ 法币转数字货币的场景（需要高级KYC）

通过智能路由，系统能够：
- 根据商户配置自动过滤可用支付方式
- 根据用户KYC等级推荐合适的支付方式
- 自动处理法币转数字货币的转换
- 综合考虑成本、成功率、速度等因素推荐最优方式

