# æ™ºèƒ½åˆçº¦åˆ†è´¦åŠŸèƒ½è¯„ä¼°

**ç‰ˆæœ¬**: V1.0  
**æ—¥æœŸ**: 2025å¹´1æœˆ  
**ç›®æ ‡**: è¯„ä¼°å½“å‰æ™ºèƒ½åˆçº¦åˆ†è´¦å®ç°æ˜¯å¦æ»¡è¶³éæ‰˜ç®¡æ”¯ä»˜æµç¨‹è¦æ±‚

---

## ğŸ“‹ ç›®å½•

1. [æ–°æ–¹æ¡ˆè¦æ±‚](#1-æ–°æ–¹æ¡ˆè¦æ±‚)
2. [å½“å‰å®ç°åˆ†æ](#2-å½“å‰å®ç°åˆ†æ)
3. [å·®è·å¯¹æ¯”](#3-å·®è·å¯¹æ¯”)
4. [æ”¹è¿›å»ºè®®](#4-æ”¹è¿›å»ºè®®)
5. [å®æ–½è®¡åˆ’](#5-å®æ–½è®¡åˆ’)

---

## 1. æ–°æ–¹æ¡ˆè¦æ±‚

### 1.1 éæ‰˜ç®¡æ”¯ä»˜æµç¨‹è¦æ±‚

```
ç”¨æˆ·æ”¯ä»˜ (æ³•å¸/æ•°å­—è´§å¸)
    â†“
Provider (åµŒå…¥å¼é›†æˆï¼ŒKYCåœ¨Providerå¤„)
    â†“
Provider â†’ Agentrix Contract (å‘é€USDC) â† è¦æ±‚1
    â†“
Agentrix Contract â†’ è‡ªåŠ¨åˆ†è´¦ â†’ å•†æˆ·MPCé’±åŒ… â† è¦æ±‚2
    â†“
å•†æˆ·MPCé’±åŒ… â†’ Off-ramp Provider â†’ é“¶è¡Œè´¦æˆ·
```

### 1.2 æ ¸å¿ƒè¦æ±‚

**è¦æ±‚ 1: Provider ç›´æ¥å‘é€ USDC åˆ°åˆçº¦**
- âœ… Provider å¯ä»¥ç›´æ¥è°ƒç”¨åˆçº¦å‡½æ•°
- âœ… åˆçº¦éªŒè¯ Provider åœ°å€ï¼ˆç™½åå•ï¼‰
- âœ… åˆçº¦æ¥æ”¶ USDC å¹¶è®°å½•

**è¦æ±‚ 2: åˆçº¦è‡ªåŠ¨åˆ†è´¦**
- âœ… æ”¶åˆ° USDC åè‡ªåŠ¨è®¡ç®—åˆ†è´¦
- âœ… è‡ªåŠ¨è½¬è´¦åˆ°å•†æˆ· MPC é’±åŒ…
- âœ… è‡ªåŠ¨è½¬è´¦å¹³å°è´¹å’Œ Agent ä½£é‡‘
- âœ… æ— éœ€åç«¯å¹²é¢„ï¼ˆå®Œå…¨é“¾ä¸Šï¼‰

**è¦æ±‚ 3: éæ‰˜ç®¡è¯æ˜**
- âœ… åˆ†è´¦é€»è¾‘åœ¨é“¾ä¸Šå¯æŸ¥
- âœ… å•†æˆ·åœ°å€æ˜¯ MPC é’±åŒ…åœ°å€
- âœ… Agentrix æ— æ³•å•æ–¹é¢ä¿®æ”¹åˆ†è´¦é€»è¾‘

---

## 2. å½“å‰å®ç°åˆ†æ

### 2.1 Commission.sol åˆ†æ

#### âœ… å·²å®ç°åŠŸèƒ½

**1. åˆ†è´¦åŠŸèƒ½ (`distributeCommission`)**
```solidity
function distributeCommission(bytes32 orderId) external nonReentrant {
    Order storage o = orders[orderId];
    // ... éªŒè¯é€»è¾‘ ...
    
    // åˆ†è´¦åˆ°å•†æˆ·
    if (o.merchant != address(0) && o.merchantAmount > 0) {
        settlementToken.transfer(o.merchant, o.merchantAmount);
    }
    
    // åˆ†è´¦åˆ°æ¨èäºº
    if (o.referralFee > 0 && o.referrer != address(0)) {
        settlementToken.transfer(o.referrer, o.referralFee);
    }
    
    // åˆ†è´¦åˆ°æ‰§è¡ŒAgent
    if (o.executionFee > 0) {
        address target = o.executorHasWallet ? o.executor : systemRebatePool;
        settlementToken.transfer(target, o.executionFee);
    }
    
    // åˆ†è´¦åˆ°å¹³å°
    if (o.platformFee > 0) {
        settlementToken.transfer(agentrixTreasury, o.platformFee);
    }
}
```

**ä¼˜ç‚¹**:
- âœ… æ”¯æŒå¤šè§’è‰²åˆ†è´¦ï¼ˆå•†æˆ·ã€æ¨èäººã€æ‰§è¡ŒAgentã€å¹³å°ï¼‰
- âœ… æœ‰é‡å…¥ä¿æŠ¤ (`nonReentrant`)
- âœ… æœ‰çŠ¶æ€éªŒè¯ï¼ˆè®¢å•çŠ¶æ€ã€äº‰è®®çŠ¶æ€ã€é”å®šæ—¶é—´ï¼‰
- âœ… æ”¯æŒ ERC20 ä»£å¸è½¬è´¦

**ç¼ºç‚¹**:
- âŒ **éœ€è¦å…ˆ `syncOrder`**: å¿…é¡»åç«¯å…ˆåŒæ­¥è®¢å•ä¿¡æ¯
- âŒ **ä¸æ˜¯è‡ªåŠ¨è§¦å‘**: éœ€è¦æ‰‹åŠ¨è°ƒç”¨ `distributeCommission`
- âŒ **ä¸æ¥æ”¶å¤–éƒ¨æ”¯ä»˜**: æ²¡æœ‰æ¥æ”¶ Provider ç›´æ¥å‘é€ USDC çš„å‡½æ•°

#### 2. è®¢å•åŒæ­¥ (`syncOrder`)
```solidity
function syncOrder(
    bytes32 orderId,
    address merchant,
    address referrer,
    address executor,
    uint256 merchantAmount,
    uint256 referralFee,
    uint256 executionFee,
    uint256 platformFee,
    uint256 settlementTime,
    bool executorHasWallet,
    bool isDisputed,
    Status status
) external onlyOwner {
    // åŒæ­¥è®¢å•ä¿¡æ¯åˆ°åˆçº¦
}
```

**é—®é¢˜**:
- âš ï¸ éœ€è¦åç«¯è®¡ç®—åˆ†è´¦é‡‘é¢ååŒæ­¥åˆ°åˆçº¦
- âš ï¸ ä¸æ˜¯è‡ªåŠ¨çš„ï¼Œéœ€è¦åç«¯è°ƒç”¨
- âš ï¸ ä¸ç¬¦åˆéæ‰˜ç®¡è¦æ±‚ï¼ˆåç«¯å‚ä¸è®¡ç®—ï¼‰

### 2.2 PaymentRouter.sol åˆ†æ

#### âœ… å·²å®ç°åŠŸèƒ½

**1. æ”¯ä»˜è·¯ç”± (`routePayment`)**
```solidity
function routePayment(
    bytes32 paymentId,
    address recipient,
    uint256 amount,
    PaymentMethod method,
    bytes32 sessionId,
    uint256 merchantPrice,
    uint256 channelFee
) external payable nonReentrant {
    // åˆ›å»ºæ”¯ä»˜è®°å½•
    payments[paymentId] = PaymentRecord({...});
    
    // å¦‚æœæ˜¯ WALLET æ”¯ä»˜ï¼Œç›´æ¥è½¬è´¦
    if (method == PaymentMethod.WALLET) {
        balances[recipient] += amount;
        payments[paymentId].completed = true;
    }
}
```

**é—®é¢˜**:
- âŒ **ä¸æ˜¯è‡ªåŠ¨åˆ†è´¦**: åªæ˜¯è®°å½•æ”¯ä»˜ï¼Œä¸è¿›è¡Œåˆ†è´¦
- âŒ **ä½™é¢ç®¡ç†**: ä½¿ç”¨å†…éƒ¨ `balances` mappingï¼Œä¸æ˜¯ç›´æ¥è½¬è´¦
- âŒ **ä¸æ”¯æŒ ERC20**: åªæ”¯æŒ ETHï¼Œä¸æ”¯æŒ USDC

### 2.3 åç«¯å®ç°åˆ†æ

#### âœ… å·²å®ç°åŠŸèƒ½

**1. ä½£é‡‘è®¡ç®— (`CommissionCalculatorService`)**
```typescript
async calculateAndRecordCommission(
    paymentId: string,
    payment: Payment,
    commissionBase?: number,
    sessionId?: string,
): Promise<Commission[]> {
    // è®¡ç®—åˆ†è´¦é‡‘é¢
    // è®°å½•åˆ°æ•°æ®åº“
    // ä½†ä¸ç›´æ¥è°ƒç”¨åˆçº¦
}
```

**é—®é¢˜**:
- âŒ **åªè®°å½•åˆ°æ•°æ®åº“**: ä¸ç›´æ¥è°ƒç”¨åˆçº¦åˆ†è´¦
- âŒ **éœ€è¦åç«¯è®¡ç®—**: åˆ†è´¦é€»è¾‘åœ¨åç«¯ï¼Œä¸åœ¨é“¾ä¸Š
- âŒ **ä¸ç¬¦åˆéæ‰˜ç®¡**: åç«¯å‚ä¸åˆ†è´¦è®¡ç®—

**2. åˆçº¦è°ƒç”¨ (`CommissionService`)**
```typescript
async executeSettlement(...) {
    // TODO: è°ƒç”¨æ™ºèƒ½åˆçº¦æ‰§è¡Œç»“ç®—
    // await this.executeSettlementOnChain(savedSettlement);
}
```

**é—®é¢˜**:
- âŒ **æœªå®ç°**: æœ‰ TODO æ³¨é‡Šï¼Œä½†æœªå®ç°é“¾ä¸Šç»“ç®—

---

## 3. å·®è·å¯¹æ¯”

### 3.1 åŠŸèƒ½å¯¹æ¯”è¡¨

| åŠŸèƒ½ | æ–°æ–¹æ¡ˆè¦æ±‚ | å½“å‰å®ç° | å·®è· |
|------|-----------|---------|------|
| **1. æ¥æ”¶ Provider æ”¯ä»˜** | âœ… Provider ç›´æ¥å‘é€ USDC åˆ°åˆçº¦ | âŒ æ— æ­¤åŠŸèƒ½ | **éœ€è¦å®ç°** |
| **2. éªŒè¯ Provider åœ°å€** | âœ… ç™½åå•éªŒè¯ | âŒ æ— æ­¤åŠŸèƒ½ | **éœ€è¦å®ç°** |
| **3. è‡ªåŠ¨åˆ†è´¦** | âœ… æ”¶åˆ° USDC åè‡ªåŠ¨åˆ†è´¦ | âš ï¸ éœ€è¦å…ˆ syncOrderï¼Œå†æ‰‹åŠ¨è°ƒç”¨ | **éœ€è¦æ”¹è¿›** |
| **4. åˆ†è´¦åˆ° MPC é’±åŒ…** | âœ… ç›´æ¥è½¬è´¦åˆ°å•†æˆ· MPC é’±åŒ… | âš ï¸ æ”¯æŒè½¬è´¦ï¼Œä½†åœ°å€æ˜¯æ™®é€šåœ°å€ | **éœ€è¦ç¡®è®¤** |
| **5. é“¾ä¸Šè‡ªåŠ¨è®¡ç®—** | âœ… åˆ†è´¦é€»è¾‘åœ¨é“¾ä¸Š | âŒ åˆ†è´¦é€»è¾‘åœ¨åç«¯ | **éœ€è¦å®ç°** |
| **6. æ— éœ€åç«¯å¹²é¢„** | âœ… å®Œå…¨é“¾ä¸Šè‡ªåŠ¨ | âŒ éœ€è¦åç«¯ syncOrder | **éœ€è¦æ”¹è¿›** |

### 3.2 è¯¦ç»†å·®è·åˆ†æ

#### å·®è· 1: ç¼ºå°‘æ¥æ”¶ Provider æ”¯ä»˜çš„å‡½æ•°

**æ–°æ–¹æ¡ˆè¦æ±‚**:
```solidity
function receiveFromProvider(
    address merchantMPCWallet,
    uint256 totalAmount,
    bytes32 orderId
) external {
    require(msg.sender == providerAddress, "Unauthorized");
    // è‡ªåŠ¨åˆ†è´¦
}
```

**å½“å‰å®ç°**: âŒ æ— æ­¤å‡½æ•°

**å½±å“**: Provider æ— æ³•ç›´æ¥å‘é€ USDC åˆ°åˆçº¦

#### å·®è· 2: åˆ†è´¦ä¸æ˜¯è‡ªåŠ¨çš„

**æ–°æ–¹æ¡ˆè¦æ±‚**:
- Provider å‘é€ USDC â†’ åˆçº¦è‡ªåŠ¨åˆ†è´¦

**å½“å‰å®ç°**:
- åç«¯è®¡ç®—åˆ†è´¦ â†’ åç«¯ syncOrder â†’ æ‰‹åŠ¨è°ƒç”¨ distributeCommission

**å½±å“**: ä¸ç¬¦åˆéæ‰˜ç®¡è¦æ±‚ï¼Œéœ€è¦åç«¯å‚ä¸

#### å·®è· 3: åˆ†è´¦é€»è¾‘åœ¨åç«¯

**æ–°æ–¹æ¡ˆè¦æ±‚**:
- åˆ†è´¦é€»è¾‘åœ¨é“¾ä¸Šï¼Œå¯å®¡è®¡

**å½“å‰å®ç°**:
- åˆ†è´¦é€»è¾‘åœ¨åç«¯ `CommissionCalculatorService`

**å½±å“**: æ— æ³•è¯æ˜éæ‰˜ç®¡ï¼Œåç«¯å¯ä»¥ä¿®æ”¹åˆ†è´¦é€»è¾‘

#### å·®è· 4: éœ€è¦åç«¯ syncOrder

**æ–°æ–¹æ¡ˆè¦æ±‚**:
- å®Œå…¨é“¾ä¸Šï¼Œæ— éœ€åç«¯

**å½“å‰å®ç°**:
- éœ€è¦åç«¯å…ˆ `syncOrder` åŒæ­¥è®¢å•ä¿¡æ¯

**å½±å“**: ä¸ç¬¦åˆéæ‰˜ç®¡è¦æ±‚

---

## 4. æ”¹è¿›å»ºè®®

### 4.1 æ–¹æ¡ˆ 1: æ‰©å±•ç°æœ‰ Commission.solï¼ˆæ¨èï¼‰

#### 4.1.1 æ·»åŠ æ¥æ”¶ Provider æ”¯ä»˜çš„å‡½æ•°

```solidity
// åœ¨ Commission.sol ä¸­æ·»åŠ 
contract Commission is Ownable, ReentrancyGuard {
    // Provider ç™½åå•
    mapping(address => bool) public authorizedProviders;
    
    // è®¢å•åˆ†è´¦é…ç½®ï¼ˆé“¾ä¸Šå­˜å‚¨ï¼‰
    struct OrderSplitConfig {
        address merchantMPCWallet;
        uint256 merchantAmount;
        uint256 referralFee;
        address referrer;
        uint256 executionFee;
        address executor;
        uint256 platformFee;
        uint256 settlementTime;
        bool executorHasWallet;
    }
    
    mapping(bytes32 => OrderSplitConfig) public orderSplitConfigs;
    
    /**
     * @dev Provider å‘é€ USDC åˆ°åˆçº¦å¹¶è‡ªåŠ¨åˆ†è´¦
     */
    function receiveFromProvider(
        bytes32 orderId,
        uint256 totalAmount
    ) external nonReentrant {
        // 1. éªŒè¯ Provider åœ°å€
        require(authorizedProviders[msg.sender], "Unauthorized provider");
        
        // 2. éªŒè¯è®¢å•é…ç½®å­˜åœ¨
        OrderSplitConfig storage config = orderSplitConfigs[orderId];
        require(config.merchantMPCWallet != address(0), "Order config not found");
        
        // 3. éªŒè¯ USDC ä½™é¢
        require(
            settlementToken.balanceOf(address(this)) >= totalAmount,
            "Insufficient USDC balance"
        );
        
        // 4. éªŒè¯ç»“ç®—æ—¶é—´ï¼ˆå¦‚æœéœ€è¦ï¼‰
        if (config.settlementTime > 0) {
            require(
                block.timestamp >= config.settlementTime,
                "Settlement time not reached"
            );
        }
        
        // 5. è‡ªåŠ¨åˆ†è´¦
        if (config.merchantMPCWallet != address(0) && config.merchantAmount > 0) {
            settlementToken.transfer(config.merchantMPCWallet, config.merchantAmount);
        }
        
        if (config.referralFee > 0 && config.referrer != address(0)) {
            settlementToken.transfer(config.referrer, config.referralFee);
        }
        
        if (config.executionFee > 0) {
            address target = config.executorHasWallet 
                ? config.executor 
                : systemRebatePool;
            if (target == address(0)) {
                target = agentrixTreasury;
            }
            settlementToken.transfer(target, config.executionFee);
        }
        
        if (config.platformFee > 0) {
            settlementToken.transfer(agentrixTreasury, config.platformFee);
        }
        
        // 6. è®°å½•åˆ†è´¦äº‹ä»¶
        emit PaymentAutoSplit(
            orderId,
            config.merchantMPCWallet,
            totalAmount,
            config.merchantAmount,
            config.platformFee,
            config.executionFee,
            config.referralFee
        );
    }
    
    /**
     * @dev è®¾ç½®è®¢å•åˆ†è´¦é…ç½®ï¼ˆç”±åç«¯æˆ–å‰ç«¯è°ƒç”¨ï¼‰
     */
    function setOrderSplitConfig(
        bytes32 orderId,
        OrderSplitConfig memory config
    ) external onlyOwner {
        require(config.merchantMPCWallet != address(0), "Invalid merchant wallet");
        orderSplitConfigs[orderId] = config;
        emit OrderSplitConfigSet(orderId, config);
    }
    
    /**
     * @dev è®¾ç½® Provider ç™½åå•
     */
    function setAuthorizedProvider(address provider, bool authorized) external onlyOwner {
        authorizedProviders[provider] = authorized;
        emit ProviderAuthorized(provider, authorized);
    }
    
    event PaymentAutoSplit(
        bytes32 indexed orderId,
        address indexed merchantWallet,
        uint256 totalAmount,
        uint256 merchantAmount,
        uint256 platformFee,
        uint256 executionFee,
        uint256 referralFee
    );
    
    event OrderSplitConfigSet(bytes32 indexed orderId, OrderSplitConfig config);
    event ProviderAuthorized(address indexed provider, bool authorized);
}
```

#### 4.1.2 æµç¨‹æ”¹è¿›

**æ”¹è¿›åçš„æµç¨‹**:
```
1. ç”¨æˆ·æ”¯ä»˜ â†’ Provider
2. åç«¯è®¡ç®—åˆ†è´¦é…ç½® â†’ è°ƒç”¨ setOrderSplitConfigï¼ˆå¯é€‰ï¼Œä¹Ÿå¯ä»¥å‰ç«¯è®¡ç®—ï¼‰
3. Provider å‘é€ USDC åˆ°åˆçº¦ â†’ è°ƒç”¨ receiveFromProvider
4. åˆçº¦è‡ªåŠ¨åˆ†è´¦ â†’ ç›´æ¥è½¬è´¦åˆ°å•†æˆ· MPC é’±åŒ…
```

**ä¼˜ç‚¹**:
- âœ… æ”¯æŒ Provider ç›´æ¥å‘é€ USDC
- âœ… è‡ªåŠ¨åˆ†è´¦ï¼Œæ— éœ€æ‰‹åŠ¨è°ƒç”¨
- âœ… åˆ†è´¦é…ç½®åœ¨é“¾ä¸Šï¼ˆå¯å®¡è®¡ï¼‰
- âœ… å…¼å®¹ç°æœ‰ `distributeCommission` å‡½æ•°

**ç¼ºç‚¹**:
- âš ï¸ ä»éœ€è¦è®¾ç½®åˆ†è´¦é…ç½®ï¼ˆä½†å¯ä»¥å‰ç«¯è®¡ç®—ï¼‰

### 4.2 æ–¹æ¡ˆ 2: å®Œå…¨é“¾ä¸Šè®¡ç®—ï¼ˆç†æƒ³æ–¹æ¡ˆï¼‰

#### 4.2.1 åœ¨é“¾ä¸Šè®¡ç®—åˆ†è´¦

```solidity
contract Commission {
    // åˆ†è´¦æ¯”ä¾‹é…ç½®ï¼ˆé“¾ä¸Šï¼‰
    struct SplitRates {
        uint256 merchantRate;      // å•†æˆ·æ¯”ä¾‹ï¼ˆåŸºç‚¹ï¼Œ10000 = 100%ï¼‰
        uint256 referralRate;      // æ¨èäººæ¯”ä¾‹
        uint256 executionRate;    // æ‰§è¡ŒAgentæ¯”ä¾‹
        uint256 platformRate;     // å¹³å°æ¯”ä¾‹
    }
    
    mapping(bytes32 => SplitRates) public productSplitRates; // productId => rates
    
    /**
     * @dev Provider å‘é€ USDC å¹¶è‡ªåŠ¨è®¡ç®—åˆ†è´¦
     */
    function receiveFromProviderAndAutoSplit(
        bytes32 orderId,
        bytes32 productId,
        address merchantMPCWallet,
        address referrer,
        address executor,
        uint256 totalAmount,
        bool executorHasWallet
    ) external nonReentrant {
        require(authorizedProviders[msg.sender], "Unauthorized");
        
        // è·å–åˆ†è´¦æ¯”ä¾‹
        SplitRates memory rates = productSplitRates[productId];
        
        // è®¡ç®—åˆ†è´¦é‡‘é¢
        uint256 merchantAmount = (totalAmount * rates.merchantRate) / 10000;
        uint256 referralFee = referrer != address(0) 
            ? (totalAmount * rates.referralRate) / 10000 
            : 0;
        uint256 executionFee = executor != address(0) && executorHasWallet
            ? (totalAmount * rates.executionRate) / 10000
            : 0;
        uint256 platformFee = totalAmount - merchantAmount - referralFee - executionFee;
        
        // è‡ªåŠ¨åˆ†è´¦
        settlementToken.transfer(merchantMPCWallet, merchantAmount);
        if (referralFee > 0) {
            settlementToken.transfer(referrer, referralFee);
        }
        if (executionFee > 0) {
            settlementToken.transfer(executor, executionFee);
        }
        if (platformFee > 0) {
            settlementToken.transfer(agentrixTreasury, platformFee);
        }
        
        emit PaymentAutoSplit(orderId, merchantMPCWallet, totalAmount, ...);
    }
}
```

**ä¼˜ç‚¹**:
- âœ… å®Œå…¨é“¾ä¸Šï¼Œæ— éœ€åç«¯
- âœ… åˆ†è´¦é€»è¾‘å¯å®¡è®¡
- âœ… ç¬¦åˆéæ‰˜ç®¡è¦æ±‚

**ç¼ºç‚¹**:
- âš ï¸ éœ€è¦é¢„å…ˆè®¾ç½®äº§å“åˆ†è´¦æ¯”ä¾‹
- âš ï¸ çµæ´»æ€§è¾ƒä½ï¼ˆä¸èƒ½åŠ¨æ€è°ƒæ•´ï¼‰

---

## 5. å®æ–½è®¡åˆ’

### 5.1 æ¨èæ–¹æ¡ˆ: æ–¹æ¡ˆ 1ï¼ˆæ‰©å±•ç°æœ‰åˆçº¦ï¼‰

#### é˜¶æ®µ 1: æ·»åŠ æ ¸å¿ƒåŠŸèƒ½ï¼ˆ1-2å‘¨ï¼‰

1. **æ·»åŠ  Provider ç™½åå•**
   - `authorizedProviders` mapping
   - `setAuthorizedProvider` å‡½æ•°

2. **æ·»åŠ è®¢å•åˆ†è´¦é…ç½®**
   - `OrderSplitConfig` struct
   - `orderSplitConfigs` mapping
   - `setOrderSplitConfig` å‡½æ•°

3. **æ·»åŠ æ¥æ”¶ Provider æ”¯ä»˜å‡½æ•°**
   - `receiveFromProvider` å‡½æ•°
   - è‡ªåŠ¨åˆ†è´¦é€»è¾‘
   - äº‹ä»¶è®°å½•

#### é˜¶æ®µ 2: æµ‹è¯•å’Œä¼˜åŒ–ï¼ˆ1å‘¨ï¼‰

1. **å•å…ƒæµ‹è¯•**
   - Provider éªŒè¯æµ‹è¯•
   - è‡ªåŠ¨åˆ†è´¦æµ‹è¯•
   - è¾¹ç•Œæƒ…å†µæµ‹è¯•

2. **é›†æˆæµ‹è¯•**
   - ä¸ç°æœ‰ `distributeCommission` å…¼å®¹æ€§
   - ä¸åç«¯é›†æˆæµ‹è¯•

#### é˜¶æ®µ 3: éƒ¨ç½²å’Œé›†æˆï¼ˆ1å‘¨ï¼‰

1. **åˆçº¦éƒ¨ç½²**
   - éƒ¨ç½²åˆ° BSC Testnet
   - é…ç½® Provider ç™½åå•

2. **åç«¯é›†æˆ**
   - ä¿®æ”¹åç«¯è°ƒç”¨ `setOrderSplitConfig`
   - æˆ–å‰ç«¯ç›´æ¥è°ƒç”¨ï¼ˆå¦‚æœå‰ç«¯è®¡ç®—ï¼‰

### 5.2 ä»£ç ä¿®æ”¹æ¸…å•

#### éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶

1. **`contract/contracts/Commission.sol`**
   - æ·»åŠ  `authorizedProviders` mapping
   - æ·»åŠ  `OrderSplitConfig` struct
   - æ·»åŠ  `receiveFromProvider` å‡½æ•°
   - æ·»åŠ  `setOrderSplitConfig` å‡½æ•°
   - æ·»åŠ  `setAuthorizedProvider` å‡½æ•°

2. **`backend/src/modules/commission/commission.service.ts`**
   - æ·»åŠ è°ƒç”¨ `setOrderSplitConfig` çš„æ–¹æ³•
   - æˆ–ç§»é™¤åç«¯è®¡ç®—ï¼Œæ”¹ä¸ºå‰ç«¯è®¡ç®—

3. **`contract/test/Commission.test.ts`**
   - æ·»åŠ  `receiveFromProvider` æµ‹è¯•
   - æ·»åŠ  Provider éªŒè¯æµ‹è¯•

---

## 6. æ€»ç»“

### 6.1 å½“å‰å®ç°è¯„ä¼°

**âœ… å·²å®ç°**:
- åˆ†è´¦åŠŸèƒ½ï¼ˆ`distributeCommission`ï¼‰
- å¤šè§’è‰²åˆ†è´¦ï¼ˆå•†æˆ·ã€Agentã€å¹³å°ï¼‰
- å®‰å…¨ä¿æŠ¤ï¼ˆé‡å…¥ä¿æŠ¤ã€çŠ¶æ€éªŒè¯ï¼‰

**âŒ æœªå®ç°**:
- æ¥æ”¶ Provider ç›´æ¥æ”¯ä»˜
- è‡ªåŠ¨åˆ†è´¦ï¼ˆéœ€è¦æ‰‹åŠ¨è°ƒç”¨ï¼‰
- å®Œå…¨é“¾ä¸Šè®¡ç®—ï¼ˆåˆ†è´¦é€»è¾‘åœ¨åç«¯ï¼‰

### 6.2 æ˜¯å¦æ»¡è¶³è¦æ±‚

**ç»“è®º**: âš ï¸ **éƒ¨åˆ†æ»¡è¶³ï¼Œéœ€è¦æ”¹è¿›**

**æ»¡è¶³çš„éƒ¨åˆ†**:
- âœ… åˆ†è´¦åŠŸèƒ½å®Œæ•´
- âœ… æ”¯æŒå¤šè§’è‰²åˆ†è´¦
- âœ… å®‰å…¨å¯é 

**ä¸æ»¡è¶³çš„éƒ¨åˆ†**:
- âŒ æ— æ³•æ¥æ”¶ Provider ç›´æ¥æ”¯ä»˜
- âŒ ä¸æ˜¯è‡ªåŠ¨åˆ†è´¦ï¼ˆéœ€è¦åç«¯å‚ä¸ï¼‰
- âŒ åˆ†è´¦é€»è¾‘åœ¨åç«¯ï¼ˆä¸ç¬¦åˆéæ‰˜ç®¡è¦æ±‚ï¼‰

### 6.3 æ”¹è¿›å»ºè®®

**æ¨è**: ä½¿ç”¨ **æ–¹æ¡ˆ 1ï¼ˆæ‰©å±•ç°æœ‰åˆçº¦ï¼‰**

**ç†ç”±**:
1. å…¼å®¹ç°æœ‰å®ç°
2. æ”¹åŠ¨æœ€å°
3. å¯ä»¥é€æ­¥è¿ç§»
4. ç¬¦åˆéæ‰˜ç®¡è¦æ±‚

**å·¥ä½œé‡**: 2-3 å‘¨

---

**æ–‡æ¡£ç»´æŠ¤**: Agentrix å¼€å‘å›¢é˜Ÿ  
**æœ€åæ›´æ–°**: 2025å¹´1æœˆ

