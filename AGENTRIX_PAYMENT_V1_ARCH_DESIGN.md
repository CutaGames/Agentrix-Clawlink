# Agentrix 支付 V1.0 架构设计方案 (Agentrix Payment V1.0 Architecture)

**版本**: V1.1  
**状态**: 已确认 (Confirmed)  
**最后更新**: 2026-01-21  
**核心目标**: 构建 AI Agent 时代的"支付+审计"基础设施，解决 Agent 身份可验证、支付动作可归因、全过程不可篡改且隐私友好的核心痛点。

> **V1.1 更新**: 新增 Stripe 法币直结通道，支持 Google Pay / Apple Pay / 信用卡直接法币支付

---

## 1. 总体架构：混合审计模型 (Hybrid Audit Model)

我们采用 **"ERC8004 (执行层) + EAS (证明层) + 透明日志 (审计层)"** 的混合架构，平衡 Web3 的去中心化信任与 Web2 的高性能执行。

### 1.1 三层架构定义

| 层次 | 技术选型 | 核心作用 | 交付物 |
| :--- | :--- | :--- | :--- |
| **执行层 (Execution)** | **ERC8004 + API Key + Stripe** | 处理支付授权、限额控制与实际资金流转。 | `PayIntent`, `SessionKey`, `PaymentIntent` |
| **证明层 (Attestation)** | **EAS (Ethereum Attestation Service)** | 为 Agent 身份、风险等级、合规状态提供链上背书。 | `UID (Attestation ID)` |
| **审计层 (Audit)** | **透明日志 (Hash Chaining)** | 记录全量交易证据链，通过哈希链条确保不可篡改。 | `AuditProof`, `Merkle Root` |

### 1.2 支付通道架构 🆕

```
                    ┌─────────────────────────────────────────┐
                    │            SmartCheckout UI             │
                    │  (统一支付入口，用户仅看到支付方式图标)      │
                    └─────────────────────────────────────────┘
                                        │
                                        ▼
                    ┌─────────────────────────────────────────┐
                    │          SmartRouter (智能路由)          │
                    │  根据商户配置、用户偏好自动选择最优通道     │
                    └─────────────────────────────────────────┘
                                        │
            ┌───────────────┬───────────┴───────────┬───────────────┐
            ▼               ▼                       ▼               ▼
    ┌───────────────┐ ┌───────────────┐ ┌───────────────┐ ┌───────────────┐
    │   QuickPay    │ │  Wallet Pay   │ │    Stripe     │ │   Transak     │
    │   (Session)   │ │   (Direct)    │ │  (法币直结)    │ │ (法币→USDC)   │
    └───────────────┘ └───────────────┘ └───────────────┘ └───────────────┘
            │               │                   │                   │
            ▼               ▼                   ▼                   ▼
    ┌───────────────────────────────┐   ┌─────────────────────────────┐
    │     链上结算 (ERC8004)         │   │    链下结算 → 批量分账       │
    │  自动分账 (智能合约)            │   │   T+3 结算给商户/Agent      │
    └───────────────────────────────┘   └─────────────────────────────┘
```

---

## 2. 核心流程设计

### 2.1 Agent 注册与身份背书 (Identity & Trust)
1. **注册**: Agent 开发者在 AX 平台注册，生成 `agentId` 并绑定公钥。
2. **背书**: AX 平台对 Agent 进行风险评估后，在链上发布一条 **EAS Attestation**。
3. **验证**: 任何第三方商户可通过链上 UID 验证该 Agent 的信用等级，无需信任 AX 数据库。

### 2.2 支付授权与执行 (Authorization & Payment)
1. **授权**: 用户通过 ERC8004 签发 Session Key 给 Agent。
2. **执行**: Agent 发起支付，携带其私钥签名。
3. **校验**: AX 后端校验：
   - API Key 是否有效。
   - Agent 签名是否匹配。
   - ERC8004 Session 是否在限额内。

### 2.3 链下审计与链上锚定 (Audit & Anchoring)
1. **记录**: 每笔交易生成 `AuditProof`，包含 `previousProofHash` 形成哈希链。
2. **脱敏**: 证据链中仅存储用户 ID 的哈希，保护隐私。
3. **锚定**: 每日将所有证据的 Merkle Root 作为一个 Attestation 发布到 EAS，实现“事后不可更改”。

---

## 3. 三层 ID 体系集成

*   **User ID**: 最终支付主体。
*   **Agent ID**: 动作发起主体（关联 EAS 信用证明）。
*   **Session ID**: 
    - **链上**: ERC8004 Session ID (授权凭证)。
    - **链下**: 支付会话 ID (审计关联键)。

---

## 4. 隐私保护策略 (Privacy-First)

*   **盲审计 (Blinded Audit)**: 审计日志中不存储明文钱包地址或姓名。
*   **选择性披露**: 审计员仅在获得用户授权（或司法介入）时，通过 AX 提供的盐值（Salt）还原身份信息。

---

## 5. 实施路线图 (Roadmap)

### Phase 1: 支付底座与沙箱 (已完成 ✅)
- [x] API Key 体系 (Sandbox/Prod)。
- [x] 托管收银台与 Webhook 重试。
- [x] 基础哈希链审计逻辑。

### Phase 2: Agent 编排与 EAS 集成 (进行中 🏗️)
- [ ] **EAS 模块开发**: 集成 EAS SDK，实现 Agent 身份存证。
- [ ] **Agent 直接支付接口**: `POST /v1/agent/execute_payment`。
- [ ] **策略引擎**: 自动校验 ERC8004 限额与 EAS 风险等级。

### Phase 3: 商业化与合规工具 (待启动 ⏳)
- [ ] **审计浏览器**: 供商户/审计员验证哈希链完整性的工具。
- [ ] **多链锚定**: 支持将 Merkle Root 锚定到 Solana/BSC。
- [ ] **分润报表**: 基于 Agent 归因的自动化分账。
