# Agentrix V3.0 统一支付流程（文字版）

## 一、用户登录/注册流程

### 1.1 用户进入支付页面
- 用户点击"支付"按钮
- 系统检查用户登录状态

### 1.2 未登录用户
- 显示登录/注册选项
- **钱包登录**：连接钱包（MetaMask、Phantom等），自动创建/绑定Agentrix ID
- **Web2登录**：邮箱/密码登录，创建/绑定Agentrix ID
- 登录成功后，系统根据Agentrix ID获取用户信息：
  - QuickPay授权状态
  - KYC状态
  - 钱包连接状态
  - 历史支付偏好

### 1.3 已登录用户
- 直接进入支付方式选择界面
- 系统根据Agentrix ID加载用户授权信息

---

## 二、支付方式选择界面

### 2.1 系统获取商家收款配置
- 查询商家设置的收款方式：
  - **只收法币**：仅支持CNY/USD等法币
  - **只收数字货币**：仅支持USDC/USDT（Solana/BSC链）
  - **两种都接受**：法币和数字货币都支持

### 2.2 智能路由计算最优价格
- 根据商家收款方式、订单金额、用户KYC状态计算：
  - 法币支付价格（Stripe）
  - 法币转数字货币价格（MoonPay、Alchemy Pay等Provider）
  - 数字货币直接支付价格（USDC/USDT）

### 2.3 显示支付方式选项

#### 选项1：QuickPay（快速支付）⚡
- **已授权用户**：
  - 显示"QuickPay"选项
  - 显示智能路由推荐的最优价格
  - 显示授权状态（单笔限额、每日限额）
- **未授权用户**：
  - 显示"启用QuickPay"选项
  - 显示授权引导（默认：每笔≤0.1U，每天≤10U）
  - 用户可选择：
    - 同意授权并设置阈值
    - 暂不授权（本次支付）
    - 不再显示引导（永久关闭）

#### 选项2：Apple Pay 🍎
- 仅当商家接受法币时显示
- 显示Stripe价格

#### 选项3：Google Pay 📱
- 仅当商家接受法币时显示
- 显示Stripe价格

#### 选项4：信用卡/借记卡 💳
- 仅当商家接受法币时显示
- 显示Stripe价格

#### 选项5：数字货币支付 ₿
- 仅当商家接受数字货币时显示
- 支持币种：USDC、USDT
- 支持链：Solana、BSC
- 显示直接支付价格（最优）

---

## 三、商家收款方式 = 只收数字货币

### 3.1 用户选择支付方式

#### 场景A：用户选择QuickPay（已授权）
1. 系统检查QuickPay授权状态
2. 根据订单金额判断：
   - **小额（<阈值）**：使用X402或Agent Pay（从钱包自动扣款）
   - **大额（≥阈值）**：直接转账（USDC/USDT）
3. 检查是否需要托管交易（Escrow）
4. 执行支付流程

#### 场景B：用户选择数字货币支付
1. 检查钱包连接状态
2. 如果未连接，引导用户连接钱包
3. 选择链（Solana或BSC）
4. 选择币种（USDC或USDT）
5. 检查是否需要托管交易
6. 执行支付流程

---

## 四、商家收款方式 = 只收法币

### 4.1 智能路由提供价格对比

系统显示两种价格选项：

#### 选项A：法币转数字货币（最优Provider）
- 显示最优Provider价格（MoonPay、Alchemy Pay等）
- 价格通常比Stripe低
- **如果用户未完成KYC**：
  - 提示"需要完成KYC才能使用此方式"
  - 引导用户完成KYC流程
  - KYC完成后，使用最优Provider价格
- **如果用户已完成KYC**：
  - 直接使用最优Provider价格
  - 执行法币转数字货币流程

#### 选项B：Stripe支付（常规方式）
- 显示Stripe价格（通常较高）
- 无需KYC
- 支持Apple Pay、Google Pay、信用卡

### 4.2 用户选择支付方式

#### 场景A：用户选择法币转数字货币（最优Provider）
1. 检查KYC状态
2. **未完成KYC**：
   - 显示KYC引导页面
   - 用户完成KYC（上传身份证、自拍等）
   - KYC审核通过后，继续支付流程
3. **已完成KYC**：
   - 直接使用最优Provider
   - 执行法币转数字货币
   - 转换为USDC/USDT后，执行支付

#### 场景B：用户选择Stripe支付
1. 创建Stripe支付意图
2. 用户填写支付信息（Apple Pay/Google Pay/信用卡）
3. 执行Stripe支付流程

---

## 五、商家收款方式 = 两种都接受

### 5.1 智能路由推荐

系统显示所有可用支付方式，并标注价格：

- **数字货币支付**：价格最低（推荐）
- **法币转数字货币**：价格中等（需要KYC）
- **Stripe支付**：价格较高（无需KYC）

### 5.2 用户选择支付方式

#### 场景A：Web3用户（有数字货币）
- 推荐选择"数字货币支付"
- 直接使用USDC/USDT支付
- 价格最优

#### 场景B：Web2用户（无数字货币）
- 推荐选择"法币转数字货币"（如果已完成KYC）
- 或选择"Stripe支付"（如果未完成KYC或不想做KYC）

---

## 六、托管交易（Escrow）流程

### 6.1 自动检测是否需要托管

系统根据以下条件判断：

- **订单类型**：
  - 电商订单：需要托管
  - 虚拟资产/NFT：需要托管（智能合约分润）
  - 服务订单：根据商家设置
- **商家设置**：
  - 是否启用托管
  - 退款政策（不支持退款/七天无理由等）
- **订单金额**：超过阈值自动启用托管

### 6.2 托管交易类型

#### 类型A：虚拟资产/NFT订单
- **特点**：
  - 不支持退款
  - 智能合约自动分润
  - 即时完成交割
- **流程**：
  1. 创建Escrow智能合约
  2. 用户支付到Escrow合约
  3. 智能合约自动分润（商家+平台）
  4. 即时完成交割（无需用户确认收货）

#### 类型B：实物订单
- **特点**：
  - 支持退款（根据商家设置）
  - 需要用户确认收货
  - 智能合约分润
- **流程**：
  1. 创建Escrow智能合约
  2. 用户支付到Escrow合约
  3. 资金锁定在合约中
  4. 商家发货
  5. 用户收到货物后，点击"确认收货"
  6. 智能合约自动分润并释放资金
  7. 如果商家设置"不支持退款"，用户无法申请退款
  8. 如果商家设置"七天无理由退款"，用户在7天内可以申请退款

### 6.3 托管交易执行

无论用户选择哪种支付方式，如果需要托管：

1. 系统自动创建Escrow合约
2. 支付资金进入Escrow合约
3. 根据订单类型执行相应流程
4. 用户无需了解技术细节，只需：
   - 支付
   - 等待发货（实物）
   - 确认收货（实物）

---

## 七、QuickPay授权流程

### 7.1 授权默认设置
- **单笔限额**：0.1U（用户可调整）
- **每日限额**：10U（用户可调整）
- **有效期**：30天（用户可调整）

### 7.2 授权内容
- X402授权（用于快速支付）
- Agent Pay授权（用于自动扣款）
- 钱包自动扣款授权

### 7.3 用户选择
- **同意授权**：设置限额，启用QuickPay
- **暂不授权**：本次支付不使用QuickPay，下次仍会提示
- **不再显示**：永久关闭QuickPay引导，用户可手动启用

---

## 八、Agent代付流程（修正）

### 8.1 Agent代付模式
- **不支持**：先支付再还款模式
- **仅支持**：Agent自动从用户钱包扣款模式

### 8.2 Agent代付流程
1. 用户选择QuickPay（已授权Agent Pay）
2. 系统检查Agent授权状态
3. Agent自动从用户钱包扣款
4. 支付完成
5. 用户无需后续还款操作

---

## 九、完整支付流程示例

### 示例1：Web3用户购买实物商品（商家接受两种支付方式）

1. **用户登录**：钱包登录，Agentrix ID已绑定
2. **选择商品**：点击"购买"
3. **系统检测**：
   - 商家接受法币和数字货币
   - 订单类型：实物商品
   - 需要托管交易
4. **显示支付方式**：
   - QuickPay（已授权，推荐，价格最优）
   - 数字货币支付（USDC/USDT，价格最优）
   - 法币转数字货币（需要KYC）
   - Stripe支付（价格较高）
5. **用户选择QuickPay**
6. **系统执行**：
   - 检查授权状态（单笔限额0.1U，每日限额10U）
   - 订单金额0.05U，在限额内
   - 使用X402支付（从钱包自动扣款）
   - 自动创建Escrow合约
   - 资金锁定在合约中
7. **支付完成**：显示"支付成功，等待商家发货"
8. **商家发货**：用户收到货物
9. **用户确认收货**：点击"确认收货"
10. **智能合约执行**：
    - 自动分润（商家+平台）
    - 释放资金给商家
11. **订单完成**

### 示例2：Web2用户购买虚拟资产（商家只收数字货币）

1. **用户登录**：邮箱登录，Agentrix ID已绑定
2. **选择商品**：NFT商品
3. **系统检测**：
   - 商家只收数字货币
   - 订单类型：虚拟资产
   - 需要托管交易（智能合约分润）
4. **显示支付方式**：
   - 数字货币支付（USDC/USDT）
   - 法币转数字货币（需要KYC）
5. **用户选择法币转数字货币**
6. **系统检查KYC**：用户未完成KYC
7. **引导KYC**：用户完成KYC流程
8. **KYC通过后**：
   - 使用最优Provider（MoonPay）转换法币为USDC
   - 自动创建Escrow合约
   - 支付到合约
9. **智能合约执行**：
   - 自动分润
   - 即时完成交割
   - NFT转移到用户钱包
10. **支付完成**

### 示例3：Web3用户购买服务（商家只收法币，用户未完成KYC）

1. **用户登录**：钱包登录
2. **选择服务**：订阅服务
3. **系统检测**：
   - 商家只收法币
   - 用户未完成KYC
4. **显示支付方式**：
   - Stripe支付（无需KYC，价格较高）
   - 法币转数字货币（需要KYC，价格较低）
5. **用户选择Stripe支付**
6. **执行Stripe支付流程**
7. **支付完成**

---

## 十、关键决策点总结

### 10.1 商家收款方式
- **只收数字货币**：用户只能选择数字货币支付或法币转数字货币
- **只收法币**：用户可以选择Stripe或法币转数字货币（需要KYC）
- **两种都接受**：用户可以选择任意支付方式

### 10.2 智能路由价格对比
- **数字货币直接支付**：价格最低（如果商家接受）
- **法币转数字货币（最优Provider）**：价格中等（需要KYC）
- **Stripe支付**：价格较高（无需KYC）

### 10.3 KYC流程触发
- 用户选择"法币转数字货币"时，如果未完成KYC，必须完成KYC
- 用户选择"Stripe支付"时，无需KYC

### 10.4 托管交易自动检测
- 电商订单：自动启用托管
- 虚拟资产/NFT：自动启用托管（智能合约分润）
- 服务订单：根据商家设置

### 10.5 QuickPay授权
- 默认阈值：每笔0.1U，每天10U
- 用户可调整阈值
- 用户可选择不授权或永久关闭引导

### 10.6 Agent代付
- 仅支持从钱包自动扣款
- 不支持先支付再还款模式

---

## 十一、待确认问题

1. ✅ 数字货币支付只支持USDC/USDT（Solana/BSC链）
2. ✅ 商家收款方式配置（只收法币/只收数字货币/两种都接受）
3. ✅ 智能路由根据商家收款方式提供价格对比
4. ✅ KYC流程在法币转数字货币时触发
5. ✅ 托管交易自动检测（电商/虚拟资产/服务）
6. ✅ QuickPay授权默认阈值（每笔0.1U，每天10U）
7. ✅ Agent代付只能从钱包扣款
8. ✅ 用户登录/注册流程（钱包登录/Web2登录）
9. ✅ 虚拟资产/NFT即时交割，实物需要确认收货
10. ✅ 商家退款政策设置（不支持退款/七天无理由）

请确认以上流程是否符合您的需求，确认后我将开始实现。

