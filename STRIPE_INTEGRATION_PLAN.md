# Stripe æ”¯ä»˜é›†æˆå®æ–½è®¡åˆ’

**ç‰ˆæœ¬**: 1.1  
**æ—¥æœŸ**: 2026å¹´1æœˆ21æ—¥  
**çŠ¶æ€**: âœ… Phase 1 å·²å®Œæˆ

---

## å®æ–½è¿›åº¦

### âœ… å·²å®Œæˆ (Phase 1)

1. **åç«¯æ ¸å¿ƒæœåŠ¡**
   - `stripe.service.ts` - å¢å¼ºç‰ˆ Stripe æœåŠ¡ï¼ˆPaymentIntentã€é€€æ¬¾ã€Customer ç®¡ç†ï¼‰
   - `stripe-provider.service.ts` - å®ç° IProvider æ¥å£çš„ Stripe Provider
   - `stripe-webhook.service.ts` - å¢å¼ºç‰ˆ Webhook å¤„ç†ï¼ˆåˆ†ä½£è®°å½•ã€é€€æ¬¾ã€äº‰è®®å¤„ç†ï¼‰
   - `stripe-settlement-scheduler.service.ts` - T+3 æ‰¹é‡ç»“ç®—è°ƒåº¦æœåŠ¡
   - `stripe-payment.controller.ts` - Stripe ä¸“ç”¨ API ç«¯ç‚¹

2. **æ™ºèƒ½è·¯ç”±å¢å¼º**
   - `smart-router.service.ts` - æ–°å¢ `selectStripeOrTransak()` å’Œ `getMultiChannelQuotes()` æ–¹æ³•

3. **DTO æ‰©å±•**
   - `payment.dto.ts` - æ–°å¢ Stripe ç›¸å…³ DTOï¼ˆCreateStripePaymentDtoã€CreateStripeRefundDto ç­‰ï¼‰

4. **å‰ç«¯ç»„ä»¶**
   - `StripePayment.tsx` - Stripe Elements æ”¯ä»˜ç»„ä»¶ï¼ˆæ”¯æŒ Apple Payã€Google Payï¼‰
   - `payment.api.ts` - æ–°å¢ Stripe ç›¸å…³ API æ–¹æ³•

5. **é…ç½®æ›´æ–°**
   - `backend/.env.example` - å®Œæ•´ Stripe é…ç½®è¯´æ˜
   - `frontend/.env.example` - Stripe å…¬é’¥é…ç½®
   - `payment.module.ts` - æ³¨å†Œæ‰€æœ‰æ–°æœåŠ¡å’Œ Controller

### ğŸ”„ å¾…å®Œæˆ (Phase 2-4)

- [ ] Stripe Connect å•†æˆ·åˆ†è´¦é›†æˆ
- [ ] å‰ç«¯ SmartCheckout ç»„ä»¶é›†æˆ Stripe é€‰é¡¹
- [ ] ç”Ÿäº§ç¯å¢ƒé…ç½®å’Œæµ‹è¯•
- [ ] ç›‘æ§å’Œå‘Šè­¦è®¾ç½®

---

## ä¸€ã€èƒŒæ™¯ä¸ç›®æ ‡

### 1.1 å½“å‰æ”¯ä»˜æ¶æ„

| æ”¯ä»˜æ–¹å¼ | åº•å±‚é€šé“ | ç»“ç®—æ–¹å¼ | ç‰¹ç‚¹ |
|---------|---------|---------|------|
| QuickPay | ERC8004 Session | é“¾ä¸Š USDC/USDT | å…Gasã€éœ€é¢„æˆæƒ |
| Wallet Pay | ç›´æ¥è½¬è´¦ | é“¾ä¸Š USDC/USDT | ç”¨æˆ·æ‰¿æ‹…Gas |
| Fiat (Transak) | Transak OnRamp | æ³•å¸â†’é“¾ä¸ŠUSDC | éœ€KYCã€æ”¯æŒå¤šç§æ³•å¸æ”¯ä»˜æ–¹å¼ |

### 1.2 Stripeé›†æˆç›®æ ‡

- **ç›´æ¥æ³•å¸æ”¯ä»˜**: æ— éœ€æ³•å¸â†’åŠ å¯†è´§å¸è½¬æ¢
- **é™ä½è´¹ç‡**: Stripe 2.9% vs Transak 3-5%
- **æ›´å¥½ç”¨æˆ·ä½“éªŒ**: åŸç”Ÿæ”¯æŒ Google Pay / Apple Pay
- **åˆè§„ç»“ç®—**: æ”¯æŒå•†æˆ·ç›´æ¥æ³•å¸æ”¶æ¬¾

---

## äºŒã€Stripe vs Transak å¯¹æ¯”

| ç»´åº¦ | Stripe | Transak |
|------|--------|---------|
| **æ”¯ä»˜æ–¹å¼** | Google Pay, Apple Pay, ä¿¡ç”¨å¡ | Google Pay, ä¿¡ç”¨å¡, é“¶è¡Œè½¬è´¦ |
| **è´¹ç‡** | 2.9% + $0.30 | 2-5% (å«æ±‡ç‡ä»·å·®) |
| **ç»“ç®—** | æ³•å¸ç›´æ¥ç»“ç®— (T+2) | è½¬æ¢ä¸º USDC é“¾ä¸Šç»“ç®— |
| **KYC** | æ— éœ€ç”¨æˆ·KYC | éœ€è¦ç”¨æˆ·KYC |
| **é€‚ç”¨åœºæ™¯** | å•†æˆ·æ¥å—æ³•å¸ | å•†æˆ·ä»…æ¥å—åŠ å¯†è´§å¸ |
| **åˆ†ä½£å¤„ç†** | æ‰¹é‡ç»“ç®— (é“¾ä¸‹) | é“¾ä¸Šåˆçº¦è‡ªåŠ¨åˆ†è´¦ |

---

## ä¸‰ã€æŠ€æœ¯æ¶æ„è®¾è®¡

### 3.1 æ”¯ä»˜è·¯ç”±é€»è¾‘æ›´æ–°

```
ç”¨æˆ·é€‰æ‹©æ”¯ä»˜æ–¹å¼
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ™ºèƒ½è·¯ç”± (SmartRouter)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è¾“å…¥: æ”¯ä»˜æ–¹å¼ã€å•†æˆ·é…ç½®ã€é‡‘é¢ã€ç”¨æˆ·åå¥½                    â”‚
â”‚  è¾“å‡º: æ¨èé€šé“ + è´¹ç‡å¯¹æ¯”                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   QuickPay  â”‚  Wallet Pay â”‚   Stripe    â”‚   Transak   â”‚
â”‚  (Session)  â”‚  (Direct)   â”‚  (æ³•å¸ç›´ç»“)  â”‚  (æ³•å¸â†’åŠ å¯†) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 Stripeæ”¯ä»˜æµç¨‹

```
ç”¨æˆ·é€‰æ‹© Google Pay / Apple Pay / ä¿¡ç”¨å¡
    â†“
å‰ç«¯è°ƒç”¨ stripe.createPaymentIntent()
    â†“
åç«¯åˆ›å»º PaymentIntent (é‡‘é¢ã€å•†æˆ·ID)
    â†“
ç”¨æˆ·å®Œæˆæ”¯ä»˜ (Stripe Elements / Payment Sheet)
    â†“
Stripe Webhook â†’ åç«¯ç¡®è®¤æ”¯ä»˜
    â†“
åç«¯æ›´æ–°è®¢å•çŠ¶æ€ã€è®°å½•åˆ†ä½£ä¿¡æ¯
    â†“
æ‰¹é‡ç»“ç®— (T+3) â†’ å•†æˆ·/Agent æ”¶æ¬¾
```

### 3.3 å•†æˆ·é…ç½®æ‰©å±•

```typescript
interface MerchantPaymentConfig {
  // ç°æœ‰é…ç½®
  acceptsCrypto: boolean;
  preferredToken: 'USDC' | 'USDT';
  
  // æ–°å¢Stripeé…ç½®
  acceptsFiat: boolean;
  stripeAccountId?: string;        // Stripe Connect è´¦æˆ·ID
  fiatSettlementMode: 'instant' | 'batch';  // ç»“ç®—æ¨¡å¼
  fiatCurrencies: string[];        // æ¥å—çš„æ³•å¸ ['USD', 'EUR', 'CNY']
}
```

---

## å››ã€åˆ†ä½£æœºåˆ¶é€‚é…

### 4.1 è´¹ç”¨æ‰¿æ‹…æ–¹

æ ¹æ® V5 åˆ†ä½£æœºåˆ¶è®¾è®¡:

| è´¹ç”¨ç±»å‹ | æ‰¿æ‹…æ–¹ | è¯´æ˜ |
|---------|--------|------|
| **Stripeå¤„ç†è´¹ (2.9%)** | ç”¨æˆ· | æ˜¾ç¤ºåœ¨æ”¯ä»˜æ€»é¢ä¸­ |
| **å¹³å°è´¹ (0.5-3%)** | å•†æˆ· | ä»å•†æˆ·æ”¶å…¥ä¸­æ‰£é™¤ |
| **é€šé“è´¹** | å•†æˆ· | ä»å•†æˆ·æ”¶å…¥ä¸­æ‰£é™¤ |
| **Agentåˆ†ä½£** | å¹³å°æ¿€åŠ±æ±  | ä»å¹³å°è´¹ä¸­åˆ†é… |

### 4.2 Stripeç»“ç®—ä¸‹çš„åˆ†ä½£æµç¨‹

```
Stripe æ”¯ä»˜å®Œæˆ
    â†“
èµ„é‡‘è¿›å…¥ Agentrix å¹³å°è´¦æˆ·
    â†“
è®°å½•åˆ†ä½£ä¿¡æ¯ (é“¾ä¸‹)
    â”œâ”€â”€ å•†æˆ·åº”æ”¶ = è®¢å•é‡‘é¢ - å¹³å°è´¹ - é€šé“è´¹
    â”œâ”€â”€ å¹³å°è´¹ â†’ å¹³å°æ”¶å…¥
    â”œâ”€â”€ æ¨å¹¿Agent â†’ å¹³å°è´¹ Ã— 20%
    â””â”€â”€ æ‰§è¡Œ:æ¨èAgent â†’ æ¿€åŠ±æ±  Ã— 7:3
    â†“
æ‰¹é‡ç»“ç®— (T+3)
    â”œâ”€â”€ å•†æˆ· â†’ é“¶è¡Œè½¬è´¦ / PayPal / Stripe Connect
    â””â”€â”€ Agent â†’ USDC é“¾ä¸Šè½¬è´¦ (æˆ–æ³•å¸)
```

### 4.3 æ··åˆç»“ç®—ç¤ºä¾‹

```
è®¢å•é‡‘é¢: $100 USD
Stripeå¤„ç†è´¹: $2.90 (ç”¨æˆ·æ‰¿æ‹…)
ç”¨æˆ·å®é™…æ”¯ä»˜: $102.90

å•†æˆ·é…ç½®: LOGICå±‚ (5% æ€»è´¹ç‡ = 1%å¹³å° + 4%æ¿€åŠ±æ± )
- å•†æˆ·æ”¶å…¥: $100 Ã— 95% = $95
- å¹³å°è´¹: $100 Ã— 1% = $1
- æ¿€åŠ±æ± : $100 Ã— 4% = $4

Agentåˆ†ä½£ (å‡è®¾æœ‰æ¨èAgentå’Œæ‰§è¡ŒAgent):
- æ¨å¹¿Agent: $1 Ã— 20% = $0.20
- æ¨èAgent: $4 Ã— 30% = $1.20
- æ‰§è¡ŒAgent: $4 Ã— 70% = $2.80
- å¹³å°å‡€æ”¶å…¥: $1 - $0.20 = $0.80
```

---

## äº”ã€UI/UXè®¾è®¡

### 5.1 æ”¯ä»˜æ–¹å¼å±•ç¤ºåŸåˆ™

**ç”¨æˆ·è§†è§’ (ä¸å˜)**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é€‰æ‹©æ”¯ä»˜æ–¹å¼                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âš¡ QuickPay      ä¸€é”®æ”¯ä»˜ (æ¨è)        â”‚
â”‚  ğŸ’³ é’±åŒ…æ”¯ä»˜       USDC/USDT ç›´æ¥è½¬è´¦    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ Apple Pay     å¤„ç†è´¹ 2.9%           â”‚
â”‚  ğŸ“± Google Pay    å¤„ç†è´¹ 2.9%           â”‚
â”‚  ğŸ’³ ä¿¡ç”¨å¡        Visa/Mastercard       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®è®¾è®¡åŸåˆ™**:
- âœ… æ˜¾ç¤ºæ”¯ä»˜æ–¹å¼å›¾æ ‡ (Google Pay, Apple Pay, Visa)
- âœ… æ˜¾ç¤ºå¤„ç†è´¹ç‡
- âŒ **ä¸æ˜¾ç¤º** Stripe / Transak ç­‰åº•å±‚é€šé“åç§°
- âŒ **ä¸æ˜¾ç¤º** åˆ†ä½£æ˜ç»† (ä»…å•†æˆ·åå°å¯è§)

### 5.2 è·¯ç”±é€æ˜åŒ–

å½“ç”¨æˆ·é€‰æ‹© "Google Pay" æ—¶:
- æ™ºèƒ½è·¯ç”±åˆ¤æ–­: å•†æˆ·æ˜¯å¦æ”¯æŒæ³•å¸ç›´ç»“?
  - âœ… æ”¯æŒ â†’ èµ° Stripe
  - âŒ ä¸æ”¯æŒ â†’ èµ° Transak (æ³•å¸â†’USDCâ†’å•†æˆ·)
- ç”¨æˆ·æ— æ„ŸçŸ¥ï¼Œä»…çœ‹åˆ° "Google Pay" å›¾æ ‡

---

## å…­ã€å®æ–½é˜¶æ®µ

### Phase 1: åŸºç¡€é›†æˆ (Week 1-2)

- [ ] åç«¯: åˆ›å»º `StripeProviderService`
- [ ] åç«¯: å®ç° Stripe PaymentIntent åˆ›å»º
- [ ] åç«¯: å®ç° Stripe Webhook å¤„ç†
- [ ] å‰ç«¯: é›†æˆ Stripe Elements / Payment Sheet
- [ ] æµ‹è¯•: Stripe æµ‹è¯•æ¨¡å¼éªŒè¯

### Phase 2: æ™ºèƒ½è·¯ç”± (Week 3)

- [ ] æ›´æ–° `SmartRouterService` æ”¯æŒ Stripe é€šé“
- [ ] å•†æˆ·é…ç½®é¡µé¢: æ·»åŠ æ³•å¸ç»“ç®—é€‰é¡¹
- [ ] è·¯ç”±å†³ç­–é€»è¾‘: Stripe vs Transak é€‰æ‹©
- [ ] è´¹ç‡å¯¹æ¯”å±•ç¤º

### Phase 3: åˆ†ä½£ç»“ç®— (Week 4)

- [ ] å®ç°é“¾ä¸‹åˆ†ä½£è®°å½•
- [ ] æ‰¹é‡ç»“ç®—ä»»åŠ¡ (Cron Job)
- [ ] å•†æˆ·/Agent æç°åŠŸèƒ½
- [ ] å¯¹è´¦ä¸æŠ¥è¡¨

### Phase 4: ä¼˜åŒ–ä¸Šçº¿ (Week 5)

- [ ] Stripe ç”Ÿäº§ç¯å¢ƒé…ç½®
- [ ] ç›‘æ§ä¸å‘Šè­¦
- [ ] æ–‡æ¡£æ›´æ–°
- [ ] ç°åº¦å‘å¸ƒ

---

## ä¸ƒã€é…ç½®æ¸…å•

### 7.1 ç¯å¢ƒå˜é‡

```env
# Stripe é…ç½®
STRIPE_SECRET_KEY=sk_test_xxx
STRIPE_PUBLISHABLE_KEY=pk_test_xxx
STRIPE_WEBHOOK_SECRET=whsec_xxx
STRIPE_CONNECT_ENABLED=true

# ç»“ç®—é…ç½®
STRIPE_SETTLEMENT_DELAY_DAYS=3
STRIPE_MIN_PAYOUT_AMOUNT=10
```

### 7.2 API ç«¯ç‚¹ (æ–°å¢)

| ç«¯ç‚¹ | æ–¹æ³• | æè¿° |
|------|------|------|
| `/api/payments/stripe/create-intent` | POST | åˆ›å»º PaymentIntent |
| `/api/payments/stripe/webhook` | POST | Stripe Webhook æ¥æ”¶ |
| `/api/payments/stripe/confirm` | POST | ç¡®è®¤æ”¯ä»˜å®Œæˆ |
| `/api/merchant/stripe/connect` | POST | Stripe Connect å…³è” |

---

## å…«ã€é£é™©ä¸åº”å¯¹

| é£é™© | å½±å“ | åº”å¯¹æªæ–½ |
|------|------|---------|
| Stripe å®¡æ ¸ä¸é€šè¿‡ | æ— æ³•ä¸Šçº¿ | å‡†å¤‡å¤‡ç”¨æ–¹æ¡ˆ (Paddle/Adyen) |
| åˆ†ä½£ç»“ç®—å»¶è¿Ÿ | å•†æˆ·/Agent ä½“éªŒå·® | æ˜ç¡®ç»“ç®—å‘¨æœŸã€æä¾›é¢„ä¼°åˆ°è´¦æ—¶é—´ |
| é€€æ¬¾å¤„ç† | åˆ†ä½£å›é€€å¤æ‚ | è®¾è®¡é€€æ¬¾å†»ç»“æœŸã€åˆ†ä½£å›æ”¶é€»è¾‘ |
| æ±‡ç‡æ³¢åŠ¨ | è·¨å¸ç§ç»“ç®—æŸå¤± | å®æ—¶æ±‡ç‡é”å®šã€ç¼“å†²æ¯”ä¾‹ |

---

## ä¹ã€éªŒæ”¶æ ‡å‡†

- [ ] ç”¨æˆ·å¯é€šè¿‡ Google Pay / Apple Pay / ä¿¡ç”¨å¡å®Œæˆæ”¯ä»˜
- [ ] æ”¯ä»˜æˆåŠŸåè®¢å•çŠ¶æ€æ­£ç¡®æ›´æ–°
- [ ] åˆ†ä½£ä¿¡æ¯æ­£ç¡®è®°å½•
- [ ] T+3 æ‰¹é‡ç»“ç®—æ­£å¸¸æ‰§è¡Œ
- [ ] å•†æˆ·/Agent å¯æŸ¥çœ‹æ”¶ç›Šæ˜ç»†
- [ ] Webhook é‡è¯•æœºåˆ¶æ­£å¸¸
- [ ] é€€æ¬¾æµç¨‹å¯ç”¨

---

**æ–‡æ¡£ç»´æŠ¤**: Agentrix Team  
**æœ€åæ›´æ–°**: 2026-01-21
