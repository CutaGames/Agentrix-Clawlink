# PayMind V3.0 下一步开发计划

## 📊 当前状态

**已完成**：
- ✅ 支付流程优化（手续费计算、总手续费和汇率显示）
- ✅ 支付聚合服务商集成
- ✅ 统一支付流程

**待完成**：
- ⏳ 商家提现功能
- ⏳ 结算功能增强（根据订单类型）
- ⏳ 实时汇率API
- ⏳ Provider API集成（真实API）

---

## 🎯 优先级P0：必须完成

### 1. 结算功能增强（根据订单类型）

#### 功能需求
- 根据订单类型设置结算条件
  - NFT/虚拟资产：即时结算（无需等待）
  - 服务：服务开始后结算（用户确认）
  - 实体商品：确认收货后结算（7天自动确认）

#### 实现计划
1. **更新Escrow服务**
   - 支持不同结算条件
   - 实现自动结算逻辑
   - 实现定时任务（7天自动确认）

2. **更新支付服务**
   - 根据订单类型设置结算条件
   - 保存到支付元数据

3. **前端显示**
   - 显示结算条件
   - 显示预计结算时间

#### 预计时间：2-3小时

---

### 2. 商家提现功能

#### 功能需求
- 商家提现申请
- 数字货币转法币（通过Provider）
- 提现手续费计算（Provider 0.3 USDC + PayMind 0.1 USDC）
- 提现状态跟踪

#### 实现计划
1. **创建提现实体**
   - `Withdrawal` 实体
   - 提现状态枚举

2. **创建提现服务**
   - `WithdrawalService` - 提现处理逻辑
   - 调用Provider API转换数字货币为法币
   - 计算提现手续费

3. **创建提现控制器**
   - `POST /api/payments/withdraw` - 创建提现申请
   - `GET /api/payments/withdraw/:id` - 查询提现状态
   - `GET /api/payments/withdraw` - 查询提现列表

4. **前端实现**
   - 提现申请页面
   - 提现状态跟踪
   - 提现历史列表

#### 预计时间：3-4小时

---

## 🎯 优先级P1：重要

### 3. 实时汇率API

#### 功能需求
- 接入实时汇率API（CoinGecko、Binance等）
- 汇率缓存机制（避免频繁请求）
- 汇率更新通知

#### 实现计划
1. **创建汇率服务**
   - `ExchangeRateService` - 汇率服务
   - 支持多个汇率API源
   - 汇率缓存（Redis或内存）

2. **更新智能路由**
   - 使用实时汇率替换模拟汇率
   - 汇率更新机制

3. **前端显示**
   - 显示汇率更新时间
   - 汇率刷新按钮

#### 预计时间：2-3小时

---

### 4. Provider API集成（真实API）

#### 功能需求
- MoonPay API集成
- Alchemy Pay API集成
- Binance API集成
- Provider配置管理

#### 实现计划
1. **更新FiatToCryptoService**
   - 真实API调用
   - Provider配置管理
   - 错误处理和重试

2. **Provider配置**
   - 环境变量配置
   - Provider选择逻辑

3. **测试**
   - Provider API测试
   - 错误处理测试

#### 预计时间：4-5小时

---

## 🎯 优先级P2：可选

### 5. 智能合约集成

#### 功能需求
- Escrow合约部署
- 分成结算合约
- 合约事件监听
- 合约状态查询

#### 实现计划
1. **合约开发**
   - Solidity合约编写
   - 合约测试

2. **后端集成**
   - 合约交互逻辑
   - 合约事件监听
   - 合约状态查询

3. **前端显示**
   - 合约地址显示
   - 合约状态显示

#### 预计时间：8-10小时

---

## 📋 开发顺序建议

### 第一阶段（本周）
1. ✅ 支付流程优化（已完成）
2. ⏳ 结算功能增强（2-3小时）
3. ⏳ 商家提现功能（3-4小时）

### 第二阶段（下周）
4. ⏳ 实时汇率API（2-3小时）
5. ⏳ Provider API集成（4-5小时）

### 第三阶段（后续）
6. ⏳ 智能合约集成（8-10小时）

---

## 🧪 测试计划

### 单元测试
- [ ] 手续费计算逻辑测试
- [ ] 结算条件判断测试
- [ ] 提现流程测试

### 集成测试
- [ ] 支付流程端到端测试
- [ ] 提现流程端到端测试
- [ ] Provider API集成测试

### 验收测试
- [ ] 所有支付场景测试
- [ ] 所有提现场景测试
- [ ] 性能测试

---

## 📝 下一步行动

1. **立即开始**：结算功能增强
2. **然后**：商家提现功能
3. **最后**：实时汇率API和Provider API集成

---

## 🎯 成功标准

- ✅ 所有支付场景正常工作
- ✅ 结算功能正常工作
- ✅ 商家提现功能正常工作
- ✅ 无编译错误
- ✅ 无运行时错误
- ✅ 所有测试通过

