# å¦‚ä½•ä¿®å¤ agent_sessions è¡¨çš„ userId NULL å€¼é—®é¢˜

## é—®é¢˜è¯´æ˜
åç«¯æœåŠ¡æ— æ³•å¯åŠ¨ï¼Œå› ä¸º `agent_sessions` è¡¨çš„ `userId` åˆ—åŒ…å« NULL å€¼ï¼Œæ— æ³•è®¾ç½®ä¸º NOT NULLã€‚

## ä¿®å¤æ­¥éª¤ï¼ˆåœ¨ WSL ç»ˆç«¯ä¸­æ‰§è¡Œï¼‰

### æ­¥éª¤ 1ï¼šè¿æ¥åˆ° PostgreSQL æ•°æ®åº“

```bash
cd /mnt/d/wsl/Ubuntu-24.04/Code/Paymind/paymind-website/backend
psql -U paymind -d paymind_db -h localhost
```

**æ³¨æ„**ï¼šå¦‚æœæç¤ºè¾“å…¥å¯†ç ï¼Œè¯·è¾“å…¥ä½ çš„ PostgreSQL æ•°æ®åº“å¯†ç ã€‚

### æ­¥éª¤ 2ï¼šæ‰§è¡Œä¿®å¤ SQL

åœ¨ `psql` æç¤ºç¬¦ä¸‹ï¼ˆä½ ä¼šçœ‹åˆ° `paymind_db=>`ï¼‰ï¼Œä¾æ¬¡æ‰§è¡Œä»¥ä¸‹ SQL å‘½ä»¤ï¼š

```sql
-- 1. åˆ é™¤æ‰€æœ‰ userId ä¸º NULL çš„è®°å½•
DELETE FROM agent_sessions WHERE "userId" IS NULL;

-- 2. åˆ é™¤å¤–é”®çº¦æŸï¼ˆå¦‚æœå­˜åœ¨ï¼‰
ALTER TABLE agent_sessions DROP CONSTRAINT IF EXISTS "FK_40a6b0600d60c067ae0f8659ce0";

-- 3. å°† userId è®¾ç½®ä¸º NOT NULL
ALTER TABLE agent_sessions ALTER COLUMN "userId" SET NOT NULL;
```

### æ­¥éª¤ 3ï¼šéªŒè¯ä¿®å¤

æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹ç»“æœï¼š

```sql
-- æ£€æŸ¥æ˜¯å¦è¿˜æœ‰ NULL å€¼
SELECT COUNT(*) FROM agent_sessions WHERE "userId" IS NULL;
-- åº”è¯¥è¿”å› 0

-- æ£€æŸ¥ userId åˆ—æ˜¯å¦å·²è®¾ç½®ä¸º NOT NULL
\d agent_sessions
-- æŸ¥çœ‹è¡¨ç»“æ„ï¼Œç¡®è®¤ userId åˆ—æ˜¾ç¤ºä¸º NOT NULL
```

### æ­¥éª¤ 4ï¼šé€€å‡º psql

```sql
\q
```

### æ­¥éª¤ 5ï¼šé‡å¯åç«¯æœåŠ¡

```bash
cd /mnt/d/wsl/Ubuntu-24.04/Code/Paymind/paymind-website/backend
npm run start:dev
```

åº”è¯¥çœ‹åˆ°ï¼š
```
ğŸš€ PayMind Backend is running on: http://0.0.0.0:3001
ğŸ“š API Documentation: http://0.0.0.0:3001/api/docs
```

## æ›¿ä»£æ–¹æ³•ï¼šä½¿ç”¨ SQL è„šæœ¬æ–‡ä»¶

å¦‚æœä½ çŸ¥é“æ•°æ®åº“å¯†ç ï¼Œå¯ä»¥ç›´æ¥æ‰§è¡Œ SQL è„šæœ¬ï¼š

```bash
cd /mnt/d/wsl/Ubuntu-24.04/Code/Paymind/paymind-website/backend
PGPASSWORD='ä½ çš„æ•°æ®åº“å¯†ç ' psql -U paymind -d paymind_db -h localhost -f scripts/fix-agent-sessions.sql
```

## å¦‚æœä¸çŸ¥é“æ•°æ®åº“å¯†ç 

1. **æ£€æŸ¥ç¯å¢ƒå˜é‡**ï¼š
   ```bash
   # æŸ¥çœ‹åç«¯ .env æ–‡ä»¶
   cat backend/.env | grep DB_PASSWORD
   ```

2. **æˆ–è€…æŸ¥çœ‹æ•°æ®åº“é…ç½®**ï¼š
   ```bash
   # æŸ¥çœ‹æ•°æ®åº“é…ç½®æ–‡ä»¶
   cat backend/src/config/database.config.ts
   ```

3. **æˆ–è€…è¯¢é—®æ•°æ®åº“ç®¡ç†å‘˜**

## å¸¸è§é—®é¢˜

### Q: æç¤º "password authentication failed"
A: æ•°æ®åº“å¯†ç ä¸æ­£ç¡®ã€‚è¯·ç¡®è®¤æ­£ç¡®çš„å¯†ç åé‡è¯•ã€‚

### Q: æç¤º "psql: command not found"
A: éœ€è¦å®‰è£… PostgreSQL å®¢æˆ·ç«¯ï¼š
```bash
sudo apt-get update
sudo apt-get install postgresql-client
```

### Q: æç¤º "connection refused"
A: PostgreSQL æœåŠ¡å¯èƒ½æœªå¯åŠ¨ï¼š
```bash
sudo service postgresql start
```

## ä¿®å¤åçš„é…ç½®è¯´æ˜

- âœ… å·²ç¦ç”¨ `synchronize`ï¼Œæ”¹ä¸ºä½¿ç”¨è¿ç§»ç®¡ç†æ•°æ®åº“ç»“æ„
- âœ… å·²åˆ›å»ºä¿®å¤è„šæœ¬ï¼š`backend/scripts/fix-agent-sessions.sql`
- âœ… å·²åˆ›å»º Node.js ä¿®å¤è„šæœ¬ï¼š`backend/scripts/fix-db.js`

ä¿®å¤å®Œæˆåï¼Œåç«¯æœåŠ¡åº”è¯¥èƒ½å¤Ÿæ­£å¸¸å¯åŠ¨ï¼

