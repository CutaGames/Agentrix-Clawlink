# æ•°æ®åº“ä¿®å¤æŒ‡å—

## é—®é¢˜
`agent_sessions` è¡¨çš„ `userId` åˆ—åŒ…å« NULL å€¼ï¼Œå¯¼è‡´åç«¯æœåŠ¡æ— æ³•å¯åŠ¨ã€‚

## å¿«é€Ÿä¿®å¤æ­¥éª¤

### æ–¹æ³• 1ï¼šä½¿ç”¨ psql å‘½ä»¤è¡Œï¼ˆæ¨èï¼‰

1. **è¿æ¥åˆ° PostgreSQL æ•°æ®åº“**ï¼š
   ```bash
   # åœ¨ WSL æˆ– Linux ç»ˆç«¯ä¸­æ‰§è¡Œ
   psql -U paymind -d paymind_db -h localhost
   ```
   
   å¦‚æœæç¤ºè¾“å…¥å¯†ç ï¼Œè¯·è¾“å…¥ä½ çš„æ•°æ®åº“å¯†ç ã€‚

2. **æ‰§è¡Œä¿®å¤ SQL**ï¼š
   ```sql
   -- åˆ é™¤æ‰€æœ‰ userId ä¸º NULL çš„è®°å½•
   DELETE FROM agent_sessions WHERE "userId" IS NULL;
   
   -- åˆ é™¤å¤–é”®çº¦æŸï¼ˆå¦‚æœå­˜åœ¨ï¼‰
   ALTER TABLE agent_sessions DROP CONSTRAINT IF EXISTS "FK_40a6b0600d60c067ae0f8659ce0";
   
   -- å°† userId è®¾ç½®ä¸º NOT NULL
   ALTER TABLE agent_sessions ALTER COLUMN "userId" SET NOT NULL;
   ```

3. **é€€å‡º psql**ï¼š
   ```sql
   \q
   ```

### æ–¹æ³• 2ï¼šä½¿ç”¨ SQL è„šæœ¬æ–‡ä»¶

```bash
# åœ¨ WSL æˆ– Linux ç»ˆç«¯ä¸­æ‰§è¡Œ
cd /mnt/d/wsl/Ubuntu-24.04/Code/Paymind/paymind-website/backend
PGPASSWORD='ä½ çš„æ•°æ®åº“å¯†ç ' psql -U paymind -d paymind_db -h localhost -f scripts/fix-agent-sessions.sql
```

### æ–¹æ³• 3ï¼šä½¿ç”¨ Node.js è„šæœ¬ï¼ˆéœ€è¦æ­£ç¡®å¯†ç ï¼‰

1. **ç¼–è¾‘è„šæœ¬è®¾ç½®å¯†ç **ï¼š
   æ‰“å¼€ `backend/scripts/fix-db.js`ï¼Œä¿®æ”¹ç¬¬ 12 è¡Œçš„å¯†ç ï¼š
   ```javascript
   password: process.env.DB_PASSWORD || 'ä½ çš„å®é™…å¯†ç ',
   ```

2. **æ‰§è¡Œè„šæœ¬**ï¼š
   ```bash
   cd backend
   node scripts/fix-db.js
   ```

### æ–¹æ³• 4ï¼šä½¿ç”¨æ•°æ®åº“ç®¡ç†å·¥å…·

å¦‚æœä½ ä½¿ç”¨ pgAdminã€DBeaver æˆ–å…¶ä»–æ•°æ®åº“ç®¡ç†å·¥å…·ï¼š

1. è¿æ¥åˆ°æ•°æ®åº“
2. æ‰“å¼€ SQL ç¼–è¾‘å™¨
3. æ‰§è¡Œ `backend/scripts/fix-agent-sessions.sql` æ–‡ä»¶ä¸­çš„ SQL è¯­å¥

## ä¿®å¤åéªŒè¯

ä¿®å¤å®Œæˆåï¼Œé‡å¯åç«¯æœåŠ¡ï¼š

```bash
cd backend
npm run start:dev
```

åº”è¯¥çœ‹åˆ°ï¼š
```
ğŸš€ PayMind Backend is running on: http://0.0.0.0:3001
ğŸ“š API Documentation: http://0.0.0.0:3001/api/docs
```

## æ³¨æ„äº‹é¡¹

- åˆ é™¤ NULL userId è®°å½•å‰ï¼Œè¯·ç¡®è®¤è¿™äº›è®°å½•æ˜¯å¦é‡è¦
- å¦‚æœè¿™äº›è®°å½•éœ€è¦ä¿ç•™ï¼Œå¯ä»¥å…ˆä¸ºå®ƒä»¬åˆ†é…ä¸€ä¸ªæœ‰æ•ˆçš„ userId
- ä¿®å¤åï¼Œ`synchronize` å·²ç¦ç”¨ï¼Œå»ºè®®ä½¿ç”¨è¿ç§»æ¥ç®¡ç†æ•°æ®åº“ç»“æ„

