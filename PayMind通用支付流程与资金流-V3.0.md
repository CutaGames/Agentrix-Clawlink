# PayMind 通用支付流程与资金流 V3.0
## 适配所有支付场景的统一流程设计

**版本**: 3.2  
**日期**: 2025年1月  
**设计理念**: 统一入口、智能路由、简化分佣、多链兼容、SLA治理

**重要更新（V3.2）**：
- ✅ **分佣计算简化**：商户价格 × 固定佣金比例（类似电商模式）
- ✅ **交易类型佣金**：根据商品类型和类别设定不同佣金比例
- ✅ **多链Agent ID**：支持ERC 8004、W3C DID、多链注册
- ✅ **SLA治理机制**：引入SLA指标、追责机制、争议解决
- ✅ 通道费用由商户承担（主流模式）
- ✅ 引入三层ID体系（User ID、Agent ID、Session ID）

---

## 📋 目录

1. [通用支付流程总览](#1-通用支付流程总览)
2. [通用支付时序图](#2-通用支付时序图)
3. [资金流走向与分派](#3-资金流走向与分派)
4. [分佣计算流程](#4-分佣计算流程)
5. [结算流程](#5-结算流程)
6. [场景适配说明](#6-场景适配说明)

---

## 1. 通用支付流程总览

### 1.1 流程阶段

PayMind统一支付流程包含以下6个核心阶段，适配所有支付场景：

```
┌─────────────────────────────────────────────────────────────┐
│                    PayMind 通用支付流程                        │
└─────────────────────────────────────────────────────────────┘

阶段1: 支付请求
  ↓
阶段2: 智能路由选择
  ↓
阶段3: 支付执行
  ↓
阶段4: 分佣计算
  ↓
阶段5: 资金托管（可选）
  ↓
阶段6: 结算分派
```

### 1.2 流程说明

| 阶段 | 功能 | 输入 | 输出 | 适配场景 |
|------|------|------|------|---------|
| **阶段1: 支付请求** | 接收支付请求，验证参数 | 用户支付请求 | 支付记录 | 所有场景 |
| **阶段2: 智能路由选择** | 选择最优支付通道 | 支付金额、货币、场景 | 推荐支付方式 | 所有场景 |
| **阶段3: 支付执行** | 执行实际支付 | 支付方式、支付信息 | 支付结果 | 所有场景 |
| **阶段4: 分佣计算** | 计算所有分佣 | 支付金额、订单类型 | 分佣记录 | 所有场景 |
| **阶段5: 资金托管** | 托管资金（如需要） | 支付金额、订单类型 | 托管记录 | 需要托管的场景 |
| **阶段6: 结算分派** | 结算并分派资金 | 分佣记录、结算条件 | 结算结果 | 所有场景 |

---

## 2. 通用支付时序图

### 2.1 完整通用时序图

```
用户                前端UI              后端API              智能路由              支付执行服务          分佣服务              托管服务              结算服务
 │                   │                   │                    │                    │                    │                    │                    │
 │──发起支付请求─────>│                   │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │
 │                   │──processPayment───>│                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │
 │                   │                   │  [阶段1: 支付请求]  │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │
 │                   │                   │  1. 创建支付记录   │                    │                    │                    │                    │
 │                   │                   │  2. 验证支付参数   │                    │                    │                    │                    │
 │                   │                   │  3. 获取用户信息   │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │
 │                   │                   │  [阶段2: 智能路由选择]│                  │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │
 │                   │                   │──selectBestChannel─>│                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │
 │                   │                   │                    │  路由决策逻辑：     │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │
 │                   │                   │                    │  1. 检查商家配置    │                    │                    │                    │
 │                   │                   │                    │     - fiat_only    │                    │                    │                    │
 │                   │                   │                    │     - crypto_only   │                    │                    │                    │
 │                   │                   │                    │     - both         │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │
 │                   │                   │                    │  2. 检查可用通道    │                    │                    │                    │
 │                   │                   │                    │     - Stripe       │                    │                    │                    │
 │                   │                   │                    │     - X402         │                    │                    │                    │
 │                   │                   │                    │     - Wallet       │                    │                    │                    │
 │                   │                   │                    │     - Multisig     │                    │                    │                    │
 │                   │                   │                    │     - Aggregator   │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │
 │                   │                   │                    │  3. 评估通道       │                    │                    │                    │
 │                   │                   │                    │     - 成本         │                    │                    │                    │
 │                   │                   │                    │     - 速度         │                    │                    │                    │
 │                   │                   │                    │     - KYC要求      │                    │                    │                    │
 │                   │                   │                    │     - 跨境支持     │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │
 │                   │                   │                    │  4. 检测跨境场景   │                    │                    │                    │
 │                   │                   │                    │     - 法币转数字货币│                  │                    │                    │
 │                   │                   │                    │     - 数字货币转法币│                  │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │
 │                   │                   │                    │<─返回路由决策──────│                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │
 │                   │                   │  RoutingDecision:  │                    │                    │                    │
 │                   │                   │  - recommendedMethod│                    │                    │                    │
 │                   │                   │  - channels        │                    │                    │                    │
 │                   │                   │  - priceComparison │                    │                    │                    │
 │                   │                   │  - totalFeeRate    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │
 │                   │                   │  [阶段3: 支付执行] │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │
 │                   │                   │──执行支付──────────>│                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │
 │                   │                   │                    │  根据支付方式：     │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │
 │                   │                   │                    │  - Stripe: 调用Stripe API│            │                    │                    │                    │
 │                   │                   │                    │  - X402: 创建支付会话│              │                    │                    │                    │
 │                   │                   │                    │  - Wallet: 等待签名  │              │                    │                    │                    │
 │                   │                   │                    │  - Aggregator: 调用聚合服务│        │                    │                    │                    │
 │                   │                   │                    │  - FiatToCrypto: 执行转换│          │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │
 │                   │                   │                    │<─支付结果───────────│                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │
 │                   │                   │  [阶段4: 分佣计算] │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │
 │                   │                   │──calculateAndRecordCommission>│        │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │
 │                   │                   │                    │  1. 获取订单类型   │                    │                    │                    │
 │                   │                   │                    │     - nft          │                    │                    │                    │
 │                   │                   │                    │     - virtual      │                    │                    │                    │
 │                   │                   │                    │     - service      │                    │                    │                    │
 │                   │                   │                    │     - product      │                    │                    │                    │
 │                   │                   │                    │     - physical     │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │
 │                   │                   │                    │  2. 获取分成配置   │                    │                    │                    │
 │                   │                   │                    │     - 执行Agent: 2-3%│                │                    │                    │
 │                   │                   │                    │     - 推荐Agent: 商品佣金率 × 30%│    │                    │                    │
 │                   │                   │                    │     - PayMind: 0.5-1%│              │                    │                    │
 │                   │                   │                    │     - Provider: 3% (如有)│          │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │
 │                   │                   │                    │  3. 计算分佣金额   │                    │                    │                    │
 │                   │                   │                    │     - 执行Agent分佣│                │                    │                    │
 │                   │                   │                    │     - 推荐Agent分佣│                │                    │                    │
 │                   │                   │                    │     - PayMind分佣 │                │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │
 │                   │                   │                    │──保存分佣记录─────>│                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │──recordPaymentCommission>│          │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │  1. 查找推广关系   │                    │                    │
 │                   │                   │                    │                    │     - merchantId   │                    │                    │
 │                   │                   │                    │                    │     - status: ACTIVE│                   │                    │
 │                   │                   │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │  2. 计算推广分成   │                    │                    │
 │                   │                   │                    │                    │     - 0.5% (永久)   │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │  3. 创建推广分成记录│                    │                    │
 │                   │                   │                    │                    │     - status: PENDING│                 │                    │
 │                   │                   │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │──保存推广分成记录─>│                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │──calculateNetworkCommission>│        │
 │                   │                   │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │  1. 查找联盟节点   │                    │
 │                   │                   │                    │                    │                    │     - 网络内商户    │                    │
 │                   │                   │                    │                    │                    │     - 节点等级     │                    │
 │                   │                   │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │  2. 计算网络分成   │                    │
 │                   │                   │                    │                    │                    │     - 0.1-0.3%     │                    │
 │                   │                   │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │  3. 创建网络分成记录│                    │
 │                   │                   │                    │                    │                    │     - status: PENDING│                 │                    │
 │                   │                   │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │──保存网络分成记录─>│                    │
 │                   │                   │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │<─分佣计算完成──────│                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │
 │                   │                   │  [阶段5: 资金托管（可选）]│            │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │
 │                   │                   │──shouldUseEscrow───>│                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │  判断条件：         │
 │                   │                   │                    │                    │                    │                    │  - 订单类型         │
 │                   │                   │                    │                    │                    │                    │  - 商家设置         │
 │                   │                   │                    │                    │                    │                    │  - 金额阈值         │
 │                   │                   │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │<─需要托管──────────│
 │                   │                   │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │──createEscrow─────>│
 │                   │                   │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │  创建托管配置：     │
 │                   │                   │                    │                    │                    │                    │  - 订单类型         │
 │                   │                   │                    │                    │                    │                    │  - 结算类型         │
 │                   │                   │                    │                    │                    │                    │  - 分成配置         │
 │                   │                   │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │<─返回escrowId─────│
 │                   │                   │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │──fundEscrow───────>│
 │                   │                   │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │  状态更新：         │
 │                   │                   │                    │                    │                    │                    │  - status: FUNDED   │
 │                   │                   │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │<─资金已托管────────│
 │                   │                   │                    │                    │                    │                    │                    │
 │                   │                   │  [阶段6: 结算分派] │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │──autoSettleByOrderType>│
 │                   │                   │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │  根据订单类型：     │
 │                   │                   │                    │                    │                    │                    │  - NFT/虚拟: 即时   │
 │                   │                   │                    │                    │                    │                    │  - 服务: 等待开始   │
 │                   │                   │                    │                    │                    │                    │  - 商品: 等待确认   │
 │                   │                   │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │──确认结算条件满足──>│
 │                   │                   │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │──executeSettlement>│
 │                   │                   │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │  1. 计算结算金额   │
 │                   │                   │                    │                    │                    │                    │     - 商户收入      │
 │                   │                   │                    │                    │                    │                    │     - Agent分佣    │
 │                   │                   │                    │                    │                    │                    │     - PayMind分佣 │
 │                   │                   │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │  2. 执行资金分派   │
 │                   │                   │                    │                    │                    │                    │     - 转账给商户   │
 │                   │                   │                    │                    │                    │                    │     - 转账给Agent │
 │                   │                   │                    │                    │                    │                    │     - 转账给PayMind│
 │                   │                   │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │<─结算完成──────────│
 │                   │                   │                    │                    │                    │                    │                    │
 │                   │<─支付成功─────────│                    │                    │                    │                    │                    │
 │<─显示支付成功──────│                   │                    │                    │                    │                    │                    │
```

---

## 3. 资金流走向与分派

### 3.1 资金流总览

```
┌─────────────────────────────────────────────────────────────┐
│                    PayMind 资金流总览                          │
└─────────────────────────────────────────────────────────────┘

商户挂单价格: $1,000
  │
  ├─→ [固定佣金计算]（基于商户价格）
  │   │
  │   ├─→ Agent佣金: $1,000 × 10% = $100（固定）
  │   ├─→ PayMind平台费: $1,000 × 1% = $10（固定）
  │   └─→ 商户预期收入: $1,000 - $100 - $10 = $890
  │
  ├─→ [用户支付] $1,000
  │
  ├─→ [通道费用扣除]（商户承担）
  │   │
  │   ├─→ Stripe: $1,000 × 2.9% = $29
  │   ├─→ X402: $1,000 × 0.06% = $0.6
  │   └─→ Wallet: $1,000 × 0.1% = $1
  │
  ├─→ [商户实际收入计算]
  │   │
  │   ├─→ Stripe通道: $890 - $29 = $861
  │   ├─→ X402通道: $890 - $0.6 = $889.4
  │   └─→ Wallet通道: $890 - $1 = $889
  │
  ├─→ [推广分成计算]（基于用户支付金额，异步）
  │   │
  │   ├─→ 推广Agent分成: $1,000 × 0.5% = $5 (T+7)
  │   └─→ 联盟节点分成: $1,000 × 0.2% = $2 (T+7)
  │
  └─→ [资金托管/结算]
      │
      ├─→ 即时结算 (NFT/虚拟资产)
      │   ├─→ 商户: $861-$889.4（根据通道）
      │   ├─→ Agent: $100 (T+1)
      │   └─→ PayMind: $10 (T+1)
      │
      └─→ 延迟结算 (服务/商品)
          ├─→ Escrow托管: $861-$889.4（根据通道）
          ├─→ 等待结算条件满足
          └─→ 释放资金并分派
```

### 3.2 资金流详细分派图

```
┌─────────────────────────────────────────────────────────────────┐
│                    资金流详细分派图                                │
└─────────────────────────────────────────────────────────────────┘

用户支付: $1,000
  │
  ├───────────────────────────────────────────────────────────────┐
  │  阶段1: 平台接收                                               │
  └───────────────────────────────────────────────────────────────┘
  │
  │  接收金额: $1,000
  │  接收方式: Stripe/X402/Wallet/Aggregator
  │  接收状态: COMPLETED
  │
  ├───────────────────────────────────────────────────────────────┐
  │  阶段2: 通道费用扣除                                           │
  └───────────────────────────────────────────────────────────────┘
  │
  │  ┌─────────────────────────────────────────────────────────┐
  │  │ 通道费用 (商户承担)                                       │
  │  │ 金额: $1,000 × 4% = $40                                  │
  │  │ 结算: 立即                                               │
  │  │ 流向: 通道提供商账户                                      │
  │  └─────────────────────────────────────────────────────────┘
  │
  │  可分配金额: $1,000 - $40 = $960
  │
  ├───────────────────────────────────────────────────────────────┐
  │  阶段3: 固定佣金计算（基于商户价格）                            │
  └───────────────────────────────────────────────────────────────┘
  │
  │  ┌─────────────────────────────────────────────────────────┐
  │  │ Agent佣金（固定）                                         │
  │  │ 金额: $1,000 × 10% = $100                               │
  │  │ 结算: T+1                                                │
  │  │ 流向: Agent钱包/账户                                      │
  │  │ 说明: 基于商户价格，不因通道费用变化                      │
  │  └─────────────────────────────────────────────────────────┘
  │
  │  ┌─────────────────────────────────────────────────────────┐
  │  │ PayMind平台费（固定）                                    │
  │  │ 金额: $1,000 × 1% = $10                                │
  │  │ 结算: T+1                                                │
  │  │ 流向: PayMind平台账户                                     │
  │  │ 说明: 基于商户价格，不因通道费用变化                      │
  │  └─────────────────────────────────────────────────────────┘
  │
  │  ┌─────────────────────────────────────────────────────────┐
  │  │ 商户预期收入                                              │
  │  │ 金额: $1,000 - $100 - $10 = $890                       │
  │  │ 说明: 商户在定价时可预估的收入                            │
  │  └─────────────────────────────────────────────────────────┘
  │
  │  ┌─────────────────────────────────────────────────────────┐
  │  │ 商户实际收入                                              │
  │  │ Stripe通道: $890 - $29 = $861                          │
  │  │ X402通道: $890 - $0.6 = $889.4                        │
  │  │ Wallet通道: $890 - $1 = $889                           │
  │  │ 说明: 商户实际收入 = 预期收入 - 通道费用                  │
  │  └─────────────────────────────────────────────────────────┘
  │
  ├───────────────────────────────────────────────────────────────┐
  │  阶段4: 推广分成计算（基于原金额，异步）                          │
  └───────────────────────────────────────────────────────────────┘
  │
  │  ┌─────────────────────────────────────────────────────────┐
  │  │ 推广Agent分成 (永久)                                      │
  │  │ 金额: $1,000 × 0.5% = $5                                 │
  │  │ 结算: T+7 (每周结算)                                      │
  │  │ 流向: 推广Agent钱包/账户                                  │
  │  └─────────────────────────────────────────────────────────┘
  │
  ├───────────────────────────────────────────────────────────────┐
  │  阶段5: 联盟网络分成计算（基于原金额，异步）                      │
  └───────────────────────────────────────────────────────────────┘
  │
  │  ┌─────────────────────────────────────────────────────────┐
  │  │ 联盟节点分成 (永久)                                       │
  │  │ 金额: $1,000 × 0.2% = $2                                 │
  │  │ 结算: T+7 (每周结算)                                      │
  │  │ 流向: 联盟节点钱包/账户                                   │
  │  └─────────────────────────────────────────────────────────┘
  │
  └───────────────────────────────────────────────────────────────┐
    阶段6: 资金托管/结算                                            │
  └───────────────────────────────────────────────────────────────┘
     │
     ├─→ 即时结算 (NFT/虚拟资产)
     │   │
     │   ├─→ 商户: $861-$889.4（根据通道，立即）
     │   ├─→ Agent: $100 (T+1)
     │   └─→ PayMind: $10 (T+1)
     │
     ├─→ 延迟结算 (服务)
     │   │
     │   ├─→ Escrow托管: $861-$889.4（根据通道）
     │   ├─→ 等待服务开始
     │   └─→ 释放资金:
     │       ├─→ 商户: $861-$889.4（根据通道）
     │       ├─→ Agent: $100 (T+1)
     │       └─→ PayMind: $10 (T+1)
     │
     └─→ 延迟结算 (商品)
         │
         ├─→ Escrow托管: $861-$889.4（根据通道）
         ├─→ 等待确认收货 (7天自动)
         └─→ 释放资金:
             ├─→ 商户: $861-$889.4（根据通道）
             ├─→ Agent: $100 (T+1)
             └─→ PayMind: $10 (T+1)
```

### 3.3 资金流分派矩阵（优化后）

| 分派对象 | 分佣类型 | 计算基础 | 分成比例 | 结算周期 | 结算时机 | 资金流向 |
|---------|---------|---------|---------|---------|---------|---------|
| **通道提供商** | 通道费用 | 用户支付金额 | 2.9%-4% | 立即 | 支付完成 | 通道提供商账户 |
| **Agent** | 固定佣金 | **商户价格** | 根据商品类型 | T+1 | 交易完成+1天 | Agent钱包/账户 |
| **PayMind** | 平台手续费 | **商户价格** | 根据商品类型 | T+1 | 交易完成+1天 | PayMind平台账户 |
| **推广Agent** | 商户推广分成 | 用户支付金额 | 0.5% | T+7 | 每周结算 | 推广Agent钱包/账户 |
| **联盟节点** | 网络分成 | 用户支付金额 | 0.1-0.3% | T+7 | 每周结算 | 联盟节点钱包/账户 |
| **商户** | 销售收入 | 商户价格 | 剩余部分 | 即时/延迟 | 根据订单类型 | 商户账户 |

**说明（V3.2优化）**：
- **固定佣金**：Agent佣金和PayMind平台费基于商户价格计算（固定），不因通道费用变化
- **通道费用**：固定损耗，由商户承担，在分佣后从商户收入扣除
- **商户实际收入**：商户预期收入 - 通道费用（不同通道实际收入不同）
- **推广分成**：推广Agent和联盟节点基于用户支付金额计算（永久分成）
- **优势**：计算简单，商户易于理解和预估成本，符合电商行业惯例

---

## 4. 分佣计算流程

### 4.1 分佣计算时序图

```
支付完成              分佣计算服务          推广服务              联盟服务              数据库
 │                     │                    │                    │                    │
 │──支付状态: COMPLETED>│                    │                    │                    │
 │                     │                    │                    │                    │
 │                     │──calculateAndRecordCommission>│          │                    │
 │                     │                    │                    │                    │
 │                     │  1. 获取订单类型   │                    │                    │
 │                     │     - nft          │                    │                    │
 │                     │     - virtual      │                    │                    │
 │                     │     - service      │                    │                    │
 │                     │     - product      │                    │                    │
 │                     │     - physical     │                    │                    │
 │                     │                    │                    │                    │
 │                     │  2. 获取分成配置   │                    │                    │
 │                     │     - 执行Agent: 2-3%│                │                    │
 │                     │     - 推荐Agent: 商品佣金率 × 30%│    │                    │
 │                     │     - PayMind: 0.5-1%│              │                    │
 │                     │     - Provider: 3% (如有)│          │                    │
 │                     │                    │                    │                    │
 │                     │  3. 计算分佣金额   │                    │                    │
 │                     │     - 执行Agent分佣│                │                    │
 │                     │     - 推荐Agent分佣│                │                    │
 │                     │     - PayMind分佣 │                │                    │
 │                     │                    │                    │                    │
 │                     │──保存分佣记录─────>│                    │                    │
 │                     │                    │                    │                    │
 │                     │                    │──recordPaymentCommission>│          │
 │                     │                    │                    │                    │
 │                     │                    │  1. 查找推广关系   │                    │
 │                     │                    │     - merchantId   │                    │
 │                     │                    │     - status: ACTIVE│                   │
 │                     │                    │                    │                    │
 │                     │                    │  2. 计算推广分成   │                    │
 │                     │                    │     - 0.5% (永久)   │                    │
 │                     │                    │                    │                    │
 │                     │                    │  3. 创建推广分成记录│                    │
 │                     │                    │     - status: PENDING│                 │
 │                     │                    │                    │                    │
 │                     │                    │──保存推广分成记录─>│                    │
 │                     │                    │                    │                    │
 │                     │                    │                    │──calculateNetworkCommission>│
 │                     │                    │                    │                    │
 │                     │                    │                    │  1. 查找联盟节点   │                    │
 │                     │                    │                    │     - 网络内商户    │                    │
 │                     │                    │                    │     - 节点等级     │                    │
 │                     │                    │                    │                    │
 │                     │                    │                    │  2. 计算网络分成   │                    │
 │                     │                    │                    │     - 0.1-0.3%     │                    │
 │                     │                    │                    │                    │
 │                     │                    │                    │  3. 创建网络分成记录│                    │
 │                     │                    │                    │     - status: PENDING│                 │
 │                     │                    │                    │                    │
 │                     │                    │                    │──保存网络分成记录─>│                    │
 │                     │                    │                    │                    │
 │                     │                    │                    │<─保存成功──────────│                    │
 │                     │                    │<─保存成功──────────│                    │
 │                     │<─分佣计算完成──────│                    │                    │
```

### 4.2 分佣计算规则

#### 4.2.1 同步分佣（立即计算）

| 分佣类型 | 计算时机 | 分成比例 | 说明 |
|---------|---------|---------|------|
| **Provider手续费** | 支付完成 | 3% | 仅法币转数字货币时 |
| **执行Agent分佣** | 支付完成 | 2-3% | 根据订单类型 |
| **推荐Agent分佣** | 支付完成 | 商品佣金率 × 30% | 如有推荐Agent |
| **PayMind平台费** | 支付完成 | 0.5-1% | 根据订单类型 |

#### 4.2.2 异步分佣（延迟计算）

| 分佣类型 | 计算时机 | 分成比例 | 结算周期 |
|---------|---------|---------|---------|
| **推广Agent分成** | 支付完成 | 0.5% | T+7 |
| **联盟节点分成** | 支付完成 | 0.1-0.3% | T+7 |

---

## 5. 结算流程

### 5.1 结算时序图

```
结算触发              结算服务              托管服务              智能合约              收款方
 │                     │                    │                    │                    │
 │──结算条件满足────────>│                    │                    │                    │
 │                     │                    │                    │                    │
 │                     │──executeSettlement>│                    │                    │
 │                     │                    │                    │                    │
 │                     │  1. 检查结算条件   │                    │                    │
 │                     │     - 订单类型     │                    │                    │
 │                     │     - 结算类型     │                    │                    │
 │                     │     - 时间条件     │                    │                    │
 │                     │                    │                    │                    │
 │                     │  2. 计算结算金额   │                    │                    │
 │                     │     - 商户收入     │                    │                    │
 │                     │     - Agent分佣   │                    │                    │
 │                     │     - PayMind分佣 │                    │                    │
 │                     │                    │                    │                    │
 │                     │  3. 检查托管状态   │                    │                    │
 │                     │                    │──检查托管状态──────>│                    │
 │                     │                    │                    │                    │
 │                     │                    │<─托管状态──────────│                    │
 │                     │                    │                    │                    │
 │                     │  4. 释放托管资金  │                    │                    │
 │                     │                    │──releaseFunds──────>│                    │
 │                     │                    │                    │                    │
 │                     │                    │                    │──释放资金─────────>│
 │                     │                    │                    │                    │
 │                     │                    │                    │<─资金已释放────────│
 │                     │                    │<─资金已释放────────│                    │
 │                     │                    │                    │                    │
 │                     │  5. 执行资金分派  │                    │                    │
 │                     │                    │                    │                    │
 │                     │                    │                    │──转账给商户───────>│
 │                     │                    │                    │                    │──[商户账户]
 │                     │                    │                    │<─转账成功──────────│
 │                     │                    │                    │                    │
 │                     │                    │                    │──转账给Agent──────>│
 │                     │                    │                    │                    │──[Agent账户]
 │                     │                    │                    │<─转账成功──────────│
 │                     │                    │                    │                    │
 │                     │                    │                    │──转账给PayMind────>│
 │                     │                    │                    │                    │──[PayMind账户]
 │                     │                    │                    │<─转账成功──────────│
 │                     │                    │                    │                    │
 │                     │<─结算完成──────────│                    │                    │
 │<─结算成功───────────│                    │                    │                    │
```

### 5.2 结算类型

| 订单类型 | 结算类型 | 自动确认 | 用户确认 | 可退款 |
|---------|---------|---------|---------|--------|
| **NFT/虚拟资产** | instant | ✅ | ❌ | ❌ |
| **服务** | service_started | ❌ | ✅ | ✅ |
| **实体商品** | delivery_confirmed | ✅ (7天) | ✅ | ✅ |

---

## 6. 场景适配说明

### 6.1 场景适配矩阵

| 支付场景 | 阶段1 | 阶段2 | 阶段3 | 阶段4 | 阶段5 | 阶段6 | 阶段7 |
|---------|------|------|------|------|------|------|------|
| **数字货币支付** | ✅ | ✅ (X402/Wallet) | ✅ | ✅ | ✅ | ✅ (可选) | ✅ |
| **法币支付** | ✅ | ✅ (Stripe) | ✅ | ✅ | ✅ | ✅ (可选) | ✅ |
| **移动支付** | ✅ | ✅ (Stripe) | ✅ | ✅ | ✅ | ✅ (可选) | ✅ |
| **跨境支付** | ✅ | ✅ (FiatToCrypto) | ✅ | ✅ | ✅ | ✅ (可选) | ✅ |
| **托管支付** | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ (必需) | ✅ |
| **聚合支付** | ✅ | ✅ (Aggregator) | ✅ | ✅ | ✅ | ✅ (可选) | ✅ |
| **多Agent协作** | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ (可选) | ✅ |
| **大额支付** | ✅ | ✅ (Multisig) | ✅ | ✅ | ✅ | ✅ (可选) | ✅ |

**阶段说明**：
- 阶段1: 支付请求（含三层ID）
- 阶段2: 智能路由选择（含通道费用计算）
- 阶段3: 支付执行
- 阶段4: 通道费用扣除
- 阶段5: 分佣计算（基于可分配金额）
- 阶段6: 资金托管（可选）
- 阶段7: 结算分派

### 6.2 场景适配说明

#### 6.2.1 数字货币支付

- **阶段2**: 智能路由选择X402或Wallet
- **阶段3**: 执行链上支付
- **阶段4**: 计算分佣（无Provider手续费）
- **阶段5**: 根据订单类型决定是否托管
- **阶段6**: 根据订单类型结算

#### 6.2.2 法币支付

- **阶段2**: 智能路由选择Stripe或聚合服务商
- **阶段3**: 执行法币支付
- **阶段4**: 计算分佣（如有Provider，包含Provider手续费）
- **阶段5**: 根据订单类型决定是否托管
- **阶段6**: 根据订单类型结算

#### 6.2.3 跨境支付

- **阶段2**: 智能路由检测跨境场景，选择FiatToCrypto或CryptoToFiat
- **阶段3**: 执行货币转换和支付
- **阶段4**: 计算分佣（包含Provider手续费）
- **阶段5**: 根据订单类型决定是否托管
- **阶段6**: 根据订单类型结算

#### 6.2.4 托管支付

- **阶段2**: 智能路由选择支付方式
- **阶段3**: 执行支付
- **阶段4**: 计算分佣
- **阶段5**: **必需**创建Escrow托管
- **阶段6**: 等待结算条件满足后释放资金

#### 6.2.5 多Agent协作

- **阶段2**: 智能路由选择支付方式
- **阶段3**: 执行支付
- **阶段4**: **计算多层分佣**（执行Agent、推荐Agent、推广Agent、联盟节点）
- **阶段5**: 根据订单类型决定是否托管
- **阶段6**: 根据订单类型结算

---

## 7. 总结

### 7.1 通用流程优势

1. **统一入口**：所有支付场景通过同一流程处理
2. **智能路由**：自动选择最优支付通道
3. **自动分佣**：自动计算所有分佣（同步+异步）
4. **灵活托管**：根据订单类型自动决定是否托管
5. **透明结算**：所有资金流向清晰可追溯

### 7.2 资金流优势

1. **透明分派**：所有分佣规则公开透明
2. **及时结算**：根据订单类型及时或延迟结算
3. **多层级分佣**：支持执行Agent、推荐Agent、推广Agent、联盟节点
4. **永久分成**：推广Agent和联盟节点获得永久分成

### 7.3 场景适配优势

1. **全场景覆盖**：适配所有常见支付场景
2. **灵活配置**：根据场景自动调整流程
3. **统一体验**：所有场景用户体验一致
4. **可扩展性**：易于添加新的支付场景

### 7.4 优化亮点（V3.2）

1. **分佣计算简化**：商户价格 × 固定佣金比例（类似电商模式），计算简单透明
2. **交易类型佣金**：根据商品类型和类别设定不同佣金比例（实体商品、服务、链上资产）
3. **多链Agent ID**：支持ERC 8004、W3C DID、多链注册（Ethereum、Solana、BSC、Polygon、Base）
4. **SLA治理机制**：引入SLA指标、追责机制、争议解决，确保服务质量
5. **通道费用明确**：通道费用是固定损耗，由商户承担（主流模式）
6. **三层ID体系**：引入User ID、Agent ID、Session ID，用于追责和治理
7. **灵活配置**：不同商品类型和场景的扣费比例可配置

**详细优化方案请参考**：
- `PayMind支付流程优化方案-V3.1.md` - 通道费用和分佣优化
- `PayMind支付系统最终优化方案-V3.2.md` - 简化分佣、多链兼容、SLA治理

---

**此通用流程和资金流设计确保了PayMind支付系统能够适配所有支付场景，同时保持流程的统一性和资金流的透明性。**

