# PayMind Agent Runtime 测试指南

## 🧪 测试准备

### 1. 数据库迁移

运行数据库迁移以创建必要的表：

```bash
cd backend
npm run migration:run
```

**需要创建的表**：
- `agent_memory` - 记忆表
- `agent_workflow` - 流程表

### 2. 启动服务

```bash
# 启动后端
cd backend
npm run start:dev

# 启动前端（如果需要）
cd paymindfrontend
npm run dev
```

---

## 🎤 语音测试支持

**✅ Runtime 完全支持语音测试！**

### 语音功能说明

1. **语音输入**：前端已集成 `VoiceInput` 组件
   - 使用 Web Speech API 进行语音转文字
   - 支持中文识别（zh-CN）
   - 识别结果自动发送到后端

2. **语音输出**：前端已集成 `VoiceOutput` 组件
   - 使用 Web Speech Synthesis API 进行文字转语音
   - 支持自动播放 Agent 回复

3. **Runtime 处理**：
   - Runtime 处理的是**文本消息**，不关心输入方式
   - 语音转文字后，与文本输入的处理流程完全相同
   - 支持所有 Runtime 功能（Memory、Workflow、Skills）

### 语音测试要求

**浏览器要求**：
- Chrome/Edge（推荐，支持 Web Speech API）
- 需要麦克风权限
- 需要网络连接（语音识别需要在线）

**测试方式**：
- 点击输入框旁的麦克风按钮开始录音
- 说话后自动识别并发送
- Agent 回复可以自动语音播放

---

## 📋 测试场景

### 场景1：完整电商流程（支持语音）

**测试步骤**：

**方式1：文本输入**
1. **搜索商品**
   ```
   用户（文本）："我想买跑步鞋"
   预期：返回商品列表，保存到 Memory
   ```

2. **加入购物车**
   ```
   用户（文本）："第一个加入购物车"
   预期：从 Memory 获取第一个商品，加入购物车
   ```

3. **结算**
   ```
   用户（文本）："结算"
   预期：创建订单，清空购物车
   ```

4. **支付**
   ```
   用户（文本）："支付"
   预期：创建支付，完成流程
   ```

**方式2：语音输入** 🎤
1. **搜索商品**
   ```
   用户（语音）："我想买跑步鞋"
   → 语音转文字："我想买跑步鞋"
   → 处理流程与文本输入完全相同
   预期：返回商品列表，保存到 Memory
   ```

2. **加入购物车**
   ```
   用户（语音）："第一个加入购物车"
   → 语音转文字："第一个加入购物车"
   → Runtime 从 Memory 获取第一个商品
   预期：从 Memory 获取第一个商品，加入购物车
   ```

3. **结算**
   ```
   用户（语音）："结算"
   → 语音转文字："结算"
   → 执行 CheckoutSkill
   预期：创建订单，清空购物车
   ```

4. **支付**
   ```
   用户（语音）："支付"
   → 语音转文字："支付"
   → 执行 PaymentSkill
   预期：创建支付，完成流程
   ```

**验证点**：
- ✅ 搜索结果保存到 Memory
- ✅ "第一个"可以正确识别
- ✅ 流程状态正确跟踪
- ✅ 订单和支付正确创建

---

### 场景2：上下文引用（支持语音）

**测试步骤**：

**文本输入**：
1. **搜索商品**
   ```
   用户："搜索手机"
   预期：返回手机列表
   ```

2. **引用搜索结果**
   ```
   用户："第二个加入购物车"
   预期：从 Memory 获取第二个手机，加入购物车
   ```

3. **再次引用**
   ```
   用户："第一个也加入购物车"
   预期：从 Memory 获取第一个手机，加入购物车
   ```

**语音输入** 🎤：
1. **搜索商品**
   ```
   用户（语音）："搜索手机"
   → 语音转文字："搜索手机"
   预期：返回手机列表，保存到 Memory
   ```

2. **引用搜索结果**
   ```
   用户（语音）："第二个加入购物车"
   → 语音转文字："第二个加入购物车"
   → Runtime 从 Memory 获取第二个商品
   预期：从 Memory 获取第二个手机，加入购物车
   ```

3. **再次引用**
   ```
   用户（语音）："第一个也加入购物车"
   → 语音转文字："第一个也加入购物车"
   → Runtime 从 Memory 获取第一个商品
   预期：从 Memory 获取第一个手机，加入购物车
   ```

**关键点**：
- ✅ 语音识别结果与文本输入处理流程完全相同
- ✅ Memory 系统支持语音输入的上下文引用
- ✅ "第一个"、"第二个"等引用在语音输入中同样有效

**验证点**：
- ✅ Memory 正确保存搜索结果
- ✅ 可以多次引用搜索结果
- ✅ 索引引用正确（"第一个"、"第二个"）

---

### 场景3：流程中断和恢复

**测试步骤**：

1. **启动流程**
   ```
   用户："我想买跑步鞋"
   预期：启动 Workflow，执行搜索步骤
   ```

2. **中断流程**
   ```
   用户："等等，我想先看看详情"
   预期：Workflow 暂停，可以查看详情
   ```

3. **恢复流程**
   ```
   用户："好的，加入购物车"
   预期：继续 Workflow，执行加购步骤
   ```

**验证点**：
- ✅ Workflow 状态正确保存
- ✅ 可以暂停和恢复流程
- ✅ 上下文不丢失

---

### 场景4：错误处理

**测试步骤**：

1. **搜索不存在的商品**
   ```
   用户："搜索不存在的商品xyz123"
   预期：返回"没有找到相关商品"
   ```

2. **加入不存在的商品**
   ```
   用户："第999个加入购物车"
   预期：返回"找不到第999个商品"
   ```

3. **结算空购物车**
   ```
   用户："结算"
   预期：返回"购物车是空的"
   ```

**验证点**：
- ✅ 错误信息清晰
- ✅ 不会崩溃
- ✅ 可以继续对话

---

## 🔍 调试方法

### 1. 查看 Memory

```sql
-- 查看会话的所有记忆
SELECT * FROM agent_memory 
WHERE session_id = 'your-session-id' 
ORDER BY created_at DESC;
```

### 2. 查看 Workflow 状态

```sql
-- 查看进行中的流程
SELECT * FROM agent_workflow 
WHERE session_id = 'your-session-id' 
AND status = 'active';
```

### 3. 查看日志

```bash
# 后端日志
cd backend
npm run start:dev

# 查看 Runtime 相关日志
# 搜索 "Runtime" 或 "Workflow" 关键字
```

---

## ✅ 测试检查清单

### 功能测试

**文本输入**：
- [ ] 商品搜索功能正常
- [ ] 加入购物车功能正常
- [ ] 结算功能正常
- [ ] 支付功能正常
- [ ] 上下文引用正常（"第一个"、"第二个"）
- [ ] 流程串联正常（搜索 → 加购 → 结算 → 支付）
- [ ] 流程状态跟踪正常
- [ ] 错误处理正常

**语音输入** 🎤：
- [ ] 语音识别功能正常（麦克风权限）
- [ ] 语音转文字准确
- [ ] 语音输入的商品搜索正常
- [ ] 语音输入的加入购物车正常
- [ ] 语音输入的上下文引用正常（"第一个"、"第二个"）
- [ ] 语音输入的流程串联正常
- [ ] 语音输出功能正常（Agent 回复自动播放）
- [ ] 语音输入的错误处理正常

### 性能测试

- [ ] Memory 搜索响应时间 < 100ms
- [ ] Workflow 执行响应时间 < 200ms
- [ ] 整体响应时间 < 500ms

### 兼容性测试

- [ ] 原有 P0 功能仍然可用
- [ ] 未登录用户可以使用
- [ ] 多轮对话正常

---

## 🎤 语音测试特别说明

### 语音输入测试

1. **启用语音输入**
   - 点击输入框旁的麦克风按钮
   - 允许浏览器访问麦克风权限
   - 开始说话，系统会自动识别

2. **语音识别准确性**
   - 使用清晰的普通话
   - 在安静的环境中测试
   - 避免背景噪音

3. **语音输出测试**
   - Agent 回复会自动转换为语音播放
   - 可以调节音量
   - 可以暂停/继续播放

### 语音测试的优势

- ✅ **更自然的交互**：语音比打字更快速
- ✅ **移动端友好**：在手机上使用更方便
- ✅ **无障碍支持**：帮助视障用户使用
- ✅ **完整功能支持**：所有 Runtime 功能都支持语音

### 语音测试的限制

- ⚠️ **浏览器要求**：需要 Chrome/Edge（支持 Web Speech API）
- ⚠️ **网络要求**：语音识别需要在线（使用云端服务）
- ⚠️ **环境要求**：需要安静的环境，避免噪音干扰
- ⚠️ **准确性**：语音识别可能不如直接输入文本准确

---

## 🐛 常见问题

### 问题1：语音识别不工作

**原因**：
- 浏览器不支持 Web Speech API
- 麦克风权限被拒绝
- 网络连接问题

**解决**：
- 使用 Chrome 或 Edge 浏览器
- 检查浏览器权限设置
- 确保网络连接正常

### 问题2：Memory 没有保存

**原因**：可能是 MemoryService 没有正确注入

**解决**：检查 `RuntimeModule` 是否正确导入到 `AgentModule`

### 问题2：Workflow 没有启动

**原因**：可能是意图识别不准确

**解决**：
- 检查意图识别逻辑
- 查看日志确认意图
- 尝试更明确的表达

### 问题3：Skills 执行失败

**原因**：可能是依赖服务没有注入

**解决**：
- 检查 `RuntimeModule` 的依赖
- 确认所有服务都已正确导入

---

## 📊 测试报告模板

### 测试结果

| 测试场景 | 状态 | 备注 |
|---------|------|------|
| 完整电商流程 | ⏳ | 待测试 |
| 上下文引用 | ⏳ | 待测试 |
| 流程中断和恢复 | ⏳ | 待测试 |
| 错误处理 | ⏳ | 待测试 |

### 性能指标

| 指标 | 目标 | 实际 | 状态 |
|------|------|------|------|
| Memory 搜索 | < 100ms | ⏳ | 待测试 |
| Workflow 执行 | < 200ms | ⏳ | 待测试 |
| 整体响应 | < 500ms | ⏳ | 待测试 |

---

## 🚀 开始测试

1. **运行数据库迁移**
2. **启动服务**
3. **按照测试场景逐一测试**
4. **记录测试结果**
5. **修复发现的问题**

---

**祝测试顺利！** 🎉

