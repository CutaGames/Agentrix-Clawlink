# PayMind 统一支付流程与时序图 - 最终版 V1.0

**版本**: 1.0  
**日期**: 2025年1月  
**设计理念**: 统一入口、智能路由、简化分佣、多链兼容、用户友好

---

## 📋 目录

1. [支付流程总览](#1-支付流程总览)
2. [完整支付时序图](#2-完整支付时序图)
3. [资金流与分佣](#3-资金流与分佣)
4. [智能路由决策](#4-智能路由决策)
5. [特殊场景处理](#5-特殊场景处理)

---

## 1. 支付流程总览

### 1.1 七阶段统一流程

```
┌─────────────────────────────────────────────────────────────┐
│              PayMind 统一支付流程（七阶段）                    │
└─────────────────────────────────────────────────────────────┘

阶段1: 支付请求与验证
  ↓
阶段2: 价格与税费计算
  ↓
阶段3: 智能路由选择
  ↓
阶段4: 支付执行
  ↓
阶段5: 分佣计算
  ↓
阶段6: 资金托管（可选）
  ↓
阶段7: 结算分派
```

### 1.2 流程阶段说明

| 阶段 | 功能 | 关键操作 | 输出 |
|------|------|---------|------|
| **阶段1: 支付请求与验证** | 接收支付请求，验证参数 | 创建支付记录、验证用户、获取产品信息 | 支付记录 |
| **阶段2: 价格与税费计算** | 计算产品价格和税费 | 获取国家价格、计算税费、计算通道费用 | 价格明细 |
| **阶段3: 智能路由选择** | 选择最优支付通道 | 评估通道、考虑KYC/QuickPay、推荐最优方式 | 路由决策 |
| **阶段4: 支付执行** | 执行实际支付 | 调用支付服务、处理支付结果 | 支付结果 |
| **阶段5: 分佣计算** | 计算所有分佣 | 计算Agent佣金、PayMind平台费、推广分成 | 分佣记录 |
| **阶段6: 资金托管** | 托管资金（如需要） | 创建Escrow、锁定资金 | 托管记录 |
| **阶段7: 结算分派** | 结算并分派资金 | 释放资金、转账给各方 | 结算结果 |

---

## 2. 完整支付时序图

### 2.1 通用支付时序图（完整版）

**说明**：此时序图展示了完整的七阶段支付流程，包括所有服务交互。

```
用户                前端UI              后端API              定价服务              税费服务              智能路由              支付服务              分佣服务              托管服务              结算服务
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │
 │──点击支付─────────>│                   │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │
 │                   │  [阶段1: 支付请求与验证]                │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │
 │                   │──processPayment───>│                    │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │  1. 创建支付记录   │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │  2. 验证用户信息   │                    │                    │                    │                    │                    │                    │
 │                   │                   │  3. 获取产品信息   │                    │                    │                    │                    │                    │                    │
 │                   │                   │  4. 生成Session ID │                    │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │
 │                   │  [阶段2: 价格与税费计算]                │                    │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │──getProductPrice──>│                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │                    │  1. 获取基础价格   │                    │                    │                    │                    │                    │                    │
 │                   │                   │                    │  2. 获取国家价格   │                    │                    │                    │                    │                    │
 │                   │                   │                    │  3. 获取区域价格   │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │                    │<─返回产品价格──────│                    │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │──calculateTax──────>│                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │  1. 获取税率       │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │  2. 计算税费       │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │<─返回税费计算──────│                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │
 │                   │  [阶段3: 智能路由选择]                  │                    │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │──getRouting────────>│                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │  路由决策逻辑：     │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │  1. 检查用户PM ID   │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │  2. 检查Agent设置   │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │  3. 检查KYC状态     │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │  4. 检查QuickPay授权│                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │  5. 评估可用通道    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │     - Stripe       │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │     - X402         │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │     - Wallet       │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │     - Aggregator   │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │  6. 计算通道费用    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │  7. 推荐最优通道    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │<─返回路由决策──────│                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │  RoutingDecision:  │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │  - recommendedMethod│                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │  - channels        │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │  - priceComparison │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │  - totalFeeRate    │                    │                    │                    │                    │                    │                    │
 │                   │                   │  - channelFee      │                    │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │
 │                   │<─返回路由建议─────│                    │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │
 │                   │──显示支付方式选择─>│                    │                    │                    │                    │                    │                    │                    │                    │
 │<─显示支付方式选择──│                   │                    │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │
 │──选择支付方式─────>│                   │                    │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │
 │                   │  [阶段4: 支付执行]│                    │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │
 │                   │──确认支付─────────>│                    │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │──executePayment───>│                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │  根据支付方式：     │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │  - Stripe: 调用Stripe API│        │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │  - X402: 创建支付会话│          │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │  - Wallet: 等待签名  │          │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │  - Aggregator: 调用聚合服务│    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │  - FiatToCrypto: 执行转换│      │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │<─支付结果───────────│                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │  [阶段5: 分佣计算] │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │──calculateAndRecordCommission>│        │                    │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │  1. 获取产品类型   │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │     - physical     │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │     - service      │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │     - nft/ft       │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │  2. 获取固定佣金率 │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │     - physical: 3% │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │     - service: 5%  │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │     - nft/ft: 2.5% │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │  3. 计算分佣金额   │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │     - 推荐Agent: 佣金率×30%│        │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │     - 执行Agent: 佣金率×70%│        │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │     - PayMind: 固定比例│          │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │──保存分佣记录─────>│                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │<─分佣计算完成──────│                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │  [阶段6: 资金托管（可选）]│            │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │──shouldUseEscrow───>│                    │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │  判断条件：         │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │  - 订单类型         │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │  - 商家设置         │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │  - 金额阈值         │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │<─需要托管──────────│                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │──createEscrow─────>│                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │  创建托管配置：     │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │  - 订单类型         │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │  - 结算类型         │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │  - 分成配置         │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │<─返回escrowId─────│                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │──fundEscrow───────>│                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │  状态更新：         │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │  - status: FUNDED   │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │<─资金已托管────────│                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │  [阶段7: 结算分派] │                    │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │──autoSettleByOrderType>│
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │  根据订单类型：     │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │  - NFT/虚拟: 即时   │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │  - 服务: 等待开始   │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │  - 商品: 等待确认   │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │──确认结算条件满足──>│                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │──executeSettlement>│                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │  1. 计算结算金额   │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │     - 商户收入      │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │     - Agent分佣    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │     - PayMind分佣 │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │  2. 执行资金分派   │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │     - 转账给商户   │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │     - 转账给Agent │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │     - 转账给PayMind│                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │<─结算完成──────────│                    │
 │                   │                   │                    │                    │                    │                    │                    │                    │                    │                    │
 │                   │<─支付成功─────────│                    │                    │                    │                    │                    │                    │                    │                    │                    │
 │<─显示支付成功──────│                   │                    │                    │                    │                    │                    │                    │                    │                    │
```

### 2.2 用户前端UI流程（6步）

```
用户操作流程：

步骤1: 支付入口
  - 显示订单信息（商品名称、价格、数量、商户）
  - 显示支付金额和通道费用说明
  - 显示总计
  - 自动加载智能路由

步骤2: 智能路由推荐
  - 显示推荐支付方式卡片（高亮）
  - 显示推荐理由
  - 显示价格对比
  - 提供"查看其他支付方式"按钮

步骤3: 支付方式选择
  - 显示所有可用支付方式
  - 每个方式显示详细信息（金额、速度、成功率、安全性）
  - 推荐标识
  - 选中状态高亮

步骤4: 支付信息确认
  - 显示商品信息
  - 显示支付方式
  - 显示费用明细（商品价格、税费、通道费用、佣金）
  - 显示协议确认复选框

步骤5: 支付处理
  - 显示加载动画
  - 显示处理进度（5个步骤）
  - 显示预计剩余时间

步骤6: 支付结果
  - 成功：显示订单信息、交易哈希
  - 失败：显示失败原因、建议操作
```

---

## 3. 资金流与分佣

### 3.1 资金流总览

```
用户支付: $1,000
  │
  ├─→ [阶段1: 平台接收]
  │   └─→ 接收金额: $1,000
  │
  ├─→ [阶段2: 通道费用扣除]（商户承担）
  │   ├─→ Stripe: $1,000 × 2.9% = $29
  │   ├─→ X402: $1,000 × 0.06% = $0.6
  │   └─→ Wallet: $1,000 × 0.1% = $1
  │
  ├─→ [阶段3: 固定佣金计算]（基于商户价格）
  │   ├─→ 推荐Agent: $1,000 × 佣金率 × 30%
  │   ├─→ 执行Agent: $1,000 × 佣金率 × 70%
  │   └─→ PayMind: $1,000 × 固定比例
  │
  ├─→ [阶段4: 商户实际收入]
  │   ├─→ Stripe通道: 预期收入 - $29
  │   ├─→ X402通道: 预期收入 - $0.6
  │   └─→ Wallet通道: 预期收入 - $1
  │
  └─→ [阶段5: 结算分派]
      ├─→ 即时结算 (NFT/虚拟资产)
      └─→ 延迟结算 (服务/商品)
```

### 3.2 固定佣金率（根据产品类型）

| 产品类型 | 总佣金率 | 推荐Agent | 执行Agent | PayMind |
|---------|---------|-----------|-----------|---------|
| **实体商品** | 3% | 0.9% | 2.1% | 0.5% |
| **服务类** | 5% | 1.5% | 3.5% | 1% |
| **链上资产** | 2.5% | 0.75% | 1.75% | 1% |

**说明**：
- 佣金基于商户价格计算（固定）
- 通道费用由商户承担（从商户收入扣除）
- 商户实际收入 = 预期收入 - 通道费用

---

## 4. 智能路由决策

### 4.1 路由决策树

```
支付请求
  │
  ├─→ [检查用户PM ID]
  │   └─→ 获取用户信息、授权状态、KYC状态
  │
  ├─→ [检查Agent设置]
  │   └─→ 推荐Agent ID、执行Agent ID
  │
  ├─→ [检查KYC状态]
  │   ├─→ 已认证：可使用所有支付方式
  │   └─→ 未认证：引导完成KYC（法币转数字货币需要）
  │
  ├─→ [检查QuickPay授权]
  │   ├─→ 已授权：优先使用QuickPay
  │   └─→ 未授权：引导授权或使用其他方式
  │
  ├─→ [评估可用通道]
  │   ├─→ Stripe（法币支付）
  │   ├─→ X402（数字货币，压缩交易）
  │   ├─→ Wallet（数字货币，直接转账）
  │   ├─→ Aggregator（聚合服务商）
  │   └─→ FiatToCrypto（法币转数字货币）
  │
  ├─→ [计算通道费用]
  │   └─→ 比较各通道成本
  │
  └─→ [推荐最优通道]
      └─→ 返回推荐支付方式
```

### 4.2 路由优先级

1. **用户PM ID** - 获取用户完整信息
2. **Agent设置** - 考虑推荐Agent和执行Agent
3. **KYC状态** - 决定可用支付方式
4. **QuickPay授权** - 优先使用已授权方式
5. **通道评估** - 成本、速度、成功率
6. **推荐最优** - 综合评估后推荐

---

## 5. 特殊场景处理

### 5.1 KYC未完成场景

```
用户选择法币转数字货币
  ↓
检查KYC状态
  ↓
未完成KYC
  ↓
显示KYC引导
  ↓
用户完成KYC
  ↓
继续支付流程
```

### 5.2 QuickPay未授权场景

```
用户选择QuickPay
  ↓
检查授权状态
  ↓
未授权
  ↓
显示授权引导
  ↓
用户同意授权
  ↓
创建QuickPay授权
  ↓
继续支付流程
```

### 5.3 需要托管场景

```
支付完成
  ↓
检测订单类型
  ↓
需要托管（实物商品/服务）
  ↓
创建Escrow托管
  ↓
锁定资金
  ↓
等待结算条件满足
  ↓
释放资金并分派
```

---

## 6. 关键设计要点

### 6.1 三层ID体系

- **User ID (PayMind ID)**: 用户唯一标识
- **Agent ID (ERC 8004)**: Agent唯一标识，支持多链
- **Session ID**: 支付会话唯一标识，用于追责

### 6.2 固定佣金模式

- 佣金基于商户价格计算（固定）
- 不同产品类型有不同佣金率
- 通道费用由商户承担

### 6.3 智能路由优化

- 优先考虑用户PM ID和Agent设置
- 考虑KYC状态和QuickPay授权
- 综合评估通道成本、速度、成功率

### 6.4 用户友好设计

- 6步UI流程，清晰明了
- 价格透明，费用说明清楚
- 智能推荐，减少用户选择负担

---

**此统一支付流程和时序图确保了PayMind支付系统的完整性、一致性和用户友好性。**

