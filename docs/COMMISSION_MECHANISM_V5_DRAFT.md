# Agentrix 分账/分佣推广机制 V5.0 设计稿

**版本**: 5.0 Final  
**日期**: 2026年1月16日  
**状态**: ✅ 已确认

---

## 一、原有机制回顾

### 1.1 原有费率配置 (financial-architecture.config.ts)

| 资产类型 | 平台费(baseRate) | 激励池(poolRate) | 总抽佣 |
|----------|------------------|------------------|--------|
| PHYSICAL (实物商品) | 0.5% | 2.5% | 3.0% |
| SERVICE (服务类) | 1.0% | 4.0% | 5.0% |
| VIRTUAL (虚拟资产) | 0.5% | 2.5% | 3.0% |
| NFT_RWA | 0.5% | 2.0% | 2.5% |
| DEV_TOOL (开发者工具/插件) | 5.0% | 15.0% | 20.0% |
| SUBSCRIPTION (订阅) | 0.5% | 2.5% | 3.0% |

### 1.2 原有 Agent 分佣机制

```typescript
// 推广Agent: 平台费的 20%
PROMOTER_SHARE_OF_BASE = 0.2;

// 当前简化逻辑 (commission-calculator.service.ts 414-432行):
// - 优先给推荐Agent (referrer) 全部激励池
// - 没有推荐Agent则给执行Agent (executor) 全部激励池
// - 都没有则进入平台基金池
// - 执行Agent无钱包时，其份额进入 rebate pool
```

### 1.3 原有设计意图 (您提到的)

```
推广Agent: 平台费的 20%
执行Agent : 推荐Agent = 7 : 3 (激励池分配)
缺席方的佣金 → Treasury (用于补贴用户活动等)
```

---

## 二、新旧方案对比分析

### 2.1 Agent 分佣方案对比

| 维度 | 原有设计 (7:3) | 我之前提的方案 (20/50/30) |
|------|----------------|---------------------------|
| **推广Agent** | 平台费 × 20% | 激励池 × 20% |
| **推荐Agent** | 激励池 × 30% | 激励池 × 50% |
| **执行Agent** | 激励池 × 70% | 激励池 × 30% |
| **缺席处理** | → Treasury | → 重新分配给在场Agent |

### 2.2 优劣分析

**原有设计 (7:3) 优势:**
- ✅ 执行Agent激励更高，鼓励Agent主动帮用户完成交易
- ✅ 缺席佣金进Treasury，可用于平台运营和用户补贴
- ✅ 推广从平台费出，不影响激励池分配
- ✅ 逻辑简单清晰

**原有设计 (7:3) 劣势:**
- ❌ 推荐Agent激励较低，可能影响推荐积极性

**我之前提的方案 (20/50/30) 优势:**
- ✅ 推荐Agent激励更高，鼓励商品发现和推荐
- ✅ 三方都参与时分配更均衡

**我之前提的方案 (20/50/30) 劣势:**
- ❌ 执行Agent激励降低
- ❌ 推广从激励池出，减少了执行/推荐的份额
- ❌ 缺席时重分配逻辑复杂

### 2.3 建议方案

**保留原有设计 (7:3)**，理由：
1. 执行Agent是完成交易的关键，应该有更高激励
2. 推广从平台费出更合理，不占用激励池
3. 缺席佣金进Treasury可用于平台运营
4. 逻辑简单，合约实现更清晰

---

## 三、修订后的费率配置

### 3.1 按 Skill Layer 分类 (根据您的反馈修订)

| Layer | 说明 | 平台费 | 激励池 | 总抽佣 | 商户收入 |
|-------|------|--------|--------|--------|----------|
| **INFRA** | 基础设施层（支付、钱包、身份） | 0.5% | 2.0% | 2.5% | 97.5% |
| **RESOURCE** | 资源层（商品、服务、数字资产） | 0.5% | 2.5% | 3.0% | 97.0% |
| **LOGIC** | 逻辑层（算法、分析、工具） | 1.0% | 4.0% | 5.0% | 95.0% |
| **COMPOSITE** | 组合层（插件、工作流） | **3.0%** | **7.0%** | **10.0%** | 90.0% |

> **修订说明:**
> - COMPOSITE (插件) 提高到 10%，平台 3%，分佣 7%
> - LOGIC 统一按 1% + 4%，不再细分
> - RESOURCE 不再区分"数字资产"和"链上操作"

### 3.2 资产类型映射

| 资产类型 | 对应 Layer | 平台费 | 激励池 |
|----------|------------|--------|--------|
| PHYSICAL | RESOURCE | 0.5% | 2.5% |
| SERVICE | RESOURCE | 0.5% | 2.5% |
| VIRTUAL | RESOURCE | 0.5% | 2.5% |
| NFT_RWA | RESOURCE | 0.5% | 2.5% |
| DEV_TOOL / 插件 | **COMPOSITE** | **3.0%** | **7.0%** |
| SUBSCRIPTION | RESOURCE | 0.5% | 2.5% |
| AGGREGATED_WEB2 | 特殊 | 上游佣金 × 20% | 上游佣金 × 80% |
| AGGREGATED_WEB3 | 特殊 | swap费 × 30% | swap费 × 70% |

---

## 四、商品来源与分佣规则 (根据您的反馈修订)

### 4.1 来源分类

| 来源 | 说明 | 分佣规则 |
|------|------|----------|
| **NATIVE** | 用户/商户上传 | 标准分佣，商户承担 |
| **IMPORTED** | 外部导入 (MCP/OpenAPI) | 标准分佣，商户承担 |
| **CONVERTED** | 商品转换 | 标准分佣，商户承担 |
| **SCANNED_UCP** | 平台扫描 UCP | 用户额外承担 1% |
| **SCANNED_X402** | 平台扫描 X402 | 用户额外承担 1% |
| **SCANNED_FT** | 扫描的 FT 资产 | 用户额外承担 **0.3%** |
| **SCANNED_NFT** | 扫描的 NFT 资产 | 用户额外承担 **0.3%** |

### 4.2 扫描商品分佣逻辑 (修订)

```
扫描商品分佣公式:
- 商户收入 = 原价 × 100% (不受影响)
- 用户额外支付 = 原价 × 1% (作为平台费用)
- 平台收入 = 用户额外支付的 1%
- Agent推荐 = 平台收入的 20% (从平台佣金里出)

示例1: 用户通过Agent购买扫描的UCP商品 $100
- 用户实际支付: $101
- 商户收到: $100
- 平台收入: $1
- 推荐Agent: $0.2 (平台收入的20%)
- 平台净收入: $0.8

示例2: 用户通过Agent购买扫描的NFT $100
- 用户实际支付: $100.30
- 商户收到: $100
- 平台收入: $0.30
- 推荐Agent: $0.06 (平台收入的20%)
- 平台净收入: $0.24
```

> **设计目的:** 让商户优先考虑从平台上传商品，以减少用户的额外 1% 费用

---

## 五、支付路径与分佣 (根据您的反馈修订)

### 5.1 支付路径费用

| 支付路径 | 是否分佣 | 通道费 | 费用承担方 | 结算方式 |
|----------|----------|--------|------------|----------|
| **X402 QuickPay** | ✅ 是 | **可配置** (默认0%) | 用户承担 | 链上自动分账 |
| **Wallet 直转** | ✅ 是 | 0% | - | 链上自动分账 |
| **AutoPay** | ✅ 是 | 0% | - | 链上自动分账 |
| **Provider 入金 (Transak)** | ✅ 是 | **动态** (Provider定) | **用户承担** | 链上自动分账 |
| **Stripe 法币直结** 🆕 | ✅ 是 | **2.9%** | **用户承担** | **批量结算 (T+3)** |

> **V5.1 更新 (2026-01-21):**
> - 新增 Stripe 法币直结支付通道
> - Stripe 处理费 (2.9%) 由用户承担
> - Stripe 支付采用批量结算，T+3 分账给商户/Agent

### 5.2 Stripe 分佣结算流程 🆕

```
Stripe 支付完成 (T+0)
    ↓
Stripe 资金到达平台账户 (T+2)
    ↓
平台记录分佣信息 (链下)
    ├── 商户应收 = 订单金额 - 平台费 - 激励池
    ├── 推广Agent → 平台费 × 20%
    └── 执行:推荐Agent → 激励池 × 7:3
    ↓
批量结算 (T+3)
    ├── 商户 → 银行转账 / Stripe Connect
    └── Agent → USDC 链上转账 (或法币)
```

**设计原则: 平台不垫资**
- Stripe 资金 T+2 到账后才执行分账
- 商户/Agent 提现周期设为 T+3+，确保资金已到位

---

## 六、Agent 分佣机制 (保留原有设计)

### 6.1 分佣主体

| 角色 | 说明 | 佣金来源 |
|------|------|----------|
| **Promoter** | 推广Agent (平台级推广) | 平台费的 20% |
| **Referrer** | 推荐Agent (引导用户发现商品) | 激励池的 30% |
| **Executor** | 执行Agent (帮助用户完成交易) | 激励池的 70% |

### 6.2 分配规则

```typescript
// 推广Agent: 从平台费中出
promoterPayout = platformFee * 0.2;
platformNetRevenue = platformFee - promoterPayout;

// 执行Agent 和 推荐Agent: 从激励池中出 (7:3)
if (hasReferrer && hasExecutor) {
  executorPayout = pool * 0.7;
  referrerPayout = pool * 0.3;
} else if (hasExecutor) {
  executorPayout = pool * 0.7;
  treasuryPayout = pool * 0.3; // 推荐缺席，30%进Treasury
} else if (hasReferrer) {
  referrerPayout = pool * 0.3;
  treasuryPayout = pool * 0.7; // 执行缺席，70%进Treasury
} else {
  treasuryPayout = pool; // 都缺席，全部进Treasury
}

// 执行Agent无钱包时
if (!executorHasWallet) {
  treasuryPayout += executorPayout;
  executorPayout = 0;
}
```

### 6.3 场景示例

**场景1: 完整链路 (推广+推荐+执行)**
```
订单金额: $100, 服务类 (平台1% + 激励池4%)
- 商户收入: $95
- 平台费: $1
  - 推广Agent: $0.2 (平台费的20%)
  - 平台净收入: $0.8
- 激励池: $4
  - 执行Agent: $2.8 (70%)
  - 推荐Agent: $1.2 (30%)
```

**场景2: 仅执行Agent**
```
订单金额: $100, 服务类
- 商户收入: $95
- 平台费: $1 → 平台净收入 $1 (无推广)
- 激励池: $4
  - 执行Agent: $2.8 (70%)
  - Treasury: $1.2 (30%, 推荐缺席)
```

**场景3: 无Agent**
```
订单金额: $100, 服务类
- 商户收入: $95
- 平台费: $1 → 平台净收入 $1
- 激励池: $4 → Treasury (全部)
```

---

## 七、已确认事项

### 7.1 费率确认 ✅

| 项目 | 确认值 | 状态 |
|------|--------|------|
| COMPOSITE (插件) 平台费 | 3% | ✅ 已确认 |
| COMPOSITE (插件) 激励池 | 7% | ✅ 已确认 |
| LOGIC 统一费率 | 1% + 4% | ✅ 已确认 |
| 扫描商品 UCP/X402 用户额外费用 | 1% | ✅ 已确认 |
| 扫描商品 FT/NFT 用户额外费用 | **0.3%** | ✅ 已确认 |

### 7.2 Agent 分佣确认 ✅

| 项目 | 确认值 | 状态 |
|------|--------|------|
| 推广Agent | 平台费的 20% | ✅ 已确认 |
| 执行Agent : 推荐Agent | 7 : 3 | ✅ 已确认 |
| 缺席佣金去向 | Treasury | ✅ 已确认 |

### 7.3 其他确认 ✅

| 项目 | 确认值 | 状态 |
|------|--------|------|
| X402 通道费 | 可配置，默认0%，后续可调整为0.3% | ✅ 已确认 |
| Provider 入金费用承担方 | 用户 | ✅ 已确认 |
| FT/NFT 扫描商品费率 | 0.3% (低于UCP/X402的1%) | ✅ 已确认 |
| **Stripe 处理费承担方** | **用户 (2.9%)** | ✅ 已确认 🆕 |
| **Stripe 结算周期** | **T+3 批量结算** | ✅ 已确认 🆕 |

---

## 八、实施进度

### 已完成 ✅

1. ✅ **费率和规则确认** - 2026-01-16
2. ✅ **更新 `financial-architecture.config.ts`**
   - COMPOSITE (插件) 费率: 3% + 7% = 10%
   - 新增 `EXECUTOR_SHARE_OF_POOL = 0.7` 和 `REFERRER_SHARE_OF_POOL = 0.3`
   - 新增扫描商品费率常量
   - 新增 X402 通道费可配置常量
3. ✅ **更新 `commission-calculator.service.ts`**
   - Agent 分佣逻辑改为 7:3 (执行:推荐)
   - 缺席方佣金进入 Treasury

### 待完成

4. ⏳ **更新合约** (待确认后执行)
   - Commission.sol: 添加扫描商品分佣逻辑
   - AutoPay.sol: 集成分佣功能
   - 添加 X402 通道费可配置功能
5. ⏳ **编写测试用例验证**
6. ⏳ **管理员界面添加 X402 通道费配置**
7. ⏳ **Stripe 法币通道集成** 🆕
   - 实现 StripeProviderService
   - 实现批量结算任务 (Cron Job)
   - 商户/Agent 提现功能

> 详见 [STRIPE_INTEGRATION_PLAN.md](../STRIPE_INTEGRATION_PLAN.md)

---

*文档由 Agentrix 技术团队编写*  
*最后更新: 2026-01-21*
