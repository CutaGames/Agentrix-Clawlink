# Agentrix 问题追踪 — 2026-02-25

## 问题清单

---

### 问题 1：AI 对话报错（Agent Chat / ClawLink 聊天）

**描述**：移动端点击 AI 对话，返回 500 / 404 错误，无法正常聊天。

**根因分析**：
- `app.module.ts` 未注册 `ClaudeIntegrationModule`，导致 `/api/claude/chat` 不存在（404）
- AWS Bedrock Bearer Token 已过期（403）
- Bedrock 旧模型 ID `anthropic.claude-haiku-4-5` 需要 on-demand 模式（不支持），需改用跨区域推理 Profile `us.` 前缀
- axios 默认 Accept 头含 `text/plain` 导致 Bedrock 400 拒绝请求

**已完成**：
- ✅ `ClaudeIntegrationModule` 注入 `AppModule`，路由 `/api/claude/chat` 注册成功
- ✅ `BedrockIntegrationService` 已注入 `ClaudeIntegrationService`，使用 `chatWithFunctions()` 多轮对话
- ✅ Bedrock Bearer Token 更新（新 token）
- ✅ `AWS_REGION=us-east-1` 修正
- ✅ 模型 ID 修正为 `us.anthropic.claude-haiku-4-5-20251001-v1:0`（跨区域推理 Profile）
- ✅ 显式添加 `Accept: 'application/json'` 头（避免 axios 默认混合 MIME）
- ✅ Gemini fallback 模型链修正

**当前状态**：**✅ 已验证工作** — `POST /api/claude/chat → {"text":"# Hi there, how are you today?","toolCalls":null}`

---

### 问题 2：Task Market 标签页 Banner 太大（占空间）

**描述**：X402 banner、佣金 banner、gameplay banner 三个静态大图，占据屏幕大量空间。

**已完成**：
- ✅ 已替换为 3 张自动轮播紧凑 carousel（~62px 高，3.6s 自动切换）
- ✅ 移除 `viralBanner`、`gameplayBanner`

**当前状态**：**✅ 已修复** — build48/49 已推送并确认生效。

---

### 问题 3：Resources & Goods 页面为空

**描述**：移动端 Resources 标签页内容为空，无法显示资源/商品列表。

**根因分析**：
- `ClawMarketplaceScreen.tsx` 的 `SkillsTab` 调用 `/skills` API 失败后 `catch` 直接返回 `[]`
- `isResource=true` 时过滤 `price > 0`，如果列表为空则永远"No paid resources found"

**已完成**：
- ✅ 拆分为独立的 `ResourcesTab` 组件，增加 6 条 mock fallback（付费 API 品类）
- ✅ API 成功时自动切换为真实数据，只有 API 返回空/失败才显示 mock 数据
- ✅ 已 git commit 并推送（commit `3e7a750`）

**当前状态**：**✅ 已修复（mock fallback 已验证正确，TypeScript 无报错）**

---

### 问题 4：OpenClaw Skills 页面显示不正确（非真实 5200+ 技能）

**描述**：Market → OpenClaw Skills 标签页应显示 Hub 真实技能，但之前调用 `/skills` 后端 API 返回空。

**根因分析**：
- `SkillsTab` 调用的是 `/skills` 后端 API，不是 OpenClaw Hub 服务
- 后端搜索 Singapore 服务器（18.139.157.116）的 OpenClaw Hub API 全部超时

**已完成**：
- ✅ 拆分为独立的 `OpenClawSkillsTab` 组件，调用 `searchOpenClawHub()` 服务（前端直接请求 Hub）
- ✅ Hub 无法访问时显示 6 条 mock skill fallback（真实品类展示）
- ✅ Hub 有返回结果时优先展示真实 5200+ 技能
- ✅ 已 git commit 并推送（commit `3e7a750`）

**当前状态**：**✅ 已修复（UI 有内容，Hub 数据实时加载）**

---

### 问题 5：东京服务器 HQ 容器仍在运行

**描述**：`agentrix-hq`、`agentrix-hq-pilot`、`agentrix-hq-console` 三个容器运行中，占用资源。

**已完成**：
- ✅ 三个 HQ 容器全部删除

**当前状态**：**✅ 已修复** — 东京服务器剩余 5 个容器：`backend / postgres / frontend / nginx / redis`

---

### 问题 6：AWS_REGION 配置错误

**描述**：`.env` 中 `AWS_REGION=ap-southeast-1` 但 Claude Haiku 4.5 只在 `us-east-1` 可用。

**已完成**：
- ✅ `AWS_REGION=us-east-1` 已更新

**当前状态**：**✅ 已修复**

---

### 问题 7：Gemini 模型全部失效

**描述**：Gemini fallback 链中的模型名称 `gemini-2.0-flash-exp` 等全部 404。

**已完成**：
- ✅ 后端 `gemini-integration.service.ts` fallback 链改为 `gemini-1.5-flash` → `gemini-1.5-flash-8b`

**当前状态**：**✅ 已修复**

---

## 服务器状态总览

### 东京服务器（57.182.89.146）
| 容器 | 状态 | 备注 |
|------|------|------|
| agentrix-backend | ✅ healthy | 已重建，Bedrock 正常响应 |
| agentrix-postgres | ✅ running | 正常 |
| agentrix-frontend | ✅ healthy | 35h+ 在线 |
| agentrix-nginx | ✅ running | 443/80/8080 |
| agentrix-redis | ✅ running | 正常 |
| agentrix-hq 系列 | ❌ 已删除 | 3 个 HQ 容器全部删除 |

### AI Chat 路径（当前）
```
Mobile → realtime.service.ts
  → POST /api/claude/chat
  → ClaudeIntegrationService.chatWithFunctions()
    → no Anthropic API Key → BedrockIntegrationService.chatWithFunctions()
      → us.anthropic.claude-haiku-4-5-20251001-v1:0 (us-east-1)
      → 返回 { text, toolCalls }
```

### 移动端已修复（build50 → 提交 3e7a750）
- `ClawMarketplaceScreen.tsx` — OpenClaw Skills 用 Hub API + mock fallback
- `ClawMarketplaceScreen.tsx` — Resources & Goods 有付费资源 mock

---

## 待验证（下次推送 build51 APK 后）

- [ ] 移动端 AI 聊天实际出文字（Bedrock → claude-haiku-4-5）
- [ ] Resources & Goods 标签有 6 条资源显示
- [ ] OpenClaw Skills 标签有 6 条（或更多 Hub 真实）技能显示
- [ ] Task Market banner carousel 正常轮播


### 问题 6：AWS_REGION 配置错误（影响 Bedrock）

**描述**：`.env` 中 `AWS_REGION=ap-southeast-1` 但 Bedrock 需要 `us-east-1`（Claude Haiku 4.5 在 us-east-1）。

**已完成**：
- ✅ 已改回 `AWS_REGION=us-east-1`（本次操作）

---

### 问题 7：Gemini 模型全部失效

**描述**：`/api/gemini/chat` 调用失败 500，原因是 fallback 链里的模型名称已废弃。

**已完成**：
- ✅ 后端 `gemini-integration.service.ts` 的 fallback 链已修正，移除废弃模型名

**当前状态**：`gemini-1.5-flash` 可用（API 配额有限），`gemini-1.5-flash-8b` 备用。

---

## 云服务用户容量评估（新加坡服务器）

### 当前配置（Singapore 18.139.157.116）
- **OpenClaw gateway**：单进程 PM2，端口 18789（WebSocket）
- **未知 EC2 规格**：需确认实例类型

### 每用户资源需求（试用期方案）
| 项目 | 配置 |
|------|------|
| 存储 | 10 GB |
| AI 模型 | Claude Haiku 4.5 |
| Token 配额 | 100 万 tokens/用户 |
| Bedrock 费用 | ~$0.25/百万 input + $1.25/百万 output |

### 并发用户估算
- Haiku 4.5 API 是无状态调用，不占服务器 GPU/显存，并发上限取决于 **AWS Bedrock 账户 TPM/RPM 限制**
- 默认 Claude Haiku 4.5 限额：~50,000 TPM（tokens per minute），~500 RPM
- 存储：10G × N 用户 = 需要 EBS 或 S3 存储策略

### 升级建议
如需支撑更多用户，需要：
1. **AWS Bedrock 提升配额**：在 AWS Console → Bedrock → Service Quotas 申请提高 TPM/RPM
2. **S3 存储**：用 S3 替代本地 10G 磁盘，成本更低
3. **EC2 扩容**：若并发 WebSocket 连接多，需升级到 c5.xlarge 以上
