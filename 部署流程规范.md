# 部署流程规范

## 📋 核心原则

### 1. **Git 是唯一数据源**
- ✅ **所有代码修改必须在本地完成**
- ✅ **所有代码必须提交到 Git**
- ✅ **服务器只从 Git 拉取代码**
- ❌ **禁止直接在服务器上修改代码**

### 2. **单向流程**
```
本地开发 → Git 提交 → Git 推送 → 服务器拉取
```

### 3. **禁止双向同步**
- ❌ **不要从服务器同步代码到本地**
- ❌ **不要在服务器上直接修改代码**
- ✅ **所有修改都在本地完成，然后推送到 Git**

---

## 🚀 标准部署流程

### ⚠️ 首次推送（如果远程仓库是空的）

如果远程仓库（GitHub）是空的，需要先进行首次推送：

```bash
# 1. 确保所有更改已提交
git add .
git commit -m "feat: 初始提交 - 包含 GPTs 和 Provider 支付功能"

# 2. 首次推送到远程（设置上游分支）
git push -u origin main

# 3. 验证推送成功
git log --oneline -5
```

**注意**：首次推送可能需要较长时间，因为要上传所有代码。

---

### 步骤 1: 本地开发
```bash
# 1. 在本地进行代码修改
# 2. 测试功能是否正常
npm run start:dev  # 后端
npm run dev        # 前端
```

### 步骤 2: 提交到 Git
```bash
# 1. 检查修改的文件
git status

# 2. 添加修改的文件
git add .

# 3. 提交（使用清晰的提交信息）
git commit -m "feat: 更新 GPTs OpenAPI Schema 到 1.0.2"

# 4. 推送到远程仓库
git push origin main
```

### 步骤 3: 部署到服务器
```bash
# 使用推荐的部署脚本（从 Git 部署）
./deploy-from-git.sh
```

---

## 📝 详细操作指南

### 场景 1: 日常功能开发

#### 1.1 开始开发
```bash
# 确保本地代码是最新的
git pull origin main

# 创建功能分支（可选，推荐）
git checkout -b feature/gpts-schema-update

# 进行开发...
```

#### 1.2 完成开发后
```bash
# 1. 检查修改
git status
git diff

# 2. 提交
git add .
git commit -m "feat: 描述你的修改"

# 3. 推送到远程
git push origin main
# 如果是分支，先合并到 main，再推送

# 4. 部署到服务器
./deploy-from-git.sh
```

### 场景 2: 紧急修复（Hotfix）

#### 2.1 快速修复流程
```bash
# 1. 本地修复
# 修改代码...

# 2. 快速提交
git add .
git commit -m "fix: 紧急修复 GPTs Schema 问题"
git push origin main

# 3. 立即部署
./deploy-from-git.sh
```

### 场景 3: 服务器出现问题需要回滚

#### 3.1 回滚到之前的版本
```bash
# 1. 查看提交历史
git log --oneline -10

# 2. 找到要回滚的版本（例如：abc1234）
# 3. 在服务器上执行（通过 SSH）
ssh root@129.226.152.88
cd /var/www/agentrix-website/backend
git checkout abc1234
npm run build
pm2 restart agentrix-backend

# 4. 本地也要同步（如果需要）
git checkout abc1234
```

---

## ⚠️ 禁止的操作

### ❌ 不要这样做：

1. **不要在服务器上直接修改代码**
   ```bash
   # ❌ 错误：直接在服务器上编辑
   ssh root@129.226.152.88
   vim /var/www/agentrix-website/backend/src/xxx.ts
   ```

2. **不要从服务器同步代码到本地**
   ```bash
   # ❌ 错误：从服务器拉取代码
   ./同步服务器代码到本地.sh
   ```

3. **不要跳过 Git 直接部署**
   ```bash
   # ❌ 错误：直接上传文件到服务器
   scp backend.tar.gz root@xxx:/tmp/
   ```

4. **不要在本地和服务器同时修改**
   - 这会导致冲突和文件丢失

---

## ✅ 正确的操作

### ✅ 应该这样做：

1. **所有修改在本地完成**
   ```bash
   # ✅ 正确：在本地修改
   code backend/src/modules/ai-integration/openai/openai-integration.controller.ts
   ```

2. **提交到 Git**
   ```bash
   # ✅ 正确：提交并推送
   git add .
   git commit -m "feat: 更新 GPTs Schema"
   git push origin main
   ```

3. **从 Git 部署到服务器**
   ```bash
   # ✅ 正确：使用 Git 部署脚本
   ./deploy-from-git.sh
   ```

---

## 🔧 部署脚本说明

### `deploy-from-git.sh` (推荐使用)
- ✅ 从 Git 拉取最新代码
- ✅ 自动备份服务器代码
- ✅ 自动构建和重启服务
- ✅ 安全可靠

### `deploy-to-server.sh` (不推荐)
- ⚠️ 直接上传文件，可能丢失 Git 历史
- ⚠️ 容易造成本地和服务器不一致

### `同步服务器代码到本地.sh` (禁止使用)
- ❌ 会导致代码混乱
- ❌ 可能覆盖本地修改
- ❌ 造成文件丢失

---

## 📊 工作流程对比

### ❌ 错误流程（导致混乱）
```
本地修改 → 直接上传服务器 → 服务器修改 → 同步回本地 → 冲突 → 文件丢失
```

### ✅ 正确流程（推荐）
```
本地修改 → Git 提交 → Git 推送 → 服务器从 Git 拉取 → 部署完成
```

---

## 🛡️ 安全检查清单

部署前检查：

- [ ] 本地代码已测试通过
- [ ] 所有修改已提交到 Git
- [ ] 代码已推送到远程仓库
- [ ] 没有未提交的更改（`git status` 显示 clean）
- [ ] 服务器有备份（部署脚本会自动备份）

---

## 🚨 遇到问题怎么办？

### 问题 1: 本地有未提交的更改
```bash
# 查看未提交的更改
git status

# 选项 A: 提交更改
git add .
git commit -m "feat: 你的修改"
git push origin main

# 选项 B: 暂存更改（稍后处理）
git stash
# 部署完成后
git stash pop
```

### 问题 2: 服务器代码和本地不一致
```bash
# 1. 确保本地代码已提交并推送
git add .
git commit -m "fix: 同步代码"
git push origin main

# 2. 强制服务器从 Git 拉取（会覆盖服务器上的修改）
ssh root@129.226.152.88
cd /var/www/agentrix-website/backend
git fetch origin
git reset --hard origin/main
npm run build
pm2 restart agentrix-backend
```

### 问题 3: 文件丢失
```bash
# 1. 检查 Git 历史
git log --all --full-history -- <file_path>

# 2. 恢复文件
git checkout <commit_hash> -- <file_path>

# 3. 提交恢复的文件
git add <file_path>
git commit -m "fix: 恢复丢失的文件"
git push origin main
```

---

## 📅 日常维护建议

### 每天开始工作前
```bash
# 拉取最新代码
git pull origin main
```

### 每天结束工作前
```bash
# 提交所有更改
git add .
git commit -m "chore: 今日工作完成"
git push origin main
```

### 部署前
```bash
# 1. 确保代码已提交
git status

# 2. 确保已推送
git push origin main

# 3. 部署
./deploy-from-git.sh
```

---

## 🎯 总结

**记住三个关键点：**

1. **所有修改在本地完成**
2. **所有代码提交到 Git**
3. **服务器只从 Git 拉取**

遵循这个流程，可以避免：
- ✅ 文件丢失
- ✅ 代码混乱
- ✅ 同步冲突
- ✅ 部署错误

---

## 📞 需要帮助？

如果遇到问题，请：
1. 检查 Git 状态：`git status`
2. 查看 Git 日志：`git log --oneline -10`
3. 检查服务器日志：`pm2 logs agentrix-backend`
4. 参考本文档的"遇到问题怎么办"部分

