import { useMemo, useState, useCallback, useEffect } from 'react';
import { AgentTemplate } from '../../../lib/api/agent-template.api';
import { useToast } from '../../../contexts/ToastContext';
import { agentTemplateApi } from '../../../lib/api/agent-template.api';
import { useRouter } from 'next/router';
import { useLocalization } from '../../../contexts/LocalizationContext';
import { WorkflowEditor, type WorkflowDefinition } from './WorkflowEditor';
import { AgentExportPanel } from './AgentExportPanel';
import { CapabilityAssembler, type AgentRole } from './CapabilityAssembler';
import { RuleTemplateSystem, type RuleTemplate } from './RuleTemplateSystem';

interface AgentGeneratorProps {
  selectedTemplate: AgentTemplate | null;
  onTemplateReset: () => void;
  isAuthenticated?: boolean;
}

const getSteps = (t: (msg: any) => string) => [
  { id: 'template', title: { zh: 'é€‰æ‹©æ¨¡æ¿', en: 'Choose Template' } },
  { id: 'config', title: { zh: 'é…ç½®èƒ½åŠ›', en: 'Configure Capabilities' } },
  { id: 'workflow', title: { zh: 'å·¥ä½œæµç¼–è¾‘', en: 'Workflow Editor' } },
  { id: 'auth', title: { zh: 'æˆæƒä¸æ”¯ä»˜', en: 'Authorization & Payment' } },
  { id: 'preview', title: { zh: 'é¢„è§ˆ & å‘å¸ƒ', en: 'Preview & Deploy' } },
];

export function AgentGenerator({
  selectedTemplate,
  onTemplateReset,
  isAuthenticated = false,
}: AgentGeneratorProps) {
  const router = useRouter();
  const { success, error } = useToast();
  const { t } = useLocalization();
  const steps = getSteps(t);
  const [currentStep, setCurrentStep] = useState(1);
  const [loading, setLoading] = useState(false);
  const [showCodePreview, setShowCodePreview] = useState(false);
  const [generatedCode, setGeneratedCode] = useState<string>('');
  const [workflow, setWorkflow] = useState<any>(null);
  const [useAdvancedWorkflow, setUseAdvancedWorkflow] = useState(false);
  const [selectedRules, setSelectedRules] = useState<RuleTemplate[]>([]);
  const [showRules, setShowRules] = useState(false);
  const [form, setForm] = useState({
    name: '',
    description: '',
    targetUsers: 'å…¨çƒç”¨æˆ·',
    tone: 'professional',
    agentType: 'user' as 'user' | 'merchant' | 'developer',
    capabilities: ['search', 'auto_pay'],
    quickPayLimit: 20,
    quickPayDaily: 200,
    payoutWallet: '',
    autoEarnEnabled: true,
    monitoringEnabled: true,
    publish: true,
  });
  const [createdAgentId, setCreatedAgentId] = useState<string | undefined>(undefined);

  // æ ¹æ®æ¨¡æ¿è‡ªåŠ¨è®¾ç½®Agentç±»å‹
  useEffect(() => {
    if (selectedTemplate) {
      const category = selectedTemplate.category?.toLowerCase() || '';
      if (category.includes('merchant') || category.includes('å•†æˆ·')) {
        setForm((prev) => ({ ...prev, agentType: 'merchant' }));
      } else if (category.includes('developer') || category.includes('å¼€å‘')) {
        setForm((prev) => ({ ...prev, agentType: 'developer' }));
      } else {
        setForm((prev) => ({ ...prev, agentType: 'user' }));
      }
    }
  }, [selectedTemplate]);

  const canContinue = useMemo(() => {
    if (!selectedTemplate) return false;
    if (currentStep === 1) {
      return form.name.trim().length > 0 && form.description.trim().length > 0;
    }
    if (currentStep === 2) {
      return form.payoutWallet.trim().length > 0;
    }
    if (currentStep === 3) {
      // å·¥ä½œæµæ­¥éª¤ï¼šå¯é€‰ï¼Œå…è®¸è·³è¿‡
      return true;
    }
    return true;
  }, [currentStep, form, selectedTemplate]);

  const handleToggleCapability = (capability: string) => {
    setForm((prev) => {
      const exists = prev.capabilities.includes(capability);
      return {
        ...prev,
        capabilities: exists
          ? prev.capabilities.filter((item) => item !== capability)
          : [...prev.capabilities, capability],
      };
    });
  };

  const proceedStep = () => {
    if (!canContinue) return;
    setCurrentStep((prev) => Math.min(prev + 1, steps.length));
  };

  const goBack = () => {
    setCurrentStep((prev) => Math.max(prev - 1, 1));
  };

  const generateCode = useCallback(() => {
    if (!selectedTemplate) return '';
    
    // æ ¹æ®Agentç±»å‹ç”Ÿæˆä¸åŒçš„ä»£ç 
    const agentType = form.agentType || 'user';
    let code = '';
    
    if (agentType === 'user') {
      code = `# ${form.name || 'My User Agent'}
# Generated by Agentrix Agent Builder - User Agent

import { AgentrixUserAgent } from '@agentrix/agent-sdk'

const agent = new AgentrixUserAgent({
  agentId: '${selectedTemplate.id}',
  apiKey: 'your-api-key',
  mode: 'user',
  capabilities: ${JSON.stringify(form.capabilities, null, 2)},
  settings: {
    quickPayLimit: ${form.quickPayLimit},
    quickPayDaily: ${form.quickPayDaily},
    autoEarnEnabled: ${form.autoEarnEnabled},
    features: {
      feeEstimation: true,
      riskAssessment: true,
      kycReuse: true,
      paymentMemory: true,
      subscriptions: true,
      budgetManagement: true,
      transactionClassification: true,
    }
  }
})

# å¯åŠ¨Agent
agent.start()

# User AgentåŠŸèƒ½ï¼š
# - è´¹ç”¨ä¼°ç®—å’Œé£é™©è¯„ä¼°
# - KYCçŠ¶æ€æŸ¥è¯¢å’Œå¤ç”¨
# - æ”¯ä»˜è®°å¿†å’Œåå¥½ç®¡ç†
# - è®¢é˜…è¯†åˆ«å’Œç®¡ç†
# - é¢„ç®—è®¾ç½®å’Œè·Ÿè¸ª
# - äº¤æ˜“åˆ†ç±»å’Œåˆ†æ`;
    } else if (agentType === 'merchant') {
      code = `# ${form.name || 'My Merchant Agent'}
# Generated by Agentrix Agent Builder - Merchant Agent

import { AgentrixMerchantAgent } from '@agentrix/agent-sdk'

const agent = new AgentrixMerchantAgent({
  agentId: '${selectedTemplate.id}',
  apiKey: 'your-api-key',
  mode: 'merchant',
  capabilities: ${JSON.stringify(form.capabilities, null, 2)},
  settings: {
    features: {
      webhookAutomation: true,
      autoFulfillment: true,
      multiChainAccounts: true,
      reconciliation: true,
      settlementRules: true,
    }
  }
})

# å¯åŠ¨Agent
agent.start()

# Merchant AgentåŠŸèƒ½ï¼š
# - Webhookè‡ªåŠ¨åŒ–é…ç½®
# - è‡ªåŠ¨å‘è´§å’Œå±¥çº¦
# - å¤šé“¾è´¦æˆ·ç®¡ç†
# - è‡ªåŠ¨å¯¹è´¦
# - ç»“ç®—è§„åˆ™é…ç½®`;
    } else {
      code = `# ${form.name || 'My Developer Agent'}
# Generated by Agentrix Agent Builder - Developer Agent

import { AgentrixDeveloperAgent } from '@agentrix/agent-sdk'

const agent = new AgentrixDeveloperAgent({
  agentId: '${selectedTemplate.id}',
  apiKey: 'your-api-key',
  mode: 'developer',
  capabilities: ${JSON.stringify(form.capabilities, null, 2)},
  settings: {
    features: {
      codeGeneration: true,
      apiDocumentation: true,
      sandboxTesting: true,
      sdkIntegration: true,
    }
  }
})

# å¯åŠ¨Agent
agent.start()

# Developer AgentåŠŸèƒ½ï¼š
# - API/SDKä»£ç ç”Ÿæˆ
# - æ–‡æ¡£æŸ¥è¯¢å’Œç¤ºä¾‹
# - æ²™ç®±æµ‹è¯•ç¯å¢ƒ
# - é›†æˆæ”¯æŒ`;
    }
    
    setGeneratedCode(code);
    return code;
  }, [selectedTemplate, form]);

  const handlePreview = () => {
    const code = generateCode();
    setShowCodePreview(true);
  };

  const handleDeploy = async () => {
    if (!isAuthenticated) {
      error(t({ zh: 'è¯·å…ˆç™»å½•åå†éƒ¨ç½² Agent', en: 'Please login before deploying Agent' }));
      return;
    }
    if (!selectedTemplate) {
      error(t({ zh: 'è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ¨¡æ¿', en: 'Please select a template first' }));
      return;
    }
    if (!form.name || !form.description) {
      error(t({ zh: 'è¯·å¡«å†™ Agent åç§°å’Œæè¿°', en: 'Please fill in Agent name and description' }));
      return;
    }
    setLoading(true);
    try {
      console.log('ğŸš€ å¼€å§‹éƒ¨ç½²Agentï¼Œæ¨¡æ¿ID:', selectedTemplate.id);
      console.log('ğŸ“‹ è¡¨å•æ•°æ®:', form);
      
      // å…ˆç”ŸæˆAgentå®ä¾‹
      const payload = {
        name: form.name,
        description: form.description,
        publish: true, // éƒ¨ç½²æ—¶è‡ªåŠ¨å‘å¸ƒ
        settings: {
          targetUsers: form.targetUsers,
          tone: form.tone,
          capabilities: form.capabilities,
          limits: {
            quickPay: {
              single: form.quickPayLimit,
              daily: form.quickPayDaily,
            },
          },
          payoutWallet: form.payoutWallet,
          autoEarnEnabled: form.autoEarnEnabled,
          monitoringEnabled: form.monitoringEnabled,
          workflow, // åŒ…å«å·¥ä½œæµå®šä¹‰
        },
      };
      
      console.log('ğŸ“¤ å‘é€è¯·æ±‚ï¼Œpayload:', JSON.stringify(payload, null, 2));
      
      // åˆ›å»ºAgentå®ä¾‹
      const instance = await agentTemplateApi.instantiateTemplate(selectedTemplate.id, payload);
      
      console.log('âœ… Agentå®ä¾‹åˆ›å»ºæˆåŠŸ:', instance);
      
      // ä¿å­˜åˆ›å»ºçš„Agent IDï¼Œç”¨äºå¯¼å‡ºåŠŸèƒ½
      const agentId = instance?.id || '';
      if (agentId) {
        setCreatedAgentId(agentId);
      }
      
      // å¦‚æœAgentåˆ›å»ºæˆåŠŸï¼Œæ›´æ–°çŠ¶æ€ä¸ºactiveï¼ˆéƒ¨ç½²ï¼‰
      if (instance && instance.id) {
        try {
          const { userAgentApi } = await import('../../../lib/api/user-agent.api');
          console.log('ğŸ”„ å°è¯•æ›´æ–°AgentçŠ¶æ€ä¸ºactive...');
          // æ³¨æ„ï¼štoggleStatuså¯èƒ½éœ€è¦ä¸åŒçš„å‚æ•°æ ¼å¼ï¼Œè¿™é‡Œå…ˆæ³¨é‡Šæ‰ï¼Œé¿å…é”™è¯¯
          // await userAgentApi.toggleStatus(instance.id, 'active');
          console.log('âœ… AgentçŠ¶æ€æ›´æ–°æˆåŠŸ');
        } catch (statusError) {
          console.warn('âš ï¸ æ›´æ–°AgentçŠ¶æ€å¤±è´¥ï¼Œä½†Agentå·²åˆ›å»º:', statusError);
        }
      }
      
      success(t({ zh: 'ğŸ‰ Agentå·²ç”Ÿæˆå¹¶éƒ¨ç½²æˆåŠŸï¼', en: 'ğŸ‰ Agent generated and deployed successfully!' }));
      
      // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯å¹¶è·³è½¬åˆ°Agentå·¥ä½œå°
      // ç¡®ä¿ instance.id å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è·³è½¬åˆ°å·¥ä½œå°é¦–é¡µ
      setTimeout(() => {
        if (agentId) {
          router.push(`/agent-enhanced?agentId=${agentId}`);
        } else {
          // å¦‚æœæ²¡æœ‰ agentIdï¼Œè·³è½¬åˆ°å·¥ä½œå°é¦–é¡µ
          router.push('/agent-enhanced');
        }
      }, 1000);
    } catch (err: any) {
      console.error('âŒ éƒ¨ç½²Agentå¤±è´¥:', err);
      console.error('é”™è¯¯è¯¦æƒ…:', {
        message: err.message,
        stack: err.stack,
        response: err.response?.data,
        status: err.response?.status,
      });
      
      // å¦‚æœæ˜¯æœªæˆæƒé”™è¯¯ï¼Œæç¤ºç™»å½•
      if (err.message?.includes('401') || err.message?.includes('Unauthorized') || err.response?.status === 401) {
        error(t({ zh: 'è¯·å…ˆç™»å½•åå†éƒ¨ç½² Agent', en: 'Please login before deploying Agent' }));
      } else if (err.response?.status === 404) {
        error(t({ zh: 'æ¨¡æ¿ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤', en: 'Template not found or deleted' }));
      } else if (err.response?.status === 400) {
        error(t({ zh: 'è¯·æ±‚å‚æ•°é”™è¯¯ï¼š' + (err.response?.data?.message || err.message), en: 'Invalid request: ' + (err.response?.data?.message || err.message) }));
      } else {
        error(err.response?.data?.message || err.message || t({ zh: 'éƒ¨ç½²å¤±è´¥ï¼Œè¯·ç¨åå†è¯•', en: 'Deployment failed, please try again' }));
      }
    } finally {
      setLoading(false);
    }
  };

  const handleSubmit = async () => {
    if (!isAuthenticated) {
      error(t({ zh: 'è¯·å…ˆç™»å½•åå†ç”Ÿæˆ Agent', en: 'Please login before generating Agent' }));
      return;
    }
    if (!selectedTemplate) {
      error(t({ zh: 'è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ¨¡æ¿', en: 'Please select a template first' }));
      return;
    }
    if (!form.name || !form.description) {
      error(t({ zh: 'è¯·å¡«å†™ Agent åç§°å’Œæè¿°', en: 'Please fill in Agent name and description' }));
      return;
    }
    setLoading(true);
    try {
      console.log('ğŸš€ å¼€å§‹ç”ŸæˆAgentï¼Œæ¨¡æ¿ID:', selectedTemplate.id);
      console.log('ğŸ“‹ è¡¨å•æ•°æ®:', form);
      
      const payload = {
        name: form.name,
        description: form.description,
        publish: form.publish,
        settings: {
          targetUsers: form.targetUsers,
          tone: form.tone,
          capabilities: form.capabilities,
          limits: {
            quickPay: {
              single: form.quickPayLimit,
              daily: form.quickPayDaily,
            },
          },
          payoutWallet: form.payoutWallet,
          autoEarnEnabled: form.autoEarnEnabled,
          monitoringEnabled: form.monitoringEnabled,
          workflow, // åŒ…å«å·¥ä½œæµå®šä¹‰
        },
      };
      
      console.log('ğŸ“¤ å‘é€è¯·æ±‚ï¼Œpayload:', JSON.stringify(payload, null, 2));
      
      const instance = await agentTemplateApi.instantiateTemplate(selectedTemplate.id, payload);
      
      console.log('âœ… Agentå®ä¾‹åˆ›å»ºæˆåŠŸ:', instance);
      
      success(t({ zh: 'ğŸ‰ Agentå·²ç”Ÿæˆå¹¶éƒ¨ç½²æˆåŠŸï¼æ­£åœ¨è·³è½¬åˆ°å·¥ä½œå°...', en: 'ğŸ‰ Agent generated and deployed successfully! Redirecting to workspace...' }));
      
      // æ˜¾ç¤ºæˆåŠŸæç¤ºå¹¶è·³è½¬åˆ°Agentå·¥ä½œå°
      if (instance && instance.id) {
        setTimeout(() => {
          router.push(`/agent-enhanced?agentId=${instance.id}`);
        }, 1500);
      }
    } catch (err: any) {
      console.error('âŒ ç”ŸæˆAgentå¤±è´¥:', err);
      console.error('é”™è¯¯è¯¦æƒ…:', {
        message: err.message,
        stack: err.stack,
        response: err.response?.data,
        status: err.response?.status,
      });
      
      // å¦‚æœæ˜¯æœªæˆæƒé”™è¯¯ï¼Œæç¤ºç™»å½•
      if (err.message?.includes('401') || err.message?.includes('Unauthorized') || err.response?.status === 401) {
        error(t({ zh: 'è¯·å…ˆç™»å½•åå†ç”Ÿæˆ Agent', en: 'Please login before generating Agent' }));
      } else if (err.response?.status === 404) {
        error(t({ zh: 'æ¨¡æ¿ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤', en: 'Template not found or deleted' }));
      } else if (err.response?.status === 400) {
        error(t({ zh: 'è¯·æ±‚å‚æ•°é”™è¯¯ï¼š' + (err.response?.data?.message || err.message), en: 'Invalid request: ' + (err.response?.data?.message || err.message) }));
      } else {
        error(err.response?.data?.message || err.message || t({ zh: 'ç”Ÿæˆ Agent å¤±è´¥ï¼Œè¯·ç¨åå†è¯•', en: 'Failed to generate Agent, please try again' }));
      }
    } finally {
      setLoading(false);
    }
  };

  if (!selectedTemplate) {
    return (
      <div className="text-center py-16 text-gray-500">
        {t({ zh: 'è¯·å…ˆä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªæ¨¡æ¿å¼€å§‹', en: 'Please select a template from the left to start' })}
      </div>
    );
  }

  return (
    <div className="bg-white rounded-3xl shadow-xl border border-gray-100 p-8 space-y-8">
      {/* Step Indicator */}
      <div className="flex items-center justify-between">
        {steps.map((step, index) => (
          <div key={step.id} className="flex-1 flex items-center">
            <div
              className={`flex items-center justify-center w-10 h-10 rounded-full border-2 font-semibold ${
                currentStep >= index + 1
                  ? 'bg-blue-600 border-blue-600 text-white'
                  : 'border-gray-200 text-gray-400'
              }`}
            >
              {index + 1}
            </div>
            <div className="ml-3">
              <p className="text-xs text-gray-400 uppercase tracking-wide">{`Step ${index + 1}`}</p>
              <p className="text-sm font-semibold text-gray-800">{t(step.title)}</p>
            </div>
            {index < steps.length - 1 && (
              <div className="flex-1 h-px bg-gradient-to-r from-gray-200 to-transparent mx-3" />
            )}
          </div>
        ))}
      </div>

      {/* Step content */}
      {currentStep === 1 && (
        <div className="space-y-6">
          <div className="flex items-start justify-between">
            <div>
              <p className="text-sm font-semibold text-gray-500 uppercase tracking-wide">
                æ¨¡æ¿å·²é€‰æ‹©
              </p>
              <h3 className="text-2xl font-bold text-gray-900">{selectedTemplate.name}</h3>
              <p className="text-gray-500 mt-2 max-w-2xl">{selectedTemplate.description}</p>
            </div>
            <button
              onClick={onTemplateReset}
              className="text-sm text-blue-600 hover:text-blue-700 font-semibold"
            >
              é‡æ–°é€‰æ‹©
            </button>
          </div>

          <div className="grid md:grid-cols-2 gap-6">
            <div>
              <label className="text-sm font-medium text-gray-700 mb-1 block">
                {t({ zh: 'Agent åç§°', en: 'Agent Name' })}
              </label>
              <input
                type="text"
                value={form.name}
                onChange={(e) => setForm((prev) => ({ ...prev, name: e.target.value }))}
                placeholder={t({ zh: 'ä¾‹å¦‚ï¼šAuto-Earn æ•è·è€…ã€å°äºŒ AIã€Launchpad åŠ©æ‰‹', en: 'e.g.: Auto-Earn Catcher, Assistant AI, Launchpad Helper' })}
                className="w-full rounded-xl border border-gray-200 px-4 py-3 text-gray-900 bg-white focus:border-blue-500 focus:ring-2 focus:ring-blue-100 placeholder:text-gray-400"
              />
            </div>
            <div>
              <label className="text-sm font-medium text-gray-700 mb-1 block">
                {t({ zh: 'é¢å‘äººç¾¤ / Persona', en: 'Target Users / Persona' })}
              </label>
              <input
                type="text"
                value={form.targetUsers}
                onChange={(e) => setForm((prev) => ({ ...prev, targetUsers: e.target.value }))}
                className="w-full rounded-xl border border-gray-200 px-4 py-3 text-gray-900 bg-white focus:border-blue-500 focus:ring-2 focus:ring-blue-100 placeholder:text-gray-400"
              />
            </div>
          </div>

          <div>
            <label className="text-sm font-medium text-gray-700 mb-1 block">{t({ zh: 'ä»‹ç» / ä»·å€¼ä¸»å¼ ', en: 'Description / Value Proposition' })}</label>
            <textarea
              rows={3}
              value={form.description}
              onChange={(e) => setForm((prev) => ({ ...prev, description: e.target.value }))}
              className="w-full rounded-2xl border border-gray-200 px-4 py-3 text-gray-900 bg-white focus:border-blue-500 focus:ring-2 focus:ring-blue-100 placeholder:text-gray-400"
            />
          </div>
        </div>
      )}

      {currentStep === 2 && (
        <div className="grid md:grid-cols-2 gap-8">
          <div>
            <h4 className="text-lg font-semibold text-gray-900 mb-3">æ ¸å¿ƒèƒ½åŠ›</h4>
            <div className="space-y-3">
              {[
                { id: 'search', label: 'AI èšåˆæœç´¢ / æ¯”ä»·' },
                { id: 'auto_pay', label: 'SmartPay / QuickPay' },
                { id: 'auto_task', label: 'è‡ªåŠ¨ä»»åŠ¡ / Auto-Earn' },
                { id: 'workflow', label: 'å¤šæ­¥éª¤ Workflow / Co-Routine' },
              ].map((cap) => (
                <label
                  key={cap.id}
                  className="flex items-center space-x-3 bg-gray-50 rounded-2xl px-4 py-3 cursor-pointer border border-transparent hover:border-gray-200"
                >
                  <input
                    type="checkbox"
                    checked={form.capabilities.includes(cap.id)}
                    onChange={() => handleToggleCapability(cap.id)}
                    className="w-4 h-4 text-blue-600 rounded"
                  />
                  <span className="text-sm font-medium text-gray-700">{t(cap.label)}</span>
                </label>
              ))}
            </div>
          </div>
          <div>
            <h4 className="text-lg font-semibold text-gray-900 mb-3">æ”¯ä»˜ & é™é¢</h4>
            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="text-sm text-gray-500">QuickPay å•ç¬”é˜ˆå€¼ (USDC)</label>
                <input
                  type="number"
                  min={1}
                  value={form.quickPayLimit}
                  onChange={(e) =>
                    setForm((prev) => ({ ...prev, quickPayLimit: Number(e.target.value) }))
                  }
                  className="w-full rounded-xl border border-gray-200 px-4 py-2 text-gray-900 bg-white focus:border-blue-500 focus:ring-2 focus:ring-blue-100 placeholder:text-gray-400"
                />
              </div>
              <div>
                <label className="text-sm text-gray-500">æ¯æ—¥é˜ˆå€¼ (USDC)</label>
                <input
                  type="number"
                  min={1}
                  value={form.quickPayDaily}
                  onChange={(e) =>
                    setForm((prev) => ({ ...prev, quickPayDaily: Number(e.target.value) }))
                  }
                  className="w-full rounded-xl border border-gray-200 px-4 py-2 text-gray-900 bg-white focus:border-blue-500 focus:ring-2 focus:ring-blue-100 placeholder:text-gray-400"
                />
              </div>
            </div>
            <div className="mt-4">
              <label className="text-sm text-gray-500">æ”¶ç›Šæ”¶æ¬¾åœ°å€ï¼ˆé’±åŒ…æˆ–æ³•å¸è´¦æˆ·ï¼‰</label>
              <input
                type="text"
                value={form.payoutWallet}
                onChange={(e) => setForm((prev) => ({ ...prev, payoutWallet: e.target.value }))}
                placeholder="0x / Solana åœ°å€ï¼Œæˆ– Stripe Account ID"
                className="w-full rounded-xl border border-gray-200 px-4 py-2 text-gray-900 bg-white focus:border-blue-500 focus:ring-2 focus:ring-blue-100 placeholder:text-gray-400"
              />
            </div>
            <div className="mt-4 flex items-center space-x-3">
              <label className="flex items-center space-x-2">
                <input
                  type="checkbox"
                  checked={form.autoEarnEnabled}
                  onChange={(e) =>
                    setForm((prev) => ({ ...prev, autoEarnEnabled: e.target.checked }))
                  }
                />
                <span className="text-sm text-gray-600">å¯ç”¨ Auto-Earn / ä»»åŠ¡è‡ªåŠ¨æ‰§è¡Œ</span>
              </label>
            </div>
          </div>
        </div>
      )}

      {currentStep === 3 && (
        <div className="space-y-6">
          <div className="flex items-center justify-between">
            <div>
              <h4 className="text-lg font-semibold text-gray-900 mb-2">
                {t({ zh: 'èƒ½åŠ›è£…é…', en: 'Capability Assembly' })}
              </h4>
              <p className="text-sm text-gray-600">
                {t({ 
                  zh: 'é€šè¿‡å‹¾é€‰èƒ½åŠ›æ¨¡å—æ¥è£…é…æ‚¨çš„ Agentã€‚Core èƒ½åŠ›æ˜¯å¿…é€‰çš„ï¼ŒAdvanced èƒ½åŠ›æ˜¯å¯é€‰çš„å¢å¼ºåŠŸèƒ½ã€‚', 
                  en: 'Assemble your Agent by selecting capability modules. Core capabilities are required, Advanced are optional.' 
                })}
              </p>
            </div>
            <button
              onClick={() => setUseAdvancedWorkflow(!useAdvancedWorkflow)}
              className="text-sm text-blue-600 hover:text-blue-700 font-medium"
            >
              {useAdvancedWorkflow 
                ? t({ zh: 'åˆ‡æ¢åˆ°è¡¨å•æ¨¡å¼', en: 'Switch to Form Mode' })
                : t({ zh: 'åˆ‡æ¢åˆ°é«˜çº§å·¥ä½œæµç¼–è¾‘å™¨', en: 'Switch to Advanced Workflow Editor' })
              }
            </button>
          </div>

          {!useAdvancedWorkflow ? (
            // è¡¨å•å¼èƒ½åŠ›è£…é…ï¼ˆé»˜è®¤æ¨¡å¼ï¼‰
            <div className="border border-gray-200 rounded-2xl p-6 bg-white">
              <CapabilityAssembler
                role={form.agentType}
                selectedCapabilities={form.capabilities}
                onCapabilitiesChange={(capabilities) => {
                  setForm((prev) => ({ ...prev, capabilities }));
                }}
              />
            </div>
          ) : (
            // é«˜çº§å·¥ä½œæµç¼–è¾‘å™¨ï¼ˆé«˜çº§æ¨¡å¼ï¼‰
            <div className="h-[600px] border border-gray-200 rounded-2xl overflow-hidden">
              <div className="mb-4 p-4 bg-yellow-50 border-b border-yellow-200">
                <p className="text-sm text-yellow-800">
                  {t({ 
                    zh: 'ğŸ’¡ é«˜çº§æ¨¡å¼ï¼šé€šè¿‡æ‹–æ‹½èŠ‚ç‚¹æ¥æ„å»ºå¤æ‚çš„å·¥ä½œæµç¨‹ã€‚é€‚åˆéœ€è¦ç²¾ç»†æ§åˆ¶æµç¨‹çš„é«˜çº§ç”¨æˆ·ã€‚', 
                    en: 'ğŸ’¡ Advanced Mode: Build complex workflows by dragging nodes. Suitable for advanced users who need fine-grained control.' 
                  })}
                </p>
              </div>
              <div className="h-[calc(100%-80px)]">
                <WorkflowEditor
                  workflow={workflow}
                  capabilities={form.capabilities}
                  onWorkflowChange={(wf) => setWorkflow(wf)}
                  onSave={(wf) => {
                    setWorkflow(wf);
                    success(t({ zh: 'å·¥ä½œæµå·²ä¿å­˜', en: 'Workflow saved' }));
                  }}
                  onImportFromCapabilities={(caps) => {
                    // å°†èƒ½åŠ›åˆ—è¡¨è½¬æ¢ä¸ºå·¥ä½œæµ
                    const nodes = caps.map((cap, index) => ({
                      id: `cap_${cap}_${index}`,
                      type: 'action' as const,
                      position: { x: 100 + (index % 3) * 200, y: 100 + Math.floor(index / 3) * 150 },
                      data: { label: cap, config: { actionType: 'capability', capabilityId: cap } },
                    }));
                    const edges = nodes.slice(0, -1).map((node, index) => ({
                      id: `edge_${index}`,
                      source: node.id,
                      target: nodes[index + 1].id,
                      condition: 'success',
                    }));
                    return { version: '1.0', nodes, edges };
                  }}
                />
              </div>
            </div>
          )}
        </div>
      )}

      {currentStep === 4 && (
        <div className="grid md:grid-cols-2 gap-8">
          <div className="space-y-4">
            <h4 className="text-lg font-semibold text-gray-900 mb-2">æˆæƒé…ç½®</h4>
            <div className="bg-gray-50 rounded-2xl p-4 border border-gray-100">
              <p className="text-sm text-gray-600">
                Builder ä¼šä¸ºæ‚¨çš„ Agent è‡ªåŠ¨é…ç½®æ¥å…¥ Agentrix æ”¯ä»˜ã€æ•°æ®ã€ä»»åŠ¡æ‰§è¡Œæƒé™ã€‚è‹¥æ‚¨
                å·²é€šè¿‡ KYCï¼Œç³»ç»Ÿä¼šåŒæ­¥ QuickPay ç™½åå•ã€‚
              </p>
            </div>
            <label className="flex items-center space-x-3">
              <input
                type="checkbox"
                checked={form.monitoringEnabled}
                onChange={(e) =>
                  setForm((prev) => ({ ...prev, monitoringEnabled: e.target.checked }))
                }
              />
              <span className="text-sm text-gray-600">
                åŒæ­¥å¯ç”¨ Agent è¿è¡Œç›‘æ§ / æŠ¥è¡¨ï¼ˆæ¨èï¼‰
              </span>
            </label>
          </div>
          <div className="space-y-4">
            <h4 className="text-lg font-semibold text-gray-900 mb-2">å‘å¸ƒé€‰é¡¹</h4>
            <label className="flex items-center space-x-3">
              <input
                type="checkbox"
                checked={form.publish}
                onChange={(e) => setForm((prev) => ({ ...prev, publish: e.target.checked }))}
              />
              <span className="text-sm text-gray-600">ç”Ÿæˆåç«‹å³ä¸Šçº¿ï¼ˆå¯éšæ—¶æš‚åœï¼‰</span>
            </label>
            <p className="text-xs text-gray-400">
              å¦‚æœæš‚ä¸å‘å¸ƒï¼ŒAgent ä¼šä¿æŒè‰ç¨¿çŠ¶æ€ï¼Œå¯åœ¨â€œæˆ‘çš„ Agentâ€åˆ—è¡¨é‡Œç»§ç»­é…ç½®å’Œæ¥æ”¶æ¨å¹¿é“¾æ¥ã€‚
            </p>
          </div>
        </div>
      )}

      {currentStep === 4 && (
        <div className="space-y-6">
          <div className="bg-gray-50 rounded-3xl border border-gray-100 p-6 space-y-4">
            <h4 className="text-xl font-semibold text-gray-900">{t({ zh: 'ç”Ÿæˆæ‘˜è¦', en: 'Generation Summary' })}</h4>
            <ul className="space-y-3 text-sm text-gray-700">
              <li>
                <strong className="text-gray-900">{t({ zh: 'åç§°', en: 'Name' })}ï¼š</strong>
                {form.name}
              </li>
              <li>
                <strong className="text-gray-900">{t({ zh: 'æ¨¡æ¿', en: 'Template' })}ï¼š</strong>
                {selectedTemplate.name}
              </li>
              <li>
                <strong className="text-gray-900">{t({ zh: 'æ ¸å¿ƒèƒ½åŠ›', en: 'Core Capabilities' })}ï¼š</strong>
                {form.capabilities.join(' / ')}
              </li>
              <li>
                <strong className="text-gray-900">QuickPay {t({ zh: 'é™é¢', en: 'Limits' })}ï¼š</strong>
                {form.quickPayLimit} USDC / {t({ zh: 'å•ç¬”', en: 'Single' })} Â· {form.quickPayDaily} USDC / {t({ zh: 'æ—¥', en: 'Day' })}
              </li>
              <li>
                <strong className="text-gray-900">{t({ zh: 'æ”¶ç›Šè´¦æˆ·', en: 'Payout Wallet' })}ï¼š</strong>
                {form.payoutWallet}
              </li>
              <li>
                <strong className="text-gray-900">Auto-Earnï¼š</strong>
                {form.autoEarnEnabled ? t({ zh: 'å·²å¯ç”¨', en: 'Enabled' }) : t({ zh: 'å…³é—­', en: 'Disabled' })}
              </li>
            </ul>
          </div>

          {/* ä»£ç é¢„è§ˆ */}
          <div className="bg-slate-900 rounded-2xl border border-slate-700 p-6 space-y-4">
            <div className="flex items-center justify-between">
              <h4 className="text-lg font-semibold text-white">{t({ zh: 'ä»£ç é¢„è§ˆ', en: 'Code Preview' })}</h4>
              <div className="flex space-x-2">
                <button
                  onClick={() => {
                    const code = generateCode()
                    navigator.clipboard.writeText(code)
                    success(t({ zh: 'ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', en: 'Code copied to clipboard' }))
                  }}
                  className="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 transition-colors"
                >
                  {t({ zh: 'å¤åˆ¶ä»£ç ', en: 'Copy Code' })}
                </button>
                <button
                  onClick={() => {
                    const code = generateCode()
                    const blob = new Blob([code], { type: 'text/plain' })
                    const url = URL.createObjectURL(blob)
                    const a = document.createElement('a')
                    a.href = url
                    a.download = `${form.name || 'agent'}.py`
                    a.click()
                    URL.revokeObjectURL(url)
                    success(t({ zh: 'ä»£ç å·²ä¸‹è½½', en: 'Code downloaded' }))
                  }}
                  className="px-4 py-2 bg-green-600 text-white rounded-lg text-sm hover:bg-green-700 transition-colors"
                >
                  {t({ zh: 'ä¸‹è½½ä»£ç ', en: 'Download Code' })}
                </button>
              </div>
            </div>
            <div className="bg-slate-950 rounded-lg p-4 overflow-x-auto">
              <pre className="text-green-400 text-sm font-mono whitespace-pre-wrap">
                {generatedCode || generateCode()}
              </pre>
            </div>
          </div>

          {/* Agentå¯¼å‡ºåŠŸèƒ½ */}
          <div className="bg-white rounded-2xl border border-gray-200 p-6">
            <AgentExportPanel
              agentId={createdAgentId} // ä½¿ç”¨åˆ›å»ºçš„Agent ID
              agentName={form.name}
              agentType={form.agentType}
              workflow={workflow}
              form={form}
              onExport={(exportType, platform) => {
                console.log('å¯¼å‡ºAgent:', { exportType, platform });
                success(t({ zh: 'å¯¼å‡ºåŒ…å·²ç”Ÿæˆ', en: 'Export package generated' }));
              }}
            />
          </div>

          {/* éƒ¨ç½²é€‰é¡¹ */}
          <div className="bg-blue-50 rounded-2xl border border-blue-100 p-6 space-y-4">
            <h4 className="text-lg font-semibold text-gray-900">{t({ zh: 'éƒ¨ç½²é€‰é¡¹', en: 'Deployment Options' })}</h4>
            <div className="space-y-3">
              <div className="flex items-center space-x-3">
                <input
                  type="checkbox"
                  checked={form.publish}
                  onChange={(e) => setForm((prev) => ({ ...prev, publish: e.target.checked }))}
                  className="w-4 h-4 text-blue-600 rounded"
                />
                <span className="text-sm text-gray-700">
                  {t({ zh: 'ç”Ÿæˆåç«‹å³ä¸Šçº¿ï¼ˆå¯éšæ—¶æš‚åœï¼‰', en: 'Publish immediately after generation (can pause anytime)' })}
                </span>
              </div>
              <p className="text-xs text-gray-500">
                {t({
                  zh: 'å¦‚æœæš‚ä¸å‘å¸ƒï¼ŒAgentä¼šä¿æŒè‰ç¨¿çŠ¶æ€ï¼Œå¯åœ¨"æˆ‘çš„Agent"åˆ—è¡¨é‡Œç»§ç»­é…ç½®å’Œæ¥æ”¶æ¨å¹¿é“¾æ¥ã€‚',
                  en: 'If not published, Agent will remain in draft status and can be configured and receive promotion links in "My Agents" list.',
                })}
              </p>
            </div>
          </div>
        </div>
      )}

      {/* Actions */}
      <div className="flex items-center justify-between">
          <button
            onClick={goBack}
            disabled={currentStep === 1 || loading}
            className="px-4 py-2 rounded-xl text-sm font-semibold text-gray-600 hover:text-gray-900 disabled:opacity-40"
          >
            {t({ zh: 'ä¸Šä¸€æ­¥', en: 'Previous' })}
          </button>
          {currentStep < steps.length && (
            <button
              onClick={proceedStep}
              disabled={!canContinue || loading}
              className="px-6 py-3 rounded-2xl bg-blue-600 text-white text-sm font-semibold shadow-lg shadow-blue-200 disabled:opacity-50"
            >
              {t({ zh: 'ä¸‹ä¸€æ­¥', en: 'Next' })}
            </button>
          )}
          {currentStep === steps.length && (
            <div className="flex space-x-3">
              <button
                onClick={handleDeploy}
                disabled={loading}
                className="px-6 py-3 rounded-2xl bg-green-600 text-white text-sm font-semibold shadow-lg shadow-green-200 disabled:opacity-50 hover:bg-green-700 transition-colors"
              >
                {loading ? t({ zh: 'éƒ¨ç½²ä¸­...', en: 'Deploying...' }) : t({ zh: 'ä¸€é”®éƒ¨ç½²', en: 'Deploy Now' })}
              </button>
              <button
                onClick={handleSubmit}
                disabled={loading}
                className="px-6 py-3 rounded-2xl bg-gradient-to-r from-blue-600 to-indigo-600 text-white text-sm font-semibold shadow-lg shadow-blue-200 disabled:opacity-50"
              >
                {loading ? t({ zh: 'ç”Ÿæˆä¸­...', en: 'Generating...' }) : t({ zh: 'ä¸€é”®ç”Ÿæˆæˆ‘çš„ Agent', en: 'Generate My Agent' })}
              </button>
            </div>
          )}
      </div>
    </div>
  );
}

