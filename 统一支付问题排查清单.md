# 统一支付问题排查清单

## 🔍 快速诊断

### 在浏览器控制台执行

```javascript
// 1. 完整诊断（推荐）
PaymentDebug.fullDiagnosis()

// 2. 单独检查各项
PaymentDebug.checkApiConfig()           // API配置
PaymentDebug.checkAuth()                // 认证状态
PaymentDebug.testBackendConnection()    // 后端连接
PaymentDebug.testPaymentRouting(100, 'CNY')  // 支付路由
```

---

## 📋 常见问题及解决方案

### 问题1: "无法连接到服务器"

**症状**：
- 浏览器控制台显示网络错误
- 支付请求失败，提示连接失败

**可能原因**：
1. 后端服务未启动
2. API URL 配置错误
3. 端口被占用
4. CORS 配置问题

**解决方案**：

1. **检查后端服务**
   ```bash
   # 检查后端是否运行
   curl http://localhost:3001/health
   
   # 如果未运行，启动后端
   cd backend
   npm run start:dev
   ```

2. **检查API配置**
   - 打开浏览器控制台
   - 执行：`PaymentDebug.checkApiConfig()`
   - 确认 API URL 为 `http://localhost:3001/api`

3. **检查端口占用**
   ```bash
   # Windows
   netstat -ano | findstr :3001
   
   # Linux/Mac
   lsof -i :3001
   ```

4. **检查CORS配置**
   - 确认后端 `main.ts` 中 CORS 配置允许前端域名
   - 开发环境通常需要允许 `http://localhost:3000`

---

### 问题2: "未授权，请重新登录"

**症状**：
- 支付请求返回 401 错误
- 自动跳转到登录页

**可能原因**：
1. Token 不存在或过期
2. Token 格式错误
3. 后端认证中间件配置问题

**解决方案**：

1. **检查Token**
   ```javascript
   // 在浏览器控制台执行
   PaymentDebug.checkAuth()
   ```

2. **重新登录**
   - 清除 localStorage：`localStorage.clear()`
   - 重新登录获取新 Token

3. **检查Token格式**
   - Token 应该是 JWT 格式（三部分，用 `.` 分隔）
   - 检查 Token 是否过期

---

### 问题3: "支付处理失败"

**症状**：
- 支付请求发送成功，但处理失败
- 返回错误消息

**可能原因**：
1. 支付数据格式错误
2. 后端支付服务配置问题
3. 支付方式不支持
4. 余额不足（加密货币支付）

**解决方案**：

1. **检查支付数据**
   - 打开浏览器 Network 标签
   - 查看 `/payments/process` 请求
   - 检查请求体数据格式

2. **检查后端日志**
   - 查看后端控制台错误信息
   - 确认支付服务是否正常

3. **检查支付方式**
   - 确认选择的支付方式后端支持
   - 检查支付路由建议：`PaymentDebug.testPaymentRouting()`

---

### 问题4: "创建支付意图失败"

**症状**：
- Stripe 支付意图创建失败
- 返回 400 或 500 错误

**可能原因**：
1. Stripe API Key 未配置
2. 金额格式错误
3. 货币不支持

**解决方案**：

1. **检查Stripe配置**
   - 确认后端 `.env` 文件中有 Stripe API Key
   - 检查 Stripe Key 是否有效

2. **检查金额格式**
   - 金额应该是数字类型
   - 货币代码应该是 ISO 格式（如 'CNY', 'USD'）

3. **测试创建意图**
   ```javascript
   PaymentDebug.testCreateIntent(100, 'CNY')
   ```

---

### 问题5: "支付路由API失败"

**症状**：
- 获取支付路由建议失败
- 返回 401 或 500 错误

**可能原因**：
1. 未登录
2. 参数格式错误
3. 后端路由服务异常

**解决方案**：

1. **检查认证**
   ```javascript
   PaymentDebug.checkAuth()
   ```

2. **检查参数**
   - 金额应该是数字
   - 货币代码应该是字符串
   - 其他参数应该是正确的类型

3. **测试路由API**
   ```javascript
   PaymentDebug.testPaymentRouting(100, 'CNY')
   ```

---

### 问题6: "QuickPay Session 不存在"

**症状**：
- QuickPay 支付失败
- 提示 Session 不存在或过期

**可能原因**：
1. 未创建 Session
2. Session 已过期
3. Session 被撤销

**解决方案**：

1. **创建Session**
   - 使用 `paymentApi.createSession()` 创建新 Session
   - 确认 Session 创建成功

2. **检查Session状态**
   - 使用 `paymentApi.getActiveSession()` 获取活跃 Session
   - 确认 Session 未过期

---

## 🔧 系统检查清单

### 前端检查

- [ ] 前端服务运行在 `http://localhost:3000`
- [ ] API URL 配置为 `http://localhost:3001/api`
- [ ] PaymentProvider 已正确包裹应用
- [ ] 用户已登录，Token 有效
- [ ] 浏览器控制台无 JavaScript 错误

### 后端检查

- [ ] 后端服务运行在 `http://localhost:3001`
- [ ] 数据库连接正常
- [ ] JWT 认证配置正确
- [ ] CORS 配置允许前端域名
- [ ] 支付服务依赖正常（Stripe、X402等）

### 网络检查

- [ ] 前端可以访问后端健康检查端点
- [ ] 支付API端点可访问
- [ ] 无CORS错误
- [ ] 网络请求正常（查看Network标签）

---

## 📝 调试步骤

### 步骤1: 环境检查

```bash
# 检查后端
curl http://localhost:3001/health

# 检查前端
curl http://localhost:3000
```

### 步骤2: 认证检查

```javascript
// 浏览器控制台
PaymentDebug.checkAuth()
```

### 步骤3: API连接检查

```javascript
// 浏览器控制台
PaymentDebug.testBackendConnection()
```

### 步骤4: 支付功能检查

```javascript
// 浏览器控制台
PaymentDebug.testPaymentRouting(100, 'CNY')
PaymentDebug.testCreateIntent(100, 'CNY')
```

### 步骤5: 查看网络请求

1. 打开浏览器开发者工具（F12）
2. 切换到 Network 标签
3. 尝试发起支付
4. 查看请求详情：
   - 请求URL
   - 请求头（特别是 Authorization）
   - 请求体
   - 响应状态码
   - 响应体

---

## 🐛 常见错误代码

| 错误代码 | 含义 | 解决方案 |
|---------|------|---------|
| 401 | 未授权 | 重新登录 |
| 403 | 无权限 | 检查用户权限 |
| 404 | 端点不存在 | 检查API路径 |
| 500 | 服务器错误 | 查看后端日志 |
| NetworkError | 网络错误 | 检查后端服务是否启动 |

---

## 📞 获取帮助

如果以上方法都无法解决问题，请提供以下信息：

1. 浏览器控制台完整错误信息
2. Network 标签中的请求详情
3. 后端控制台日志
4. 执行 `PaymentDebug.fullDiagnosis()` 的输出

