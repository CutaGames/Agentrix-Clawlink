# Agentrix 开发注意事项与经验总结 (2025-12-28)

## 1. 核心教训：为什么会出现系统性崩溃？
本次事故的主要原因是 **“新功能集成 (MCP) + 基础设施不一致 (数据库表缺失)”** 产生的连锁反应。

### 关键问题点：
1.  **强耦合初始化**：MCP 模块在启动时强行加载多个核心 Service，并尝试查询数据库。当数据库表（如 `skills`）缺失时，导致 NestJS 进程启动失败。
2.  **缺乏容错机制**：核心链路（如登录、支付）与实验性功能（MCP）未做物理或逻辑隔离。
3.  **环境同步风险**：本地代码领先于远程数据库 Schema，导致部署后出现字段不匹配（如 `appleId` 报错）。

---

## 2. 后续开发注意事项 (Best Practices)

### A. 模块解耦与容错
-   **异步初始化**：对于非核心模块（如 MCP、第三方集成），严禁在 `onModuleInit` 中执行可能失败的同步数据库操作。应使用 `setTimeout` 或异步任务。
-   **软依赖检查**：在调用其他模块 Service 前，先检查相关资源（如数据库表、API Key）是否存在。
-   **独立开关**：为实验性功能增加环境变量开关（如 `ENABLE_MCP=true`），确保在紧急情况下可以一键关闭。

### B. 数据库变更管理
-   **Migration 优先**：所有数据库变更必须通过 `TypeORM Migration` 脚本执行，严禁手动修改远程数据库。
-   **向下兼容**：新增字段应允许 `NULL`，或提供默认值，防止旧代码在未更新时崩溃。
-   **备份意识**：在执行任何涉及 `DROP` 或 `ALTER` 的操作前，必须先执行 `npm run backup:db`。

### C. 部署与回滚
-   **冒烟测试**：部署后立即访问 `/api/health` 和核心业务端点。
-   **版本标记**：重要节点使用 `git tag`，方便快速回滚代码。
-   **日志监控**：部署后观察 `pm2 logs` 至少 5 分钟，重点关注 `ERROR` 级别日志。

---

## 3. MCP 模块优化方案

### 优化目标：
1.  **启动隔离**：确保 MCP 故障不影响后端主进程启动。
2.  **数据库容错**：即使 `skills` 表为空或不存在，MCP 也能正常启动。
3.  **性能优化**：减少对核心 Service 的直接依赖。

### 执行计划：
- [ ] 修改 `McpService`，将工具加载逻辑改为异步。
- [ ] 增加 `try-catch` 保护数据库查询。
- [ ] 增加环境变量开关支持。
