# æ”¯ä»˜ç³»ç»Ÿç«¯åˆ°ç«¯æ—¶åºå›¾ä¸é—®é¢˜æ’æŸ¥ V1.0

> åˆ›å»ºæ—¥æœŸ: 2024-12-17
> ç‰ˆæœ¬: V1.0

## ä¸€ã€é—®é¢˜è¯Šæ–­æ‘˜è¦

### 1.1 QuickPay æˆæƒå¼¹çª—å·²å‡ºä½†æœªæˆæƒæˆåŠŸ

**é—®é¢˜åˆ†æï¼š**

æ ¹æ®ä»£ç åˆ†æï¼ŒQuickPayæˆæƒæµç¨‹æ¶‰åŠä»¥ä¸‹å…³é”®æ­¥éª¤ï¼š

1. **å‰ç«¯ Session åˆ›å»º** (`useSessionManager.ts`)
   - ç”Ÿæˆ Session Key (æœ¬åœ°)
   - ç”¨æˆ·ç­¾åæˆæƒæ¶ˆæ¯
   - æ£€æŸ¥å¹¶æˆæƒ USDT ç»™ ERC8004 åˆçº¦
   - è°ƒç”¨é“¾ä¸Š `createSession` æ–¹æ³•
   - å°† Session ä¿¡æ¯åŒæ­¥åˆ°åç«¯

2. **å¯èƒ½å¤±è´¥çš„ç¯èŠ‚ï¼š**
   - âŒ **USDT æˆæƒå¤±è´¥**ï¼šç”¨æˆ·æ‹’ç»æˆæƒäº¤æ˜“æˆ– Gas ä¸è¶³
   - âŒ **é“¾ä¸Š Session åˆ›å»ºå¤±è´¥**ï¼šåˆçº¦è°ƒç”¨å¤±è´¥
   - âŒ **åç«¯åŒæ­¥å¤±è´¥**ï¼šAPI è°ƒç”¨å¤±è´¥ä½†å‰ç«¯æ˜¾ç¤ºå·²æˆæƒ

**å…³é”®ä»£ç ä½ç½®ï¼š**
- [useSessionManager.ts#L86-L180](frontend/hooks/useSessionManager.ts#L86-L180) - USDTæˆæƒé€»è¾‘
- [useSessionManager.ts#L183-L213](frontend/hooks/useSessionManager.ts#L183-L213) - é“¾ä¸ŠSessionåˆ›å»º
- [useSessionManager.ts#L215-L226](frontend/hooks/useSessionManager.ts#L215-L226) - åç«¯åŒæ­¥

### 1.2 X402 é’±åŒ…å·²ç™»å½•ä½†æç¤ºæœªç™»å½•

**é—®é¢˜åˆ†æï¼š**

æ ¹æ® `Web3Context.tsx` å’Œ `SmartCheckout.tsx` åˆ†æï¼š

1. **é’±åŒ…è¿æ¥çŠ¶æ€æ£€æµ‹** (`Web3Context.tsx#L28-L77`)
   - ä¾èµ– `localStorage.getItem('agentrix_user')` åˆ¤æ–­ç”¨æˆ·ç™»å½•
   - å¦‚æœæ²¡æœ‰ç”¨æˆ·ç™»å½•ï¼Œä¼šæ¸…é™¤æ‰€æœ‰é’±åŒ…è¿æ¥

2. **é—®é¢˜åŸå› ï¼š**
   - âŒ **ç”¨æˆ·æœªç™»å½•åç«¯è´¦æˆ·**ï¼š`agentrix_user` ä¸å­˜åœ¨å¯¼è‡´é’±åŒ…çŠ¶æ€è¢«æ¸…é™¤
   - âŒ **é’±åŒ…æ¢å¤å¤±è´¥**ï¼šMetaMask ç­‰é’±åŒ…æ¢å¤è¿æ¥å¤±è´¥ä½†æ— é”™è¯¯æç¤º
   - âŒ **çŠ¶æ€åŒæ­¥é—®é¢˜**ï¼šå‰ç«¯çŠ¶æ€ä¸å®é™…é’±åŒ…è¿æ¥ä¸ä¸€è‡´

---

## äºŒã€ç«¯åˆ°ç«¯æ”¯ä»˜æ—¶åºå›¾

### 2.1 QuickPay æ”¯ä»˜æµç¨‹ï¼ˆå®Œæ•´æ—¶åºï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·/UI    â”‚     â”‚  å‰ç«¯æœåŠ¡    â”‚     â”‚   åç«¯API    â”‚     â”‚   Relayer    â”‚     â”‚   åŒºå—é“¾     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                    â”‚                    â”‚                    â”‚                    â”‚
       â”‚ 1. ç‚¹å‡»QuickPay    â”‚                    â”‚                    â”‚                    â”‚
       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                    â”‚                    â”‚                    â”‚
       â”‚                    â”‚                    â”‚                    â”‚                    â”‚
       â”‚                    â”‚ 2. æ£€æŸ¥SessionçŠ¶æ€  â”‚                    â”‚                    â”‚
       â”‚                    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                    â”‚                    â”‚
       â”‚                    â”‚                    â”‚                    â”‚                    â”‚
       â”‚                    â”‚ 3. è¿”å›Sessionä¿¡æ¯  â”‚                    â”‚                    â”‚
       â”‚                    â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                    â”‚                    â”‚
       â”‚                    â”‚                    â”‚                    â”‚                    â”‚
       â”‚                    â”‚ 4. æ£€æŸ¥USDTæˆæƒé¢åº¦ â”‚                    â”‚                    â”‚
       â”‚                    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                    â”‚                    â”‚                    â”‚                    â”‚
       â”‚ 5. [éœ€è¦æˆæƒ]       â”‚                    â”‚                    â”‚                    â”‚
       â”‚    å¼¹å‡ºé’±åŒ…æˆæƒ     â”‚                    â”‚                    â”‚                    â”‚
       â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                    â”‚                    â”‚                    â”‚
       â”‚                    â”‚                    â”‚                    â”‚                    â”‚
       â”‚ 6. ç”¨æˆ·ç¡®è®¤æˆæƒ    â”‚                    â”‚                    â”‚                    â”‚
       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                    â”‚                    â”‚                    â”‚
       â”‚                    â”‚                    â”‚                    â”‚                    â”‚
       â”‚                    â”‚ 7. å‘é€approveäº¤æ˜“ â”‚                    â”‚                    â”‚
       â”‚                    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                    â”‚                    â”‚                    â”‚                    â”‚
       â”‚                    â”‚ 8. äº¤æ˜“ç¡®è®¤        â”‚                    â”‚                    â”‚
       â”‚                    â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚                    â”‚                    â”‚                    â”‚                    â”‚
       â”‚                    â”‚ 9. æ„å»ºæ”¯ä»˜ç­¾å    â”‚                    â”‚                    â”‚
       â”‚                    â”‚ (Session Keyç­¾å)  â”‚                    â”‚                    â”‚
       â”‚                    â”‚                    â”‚                    â”‚                    â”‚
       â”‚                    â”‚ 10. è°ƒç”¨æ”¯ä»˜API    â”‚                    â”‚                    â”‚
       â”‚                    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                    â”‚                    â”‚
       â”‚                    â”‚                    â”‚                    â”‚                    â”‚
       â”‚                    â”‚                    â”‚ 11. è½¬å‘åˆ°Relayer  â”‚                    â”‚
       â”‚                    â”‚                    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                    â”‚
       â”‚                    â”‚                    â”‚                    â”‚                    â”‚
       â”‚                    â”‚                    â”‚                    â”‚ 12. éªŒè¯ç­¾å       â”‚
       â”‚                    â”‚                    â”‚                    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
       â”‚                    â”‚                    â”‚                    â”‚                    â”‚
       â”‚                    â”‚                    â”‚                    â”‚ 13. éªŒè¯Session    â”‚
       â”‚                    â”‚                    â”‚                    â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
       â”‚                    â”‚                    â”‚                    â”‚                    â”‚
       â”‚                    â”‚                    â”‚                    â”‚ 14. æ‰§è¡Œæ”¯ä»˜       â”‚
       â”‚                    â”‚                    â”‚                    â”‚ (executeWithSession)
       â”‚                    â”‚                    â”‚                    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
       â”‚                    â”‚                    â”‚                    â”‚                    â”‚
       â”‚                    â”‚                    â”‚                    â”‚ 15. äº¤æ˜“å“ˆå¸Œ       â”‚
       â”‚                    â”‚                    â”‚                    â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
       â”‚                    â”‚                    â”‚                    â”‚                    â”‚
       â”‚                    â”‚                    â”‚ 16. è¿”å›ç»“æœ       â”‚                    â”‚
       â”‚                    â”‚                    â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                    â”‚
       â”‚                    â”‚                    â”‚                    â”‚                    â”‚
       â”‚                    â”‚ 17. æ›´æ–°æ”¯ä»˜çŠ¶æ€   â”‚                    â”‚                    â”‚
       â”‚                    â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                    â”‚                    â”‚
       â”‚                    â”‚                    â”‚                    â”‚                    â”‚
       â”‚ 18. æ˜¾ç¤ºæ”¯ä»˜æˆåŠŸ   â”‚                    â”‚                    â”‚                    â”‚
       â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                    â”‚                    â”‚                    â”‚
       â”‚                    â”‚                    â”‚                    â”‚                    â”‚
       â–¼                    â–¼                    â–¼                    â–¼                    â–¼

```

### 2.2 èµ„é‡‘æµå‘å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            èµ„é‡‘æµå‘ (ä»¥100 USDTè®¢å•ä¸ºä¾‹)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                  â”‚
â”‚   â”‚   ç”¨æˆ·é’±åŒ…    â”‚                                                                  â”‚
â”‚   â”‚  (100 USDT)  â”‚                                                                  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                                                  â”‚
â”‚          â”‚                                                                          â”‚
â”‚          â”‚ 1. transferFrom (100 USDT)                                              â”‚
â”‚          â”‚    (ç”± Relayer è°ƒç”¨ ERC8004SessionManager)                               â”‚
â”‚          â–¼                                                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚   â”‚                    Commission åˆçº¦ (åˆ†è´¦åˆçº¦)                              â”‚     â”‚
â”‚   â”‚                                                                           â”‚     â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚     â”‚
â”‚   â”‚   â”‚                         è´¹ç”¨åˆ†é…                                 â”‚    â”‚     â”‚
â”‚   â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚     â”‚
â”‚   â”‚   â”‚                                                                  â”‚    â”‚     â”‚
â”‚   â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚    â”‚     â”‚
â”‚   â”‚   â”‚  â”‚ æ¿€åŠ±æ±  (1%)   â”‚   â”‚ å¹³å°è´¹ (2%)  â”‚   â”‚ å•†æˆ· (97%)   â”‚        â”‚    â”‚     â”‚
â”‚   â”‚   â”‚  â”‚  1.00 USDT   â”‚   â”‚  2.00 USDT   â”‚   â”‚  97.00 USDT  â”‚        â”‚    â”‚     â”‚
â”‚   â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚    â”‚     â”‚
â”‚   â”‚   â”‚         â”‚                  â”‚                  â”‚                 â”‚    â”‚     â”‚
â”‚   â”‚   â”‚         â”‚                  â”‚                  â”‚                 â”‚    â”‚     â”‚
â”‚   â”‚   â”‚         â”‚           X402è´¹ç”¨(0.3%)            â”‚                 â”‚    â”‚     â”‚
â”‚   â”‚   â”‚         â”‚           ä»å¹³å°è´¹æ‰£é™¤              â”‚                 â”‚    â”‚     â”‚
â”‚   â”‚   â”‚         â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”           â”‚                 â”‚    â”‚     â”‚
â”‚   â”‚   â”‚         â”‚           â”‚             â”‚           â”‚                 â”‚    â”‚     â”‚
â”‚   â”‚   â”‚         â–¼           â–¼             â–¼           â–¼                 â”‚    â”‚     â”‚
â”‚   â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚    â”‚     â”‚
â”‚   â”‚   â”‚  â”‚æ¿€åŠ±æ± åœ°å€â”‚ â”‚X402åè®® â”‚ â”‚å¹³å°åœ°å€ â”‚ â”‚ å•†æˆ·åœ°å€     â”‚      â”‚    â”‚     â”‚
â”‚   â”‚   â”‚  â”‚ 1.00 USDTâ”‚ â”‚0.30 USDTâ”‚ â”‚1.70 USDTâ”‚ â”‚ 97.00 USDT   â”‚      â”‚    â”‚     â”‚
â”‚   â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚    â”‚     â”‚
â”‚   â”‚   â”‚                                                                  â”‚    â”‚     â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚     â”‚
â”‚   â”‚                                                                           â”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 Wallet ç›´æ¥æ”¯ä»˜æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·/UI    â”‚     â”‚  å‰ç«¯æœåŠ¡    â”‚     â”‚   åç«¯API    â”‚     â”‚   åŒºå—é“¾     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚ 1. ç‚¹å‡»WalletPay   â”‚                    â”‚                    â”‚
       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                    â”‚                    â”‚
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚                    â”‚ 2. æ£€æŸ¥é’±åŒ…è¿æ¥    â”‚                    â”‚
       â”‚                    â”‚ [isConnected?]     â”‚                    â”‚
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚                    â”‚ 3. è·å–åˆçº¦åœ°å€    â”‚                    â”‚
       â”‚                    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                    â”‚
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚                    â”‚ 4. è¿”å›Commission  â”‚                    â”‚
       â”‚                    â”‚    åˆçº¦åœ°å€        â”‚                    â”‚
       â”‚                    â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                    â”‚
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚ 5. å¼¹å‡ºé’±åŒ…ç¡®è®¤    â”‚                    â”‚                    â”‚
       â”‚    (Transfer)      â”‚                    â”‚                    â”‚
       â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                    â”‚                    â”‚
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚ 6. ç”¨æˆ·ç¡®è®¤äº¤æ˜“    â”‚                    â”‚                    â”‚
       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                    â”‚                    â”‚
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚                    â”‚ 7. å‘é€transferäº¤æ˜“â”‚                    â”‚
       â”‚                    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚                    â”‚ 8. äº¤æ˜“ç¡®è®¤(txHash)â”‚                    â”‚
       â”‚                    â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚                    â”‚ 9. è®°å½•æ”¯ä»˜åˆ°åç«¯  â”‚                    â”‚
       â”‚                    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                    â”‚
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚                    â”‚ 10. æ”¯ä»˜è®°å½•ä¿å­˜   â”‚                    â”‚
       â”‚                    â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                    â”‚
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚ 11. æ˜¾ç¤ºæ”¯ä»˜æˆåŠŸ   â”‚                    â”‚                    â”‚
       â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                    â”‚                    â”‚
       â”‚                    â”‚                    â”‚                    â”‚
       â–¼                    â–¼                    â–¼                    â–¼
```

---

## ä¸‰ã€QuickPay æˆæƒé—®é¢˜æ’æŸ¥æ¸…å•

### 3.1 å‰ç«¯æ£€æŸ¥é¡¹

| æ£€æŸ¥é¡¹ | ä»£ç ä½ç½® | é¢„æœŸè¡Œä¸º | æ£€æŸ¥æ–¹æ³• |
|--------|----------|----------|----------|
| Session Key ç”Ÿæˆ | `SessionKeyManager.generateSessionKey()` | ç”Ÿæˆæœ¬åœ°å¯†é’¥å¯¹ | Console æ—¥å¿— |
| ç”¨æˆ·ç­¾å | `signMessage(message)` | é’±åŒ…å¼¹çª—è®©ç”¨æˆ·ç­¾å | è§‚å¯Ÿé’±åŒ…å¼¹çª— |
| USDT æˆæƒæ£€æŸ¥ | `tokenContract.allowance()` | æ£€æŸ¥å½“å‰æˆæƒé¢åº¦ | Console æ—¥å¿— |
| USDT æˆæƒäº¤æ˜“ | `tokenContract.approve()` | å‘èµ·æˆæƒäº¤æ˜“ | é’±åŒ…å¼¹çª— + äº¤æ˜“ç¡®è®¤ |
| é“¾ä¸Š Session åˆ›å»º | `sessionManagerContract.createSession()` | åˆ›å»ºé“¾ä¸Š Session | äº¤æ˜“ç¡®è®¤ |
| åç«¯åŒæ­¥ | `paymentApi.createSession()` | Session ä¿å­˜åˆ°åç«¯ | API å“åº” |

### 3.2 åç«¯æ£€æŸ¥é¡¹

| æ£€æŸ¥é¡¹ | ä»£ç ä½ç½® | é¢„æœŸè¡Œä¸º | æ£€æŸ¥æ–¹æ³• |
|--------|----------|----------|----------|
| Session è®°å½•å­˜å‚¨ | `quick-pay-grant.service.ts` | æ•°æ®åº“ä¿å­˜ | æ•°æ®åº“æŸ¥è¯¢ |
| Relayer åˆå§‹åŒ– | `relayer.service.ts#L53-L129` | é’±åŒ…å’Œåˆçº¦åˆå§‹åŒ– | å¯åŠ¨æ—¥å¿— |
| Relayer ä½™é¢ | `relayer.service.ts#L134-L136` | BNB ä½™é¢ > 0 | å¯åŠ¨æ—¥å¿— |
| ç­¾åéªŒè¯ | `relayer.service.ts#L370-L500` | éªŒè¯ç”¨æˆ·ç­¾å | æ”¯ä»˜æ—¥å¿— |

### 3.3 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

#### é—®é¢˜1: USDT æˆæƒå¼¹çª—å‡ºç°ä½†æˆæƒå¤±è´¥

**ç—‡çŠ¶**: é’±åŒ…å¼¹å‡ºæˆæƒçª—å£ï¼Œç”¨æˆ·ç‚¹å‡»ç¡®è®¤ï¼Œä½†ä»æ˜¾ç¤ºéœ€è¦æˆæƒ

**å¯èƒ½åŸå› **:
1. Gas è´¹ä¸è¶³ï¼ˆBNB ä½™é¢ä¸å¤Ÿï¼‰
2. äº¤æ˜“è¢«ç”¨æˆ·æ‹’ç»ï¼ˆé”™è¯¯ä»£ç  4001ï¼‰
3. ç½‘ç»œé—®é¢˜å¯¼è‡´äº¤æ˜“æœªå¹¿æ’­

**è§£å†³æ–¹æ¡ˆ**:
```typescript
// useSessionManager.ts ä¸­éœ€è¦æ·»åŠ è¯¦ç»†çš„é”™è¯¯å¤„ç†
try {
  const approveTx = await tokenWithSigner.approve(erc8004Address, approvalAmount);
  console.log('æˆæƒäº¤æ˜“å·²å‘é€:', approveTx.hash);
  
  // ç­‰å¾…äº¤æ˜“ç¡®è®¤
  const receipt = await approveTx.wait();
  console.log('æˆæƒäº¤æ˜“å·²ç¡®è®¤:', receipt);
  
  // éªŒè¯æˆæƒæ˜¯å¦æˆåŠŸ
  const newAllowance = await tokenContract.allowance(userAddress, erc8004Address);
  if (newAllowance < approvalAmount) {
    throw new Error('æˆæƒé‡‘é¢ä¸è¶³ï¼Œè¯·é‡è¯•');
  }
} catch (error) {
  // è¯¦ç»†é”™è¯¯å¤„ç†...
}
```

#### é—®é¢˜2: Session åˆ›å»ºæˆåŠŸä½†æ”¯ä»˜å¤±è´¥

**ç—‡çŠ¶**: æˆæƒæˆåŠŸï¼Œä½†ç‚¹å‡»æ”¯ä»˜æ—¶å¤±è´¥

**å¯èƒ½åŸå› **:
1. Relayer é’±åŒ… BNB ä½™é¢ä¸è¶³
2. Session å·²è¿‡æœŸ
3. ç­¾åä¸åŒ¹é…

**æ£€æŸ¥æ–¹æ³•**:
```bash
# æ£€æŸ¥ Relayer ä½™é¢
curl http://localhost:3001/api/relayer/status

# æ£€æŸ¥ Session çŠ¶æ€
curl http://localhost:3001/api/sessions?active=true
```

---

## å››ã€X402 é’±åŒ…ç™»å½•çŠ¶æ€é—®é¢˜

### 4.1 é—®é¢˜æ ¹å› åˆ†æ

æ ¹æ® [Web3Context.tsx#L28-L77](frontend/contexts/Web3Context.tsx#L28-L77)ï¼š

```typescript
// æ¢å¤é’±åŒ…è¿æ¥æ—¶æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
const savedUser = localStorage.getItem('agentrix_user')
if (!savedUser) {
  // æ²¡æœ‰ç”¨æˆ·ç™»å½•ï¼Œæ¸…é™¤æ‰€æœ‰é’±åŒ…è¿æ¥
  setConnectedWallets([])
  setDefaultWallet(null)
  return  // âš ï¸ è¿™é‡Œç›´æ¥è¿”å›ï¼Œä¸ä¼šæ¢å¤é’±åŒ…
}
```

**é—®é¢˜**ï¼šé’±åŒ…è¿æ¥çŠ¶æ€ä¾èµ–äºåç«¯ç”¨æˆ·ç™»å½•çŠ¶æ€ã€‚å¦‚æœç”¨æˆ·æœªç™»å½•åç«¯è´¦æˆ·ï¼Œå³ä½¿é’±åŒ…å·²è¿æ¥ï¼Œä¹Ÿä¼šè¢«è®¤ä¸ºæœªç™»å½•ã€‚

### 4.2 è§£å†³æ–¹æ¡ˆ

**æ–¹æ¡ˆ1: è§£è€¦é’±åŒ…è¿æ¥å’Œç”¨æˆ·ç™»å½•**

```typescript
// ä¿®æ”¹ Web3Context.tsx
const restoreWallets = async () => {
  try {
    // ä¸å†æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€ï¼Œå…è®¸é’±åŒ…ç‹¬ç«‹è¿æ¥
    try {
      const restored = await walletService.restoreConnections()
      setConnectedWallets(restored)
      setDefaultWallet(walletService.getDefaultWallet())
    } catch (restoreError: any) {
      // é”™è¯¯å¤„ç†...
    }
  } catch (error) {
    console.error('æ¢å¤é’±åŒ…è¿æ¥å¤±è´¥:', error)
  }
}
```

**æ–¹æ¡ˆ2: æ”¯æŒé’±åŒ…ç™»å½•**

å¯¹äº X402 é¡µé¢ï¼Œç”¨æˆ·å¯èƒ½åªéœ€è¦é’±åŒ…è¿æ¥è€Œä¸éœ€è¦ä¼ ç»Ÿç™»å½•ã€‚å¯ä»¥æ·»åŠ é’±åŒ…ç™»å½•é€‰é¡¹ï¼š

```typescript
// åœ¨ x402.tsx ä¸­æ·»åŠ é’±åŒ…ç™»å½•æ£€æµ‹
useEffect(() => {
  const checkWalletStatus = async () => {
    // 1. æ£€æŸ¥é’±åŒ…æ˜¯å¦å·²è¿æ¥
    if (isConnected && defaultWallet) {
      setWalletLoggedIn(true);
    }
    
    // 2. å¦‚æœé’±åŒ…å·²è¿æ¥ä½†æ²¡æœ‰ç”¨æˆ·ç™»å½•ï¼Œè‡ªåŠ¨è§¦å‘é’±åŒ…ç™»å½•
    if (isConnected && defaultWallet && !localStorage.getItem('agentrix_user')) {
      try {
        await walletLogin(defaultWallet.address);
      } catch (error) {
        console.error('é’±åŒ…ç™»å½•å¤±è´¥:', error);
      }
    }
  };
  
  checkWalletStatus();
}, [isConnected, defaultWallet]);
```

---

## äº”ã€X402 è‡ªåŠ¨è·å–å•†å“åŠŸèƒ½æ¸…å•

### 5.1 éœ€è¦å®Œæˆçš„åŠŸèƒ½

| åºå· | åŠŸèƒ½ | çŠ¶æ€ | ä¼˜å…ˆçº§ | è¯´æ˜ |
|------|------|------|--------|------|
| 1 | X402 æˆæƒæ£€æŸ¥ API | âœ… å·²å®ç° | P0 | `GET /payments/x402/authorization` |
| 2 | X402 æˆæƒåˆ›å»º API | âœ… å·²å®ç° | P0 | `POST /payments/x402/authorization` |
| 3 | å‰ç«¯ API è°ƒç”¨æ–¹æ³• | âœ… å·²å®ç° | P0 | `paymentApi.checkX402Authorization()` / `createX402Authorization()` |
| 4 | é’±åŒ…ç™»å½•çŠ¶æ€æ˜¾ç¤º | âœ… å·²ä¿®å¤ | P0 | X402é¡µé¢æ˜¾ç¤ºé’±åŒ…è¿æ¥çŠ¶æ€ |
| 5 | é’±åŒ…é€‰æ‹©å™¨å¼¹çª— | âœ… å·²å®ç° | P0 | æœªè¿æ¥é’±åŒ…æ—¶æ˜¾ç¤ºé€‰æ‹©å™¨ |
| 6 | æ”¯ä»˜ç»“æœå›è°ƒ | âœ… å·²å®ç° | - | SmartCheckout å·²æ”¯æŒ |
| 7 | å•†å“è‡ªåŠ¨è·å–é›†æˆ | ğŸŸ¡ éƒ¨åˆ†å®ç° | P1 | éœ€è¦ä¸äº§å“APIé›†æˆ |

### 5.2 è¯¦ç»†åŠŸèƒ½è§„æ ¼

#### 5.2.1 X402 æˆæƒæ£€æŸ¥ API

**éœ€è¦åœ¨åç«¯æ·»åŠ çš„æ¥å£**:

```typescript
// backend/src/modules/payment/payment.controller.ts

@Get('x402/authorization')
@UseGuards(AuthGuard)
async checkX402Authorization(@Request() req) {
  return this.x402AuthorizationService.checkAuthorization(req.user.id);
}
```

**å‰ç«¯è°ƒç”¨**:

```typescript
// frontend/lib/api/payment.api.ts

checkX402Authorization: async (): Promise<X402Authorization | null> => {
  try {
    return await apiClient.get<X402Authorization>('/payments/x402/authorization');
  } catch (error) {
    if ((error as any)?.status === 404) {
      return null;
    }
    throw error;
  }
},
```

#### 5.2.2 X402 æˆæƒåˆ›å»º API

**éœ€è¦åœ¨åç«¯æ·»åŠ çš„æ¥å£**:

```typescript
// backend/src/modules/payment/payment.controller.ts

@Post('x402/authorization')
@UseGuards(AuthGuard)
async createX402Authorization(
  @Request() req,
  @Body() dto: { singleLimit: number; dailyLimit: number; durationDays?: number }
) {
  return this.x402AuthorizationService.createAuthorization(
    req.user.id,
    dto.singleLimit,
    dto.dailyLimit,
    dto.durationDays || 30
  );
}
```

**å‰ç«¯è°ƒç”¨**:

```typescript
// frontend/lib/api/payment.api.ts

createX402Authorization: async (request: {
  singleLimit: number;
  dailyLimit: number;
  durationDays?: number;
}): Promise<X402Authorization> => {
  return apiClient.post<X402Authorization>('/payments/x402/authorization', request);
},
```

---

## å…­ã€ä¸Šçº¿å‰æ£€æŸ¥æ¸…å•

### 6.1 åç«¯æ£€æŸ¥

- [ ] Relayer é’±åŒ…æœ‰è¶³å¤Ÿ BNB (å»ºè®® > 0.1 BNB)
- [ ] ERC8004 åˆçº¦åœ°å€é…ç½®æ­£ç¡®
- [ ] Commission åˆçº¦åœ°å€é…ç½®æ­£ç¡®
- [ ] USDT åˆçº¦åœ°å€é…ç½®æ­£ç¡® (BSC Testnet: 0x337610d27c682E347C9cD60BD4b3b107C9d34dDd)
- [ ] RPC URL é…ç½®æ­£ç¡®ä¸”å¯è®¿é—®
- [ ] æ•°æ®åº“ migrations å·²æ‰§è¡Œ

### 6.2 å‰ç«¯æ£€æŸ¥

- [ ] ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®
  - `NEXT_PUBLIC_ERC8004_CONTRACT_ADDRESS`
  - `NEXT_PUBLIC_BSC_TESTNET_USDT_ADDRESS`
  - `NEXT_PUBLIC_BSC_TESTNET_RPC_URL`
- [ ] é’±åŒ…è¿æ¥åŠŸèƒ½æ­£å¸¸
- [ ] Session åˆ›å»ºæµç¨‹å®Œæ•´
- [ ] æ”¯ä»˜æµç¨‹æµ‹è¯•é€šè¿‡

### 6.3 åˆçº¦æ£€æŸ¥

- [ ] ERC8004SessionManager å·²éƒ¨ç½²
- [ ] Commission åˆçº¦å·²éƒ¨ç½²
- [ ] Relayer åœ°å€å·²æ·»åŠ åˆ° Commission åˆçº¦ç™½åå•
- [ ] è´¹ç‡é…ç½®æ­£ç¡® (æ¿€åŠ±æ±  1%, å¹³å°è´¹ 2%, X402 è´¹ 0.3%)

---

## ä¸ƒã€è°ƒè¯•å‘½ä»¤

```bash
# æ£€æŸ¥åç«¯å¥åº·çŠ¶æ€
curl http://localhost:3001/api/health

# æ£€æŸ¥ Relayer çŠ¶æ€
curl http://localhost:3001/api/relayer/status

# æ£€æŸ¥åˆçº¦åœ°å€é…ç½®
curl http://localhost:3001/api/payments/contract-address

# æµ‹è¯• QuickPay æ”¯ä»˜
curl -X POST http://localhost:3001/api/payments/process \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <token>" \
  -d '{
    "amount": 1,
    "currency": "USDT",
    "paymentMethod": "x402",
    "merchantId": "test_merchant",
    "description": "Test payment",
    "metadata": {
      "sessionId": "<session_id>",
      "signature": "<signature>",
      "nonce": 1234567890
    }
  }'
```

---

## é™„å½•: ç›¸å…³æ–‡ä»¶ç´¢å¼•

| æ–‡ä»¶ | ç”¨é€” |
|------|------|
| `frontend/hooks/useSessionManager.ts` | Session åˆ›å»ºå’Œç®¡ç† |
| `frontend/hooks/useQuickPay.ts` | QuickPay æ‰§è¡Œé€»è¾‘ |
| `frontend/contexts/Web3Context.tsx` | é’±åŒ…è¿æ¥çŠ¶æ€ç®¡ç† |
| `frontend/components/payment/SmartCheckout.tsx` | æ”¯ä»˜ç»„ä»¶ |
| `frontend/pages/pay/x402.tsx` | X402 æ”¯ä»˜é¡µé¢ |
| `backend/src/modules/relayer/relayer.service.ts` | Relayer æœåŠ¡ |
| `backend/src/modules/payment/payment.service.ts` | æ”¯ä»˜å¤„ç†æœåŠ¡ |
| `backend/src/modules/payment/x402-authorization.service.ts` | X402 æˆæƒæœåŠ¡ |
