# é’±åŒ…è´¦æˆ·ç»‘å®šé‚®ç®±åŠŸèƒ½ä¿®å¤æŠ¥å‘Š

**æ—¥æœŸ**: 2025-01-24  
**çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ“‹ é—®é¢˜æè¿°

ç”¨æˆ·é€šè¿‡é’±åŒ…ç™»å½•åï¼ˆPayMind ID: `pm-1763463490911-91zf91wu2`ï¼‰ï¼Œåœ¨ç”¨æˆ·è®¾ç½®é¡µé¢æ— æ³•ç»‘å®šé‚®ç®±ã€‚é¡µé¢æ˜¾ç¤º"æœªç»‘å®šé‚®ç®±"ï¼Œä½†ç¼–è¾‘æ¨¡å¼ä¸‹è¾“å…¥é‚®ç®±åç‚¹å‡»"ä¿å­˜"æŒ‰é’®æ²¡æœ‰å®é™…ä¿å­˜ã€‚

---

## âœ… ä¿®å¤å†…å®¹

### 1. å‰ç«¯ï¼šç”¨æˆ·è®¾ç½®é¡µé¢ä¿å­˜åŠŸèƒ½

**é—®é¢˜**ï¼šç¼–è¾‘æ¨¡å¼ä¸‹ç‚¹å‡»"ä¿å­˜"æŒ‰é’®åªæ˜¯åˆ‡æ¢ç¼–è¾‘çŠ¶æ€ï¼Œæ²¡æœ‰å®é™…è°ƒç”¨APIä¿å­˜é‚®ç®±ã€‚

**ä¿®å¤**ï¼š
- æ·»åŠ äº† `handleSave` å‡½æ•°ï¼Œå®é™…è°ƒç”¨ `userApi.updateProfile` API
- æ·»åŠ äº†é‚®ç®±ã€æ˜µç§°ã€ä¸ªäººç®€ä»‹çš„è¾“å…¥æ¡†çŠ¶æ€ç®¡ç†
- æ·»åŠ äº†ä¿å­˜ä¸­çš„åŠ è½½çŠ¶æ€
- æ›´æ–°ç”¨æˆ·ä¸Šä¸‹æ–‡ï¼Œç¡®ä¿å‰ç«¯æ˜¾ç¤ºæœ€æ–°çš„é‚®ç®±ä¿¡æ¯

**ä¿®æ”¹æ–‡ä»¶**ï¼š`paymindfrontend/pages/app/user/profile.tsx`

**å…³é”®ä»£ç **ï¼š
```typescript
const handleSave = async () => {
  if (!isEditing) {
    setIsEditing(true)
    return
  }

  setIsSaving(true)
  try {
    const updatedUser = await userApi.updateProfile({
      email: email || undefined,
      nickname: nickname || undefined,
      bio: bio || undefined,
    })
    
    // æ›´æ–°ç”¨æˆ·ä¸Šä¸‹æ–‡
    if (updateUser && updatedUser.user) {
      updateUser({
        email: updatedUser.user.email,
        nickname: updatedUser.user.nickname,
        bio: updatedUser.user.bio,
      })
    }
    
    toast.success('ç”¨æˆ·ä¿¡æ¯æ›´æ–°æˆåŠŸ')
    setIsEditing(false)
  } catch (error: any) {
    // é”™è¯¯å¤„ç†...
  } finally {
    setIsSaving(false)
  }
}
```

---

### 2. å‰ç«¯ï¼šUserContext æ·»åŠ  updateUser æ–¹æ³•

**é—®é¢˜**ï¼šUserContext æ²¡æœ‰ `updateUser` æ–¹æ³•ï¼Œæ— æ³•æ›´æ–°ç”¨æˆ·ä¿¡æ¯ã€‚

**ä¿®å¤**ï¼š
- åœ¨ `UserContextType` æ¥å£ä¸­æ·»åŠ  `updateUser` æ–¹æ³•
- å®ç° `updateUser` å‡½æ•°ï¼Œæ›´æ–°ç”¨æˆ·çŠ¶æ€å’Œ localStorage

**ä¿®æ”¹æ–‡ä»¶**ï¼š`paymindfrontend/contexts/UserContext.tsx`

**å…³é”®ä»£ç **ï¼š
```typescript
const updateUser = (userData: Partial<User>) => {
  if (!user) return

  const updatedUser: User = {
    ...user,
    ...userData
  }

  setUser(updatedUser)
  localStorage.setItem('paymind_user', JSON.stringify(updatedUser))
}
```

---

### 3. åç«¯ï¼šé‚®ç®±å”¯ä¸€æ€§éªŒè¯

**é—®é¢˜**ï¼šåç«¯ `updateProfile` æ–¹æ³•æ²¡æœ‰éªŒè¯é‚®ç®±æ˜¯å¦å·²è¢«å…¶ä»–ç”¨æˆ·ä½¿ç”¨ã€‚

**ä¿®å¤**ï¼š
- æ·»åŠ é‚®ç®±å”¯ä¸€æ€§éªŒè¯é€»è¾‘
- å¦‚æœé‚®ç®±å·²è¢«å…¶ä»–ç”¨æˆ·ä½¿ç”¨ï¼ŒæŠ›å‡º `ConflictException`

**ä¿®æ”¹æ–‡ä»¶**ï¼š`backend/src/modules/user/user.service.ts`

**å…³é”®ä»£ç **ï¼š
```typescript
// å¦‚æœæ›´æ–°é‚®ç®±ï¼Œæ£€æŸ¥é‚®ç®±æ˜¯å¦å·²è¢«å…¶ä»–ç”¨æˆ·ä½¿ç”¨
if (dto.email && dto.email !== user.email) {
  const existingUser = await this.userRepository.findOne({
    where: { email: dto.email },
  });

  if (existingUser && existingUser.id !== userId) {
    throw new ConflictException('è¯¥é‚®ç®±å·²è¢«å…¶ä»–è´¦å·ä½¿ç”¨');
  }
}
```

---

## ğŸ¨ UI æ”¹è¿›

1. **è¾“å…¥æ¡†æ ·å¼**ï¼šä¸ºæ‰€æœ‰è¾“å…¥æ¡†æ·»åŠ  `text-gray-900` ç±»ï¼Œç¡®ä¿æ–‡å­—å¯è§
2. **ä¿å­˜æŒ‰é’®**ï¼šæ·»åŠ åŠ è½½çŠ¶æ€ï¼ˆ"ä¿å­˜ä¸­..."ï¼‰ï¼Œç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤æäº¤
3. **é”™è¯¯æç¤º**ï¼šæ”¹è¿›é”™è¯¯å¤„ç†ï¼Œæä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### 1. æµ‹è¯•é‚®ç®±ç»‘å®š

1. ä½¿ç”¨é’±åŒ…ç™»å½•ï¼ˆæˆ–å·²ç™»å½•çš„é’±åŒ…è´¦æˆ·ï¼‰
2. è¿›å…¥ç”¨æˆ·è®¾ç½®é¡µé¢ï¼ˆ`/app/user/profile`ï¼‰
3. ç‚¹å‡»"ç¼–è¾‘"æŒ‰é’®
4. åœ¨"é‚®ç®±åœ°å€"è¾“å…¥æ¡†ä¸­è¾“å…¥é‚®ç®±ï¼ˆä¾‹å¦‚ï¼š`50084809@qq.com`ï¼‰
5. ç‚¹å‡»"ä¿å­˜"æŒ‰é’®
6. **éªŒè¯**ï¼š
   - åº”è¯¥æ˜¾ç¤º"ç”¨æˆ·ä¿¡æ¯æ›´æ–°æˆåŠŸ"æç¤º
   - é‚®ç®±åº”è¯¥æ˜¾ç¤ºåœ¨é¡µé¢ä¸Š
   - é€€å‡ºç¼–è¾‘æ¨¡å¼åï¼Œé‚®ç®±åº”è¯¥ä»ç„¶æ˜¾ç¤º

### 2. æµ‹è¯•é‚®ç®±å”¯ä¸€æ€§éªŒè¯

1. ä½¿ç”¨é’±åŒ…è´¦æˆ·ç™»å½•
2. å°è¯•ç»‘å®šä¸€ä¸ªå·²è¢«å…¶ä»–è´¦å·ä½¿ç”¨çš„é‚®ç®±
3. **éªŒè¯**ï¼šåº”è¯¥æ˜¾ç¤º"è¯¥é‚®ç®±å·²è¢«å…¶ä»–è´¦å·ä½¿ç”¨"é”™è¯¯æç¤º

### 3. æµ‹è¯•æ˜µç§°å’Œä¸ªäººç®€ä»‹

1. åœ¨ç¼–è¾‘æ¨¡å¼ä¸‹ï¼Œè¾“å…¥æ˜µç§°å’Œä¸ªäººç®€ä»‹
2. ç‚¹å‡»"ä¿å­˜"æŒ‰é’®
3. **éªŒè¯**ï¼šæ˜µç§°å’Œä¸ªäººç®€ä»‹åº”è¯¥è¢«ä¿å­˜å¹¶æ˜¾ç¤º

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **é‚®ç®±éªŒè¯**ï¼šåç«¯ä¼šéªŒè¯é‚®ç®±æ ¼å¼ï¼ˆé€šè¿‡ DTO éªŒè¯ï¼‰
2. **é‚®ç®±å”¯ä¸€æ€§**ï¼šåŒä¸€ä¸ªé‚®ç®±åªèƒ½ç»‘å®šä¸€ä¸ªè´¦å·
3. **ç”¨æˆ·ä¸Šä¸‹æ–‡æ›´æ–°**ï¼šä¿å­˜æˆåŠŸåï¼Œç”¨æˆ·ä¸Šä¸‹æ–‡ä¼šè‡ªåŠ¨æ›´æ–°ï¼Œç¡®ä¿å‰ç«¯æ˜¾ç¤ºæœ€æ–°ä¿¡æ¯
4. **localStorage åŒæ­¥**ï¼šç”¨æˆ·ä¿¡æ¯ä¼šåŒæ­¥ä¿å­˜åˆ° localStorageï¼Œåˆ·æ–°é¡µé¢åä»ç„¶æœ‰æ•ˆ

---

## ğŸ”§ API ç«¯ç‚¹

### æ›´æ–°ç”¨æˆ·ä¿¡æ¯

**ç«¯ç‚¹**ï¼š`PUT /api/users/profile`

**è¯·æ±‚å¤´**ï¼š
```
Authorization: Bearer {JWT_TOKEN}
Content-Type: application/json
```

**è¯·æ±‚ä½“**ï¼š
```json
{
  "email": "user@example.com",
  "nickname": "ç”¨æˆ·æ˜µç§°",
  "bio": "ä¸ªäººç®€ä»‹"
}
```

**å“åº”**ï¼š
```json
{
  "message": "ç”¨æˆ·ä¿¡æ¯æ›´æ–°æˆåŠŸ",
  "user": {
    "id": "uuid",
    "paymindId": "pm-xxx",
    "email": "user@example.com",
    "roles": ["user"],
    "kycLevel": "none",
    "kycStatus": "none",
    "avatarUrl": null,
    "createdAt": "2025-01-24T00:00:00.000Z"
  }
}
```

**é”™è¯¯å“åº”**ï¼š
- `409 Conflict`ï¼šè¯¥é‚®ç®±å·²è¢«å…¶ä»–è´¦å·ä½¿ç”¨
- `404 Not Found`ï¼šç”¨æˆ·ä¸å­˜åœ¨
- `401 Unauthorized`ï¼šæœªæˆæƒï¼ˆéœ€è¦ç™»å½•ï¼‰

---

## âœ… å®ŒæˆçŠ¶æ€

- âœ… å‰ç«¯ç”¨æˆ·è®¾ç½®é¡µé¢ä¿å­˜åŠŸèƒ½
- âœ… UserContext æ·»åŠ  updateUser æ–¹æ³•
- âœ… åç«¯é‚®ç®±å”¯ä¸€æ€§éªŒè¯
- âœ… é”™è¯¯å¤„ç†å’Œç”¨æˆ·æç¤º
- âœ… UI æ ·å¼æ”¹è¿›

---

## ğŸ“ åç»­ä¼˜åŒ–å»ºè®®

1. **é‚®ç®±éªŒè¯**ï¼šæ·»åŠ é‚®ç®±éªŒè¯åŠŸèƒ½ï¼Œå‘é€éªŒè¯é‚®ä»¶
2. **å¯†ç è®¾ç½®**ï¼šä¸ºé’±åŒ…è´¦æˆ·æ·»åŠ è®¾ç½®å¯†ç åŠŸèƒ½ï¼Œå…è®¸ä½¿ç”¨é‚®ç®±+å¯†ç ç™»å½•
3. **é‚®ç®±è§£ç»‘**ï¼šæ·»åŠ é‚®ç®±è§£ç»‘åŠŸèƒ½ï¼ˆéœ€è¦éªŒè¯ï¼‰
4. **å†å²è®°å½•**ï¼šè®°å½•é‚®ç®±å˜æ›´å†å²

