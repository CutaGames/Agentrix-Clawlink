# Agentrix Commerce Skill 对话框使用流程（设计稿 V2）

本文档沉淀本次讨论的**技能调用入口**与**完整交互流程**，用于指导后续在 Agentrix 工作台对话框、Cursor/IDE 与 Claude Desktop 的一致体验实现。

**协议支持**：
- **UCP**：商用能力发现与结账流程
- **X402**：自动化支付/授权

---

## 一、技能入口与识别（统一设计）

### 1) 自然语言触发（默认入口）
- 用户直接描述需求，例如：
  - "我要创建分账方案"
  - "给团队建一个预算池"
  - "帮我算手续费"
  - "发布一个任务到 marketplace"

系统行为：
- 语义识别 → 归类到 commerce skill 下的分类 → 展示分类卡片

### 2) @技能直呼（强入口）
- 用户输入：`@commerce` 或 `@agentrix commerce`
- 直接进入 commerce 技能的分类卡片

### 3) 命令式入口
- 用户输入：`/skills` → 展示**可用技能列表**
- 用户输入：`/skill commerce` → 进入 commerce 分类卡片
- **规范**：`/` 开头用于系统命令，`@` 用于技能调用

### 4) UI 按钮入口
- "Skills"按钮 或 "+" 按钮 → 列表 + 搜索
- 选择 `commerce` → 展示分类卡片
- 快捷键：`Ctrl+Shift+P` 呼出技能面板

### 5) 历史记录入口（新增）
- "最近使用的技能"快速访问
- 支持收藏常用技能

---

## 二、commerce skill 分类卡片（三层结构）

### 第一层：场景入口（4 个主分类）

进入 `@commerce` 后展示 4 个场景入口：

| 图标 | 分类 | 说明 | UCP/X402 支持 |
|------|------|------|--------------|
| 💰 | **收付款** | 支付、收款、生成链接 | ✅ X402 自动授权 |
| 💱 | **资金兑换** | On-ramp / Off-ramp | ✅ UCP 能力发现 |
| 👥 | **协作分账** | 分佣、预算池、里程碑、酬劳 | ✅ UCP 结账流程 |
| 🚀 | **发布** | 任务/商品/Skill 发布 | ✅ UCP 商品注册 |

### 第二层：子功能（点击展开）

**💰 收付款**
- 发起支付（X402: `payment/create`）
- 生成收款链接（X402: `payment/link`）
- 查询订单状态

**💱 资金兑换**
- 法币 → 加密货币（Transak on-ramp）
- 加密货币 → 法币（off-ramp）
- 汇率查询

**👥 协作分账**
- 创建分账方案（UCP: `split/create`）
- 管理预算池（UCP: `budget/pool`）
- 里程碑管理（UCP: `milestone/*`）
- 发放协作酬劳
- 费用计算/预览
- 查看费率结构

**🚀 发布**
- 发布协作任务（UCP: `task/publish`）
- 发布商品（UCP: `product/publish`）
- 发布 Skill（UCP: `skill/publish`）
- 同步到外部平台

### 第三层：渐进式表单输入

每个子功能点击后进入**渐进式表单**：
- 先问核心必填字段
- 可选字段折叠显示
- 实时校验 + 错误提示
- 智能填充（常用收款方、默认币种）

---

## 三、按类别的完整对话流程

### A. 支付 / 收款（X402 协议）

**触发语句**：
- "我要付款/收款"
- "生成支付链接"

**X402 协议流程**：
```
1. 用户发起支付请求
2. 系统生成 X402 Payment Request
3. 自动检查授权额度
4. 若已授权：自动扣款
5. 若未授权：展示授权确认卡片
6. 返回支付结果 + 交易ID
```

**表单字段（渐进式）**：
- 必填：金额、币种
- 选填：收款方、订单描述、回调URL

**结果卡片**：
```
┌─────────────────────────────────┐
│ ● 支付成功                       │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│ 💰 金额: 100 USDC               │
│ 👤 收款方: @alice               │
│ 🔗 交易ID: tx_xxx               │
│ 📋 X402 Ref: x402_xxx           │
│                                 │
│ [查看详情] [再次支付]            │
└─────────────────────────────────┘
```

---

### B. 法币/数字货币兑换（On‑ramp / Off‑ramp）

**触发语句**：
- "用法币换USDC"
- "把USDC提现"

**UCP 能力发现**：
```
GET /ucp/capabilities?type=exchange
→ 返回可用的兑换服务列表
```

**表单字段（渐进式）**：
- 必填：金额、源币种、目标币种
- 选填：目标地址、到账方式

---

### C. 分账 / 分佣（Split Plan）

**触发语句**：
- "设置分佣比例"
- "创建分账方案"

**UCP 协议**：
```
POST /ucp/commerce/split
{
  "participants": [...],
  "ratios": [...],
  "settlement": "auto"
}
```

**表单字段（渐进式）**：
- 必填：参与方列表、分账比例
- 选填：结算方式、生效时间

**下一步按钮**：
- 激活方案 / 关联商品 / 预览分账

---

### D. 预算池（Budget Pool）

**触发语句**：
- "给团队分配预算"
- "建一个任务预算池"

**UCP 协议**：
```
POST /ucp/commerce/budget-pool
{
  "totalBudget": "1000 USDC",
  "deadline": "2026-03-01",
  "milestones": []
}
```

**表单字段（渐进式）**：
- 必填：总预算、币种
- 选填：截止时间、质量门槛、里程碑列表

**下一步按钮**：
- 添加里程碑 / 立即激活

---

### E. 里程碑（Milestone）

**触发语句**：
- "给预算池加一个里程碑"
- "提交里程碑验收"

**UCP 协议**：
```
POST /ucp/commerce/milestone
{
  "poolId": "pool_xxx",
  "title": "阶段一",
  "ratio": 30,
  "criteria": "..."
}
```

**表单字段（渐进式）**：
- 必填：里程碑标题、占比
- 选填：验收标准、交付物

---

### F. 协作酬劳

**触发语句**：
- "给协作团队发放报酬"
- "按里程碑放款"

**X402 自动释放**：
```
当里程碑验收通过时，X402 自动触发：
POST /x402/release
{
  "milestoneId": "ms_xxx",
  "approved": true
}
→ 自动分账到各参与方
```

---

### G. 费用计算 / 预览

**触发语句**：
- "算手续费"
- "预览分账结果"

**表单字段**：
- 必填：金额、支付方式
- 返回：费用明细、净收入

---

### H. 费率结构

**触发语句**：
- "费率结构是什么？"

**直接返回费率卡片**：
```
┌─────────────────────────────────┐
│ 📊 Agentrix 费率结构            │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│ 平台服务费: 2.5%                │
│ 支付手续费: 1.5%                │
│ 跨境附加费: 0.5%                │
│ X402 自动结算: 免费              │
│                                 │
│ [查看完整费率表]                 │
└─────────────────────────────────┘
```

---

## 四、发布分类（新增）

### 🚀 发布入口

作为 `@commerce` 第四个主分类，提供一键发布能力。

### 发布类型

| 类型 | 说明 | UCP 端点 |
|------|------|----------|
| 协作任务 | 自动创建预算池 + 里程碑 | `POST /ucp/task/publish` |
| 商品 | 生成商品页 + 支付链接 | `POST /ucp/product/publish` |
| Skill | 发布到 Skill Marketplace | `POST /ucp/skill/publish` |

### 发布流程

```
1. 选择发布类型
   ○ 协作任务  ○ 商品  ○ Skill

2. 选择模板或自定义
   ○ 设计任务  ○ 开发任务  ○ 翻译任务
   ○ 商品销售  ○ 技能服务  ○ 自定义

3. 填写表单（渐进式）
   - 必填：标题、描述、价格
   - 选填：标签、交付要求、截止时间

4. 配置支付/分佣策略
   - 选择已有分账方案 或 自动生成
   - 设置里程碑（可选）

5. 选择发布渠道
   ☑ Agentrix Marketplace
   ☐ 外部平台（Webhook）

6. 确认发布
```

### 发布结果卡片

```
┌─────────────────────────────────┐
│ ● 发布成功                       │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│ 📦 类型: 协作任务                │
│ 📝 标题: 设计一个Logo            │
│ 💰 预算: 500 USDC               │
│ 🔗 链接: agentrix.io/task/xxx   │
│ 📋 UCP ID: ucp_task_xxx         │
│                                 │
│ [查看详情] [分享] [编辑]         │
└─────────────────────────────────┘
```

---

## 五、统一结果展示规范

### 状态可视化

| 状态 | 图标 | 颜色 |
|------|------|------|
| 成功 | ● | 绿色 |
| 处理中 | ○ | 黄色 |
| 失败 | ✗ | 红色 |

### 结果卡片结构

```
┌─────────────────────────────────┐
│ [状态图标] [操作类型]            │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│ [关键字段1]: [值1]              │
│ [关键字段2]: [值2]              │
│ [ID/引用号]                     │
│                                 │
│ [主要操作] [次要操作]            │
└─────────────────────────────────┘
```

### 错误处理

失败时展示：
- 错误原因
- 建议操作
- 重试按钮

### 操作确认与撤销

敏感操作（支付/发布）增加二次确认：
```
┌─────────────────────────────────┐
│ 确认支付 100 USDC 给 @alice？   │
│                                 │
│ [取消]  [确认支付]               │
└─────────────────────────────────┘
```

支持 30s 内撤销未完成操作。

---

## 六、对话连续性

### 上下文延续

```
用户: 创建一个 1000 USDC 的预算池
AI: ✅ 预算池已创建 (ID: pool_xxx)

用户: 给它加两个里程碑
AI: [自动关联 pool_xxx，无需重复输入]
    请填写第一个里程碑：
```

### 多步骤操作记忆

系统自动记住当前会话中创建的：
- 预算池 ID
- 分账方案 ID
- 订单 ID

---

## 七、技能列表展示规范

### `/skills` 或 Skills 按钮

- 展示可用技能列表 + 搜索框
- 分组展示：
  - 💰 支付类
  - 📦 商务类
  - 🔧 工具类
- 显示最近使用

### `@commerce`

- 直接展示 commerce 分类卡片（4 个场景入口）
- 不显示原始参数

---

## 八、跨平台适配规范

### 平台差异矩阵

| 平台 | 入口 | 表单 | 结果 | 协议 |
|------|------|------|------|------|
| **Agentrix 工作台** | 全功能 | 可视化表单 | 富卡片 | UCP + X402 |
| **Cursor/IDE** | MCP 工具 + 自然语言 | 内联参数 | Markdown | UCP |
| **Claude Desktop** | @commerce + MCP | 结构化 JSON | 文本 + 链接 | UCP |

### 降级策略

当平台不支持富卡片时，自动降级为结构化文本：

```markdown
✅ **支付成功**
- 金额: 100 USDC
- 收款方: @alice
- 交易ID: tx_xxx

[查看详情](https://agentrix.io/tx/xxx)
```

---

## 九、UCP/X402 协议集成

### UCP 能力发现

```http
GET /ucp/.well-known/capabilities
```

返回：
```json
{
  "commerce": {
    "payment": ["create", "query", "refund"],
    "split": ["create", "update", "delete"],
    "budget": ["create", "milestone", "release"],
    "publish": ["task", "product", "skill"]
  }
}
```

### X402 自动支付

```http
GET /resource
→ 402 Payment Required
→ X-Payment-402: {...}

POST /x402/pay
{
  "amount": "100 USDC",
  "resource": "/api/skill/xxx"
}
→ 200 OK + Access Token
```

### 商品/Skill 注册到 UCP

```http
POST /ucp/register
{
  "type": "skill",
  "name": "Data Analysis",
  "price": "10 USDC",
  "endpoint": "/api/skill/analysis",
  "x402": {
    "enabled": true,
    "autoAuth": true
  }
}
```

---

## 十、权限与安全

### 角色权限

| 角色 | 可见分类 | 操作限制 |
|------|----------|----------|
| 普通用户 | 收付款、兑换 | 单笔限额 |
| 商户 | 全部 | 无限制 |
| 开发者 | 全部 + API | 无限制 |

### 敏感操作验证

- 大额支付（>1000 USDC）：二次验证
- 发布到外部平台：确认弹窗
- 修改分账方案：需所有参与方确认

### 审计日志

所有 commerce 操作可追溯：
- 操作时间
- 操作者
- 操作类型
- 操作结果
- UCP/X402 引用ID

---

## 十一、优化 TODO 清单

### P0 - 核心功能（本周）

- [ ] **T001**: 重构分类结构为三层（4 场景入口 → 子功能 → 表单）
- [ ] **T002**: 实现渐进式表单（必填先展示，选填折叠）
- [ ] **T003**: 增加"🚀 发布"分类卡片到 `@commerce`
- [ ] **T004**: 表单实时校验 + 错误提示
- [ ] **T005**: 结果卡片状态可视化（成功/处理中/失败）

### P1 - 交互增强（下周）

- [ ] **T006**: 上下文延续（记住当前会话的 poolId/splitId）
- [ ] **T007**: 敏感操作二次确认弹窗
- [ ] **T008**: 30s 撤销功能
- [ ] **T009**: 智能填充（常用收款方、默认币种）
- [ ] **T010**: 历史记录 + 收藏技能

### P2 - 协议集成（下周）

- [ ] **T011**: UCP 能力发现端点实现
- [ ] **T012**: X402 支付流程集成
- [ ] **T013**: 商品/Skill 注册到 UCP
- [ ] **T014**: 发布到 Marketplace 接口

### P3 - 跨平台（第三周）

- [ ] **T015**: MCP 工具适配（Cursor/Claude Desktop）
- [ ] **T016**: 降级策略实现（富卡片 → Markdown）
- [ ] **T017**: 外部平台 Webhook 输出

### P4 - 安全与审计（第三周）

- [ ] **T018**: 角色权限控制
- [ ] **T019**: 大额支付二次验证
- [ ] **T020**: 审计日志记录

### P5 - 优化完善（持续）

- [ ] **T021**: 发布模板预设（设计/开发/翻译任务）
- [ ] **T022**: 批量操作支持
- [ ] **T023**: 通知与订阅（支付到账、里程碑完成）
- [ ] **T024**: 导出操作历史

---

## 十二、测试用例

### 基础流程测试

1. **入口测试**
   - 输入 `@commerce` → 显示 4 个场景入口
   - 输入 `/skills` → 显示技能列表
   - 输入自然语言 → 匹配正确分类

2. **支付流程**
   - 选择"收付款" → "发起支付"
   - 填写金额、收款方
   - 确认后返回成功卡片

3. **发布流程**
   - 选择"发布" → "发布协作任务"
   - 填写标题、描述、预算
   - 配置分佣策略
   - 发布成功返回链接

### X402 集成测试

1. **自动授权**
   - 调用需付费 Skill
   - 触发 402 响应
   - 自动扣款成功

2. **手动授权**
   - 超过授权额度
   - 展示确认弹窗
   - 用户确认后扣款

---

> 文档版本：V2.0
> 更新日期：2026-02-03
> 状态：待实现
